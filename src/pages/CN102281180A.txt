<!DOCTYPE html><html><head><title>专利 CN102281180A - 应用于不同局域网的终端相互通讯的虚拟网卡通讯装置 -  Google 专利</title><script>(function(){(function(){function e(a){this.t={};this.tick=function(a,c,b){var d=void 0!=b?b:(new Date).getTime();this.t[a]=[d,c];if(void 0==b)try{window.console.timeStamp("CSI/"+a)}catch(e){}};this.tick("start",null,a)}var a;window.performance&&(a=window.performance.timing);var f=a?new e(a.responseStart):new e;window.jstiming={Timer:e,load:f};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick("_wtsrt",void 0,c),b.tick("wtsrt_",
"_wtsrt",d),b.tick("tbsd_","wtsrt_"))}try{a=null,window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick("_tbnd",void 0,window.chrome.csi().startE),b.tick("tbnd_","_tbnd",c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick("_tbnd",void 0,window.external.startE),b.tick("tbnd_","_tbnd",c))),a&&(window.jstiming.pt=a)}catch(g){}})();})();
</script><link rel="stylesheet" href="/patents/css/_6e802a6b2b28d51711baddc2f3bec198/kl_intl_patents_bundle.css" type="text/css" /><script src="/books/javascript/atb_6e802a6b2b28d51711baddc2f3bec198__zh_cn.js"></script><script>function googleTranslateElementInit() {new google.translate.TranslateElement({pageLanguage: "zh",gaTrack: true,gaId: "UA-27188110-1",multilanguagePage: true});}</script><script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script><meta name="DC.type" content="Patent"><meta name="DC.title" content="应用于不同局域网的终端相互通讯的虚拟网卡通讯装置"><meta name="DC.contributor" content="李勇" scheme="inventor"><meta name="DC.contributor" content="冶金自动化研究设计院" scheme="assignee"><meta name="DC.date" content="2011-7-14" scheme="dateSubmitted"><meta name="DC.description" content="一种应用于不同局域网的终端相互通讯的虚拟网卡通讯装置，属于计算机通讯范畴的虚拟网卡通讯技术领域。包括：两个终端上的真实网卡NICA和NICB，功能是对外界执行真实的网络数据接收和转发工作，是虚拟网卡工作的基础；虚拟网卡NIC_SIMA和NIC_SIMB，它们为上层应用提供虚拟地址，上层应用使用该虚拟地址和对方通讯的时候，TCP/IP数据包流经该虚拟网卡，虚拟网卡软件将虚拟地址转换为真实的通讯地址，通过分配该通讯地址的真实网卡和对方通讯；地址服务器S，它作为两个虚拟网卡通讯的中介，协调两个虚拟网卡一步步建立通讯过程；真实网卡作为终端真实的物理设备存在于终端的硬件设备之中，虚拟网卡为终端上的一个驻留程序存在。"><meta name="DC.date" content="2011-12-14"><meta name="DC.relation" content="CN:101159657:A" scheme="references"><meta name="DC.relation" content="CN:101699801:A" scheme="references"><meta name="DC.relation" content="CN:101854313:A" scheme="references"><meta name="DC.relation" content="US:20080183853:A1" scheme="references"><meta name="citation_reference" content="李超: &quot;Xen VMX虚拟网卡的研究和模型改进&quot;, 《中国优秀硕士学位论文全文数据库》, 15 July 2008 (2008-07-15)"><meta name="citation_patent_publication_number" content="CN:102281180:A"><meta name="citation_patent_application_number" content="CN:201110197101"><link rel="canonical" href="https://www.google.com/patents/CN102281180A?cl=zh"/><meta property="og:url" content="https://www.google.com/patents/CN102281180A?cl=zh"/><meta name="title" content="专利 CN102281180A - 应用于不同局域网的终端相互通讯的虚拟网卡通讯装置"/><meta name="description" content="一种应用于不同局域网的终端相互通讯的虚拟网卡通讯装置，属于计算机通讯范畴的虚拟网卡通讯技术领域。包括：两个终端上的真实网卡NICA和NICB，功能是对外界执行真实的网络数据接收和转发工作，是虚拟网卡工作的基础；虚拟网卡NIC_SIMA和NIC_SIMB，它们为上层应用提供虚拟地址，上层应用使用该虚拟地址和对方通讯的时候，TCP/IP数据包流经该虚拟网卡，虚拟网卡软件将虚拟地址转换为真实的通讯地址，通过分配该通讯地址的真实网卡和对方通讯；地址服务器S，它作为两个虚拟网卡通讯的中介，协调两个虚拟网卡一步步建立通讯过程；真实网卡作为终端真实的物理设备存在于终端的硬件设备之中，虚拟网卡为终端上的一个驻留程序存在。"/><meta property="og:title" content="专利 CN102281180A - 应用于不同局域网的终端相互通讯的虚拟网卡通讯装置"/><meta property="og:type" content="book"/><meta property="og:site_name" content="Google Books"/><meta property="og:image" content="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"/><link rel="image_src" href="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"/><script>if (window['_OC_timingAction']) {window['_OC_timingAction']('patents_refpage');}</script><style>#gbar,#guser{font-size:13px;padding-top:1px !important;}#gbar{height:22px}#guser{padding-bottom:7px !important;text-align:right}.gbh,.gbd{border-top:1px solid #c9d7f1;font-size:1px}.gbh{height:0;position:absolute;top:24px;width:100%}@media all{.gb1{height:22px;margin-right:.5em;vertical-align:top}#gbar{float:left}}a.gb1,a.gb4{text-decoration:underline !important}a.gb1,a.gb4{color:#00c !important}.gbi .gb4{color:#dd8e27 !important}.gbf .gb4{color:#900 !important}

#gbar { padding:.3em .6em !important;}</style></head><body ><div id=gbar><nobr><a class=gb1 href="https://www.google.com/search?cl=zh&hl=zh-CN&sa=N&tab=tw">搜索</a> <a class=gb1 href="https://www.google.com/search?cl=zh&hl=zh-CN&tbm=isch&source=og&sa=N&tab=ti">图片</a> <a class=gb1 href="https://maps.google.com/maps?cl=zh&hl=zh-CN&sa=N&tab=tl">地图</a> <a class=gb1 href="https://play.google.com/?cl=zh&hl=zh-CN&sa=N&tab=t8">Play</a> <a class=gb1 href="https://www.youtube.com/results?cl=zh&hl=zh-CN&sa=N&tab=t1">YouTube</a> <a class=gb1 href="https://news.google.com/nwshp?hl=zh-CN&tab=tn">新闻</a> <a class=gb1 href="https://mail.google.com/mail/?tab=tm">Gmail</a> <a class=gb1 href="https://drive.google.com/?tab=to">云端硬盘</a> <a class=gb1 style="text-decoration:none" href="https://www.google.com/intl/zh-CN/options/"><u>更多</u> &raquo;</a></nobr></div><div id=guser width=100%><nobr><span id=gbn class=gbi></span><span id=gbf class=gbf></span><span id=gbe></span><a target=_top id=gb_70 href="https://www.google.com/accounts/Login?service=&continue=https://www.google.com/patents%3Fcl%3Dzh%26hl%3Dzh-CN&hl=zh-CN" class=gb4>登录</a></nobr></div><div class=gbh style=left:0></div><div class=gbh style=right:0></div><div role="alert" style="position: absolute; left: 0; right: 0;"><a href="https://www.google.com/patents/CN102281180A?cl=zh&amp;hl=zh-CN&amp;output=html_text" title="屏幕阅读器用户请注意：点击此链接可进入无障碍模式。阅读器在无障碍模式下具有同样的基本功能，但可让用户获得更好的体验。"><img border="0" src="//www.google.com/images/cleardot.gif"alt="屏幕阅读器用户请注意：点击此链接可进入无障碍模式。阅读器在无障碍模式下具有同样的基本功能，但可让用户获得更好的体验。"></a></div><div class="kd-appbar"><h2 class="kd-appname"><a href="/patents?hl=zh-CN"> 专利</a></h2><div class="kd-buttonbar left" id="left-toolbar-buttons"><a id="appbar-write-review-link" href=""></a><a id="appbar-view-print-sample-link" href=""></a><a id="appbar-view-ebook-sample-link" href=""></a><a id="appbar-patents-prior-art-finder-link" href="https://www.google.com/patents/related/CN102281180A"></a><a id="appbar-patents-discuss-this-link" href="https://www.google.com/url?id=8b2bBwABERAJ&amp;q=http://patents.stackexchange.com/redirect/google-patents%3Fpublication%3DCN102281180A&amp;usg=AFQjCNHAFyiWe3YPFvuIKJL77rgWW4wcxQ" data-is-grant="false"></a><a id="appbar-read-patent-link" href="//docs.google.com/viewer?url=patentimages.storage.googleapis.com/pdfs/bbe6030b59411272a3fd/CN102281180A.pdf"></a><a id="appbar-download-pdf-link" href="//patentimages.storage.googleapis.com/pdfs/bbe6030b59411272a3fd/CN102281180A.pdf"></a><a class="appbar-content-language-link" data-selected="true" data-label="中文" href="/patents/CN102281180A?cl=zh&amp;hl=zh-CN"></a><a class="appbar-content-language-link" data-label="英语" href="/patents/CN102281180A?cl=en&amp;hl=zh-CN"></a></div><div class="kd-buttonbar right" id="right-toolbar-buttons"></div></div><div id="books-microdata" itemscope=""itemtype="http://schema.org/Book"itemid="https://www.google.com/patents/CN102281180A?cl=zh" style="display:none"><span itemprop="description">一种应用于不同局域网的终端相互通讯的虚拟网卡通讯装置，属于计算机通讯范畴的虚拟网卡通讯技术领域。包括：两个终端上的真实网卡NICA和NICB，功能是对外界执行真实的网络数据接收和转发工作，是虚拟网卡工作的基础； ...</span><span itemprop="url">https://www.google.com/patents/CN102281180A?cl=zh&amp;utm_source=gb-gplus-share</span><span class="main-title" itemprop="name">专利 CN102281180A - 应用于不同局域网的终端相互通讯的虚拟网卡通讯装置</span><img itemprop="image" src="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"alt="专利 CN102281180A - 应用于不同局域网的终端相互通讯的虚拟网卡通讯装置" title="专利 CN102281180A - 应用于不同局域网的终端相互通讯的虚拟网卡通讯装置"></div><div style="display: none"><ol id="ofe-gear-menu-contents" class="gbmcc"><li class="gbe gbmtc"><a class="gbmt goog-menuitem-content" id="" href="https://www.google.com/advanced_patent_search?hl=zh-CN"> 高级专利搜索</a></li></ol></div><div id="volume-main"><div id="volume-center"><div class=vertical_module_list_row><div id=intl_patents class=about_content><div id=intl_patents_v><table class="patent-bibdata patent-drawings-missing"><tr><td class="patent-bibdata-heading"> 公开号</td><td class="single-patent-bibdata">CN102281180 A</td></tr><tr><td class="patent-bibdata-heading">发布类型</td><td class="single-patent-bibdata">申请</td></tr><tr><td class="patent-bibdata-heading"> 专利申请号</td><td class="single-patent-bibdata">CN 201110197101</td></tr><tr><td class="patent-bibdata-heading">公开日</td><td class="single-patent-bibdata">2011年12月14日</td></tr><tr><td class="patent-bibdata-heading"> 申请日期</td><td class="single-patent-bibdata">2011年7月14日</td></tr><tr><td class="patent-bibdata-heading"> 优先权日<span class="patent-tooltip-anchor patent-question-icon"data-tooltip-text="优先日期属于假设性质，不具任何法律效力。Google 对于所列日期的正确性并没有进行法律分析，也不作任何陈述。"></span></td><td class="single-patent-bibdata">2011年7月14日</td></tr><tr class="patent-bibdata-list-row alternate-patent-number"><td class="patent-bibdata-heading"> 公开号</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value">201110197101.9, </span><span class="patent-bibdata-value">CN 102281180 A, </span><span class="patent-bibdata-value">CN 102281180A, </span><span class="patent-bibdata-value">CN 201110197101, </span><span class="patent-bibdata-value">CN-A-102281180, </span><span class="patent-bibdata-value">CN102281180 A, </span><span class="patent-bibdata-value">CN102281180A, </span><span class="patent-bibdata-value">CN201110197101, </span><span class="patent-bibdata-value">CN201110197101.9</span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading"> 发明者</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=ininventor:%22%E6%9D%8E%E5%8B%87%22">李勇</a></span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading"> 申请人</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=inassignee:%22%E5%86%B6%E9%87%91%E8%87%AA%E5%8A%A8%E5%8C%96%E7%A0%94%E7%A9%B6%E8%AE%BE%E8%AE%A1%E9%99%A2%22">冶金自动化研究设计院</a></span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading">导出引文</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="/patents/CN102281180A.bibtex?cl=zh">BiBTeX</a>, </span><span class="patent-bibdata-value"><a href="/patents/CN102281180A.enw?cl=zh">EndNote</a>, </span><span class="patent-bibdata-value"><a href="/patents/CN102281180A.ris?cl=zh">RefMan</a></span></span></td></tr><tr class="patent-internal-links"><td colspan=2><span class="patent-bibdata-value"><a href="#backward-citations">专利引用</a> (4),</span> <span class="patent-bibdata-value"><a href="#npl-citations">非专利引用</a> (1),</span> <span class="patent-bibdata-value"><a href="#forward-citations"> 被以下专利引用</a> (6),</span> <span class="patent-bibdata-value"><a href="#classifications">分类</a> (1),</span> <span class="patent-bibdata-value"><a href="#legal-events">法律事件</a> (3)</span> </td></tr><tr><td colspan=2 class="patent-bibdata-external-link-spacer-top"></td></tr><tr class="patent-bibdata-external-link-spacer-bottom"></tr><tr><td colspan=2><span class="patent-bibdata-heading">外部链接:&nbsp;</span><span><span class="patent-bibdata-value"><a href="https://www.google.com/url?id=8b2bBwABERAJ&amp;q=http://211.157.104.87:8080/sipo/zljs/hyjs-yx-new.jsp%3Frecid%3D201110197101&amp;usg=AFQjCNGBZ1RgeVf5li-9J8HucPzGMdX7og"> 中国国家知识产权局</a>, </span><span class="patent-bibdata-value"><a href="https://www.google.com/url?id=8b2bBwABERAJ&amp;q=http://worldwide.espacenet.com/publicationDetails/biblio%3FCC%3DCN%26NR%3D102281180A%26KC%3DA%26FT%3DD&amp;usg=AFQjCNG1jvGbmhXBbYMvSF5cIRlmt6gO8Q"> 欧洲专利数据库 (Espacenet)</a></span></span></td></tr><tr class="patent-bibdata-group-spacer"></tr></table><div class="number-and-title"><span class="patent-title"><invention-title mxw-id="PT104818203" lang="ZH" load-source="patent-office">应用于不同局域网的终端相互通讯的虚拟网卡通讯装置</invention-title>
      </span><br><span class="patent-number">CN 102281180 A</span></div><div class="patent-section patent-abstract-section"><div class="patent-section-header"><span class="patent-section-title"> 摘要</span></div><div class="patent-text"><abstract mxw-id="PA86723044" lang="ZH" load-source="patent-office">
    <div class="abstract">一种应用于不同局域网的终端相互通讯的虚拟网卡通讯装置，属于计算机通讯范畴的虚拟网卡通讯技术领域。包括：两个终端上的真实网卡NICA和NICB，功能是对外界执行真实的网络数据接收和转发工作，是虚拟网卡工作的基础；虚拟网卡NIC_SIMA和NIC_SIMB，它们为上层应用提供虚拟地址，上层应用使用该虚拟地址和对方通讯的时候，TCP/IP数据包流经该虚拟网卡，虚拟网卡软件将虚拟地址转换为真实的通讯地址，通过分配该通讯地址的真实网卡和对方通讯；地址服务器S，它作为两个虚拟网卡通讯的中介，协调两个虚拟网卡一步步建立通讯过程；真实网卡作为终端真实的物理设备存在于终端的硬件设备之中，虚拟网卡为终端上的一个驻留程序存在。</div>
  </abstract>
  </div></div><div class="patent-section patent-claims-section"><div class="patent-section-header"><span class="patent-section-title">权利要求<span class="patent-section-count">(4)</span></span></div><div class="patent-text"><div mxw-id="PCLM37158787" lang="ZH" load-source="patent-office" class="claims">
    <div class="claim"> <div num="1" class="claim">
      <div class="claim-text">1.一种应用于不同局域网的终端相互通讯的虚拟网卡通讯装置，其特征在于，包括： 两个终端上的真实网卡NICA和OTCB，功能是对外界执行真实的网络数据接收和转发工作，是虚拟网卡工作的基础；虚拟网卡NIC_SIMA和NIC_SIMB，它们为上层应用提供虚拟地址，上层应用使用该虚拟地址和对方通讯的时候，TCP/IP数据包流经该虚拟网卡，虚拟网卡软件将虚拟地址转换为真实的通讯地址，通过分配该通讯地址的真实网卡和对方通讯；地址服务器S，它作为两个虚拟网卡通讯的中介，协调两个虚拟网卡一步步建立通讯过程；真实网卡作为终端真实的物理设备存在于终端的硬件设备之中，虚拟网卡为终端上的一个驻留程序存在，地址服务器S是部署在因特网上软件模块，可以从因特网上的任何地方访问到该服务器；地址服务器S的功能包括：1)统一管理所有连接到该服务的所有的虚拟地址，在虚拟网卡激活的时候为虚拟网卡分配通讯地址，在虚拟网卡断开的时候回收通讯地址；2)接受来自某个虚拟网卡软件的通讯地址信息，向有意连接该虚拟网卡的其他虚拟网卡发送通讯地址信息和连接方法；3)协调两个虚拟网卡之间通过双方发送的地址进行通讯，完成信息的交互、连接握手、 连接建立、媒体、数据流的传送；4)应用结束后关闭两个虚拟网卡之间的连接、释放资源并确认；5)统计虚拟网卡传输地址的连接信息，包括传输速率、传输质量、断线率和工作时间等信息，计算优先级，为连接方选择传输地址提供参考。虚拟网卡NIC_SIMA和NIC_SIMB的功能包括：通讯地址收集、虚拟地址注册、虚拟地址查询、传输地址选择、使用通讯地址执行数据传输操作、发送心跳数据包、虚拟地址注销； 虚拟网卡NIC_SIMA和NIC_SIMB的内部结构包括下面这些模块： 网络协议接口单元：用于处理访问该虚拟网卡的TCP/IP的数据包，对包含在数据包中的虚拟通讯地址进行转换和处理，根据转换后的地址选择真实网卡和外部通讯；通讯处理单元：执行通讯地址收集、地址交换、连接检查、数据传输等功能；实现当前虚拟网卡和其他局域网的虚拟网卡的数据传输过程；信息管理单元：该信息管理单元包含着当前在本虚拟网卡和其他虚拟网卡进行通讯过程中所有的数据结构。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="2" class="claim">
      <div class="claim-text">2.根据权利要求1所述的虚拟网卡通讯装置，其特征在于，通讯地址收集：收集当前终端可以用于双方建立通讯的地址，地址信息包括一个&lt;IP 地址，端口〉对，地址类别主要分为三类：本机所有网卡的地址，通过遍历本机所有网卡得到；NAT映射地址，一般的路由器都有网络地址转换功能，可以将局域网内的地址映射为 NAT出口的地址，在路由器上直接配置映射关系，或通过访问STUN服务器得到可供外部访问当前终端的映射地址；中继地址，有些NAT是对称式的，不支持固定的NAT映射，对于这种NAT，只能向特定的TURN服务器申请一个中继地址，所有的通讯数据包要经过中继服务器转发。对于每种类型的地址，参照ICE(互动式连接建立）算法计算一个优先级别，作为在后续地址检测中选择最佳通讯地址的参考；虚拟地址注册；为了向上层应用提供服务，虚拟网卡需要向地址服务器S申请一个虚拟地址，同时将自己的通讯地址、身份认证信息发送给服务器端；虚拟地址查询，为了和对等方虚拟网卡通讯，需要根据虚拟地址查询对方的通讯地址 fn息；传输地址选择：在收到对方的通讯地址信息之后，双方都需要根据这些通讯地址进行连接检查，从中获得一个最佳的传输地址作为最终的传输地址；发送心跳数据包：考虑到NAT分配的地址有时效性，虚拟网卡会定时发送心跳数据包给对方的通讯地址，进行检测，并发送当前地址的连接情况信息反馈给地址服务器S，在通讯地址失效的情况下虚拟网卡会从地址列表中重新选择通讯地址并进行检测；虚拟地址注销：数据传输完毕后，虚拟网卡根据需要会断开所有和对等方虚拟网卡的网络连接，同时发送注销请求给地址服务器S，地址服务器回收分配给该虚拟网卡的通讯地址，虚拟网卡断开。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="3" class="claim">
      <div class="claim-text">3.根据权利要求1所述的虚拟网卡通讯装置，其特征在于，所述的信息管理单元包含着当前在本虚拟网卡和其他虚拟网卡进行通讯过程中所有的数据结构，包括：候选地址列表：该表格中存储着收集到的可以用于其他虚拟网卡和自己通讯的地址列表，包括前面所述的三类地址信息，根据实际的应用，用户可以向这个列表中添加其他可以用于通讯的地址信息，添加完毕之后需要计算并更新每个地址的优先级，计算公式可以由用户自己定义；虚拟地址映射表：该表格中存储对等方虚拟地址相关信息，通过该虚拟地址映射表可以查询到虚拟地址对应的真实连接地址；虚拟地址映射表中包含的信息包括：虚拟地址、 访问端口、本方真实传输地址、本方真实传输端口、对方传输地址、对方传输端口、地址状态、创建时间等信息；用户认证信息：虚拟网卡需要在连接地址服务器的时候，需要提供一个身份信息给地址服务器；经过认证之后，虚拟网卡才能注册和查询虚拟地址信息；好友和历史访问信息：在虚拟网卡内部有一个好友列表，每个好友是一个虚拟网卡用户，他们都注册到当前地址服务器；这个信息是在虚拟网卡初始化的时候，虚拟网卡从服务器上读取到的；好友级别的用户可以提供比其他用户更好的传输质量和传输速度；地址检查列表：在执行地址检查过程生成的临时数据，这个数据在数据传输完毕后可以被清除，作为一种优化的选项，这个列表信息可以保留，下次虚拟网卡重新启动后重新建立地址检查表的时候，考虑到这个优先级因子，以前高优先级的地址还会保持优先选择，这样用户选择的传输地址就能保持一个优化的状态；优化因子和优化算法由用户选择和定义，或以根据当前网络变动情况进行演化；输入输出缓冲区：用于临时缓存需要发送和接收的数据包。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="4" class="claim">
      <div class="claim-text">4.根据权利要求1所述的虚拟网卡通讯装置，其特征在于，虚拟网卡通过地址服务器实现通讯过程中交互的消息流程包括：1)虚拟地址注册请求：在收集完地址之后，虚拟网卡将外界可以和自己通讯的所有地址信息打成一数据包，加上自己的身份认证和好友信息，加密后发送给地址服务器S ；2)注册应答消息：地址交换服务器在内部维护一个虚拟地址信息映射表，根据一定算法和规则向发送端返回一个未用的虚拟IP地址，并以该IP地址作为键值更新映射表，然后再将该虚拟IP地址信息通过正常的TCP/IP数据包发送给该虚拟网卡；3)更新请求消息：当前虚拟网卡将自己收集到的通讯地址信息发送给地址交换服务器S ；当前虚拟网卡在此之前已经做了一个连接检查的操作，考虑到网络的时延，某些地址的状态还没有及时返回，为了保持地址的有效性，虚拟网卡需要不断地将有效的地址信息更新到服务器中，服务器再将更新后的地址状态信息转发到其他虚拟网卡用户；4)更新应答消息：根据当前虚拟网卡的虚拟地址，地址交换服务器及时更新数据库中的地址信息，然后发送一个应答消息给虚拟网卡；5)认证请求：其他虚拟网卡需要和当前虚拟网卡通讯之前，需要提供身份认证信息；6)认证应答：对于来自某个虚拟网卡的认证请求，地址交换服务器需要核对当前虚拟网卡提交的身份信息，返回当前虚拟网卡的通讯权限和好友列表；7)查询请求：可以根据某个虚拟网卡地址查询到该虚拟网卡可用的地址信息。就是虚拟网卡在和其他虚拟网卡通讯之前，需要首先查询该虚拟网卡的真实地址，查询凭证就是对方虚拟网卡的虚拟地址；需要输入一个或者多个虚拟地址信息组成一个字符串给地址服务器，如果需要查询所有可访问的可以使用可以输入一个通配符*，查询到所有虚拟网卡组成的列表；8)查询应答消息：服务器在收到该请求消息后，会从数据库中进行查询，如果查询成功，则返回对应虚拟地址真实的传输地址信息，否则向发送方报告一个地址不可达信息；9)订阅消息：进行通讯的双方的网络状况有时是在不断地变动过程中，有的时候用户希望对方的网络地址发生变化的时候本方及时得到通知，这就需要订阅消息；订阅消息需要两个虚拟网卡、地址交换服务器三方参与，首先虚拟网卡向地址交换服务器发送订阅消息，该消息经该服务器转发到对方虚拟网卡所在的客户机；10)订阅消息应答：在收到订阅消息之后，对方虚拟网卡将发送一个确认消息或者发送一个拒绝消息，表示拒绝提供订阅功能；这个确认消息表示两方存在这样一个订阅关系， 在本方向地址交换服务器更新地址信息的时候，对方将收到一个通知，及时地处理通讯地址的变化；11)注销请求：客户机希望注销该虚拟网卡，需要从地址服务器S中移除掉本方地址信息，将发送该请求；12)注销应答：地址服务器S检查数据库中的虚拟地址映射表，从中移除掉该客户机的虚拟网卡地址映射信息，并发送一个应答给客户端。</div>
    </div>
  </div> </div>
  </div></div><div class="patent-section patent-description-section"><div class="patent-section-header"><span class="patent-section-title"> 说明</span></div><div class="patent-text"><div mxw-id="PDES42818303" lang="ZH" load-source="patent-office" class="description">
    <p>应用于不同局域网的终端相互通讯的虚拟网卡通讯装置</p>
    <p>技术领域</p>
    <p>[0001]	本发明属于计算机通讯范畴的虚拟网卡通讯技术领域，特别是提供了一种应用于两个不同的局域网中的终端相互通讯的虚拟网卡通讯装置。</p>
    <p>背景技术</p>
    <p>[0002]	在不同局域网中的通讯终端的地址是该局域网中的路由器/NAT分配的，这些通讯地址一般只在当前局域网中有效，跨越两个不同局域网的用户是不能直接相互访问到的。但是，在人们日常的生产生活中有大量的通讯需求，要求双方能建立直接的联系，比如网络电话、语音、视频聊天等。对于这些应用需求，有很多种解决方法，比如在路由器/NAT 中添加地址映射建立虚拟主机、采用UDP/TCP打洞技术开放通讯地址、采用中继服务器技术来转发数据包，或者采用专门的VPN技术将TCP/IP数据包加密后封装在特定数据包中在网络上传输，接收方在收到该数据包后再解密拆包再还原出通讯的内容，等等。采用这些方案需要对应用进行特别处理，往往需要对原来在局域网中的应用进行重新编程，相对代价比较高昂，一般使用于企业用户，不适合在因特网上普遍推广。本专利设计的目的是提出一种解决此类问题的通讯装置，这个通讯装置包括两个分别部署在两个不同局域网的终端和一个部署在因特网上的服务器组成，两个终端上应用通过虚拟网卡进行通讯；两个虚拟网卡相互直接的通讯地址通过公网上的服务器交换得到，而在虚拟网卡上层，两个应用通过地址交换服务器分配的虚拟IP地址通讯，在虚拟网卡内部实现跨越两个不同局域网进行通讯的复杂的通讯逻辑，包括传输地址获取、连接性检查、连接建立、断线重连、连接管理等。通过这样的装置，双方通讯就如同在一个局域网内，这样企业应用的开发者只需要开发基于局域网的应用，在企业内部网络拓扑发生变化的时候只需要修改虚拟网卡的配置即可，这样对于保护用户的投资，减少或者避免现有系统的更改，保持系统稳定有着重大意义。</p>
    <p>[0003]	详细介绍技术背景，并描述已有的与本发明最相近似的技术方案</p>
    <p>[0004]	作为本发明基础的且帮助理解本发明公知技术内容</p>
    <p>[0005]	网卡（Network Interface Card，简称NIC)，也称网络适配器，是电脑与局域网相互连接的设备。无论是普通电脑还是高端服务器，只要连接到局域网，就都需要安装一块网卡。如果有必要，一台电脑也可以同时安装两块或多块网卡。网卡（NIC)插在计算机主板插槽中，负责将用户要传递的数据转换为网络上其它设备能够识别的信息格式，该信息进一步通过网络介质传输到网络上其他主机的网卡之中。网卡对流经自己的所有数据包进行检测，对与自己有关联的数据包进行处理后再进一步转发到其他主机上。</p>
    <p>[0006]	虚拟网卡是一种软件模拟技术，通过软件的方式在计算机虚拟出一块“网卡”， 这个网卡的功能和真实的网卡的功能完全一样，虚拟网卡也有个一个地址，通过该虚拟地址虚拟网卡可以和外部网络进行无差别的通讯。比如，在使VMWare公司的VMWare Workstation虚拟机软件时，通过虚拟网卡可以使本机和虚拟机进行通讯；通过虚拟网卡技术，可以完全实现已有的网卡功能，实现一些特殊用途的通信。[0007]	地址收集技术。两个不同局域网的两个虚拟网卡能够通讯的前提是必须要有合适的通讯地址，而这个通讯地址的获得可以采用多种方法得到，比如本地的通讯地址可以通过遍历本机上的所有网卡的地址；检查当前终端在路由器WAN(广域网)侧的通讯地址，可以得到路由器的映射地址；还可以从一个专门的中继服务器上获取一个专门用于转发的通讯地址。不同类型的通讯地址的质量和传输速率是不一样的，在实际数据传输的时候需要从中筛选出最佳的通讯地址再进行进一步的通讯。</p>
    <p>[0008]	网络穿越技术</p>
    <p>[0009]	NAT的英文全称为Network Address ^Translators，它的主要功能是负责当前路由器管理的局域网和公共网络之间的地址转换和转发。在NAT上可能部署有防火墙，能阻止某些协议类型的数据包通过。</p>
    <p>[0010]	STUN技术介绍</p>
    <p>[0011]在	RFC3489 中，STUN 定义为 Simple Traversal of UDP through NAT，使用 UDP 方式对NAT的穿越。主要步骤包括：在内网的STUN客户端向NAT外的STUN服务器发送STUN请求消息查询自己转换后的地址，STUN服务器在收到请求消息后，获得自己看到的来源STUN 消息的来源地址信息，将这个信息作为负载存入响应消息中。STUN客户端通过返回消息中的内容得知在NAT上的对应的外部地址，将这个信息存入以后呼叫协议的UDP负载中。由于通过STUN协议已经在NAT上预先建立了媒体流的NAT映射表项，故数据流可顺利穿越NAT。</p>
    <p>[0012]	TURN技术介绍</p>
    <p>[0013]	TURN 技术的英文全称为 Traversal Using Relay NAT (TURN) &#8212;种穿越 NAT 的协议，它允许一个在NAT (或者防火墙）后的终端通过TCP/UDP连接接受数据。TURN是一个简单的客户端服务器协议，包括一个TURN服务器和一个TURN客户端。TURN协议采用和STUN 协议相同的语法和操作规则。TURN可以运行在TCP和UDP之上。通过TURN实现网关穿越的基本步骤是：</p>
    <p>[0014]	TURN客户端首先要去发现TURN服务器的地址。一旦发现了一个TURN服务器，客户端会发送一个TURN Allocate请求给TURN服务器。TURN提供了一种基于共享私密对既包括请求又包括响应的交互式认证和完整消息检验机制。在消息得到验证之后，TURN服务器会记录请求方（简称SA)的源传输地址，然后在TURN应答中返回一个公共的传输地址（简称PA)。TURN服务器有责任保证发送到PA的数据包转发到TURN Server。TURN Server于是在PA上等待数据。当接收到数据后，TURN krver会接受这个连接（在TCP的情况下）， 并且存储数据来源的地址和端口信息（RA)。在接收到数据之后，数据就会被转发到SA。这样TURN krver就充当了一个中继服务器的角色，将从SA接收到的数据转发到RA，将从RA 到PA的数据转发到SA。</p>
    <p>[0015]	现有实现虚拟网卡的技术主要是通过VPN技术来实现。VPN主要采用IP隧道技术来实现通讯过程，来自客户端的数据包首先被重定向到虚拟网卡，虚拟网卡将客户端的数据采用指定的方式封装到IP数据报之中，这些数据报作为负载通过TCP/UDP发送到公网上的VPN服务器上，VPN服务器对这些数据包进行处理，将负载中的用户地址转换为真实的IP 地址，发给目标客户。VPN的缺点是一般都需要专门支持VPN的软硬件来支持，在公网上一般都有很多NAT/防火墙可以分析和过滤VPN数据包，在很多网络中VPN不能正常使用。而且VPN数据包需要进行IP封装，在传输过程中有比较大的带宽损耗。[0016]	以因果关系推理的方式推导出现有技术的缺点是什么？针对这些缺点，说明本发明的目的。</p>
    <p>[0017]	现有实现跨越两个局域网的终端通讯的虚拟网卡技术大都采用VPN(虚拟专用网络）技术来实现。在这些实现方案中，实现通讯的步骤是：</p>
    <p>[0018]	1)终端将IP数据包（或者以太网数据包，日本Sof让ther虚拟网卡软件采用这种技术）提交给虚拟网卡；</p>
    <p>[0019]	2)虚拟网卡对IP数据包（或者以太网数据包）进行加密处理，封装在UDP/TCP数据包中，然后通过真实网卡将数据包发送到公网的服务器；</p>
    <p>[0020]	3)公网服务器收到该数据封包之后，对其数据包头进行解密，从中获得对方的IP 地址，然后将按照发送方的策略重新封装数据包，发送到接收方的虚拟网卡（接收方虚拟网卡已经提前连接到服务器上）；</p>
    <p>[0021]	4)接收方虚拟网卡在收到服务器发来的加密数据包，执行解密过程，获得原始数据包的数据。这样接收方就获得了原始数据包。</p>
    <p>[0022]	VPN的最大特点是双方通讯需要特别的硬件支持，一般应用于企业用户，代价比较高昂；但VPN采用数据封包方式传输，即在TCP/IP数据包中又进行了进一步的封装，数据封包方式增大了负载，降低了有效数据的传送速度；在VPN服务器暂时失效的情况下，虚拟网卡就不能被访问到。而且很多防火墙都添加了对IPkc/VPN数据的过滤模块，这样在很多情况下通讯就不成功。</p>
    <p>发明内容</p>
    <p>[0023]	本发明技术方案的详细阐述，应该结合流程图、原理图、电路图、时序图进行说明</p>
    <p>[0024]	一、通讯装置组成结构</p>
    <p>[0025]	本发明提出了一种两个不同局域网的两个终端通过虚拟网卡进行通讯的装置，该装置的组成包括：1)两个终端上的真实网卡NICA和NICB，它们的主要功能是对外界执行真实的网络数据接收和转发工作，是虚拟网卡工作的基础；2)虚拟网卡NIC_SIMA和NIC_ SIMB,它们为上层应用提供虚拟地址，上层应用使用该虚拟地址和对方通讯的时候，TCP/IP 数据包流经该虚拟网卡，虚拟网卡软件将虚拟地址转换为真实的通讯地址，通过分配该通讯地址的真实网卡和对方通讯；幻地址服务器S，它作为两个虚拟网卡通讯的中介，协调两个虚拟网卡一步步建立通讯过程。真实网卡作为终端真实的物理设备存在于终端的硬件设备之中，虚拟网卡为终端上的一个驻留程序存在，地址服务器S是部署在因特网上软件模块，可以从任何地方访问到该服务器。</p>
    <p>[0026]	地址服务器S的主要功能包括：</p>
    <p>[0027]	1)统一管理所有连接到该服务的所有的虚拟地址，在虚拟网卡激活的时候为虚拟网卡分配通讯地址，在虚拟网卡断开的时候回收通讯地址；</p>
    <p>[0028]	2)接受来自某个虚拟网卡软件的通讯地址信息，向有意连接该虚拟网卡的其他虚拟网卡发送通讯地址信息和连接方法；</p>
    <p>[0029]	3)协调两个虚拟网卡之间通过双方发送的地址进行通讯，完成信息的交互、连接握手、连接建立、媒体、数据流的传送；</p>
    <p>[0030]	4)应用结束后关闭两个虚拟网卡之间的连接、释放资源并确认；[0031]	5)统计虚拟网卡传输地址的连接信息，包括传输速率、传输质量、断线率和工作时间等信息，计算优先级，为连接方选择传输地址提供参考。</p>
    <p>[0032]	虚拟网卡的主要功能包括：</p>
    <p>[0033]	1)通讯地址收集。收集当前终端可以用于双方建立通讯的地址，地址信息包括一个&lt;IP地址，端口〉对，地址类别主要分为三类：a)本机所有网卡的地址，通过遍历本机所有网卡得到；b)NAT映射地址。一般的路由器都有网络地址转换功能，可以将局域网内的地址映射为NAT出口的地址，可以在路由器上直接配置映射关系，也可以通过访问STUN服务器得到；c)中继地址。有些NAT是对称式的，不支持固定的NAT映射，对于这种NAT，只能向特定的TURN服务器申请一个中继地址，所有的通讯数据包要经过中继服务器转发。对于每种类型的地址，参照ICE (互动式连接建立）算法计算一个优先级别；</p>
    <p>[0034]	2)虚拟地址注册；为了向上层应用提供服务，虚拟网卡需要向地址服务器S申请一个虚拟地址，同时将自己的通讯地址、身份认证等信息发送给服务器端；</p>
    <p>[0035]	3)虚拟地址查询，为了和对等方虚拟网卡通讯，需要根据虚拟地址查询对方的通讯地址信息；</p>
    <p>[0036]	4)传输地址选择。在收到对方的通讯地址信息之后，双方都需要根据这些通讯地址进行连接检查，从中获得一个最佳的传输地址作为最终的传输地址；</p>
    <p>[0037]	5)使用通讯地址执行数据传输操作；</p>
    <p>[0038]	6)发送心跳数据包。考虑到NAT分配的地址有时效性，虚拟网卡会定时发送心跳数据包给对方的通讯地址，进行检测，并发送当前地址的连接情况信息反馈给地址服务器 S，在通讯地址失效的情况下虚拟网卡会从地址列表中重新选择通讯地址并进行检测；</p>
    <p>[0039]	7)虚拟地址注销。数据传输完毕后，虚拟网卡根据需要会断开了所有和对等方虚拟网卡的网络连接，同时发送注销请求给地址服务器S，地址服务器回收分配给该虚拟网卡的通讯地址，虚拟网卡断开。</p>
    <p>[0040]	虚拟网卡的内部结构图如说明书附图1所示，主要包括下面这些模块：</p>
    <p>[0041]	a.网络协议接口单元：用于处理访问该虚拟网卡的TCP/IP的数据包，对包含在数据包中的虚拟通讯地址进行转换和处理，根据转换后的地址选择真实网卡和外部通讯；</p>
    <p>[0042]	b.通讯处理单元：执行通讯地址收集、地址交换、连接检查、数据传输等功能。实现当前虚拟网卡和其他局域网的虚拟网卡的数据传输过程；</p>
    <p>[0043]	c.信息管理单元：该信息管理单元包含着当前在本虚拟网卡和其他虚拟网卡进行通讯过程中所有的数据结构，包括：</p>
    <p>[0044]	1)候选地址列表该表格中存储着收集到的可以用于其他虚拟网卡和自己通讯的地址列表，主要包括前面所述的三类地址信息，根据实际的应用，用户可以向这个列表中添加其他可以用于通讯的地址信息，添加完毕之后需要计算并更新每个地址的优先级，计算公式可以由用户自己定义。</p>
    <p>[0045]	2)虚拟地址映射表该表格中存储对等方虚拟地址相关信息，通过该虚拟地址映射表可以查询到虚拟地址对应的真实连接地址。虚拟地址映射表中包含的信息包括：虚拟地址、访问端口、本方真实传输地址、本方真实传输端口、对方传输地址、对方传输端口、地址状态、创建时间等信息。</p>
    <p>[0046]	3)用户认证信息。虚拟网卡需要在连接地址服务器的时候，需要提供一个身份信息给地址服务器。经过认证之后，虚拟网卡才能注册和查询虚拟地址信息。</p>
    <p>[0047]	4)好友和历史访问信息。在虚拟网卡内部有一个好友列表，每个好友是一个虚拟网卡用户，他们都注册到当前地址服务器。这个信息是在虚拟网卡初始化的时候，虚拟网卡从服务器上读取到的。好友级别的用户可以提供比其他用户更好的传输质量和传输速度。</p>
    <p>[0048]	5)地址检查列表。在执行地址检查过程生成的临时数据。这个数据在数据传输完毕后可以被清除，作为一种优化的选项，这个列表信息可以保留，下次虚拟网卡重新启动后重新建立地址检查表的时候，考虑到这个优先级因子，以前高优先级的地址还会保持优先选择，这样用户选择的传输地址就能保持一个优化的状态。优化因子和优化算法可以由用户选择和定义，也可以根据当前网络变动情况进行演化，本专利不做特殊限制。</p>
    <p>[0049]	6)输入输出缓冲区。用于临时缓存需要发送和接收的数据包。</p>
    <p>[0050]	d.虚拟网卡与地址服务器交互单元。该单元的主要功能包括：</p>
    <p>[0051]	1)虚拟地址注册当前虚拟网卡必须要有一个IP地址来和其他虚拟网卡通讯。 首先，当前虚拟网卡向地址服务器发送一个注册请求，地址服务器S根据当前虚拟网卡的地址从自己内部的地址池中选择一个未占用的地址分配给该虚拟网卡用户，并标志该地址为占用状态；</p>
    <p>[0052]	2)虚拟地址映射更新注册成功后，当前虚拟网卡将自己收集到的通讯地址发送给地址服务器S。当前地址服务器收到这个信息后，将虚拟地址放在服务端的一个映射表中。</p>
    <p>[0053]	3)虚拟地址交换当前虚拟网卡为了和对等方通讯，需要向地址服务器查询对等方的通讯地址，当然，对方虚拟网卡是预先注册到该服务器并且更新了地址信息。为了保证通讯的安全，在虚拟地址交换的时候地址交换服务器需要对当前虚拟网卡的身份进行认证。</p>
    <p>[0054]	4)通讯地址状态更新当前虚拟网卡获得了对方提供的传输地址，就进行了从连接检查到连接建立、数据传输等多个操作，在此之中，通讯地址的可用性和性能就是很重要的指标。在这些操作的每一步中，当前虚拟网卡会向地址服务器提供通讯地址状态的最新 fn息ο</p>
    <p>[0055]	5)虚拟地址注销在双方通讯结束后，虚拟网卡需要从系统中注销。首先虚拟网卡会向地址服务器发送一个注销请求，地址服务器收到这个请求之后，将当前虚拟网卡的地址从服务器中清除掉，断开与服务器的连接，并且将该虚拟地址设置为可用状态。</p>
    <p>[0056]	e.信息存储模块。需要存储的信息包括用户身份信息、好友信息和地址状态信息。 通过信息存储模块，虚拟网卡可以有效地保存各种参数信息，在虚拟网卡出现故障重新启动之后可以重新读取这些参数信息作为参考。</p>
    <p>[0057]	f.地址优化模块。需要根据当前虚拟网卡的通讯状况，更新对方每个通讯地址的优先级，在本专利中使用ICE(互动式连接建立算法）中的优先级算法作为默认的优先级计算算法。为了提高系统的可用性，优化算法提供统一的接口，系统只需要调用该接口就可以对优先级进行计算，在实现的时候优化算法以动态库的方式出现，在系统初始化的时候加载，可以被同样接口的其他优化算法替换。</p>
    <p>[0058]	虚拟网卡和地址交换服务器的消息通讯流程如图3表示。在图3中包含了两个虚拟网卡和一个地址交换服务器，交流的消息流程包括：[0059]	1)虚拟地址注册请求。在收集完地址之后，虚拟网卡将外界可以和自己通讯的所有地址信息打成一数据包，加上自己的身份认证和好友信息（哪些虚拟网卡可以访问自己），加密后发送给地址服务器S ；</p>
    <p>[0060]	2)注册应答消息。地址交换服务器在内部维护一个虚拟地址信息映射表，根据一定算法和规则向发送端返回一个未用的虚拟IP地址，并以该IP地址作为键值更新映射表， 然后再将该虚拟IP地址信息通过正常的TCP/IP数据包发送给该虚拟网卡。</p>
    <p>[0061]	3)更新请求消息。当前虚拟网卡将自己收集到的通讯地址信息发送给地址交换服务器S。当前虚拟网卡在此之前已经做了一个连接检查的操作，考虑到网络的时延，某些地址的状态还没有及时返回，为了保持地址的有效性，虚拟网卡需要不断地将有效的地址信息更新到服务器中，服务器再将更新后的地址状态信息转发到其他虚拟网卡用户。</p>
    <p>[0062]	4)更新应答消息。根据当前虚拟网卡的虚拟地址，地址交换服务器及时更新数据库中的地址信息，然后发送一个应答消息给虚拟网卡。</p>
    <p>[0063]	5)认证请求。其他虚拟网卡需要和当前虚拟网卡通讯之前，需要提供身份认证信肩、ο</p>
    <p>[0064]	6)认证应答对于来自某个虚拟网卡的认证请求，地址交换服务器需要核对当前虚拟网卡提交的身份信息，返回当前虚拟网卡的通讯权限和好友列表。</p>
    <p>[0065]	7)查询请求。可以根据某个虚拟网卡地址查询到该虚拟网卡可用的地址信息。就是虚拟网卡在和其他虚拟网卡通讯之前，需要首先查询该虚拟网卡的真实地址，查询凭证就是对方虚拟网卡的虚拟地址。需要输入一个或者多个虚拟地址信息组成一个字符串给地址服务器，如果需要查询所有可访问的可以使用可以输入一个通配符*，查询到所有虚拟网卡组成的列表。</p>
    <p>[0066]	8)查询应答消息。服务器在收到该请求消息后，会从数据库中进行查询，如果查询成功，则返回对应虚拟地址真实的传输地址信息，否则向发送方报告一个地址不可达信息；</p>
    <p>[0067]	9)订阅消息。进行通讯的双方的网络状况有时是在不断地变动过程中，有的时候用户希望对方的网络地址发生变化的时候本方及时得到通知，这就需要订阅消息。订阅消息需要两个虚拟网卡、地址交换服务器三方参与，首先虚拟网卡向地址交换服务器发送订阅消息，该消息经该服务器转发到对方虚拟网卡所在的客户机；</p>
    <p>[0068]	10)订阅消息应答。在收到订阅消息之后，对方虚拟网卡将发送一个确认消息（或者发送一个拒绝消息，表示拒绝提供订阅功能），这个确认消息表示两方存在这样一个订阅关系，在本方向地址交换服务器更新地址信息的时候，对方将收到一个通知，及时地处理通讯地址的变化。</p>
    <p>[0069]	11)注销请求。客户机希望注销该虚拟网卡，需要从地址服务器S中移除掉本方地址信息，将发送该请求；</p>
    <p>[0070]	12)注销应答。地址服务器S检查数据库中的虚拟地址映射表，从中移除掉该客户机的虚拟网卡地址映射信息，并发送一个应答给客户端。</p>
    <p>[0071]	综上所述，如说明书附图4所示，两个处于不同局域网的虚拟网卡通过虚拟网卡为中介建立通讯过程可以简述如下：</p>
    <p>[0072]	a.首先在建立连接之前，双方虚拟网卡需要做收集地址的准备工作，所收集的地址可以是任何对方可以用来和自己进行通讯的地址，根据收集的地址的类型不同，双方虚拟网卡需要为每个地址计算一个优先级，做为后续连接检查中筛选地址的依据；</p>
    <p>[0073]	b.双方向地址服务器S注册虚拟地址和传输地址的映射，并且根据虚拟地址向地址服务器S请求对方的传输地址；</p>
    <p>[0074]	c.在获得对方提供的传输地址之后，再加上自身的传输地址，组成多组连接地址对，每个连接地址对有不同的优先级，这些地址就是进行连接检查的候选地址。双方根据候选地址列表开始进行连接检查测试，在检查过程中根据测试结果对候选地址进行筛选，从中选择一个最佳的地址对作为双方的通讯地址链路，并通知地址服务器，更新虚拟连接信肩、ο</p>
    <p>[0075]	d.双方开始根据虚拟地址传输数据。虚拟网卡查询地址服务器，得到最新的虚拟地址和真实通讯地址的映射，根据真实通讯地址选择真实网卡传输数据。</p>
    <p>[0076]	e.某些通讯地址有时效性，当前虚拟网卡需要定时向该通讯地址发送特殊类型的数据包，该数据包的作用就是延长该地址的有效期，避免在数据传输过程中连接断开。</p>
    <p>[0077]	f.在数据传输完毕后，根据需要，双方虚拟网卡可以向地址服务器注销，虚拟网卡回收分配为双方虚拟网卡的虚拟通讯地址，双方虚拟网卡连接断开。</p>
    <p>[0078]	用推理方式推导出本发明的优点，可以对应3部分所要解决的技术问题或发明目的来描述。</p>
    <p>[0079]	本发明相比VPN技术有如下创新点：</p>
    <p>[0080]	1)本发明提出了一个虚拟网卡通讯装置来实现跨越两个局域网的两个终端的建立直接的通讯过程。相比使用VPN技术来说，可以在地址收集过程中在NAT上实现UDP/TCP 打洞建立一个有效的地址映射，通讯双方使用映射后的地址传输速度是最快的，而VPN技术则使用了隧道传输技术，在传输的数据包中封装了原始的TCP/UDP数据包，增加了网络传输的负荷，传输效率相对较低。日本的SoftKher软件则是在TCP层次实现了对以太网的模拟技术，当相比之下还是不如建立直接的通讯链路效率高。</p>
    <p>[0081]	2) VPN&#8212;般需要专门的厂家提供特定的软硬件产品来实现，它会受到路由器/NAT 的配置影响，或者受到网关代理设备的影响。而本虚拟网卡采用灵活的地址检测方案进行连接尝试，从使用直接的本地局域网地址通讯到使用专门的中继服务器来转发数据，这些地址信息可以通过检测得到，灵活地适应各种不同的网络变化情况，提高了本虚拟网卡的健壮性。</p>
    <p>[0082]	3) VPN 一般需要特定的协议支持，比如IPSEC，而且不同厂商的VPN产品和解决方案很难兼容，脱离开具体的VPN设备VPN技术就没有了用武之地，相比之下本虚拟网卡采用标准的TCP/IP协议进行地址收集和连接性检测，上层应用使用虚拟地址通讯也是基于 TCP/IP的，没有硬件和协议限制。本发明在部署的时候，相对比较灵活，最基本的只需要在公网上架设一台地址服务器，现在需要路由器/NAT都提供了端口映射功能，可以提供专门的NAT映射地址，也可以在地址服务器上部署一台标准的STUN服务器和TURN服务器作为辅助，获取更多可用的通讯地址。</p>
    <p>[0083]	本发明在地址搜集过程中可以使用标准的ICE技术来进行地址收集和检测。在 ICE规范中规定了三类地址作为可选的通讯地址：本机地址、服务器映射地址和中继服务器地址；在连接检查过程中使用四步握手协议；在连接检查完毕后按照ICE规定的规则对地址进行排序，获得最佳的传输地址；对于传输过程中地址的选择，在虚拟网卡设计过程中每个虚拟网卡可以灵活地定义排序规则和演化规则，以获得最优的传输效果；同时，有可能检测到多条有效的传输通路，虚拟网卡可以使用多个传输通道来执行用户层的一个传输， 可以获得比单个真实网卡传输更好的效果；</p>
    <p>[0084]	3)当前虚拟网卡给最终应用提供的是虚拟地址，最终应用只需要通过虚拟地址可以喝对方进行通讯；而在虚拟网卡中双方通过地址服务器交换地址、建立通讯的细节则被隐藏在虚拟网卡内部，不需要用户参与。</p>
    <p>[0085]	4)当前虚拟网卡具备简单的数据存储功能，存储的数据包括认证信息、虚拟网卡好友信息、和地址状态信息。认证功能可以防止虚拟网卡执行未授权的传输操作，提高虚拟网卡的安全性；好友信息可以为当前虚拟网卡软件的用户进行分级，为不同级别的好友提供的传输数据的质量不同；传输速率也不同；通过缓存地址状态信息可以为每个传输地址提供一个历史的优先级因子，为当前网卡选择最佳的传输地址提供参考。</p>
    <p>[0086]幻为了保持传输地址的可靠性，虚拟网卡会定时向对方传输地址发送保持状态消息，这个操作不需要用户参与；在连接检测和数据传输过程中当前虚拟网卡会不断地向地址服务器发送传输地址的状态信息，包括传输地址源和目标、传输速率，地址类型、连通性情况等信息，为连接到当前地址服务器的所有虚拟网卡选择最佳的通讯地址提供参考。</p>
    <p>[0087]	6)在某些网络中，比如无线网络，网络组成和网络结构是易变的，但是通过虚拟网卡通讯是使用相对固定的虚拟地址进行通讯的，对真实网络的检测是虚拟网卡内部的工作，虚拟网卡本身的状态相对稳定一些，可以保证上层网络的稳定性和健壮性，减少应用程序出错的概率。</p>
    <p>[0088]	7)提供地址优化算法模块，该模块做成可插拔的动态库组件，可以方便地升级和替换，方便用户对虚拟网卡软件进行持续的改进和优化。</p>
    <p>[0089]	针对技术方案，是否还有别的替代方案同样能完成发明目的？</p>
    <p>[0090]	本方案是针对使用VPN技术进行私网通讯的改进方案，采用ICE和地址交换服务器进行虚拟地址的交换，通讯的细节交给虚拟网卡处理。从本专利的用途来说，尚无别的替代方案。</p>
    <p>附图说明</p>
    <p>[0091]	图1为虚拟网卡内部结构图。</p>
    <p>[0092]	图2虚拟网卡通讯装置结构图。</p>
    <p>[0093]	图3为虚拟网卡和地址服务器的消息交互图。</p>
    <p>[0094]	图4为虚拟网卡实现数据通讯的基本流程图。</p>
    <p>具体实施方式</p>
    <p>[0095]	参照图2，说明本专利实现两个不同局域网的终端通讯的实例。客户端1和客户端 2分别位于两个不同的局域网中，其中客户端1位于NATl后的局域网1中，在局域网1中的网络地址为192. 168. 0. 100，NAT1为客户端1所在的网关，它的局域网地址是192. 168. 0. 1， 公网地址是133. 155. 23. 26 ；客户端2位于NAT2后的局域网2中，在局域网2中的地址为 172. 16. 13. 11，NAT2为客户端2所在的网关，它的局域网地址是172. 16. 0. 1，公网地址是129. 33. 88. 6。两个NAT都非对称式的NAT，可以使用STUN协议来进行地址检测。在公网上部署了两台STUN服务器，用于发现每个客户端NAT出口的映射地址，两台STUN服务器的地址分别是129. 1. 23. 29和129. 1. 23. 30 ；还有一个地址交换服务器，用于在虚拟网卡通讯过程中交换地址信息，地址交换服务器的地址是12. 12. 1. 100。下面就这个网络拓扑来说明两个客户机是如何通过虚拟网卡来实现通讯过程的。</p>
    <p>[0096]	首先，两个客户端上的虚拟网卡需要收集本方可以用于通讯的地址。在当前例子中，两个NAT都非对称式的NAT，所以不需要中继地址，只需要前两类地址，比如客户端1收集的地址包括两个地址：</p>
    <p>[0097]	192. 168. 0. 100 ：80为客户端1上的真实网卡的通讯地址；</p>
    <p>[0098]	133. 155. 23. 26 :1234为客户端1通过STUN服务器查到的通讯地址；</p>
    <p>[0099]	客户端2也是同样：</p>
    <p>[0100]	172. 168. 13. 11为客户端2上的真实网卡的通讯地址；</p>
    <p>[0101]	129. 33. 88. 6为客户端2上通过STUN服务器查到的通讯地址。</p>
    <p>[0102]	然后双方需要向地址服务器注册虚拟地址和真实传输地址的映射关系，在注册完毕之后可以通过地址服务器查询映射关系。经过这一步，客户端1注册的虚拟地址为 10. 10. 0. 101，客户端2注册的虚拟地址为10. 10. 0. 102.</p>
    <p>[0103]	在两个虚拟网卡得到了双方的真实传输地址后，就开始对这些地址发送TCP/IP 数据包，执行连接检测过程。经过反复检测，发现客户端1可以和客户端2正常通讯的传输地址对为：</p>
    <p>[0104]	(192. 168. 0. 1 :80，129. 33. 88. 6 :4321)</p>
    <p>[0105]	客户端2可以和客户端1正常通讯的传输地址对为：</p>
    <p>[0106]	(172. 16. 13. 11 :5566,133. 155. 23. 26 :1234)。</p>
    <p>[0107]	这个信息会被保存到虚拟网卡内部的虚拟地址映射表中，供数据传输时使用。</p>
    <p>[0108]	对于建立在双方虚拟网卡上的TCP/IP应用来说，它们使用虚拟地址来进行通讯， 虚拟地址是可以被虚拟网卡识别的，通过查询虚拟地址映射表，虚拟网卡内部使用真实的传输地址进行通讯。</p>
    <p>[0109]	在数据传输完毕，两方可以根据需要可以从地址交换服务器上注销自己，双方的虚拟网卡就会显示为断开状态，也可以根据需要自动重新连接。</p>
  </div>
  </div></div><div class="patent-section patent-tabular-section"><a id="backward-citations"></a><div class="patent-section-header"><span class="patent-section-title">专利引用</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th">引用的专利</th><th class="patent-data-table-th"> 申请日期</th><th class="patent-data-table-th">公开日</th><th class="patent-data-table-th"> 申请人</th><th class="patent-data-table-th">专利名</th></tr></thead><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN101159657A?cl=zh">CN101159657A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2007年10月16日</td><td class="patent-data-table-td patent-date-value">2008年4月9日</td><td class="patent-data-table-td ">华为技术有限公司</td><td class="patent-data-table-td ">一种实现私网穿越的方法、设备及服务器</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN101699801A?cl=zh">CN101699801A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2009年10月30日</td><td class="patent-data-table-td patent-date-value">2010年4月28日</td><td class="patent-data-table-td ">孙喜明;张仑</td><td class="patent-data-table-td ">一种数据传输方法及传输数据的虚拟对等网络系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN101854313A?cl=zh">CN101854313A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2009年9月27日</td><td class="patent-data-table-td patent-date-value">2010年10月6日</td><td class="patent-data-table-td ">济南维优科技开发有限公司</td><td class="patent-data-table-td ">一种基于p2p-vpn技术穿越nat的远程访问网关</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/US20080183853">US20080183853</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2007年6月28日</td><td class="patent-data-table-td patent-date-value">2008年7月31日</td><td class="patent-data-table-td ">Microsoft Corporation</td><td class="patent-data-table-td ">Private virtual lan spanning a public network for connection of arbitrary hosts</td></tr></table><div class="patent-section-footer">* 由审查员引用</div></div><div class="patent-section patent-tabular-section"><a id="npl-citations"></a><div class="patent-section-header"><span class="patent-section-title">非专利引用</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th colspan="3"class="patent-data-table-th">参考文献</th></tr></thead><tr><td class="patent-data-table-td ">1</td><td class="patent-data-table-td "><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td ">李超: "<a href='http://scholar.google.com/scholar?q="Xen+VMX%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1%E7%9A%84%E7%A0%94%E7%A9%B6%E5%92%8C%E6%A8%A1%E5%9E%8B%E6%94%B9%E8%BF%9B"'>Xen VMX虚拟网卡的研究和模型改进</a>", 《中国优秀硕士学位论文全文数据库》, 15 July 2008 (2008-07-15)</td></tr></table><div class="patent-section-footer">* 由审查员引用</div></div><div class="patent-section patent-tabular-section"><a id="forward-citations"></a><div class="patent-section-header"><span class="patent-section-title"> 被以下专利引用</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th">引用专利</th><th class="patent-data-table-th"> 申请日期</th><th class="patent-data-table-th">公开日</th><th class="patent-data-table-th"> 申请人</th><th class="patent-data-table-th">专利名</th></tr></thead><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102420642A?cl=zh">CN102420642A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年12月15日</td><td class="patent-data-table-td patent-date-value">2012年4月18日</td><td class="patent-data-table-td ">北京握奇数据系统有限公司</td><td class="patent-data-table-td ">蓝牙设备及其通信方法</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102420642B?cl=zh">CN102420642B</a></td><td class="patent-data-table-td patent-date-value">2011年12月15日</td><td class="patent-data-table-td patent-date-value">2014年4月23日</td><td class="patent-data-table-td ">北京握奇数据系统有限公司</td><td class="patent-data-table-td ">蓝牙设备及其通信方法</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102891848A?cl=zh">CN102891848A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2012年9月25日</td><td class="patent-data-table-td patent-date-value">2013年1月23日</td><td class="patent-data-table-td ">汉柏科技有限公司</td><td class="patent-data-table-td ">利用IPSec安全联盟进行加密解密的方法</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102891848B?cl=zh">CN102891848B</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2012年9月25日</td><td class="patent-data-table-td patent-date-value">2015年12月2日</td><td class="patent-data-table-td ">汉柏科技有限公司</td><td class="patent-data-table-td ">利用IPSec安全联盟进行加密解密的方法</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN103501282A?cl=zh">CN103501282A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2013年10月9日</td><td class="patent-data-table-td patent-date-value">2014年1月8日</td><td class="patent-data-table-td ">中国联合网络通信集团有限公司</td><td class="patent-data-table-td ">网络报文发送控制方法、虚拟交换机和物理机</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/WO2015010640A1?cl=zh">WO2015010640A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2014年7月24日</td><td class="patent-data-table-td patent-date-value">2015年1月29日</td><td class="patent-data-table-td ">Huawei Technologies Co., Ltd.</td><td class="patent-data-table-td ">控制管理设备的方法和相关设备</td></tr></table><div class="patent-section-footer">* 由审查员引用</div></div><div class="patent-section patent-tabular-section"><a id="classifications"></a><div class="patent-section-header"><span class="patent-section-title">分类</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th"> </th><th class="patent-data-table-th"> </th></tr></thead><tr><td class="patent-data-table-td ">国际分类号</td><td class="patent-data-table-td "><span class="nested-value"><a href="https://www.google.com/url?id=8b2bBwABERAJ&amp;q=http://web2.wipo.int/ipcpub/&amp;usg=AFQjCNER44F5jlVoswCkvW3YEcB5lW4moA#refresh=page&amp;notion=scheme&amp;version=20130101&amp;symbol=H04L0012460000">H04L12/46</a></span></td></tr></table><div class="patent-section-footer"></div></div><div class="patent-section patent-tabular-section"><a id="legal-events"></a><div class="patent-section-header"><span class="patent-section-title">法律事件</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th"> 日期</th><th class="patent-data-table-th">代码</th><th class="patent-data-table-th">事件</th><th class="patent-data-table-th">说明</th></tr></thead><tr><td class="patent-data-table-td patent-date-value">2011年12月14日</td><td class="patent-data-table-td ">C06</td><td class="patent-data-table-td ">Publication</td><td class="patent-data-table-td "></td></tr><tr><td class="patent-data-table-td patent-date-value">2012年2月1日</td><td class="patent-data-table-td ">C10</td><td class="patent-data-table-td ">Entry into substantive examination</td><td class="patent-data-table-td "></td></tr><tr><td class="patent-data-table-td patent-date-value">2014年2月19日</td><td class="patent-data-table-td ">C02</td><td class="patent-data-table-td ">Deemed withdrawal of patent application after publication (patent law 2001)</td><td class="patent-data-table-td "></td></tr></table><div class="patent-section-footer"></div></div><div class="modal-dialog" id="patent-images-lightbox"><div class="patent-lightbox-controls"><div class="patent-lightbox-rotate-controls"><div class="patent-lightbox-rotation-text">旋转</div><div class="rotate-icon rotate-ccw-icon"></div><div class="rotate-icon rotate-cw-icon"></div></div><div class="patent-lightbox-index-counter"></div><a class="patent-lightbox-fullsize-link" target="_blank">原始图片</a><div class="patent-drawings-control patent-drawings-next"><img class="patent-drawings-button-img"src="/googlebooks/images/kennedy/page_right.png" alt="Next page"width="21" height="21" /></div><div class="patent-drawings-control patent-drawings-prev"><img class="patent-drawings-button-img"src="/googlebooks/images/kennedy/page_left.png" alt="Previous page"width="21" height="21" /></div></div><div class="modal-dialog-content"><div class="patent-lightbox-image-holder"><div class="patent-lightbox-placeholder"></div></div></div></div><script>_OC_initPatentsAtb({image_not_available_html: " 未提供图片。\x3ca href\x3d//docs.google.com/viewer?url\x3dpatentimages.storage.googleapis.com/pdfs/bbe6030b59411272a3fd/CN102281180A.pdf\x3e查看 PDF\x3c/a\x3e"});</script></div></div></div></div></div><script>(function() {var href = window.location.href;if (href.indexOf('?') !== -1) {var parameters = href.split('?')[1].split('&');for (var i = 0; i < parameters.length; i++) {var param = parameters[i].split('=');if (param[0] == 'focus') {var elem = document.getElementById(param[1]);if (elem) {elem.focus();}}}}})();</script><script>_OC_addFlags({LockSrc:"/books/javascript/lock_6e802a6b2b28d51711baddc2f3bec198.js", Host:"https://www.google.com/", IsBooksRentalEnabled:1, IsBrowsingHistoryEnabled:1, IsWebReaderSvgEnabled:0, IsImageModeNotesEnabled:1, IsOfflineBubbleEnabled:1, IsFutureOnSaleVolumesEnabled:1, IsBooksUnifiedLeftNavEnabled:1, IsMobileRequest:0, IsZipitFolderCollectionEnabled:1, IsAdsDisabled:0, IsEmbeddedMediaEnabled:1, IsImageModeAnnotationsEnabled:1, IsMyLibraryGooglePlusEnabled:1, IsImagePageProviderEnabled:1, IsBookcardListPriceSmall:0, IsInternalUser:0, IsBooksShareButtonEnabled:0, IsDisabledRandomBookshelves:0});_OC_Run({"enable_p13n":false,"is_cobrand":false,"sign_in_url":"https://www.google.com/accounts/Login?service=\u0026continue=https://www.google.com/patents%3Fcl%3Dzh%26hl%3Dzh-CN\u0026hl=zh-CN"}, {"volume_id":"","is_ebook":true,"volumeresult":{"has_flowing_text":false,"has_scanned_text":true,"can_download_pdf":false,"can_download_epub":false,"is_pdf_drm_enabled":false,"is_epub_drm_enabled":false,"download_pdf_url":"https://www.google.com/patents/download/%E5%BA%94%E7%94%A8%E4%BA%8E%E4%B8%8D%E5%90%8C%E5%B1%80%E5%9F%9F%E7%BD%91%E7%9A%84%E7%BB%88%E7%AB%AF%E7%9B%B8%E4%BA%92.pdf?id=8b2bBwABERAJ\u0026hl=zh-CN\u0026output=pdf\u0026sig=ACfU3U3VHsQF8im-wUaBLGLXDCzZxqNPvg"},"sample_url":"https://www.google.com/patents/reader?id=8b2bBwABERAJ\u0026hl=zh-CN\u0026printsec=frontcover\u0026output=reader\u0026source=gbs_atb_hover","is_browsable":true,"is_public_domain":true}, {});</script><div id="footer_table" style="font-size:83%;text-align:center;position:relative;top:20px;height:4.5em;margin-top:2em"><div style="margin-bottom:8px"><a href="https://www.google.com/search?hl=zh-CN"><nobr>Google&nbsp;首页</nobr></a> - <a href="//www.google.com/patents/sitemap/"><nobr>站点地图</nobr></a> - <a href="http://www.google.com/googlebooks/uspto.html"><nobr>美国专利商标局 (USPTO) 专利信息批量下载</nobr></a> - <a href="/intl/zh-CN/privacy/"><nobr>隐私权政策</nobr></a> - <a href="/intl/zh-CN/policies/terms/"><nobr>服务条款</nobr></a> - <a href="https://support.google.com/faqs/answer/2539193?hl=zh-CN"><nobr> 关于 Google 专利</nobr></a> - <a href="//www.google.com/tools/feedback/intl/zh-CN/error.html" onclick="try{_OC_startFeedback({productId: '72792',locale: 'zh-CN'});return false;}catch(e){}"><nobr>发送反馈</nobr></a></div></div> <script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">var pageTracker = _gat._getTracker("UA-27188110-1");pageTracker._setCookiePath("/patents/");pageTracker._trackPageview();</script> </body></html>