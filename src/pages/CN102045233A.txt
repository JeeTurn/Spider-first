<!DOCTYPE html><html><head><title>专利 CN102045233A - 一种网络通信中控制报文转发的方法和设备 -  Google 专利</title><script>(function(){(function(){function e(a){this.t={};this.tick=function(a,c,b){var d=void 0!=b?b:(new Date).getTime();this.t[a]=[d,c];if(void 0==b)try{window.console.timeStamp("CSI/"+a)}catch(e){}};this.tick("start",null,a)}var a;window.performance&&(a=window.performance.timing);var f=a?new e(a.responseStart):new e;window.jstiming={Timer:e,load:f};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick("_wtsrt",void 0,c),b.tick("wtsrt_",
"_wtsrt",d),b.tick("tbsd_","wtsrt_"))}try{a=null,window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick("_tbnd",void 0,window.chrome.csi().startE),b.tick("tbnd_","_tbnd",c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick("_tbnd",void 0,window.external.startE),b.tick("tbnd_","_tbnd",c))),a&&(window.jstiming.pt=a)}catch(g){}})();})();
</script><link rel="stylesheet" href="/patents/css/_6e802a6b2b28d51711baddc2f3bec198/kl_intl_patents_bundle.css" type="text/css" /><script src="/books/javascript/atb_6e802a6b2b28d51711baddc2f3bec198__zh_cn.js"></script><script>function googleTranslateElementInit() {new google.translate.TranslateElement({pageLanguage: "zh",gaTrack: true,gaId: "UA-27188110-1",multilanguagePage: true});}</script><script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script><meta name="DC.type" content="Patent"><meta name="DC.title" content="一种网络通信中控制报文转发的方法和设备"><meta name="DC.contributor" content="刘平" scheme="inventor"><meta name="DC.contributor" content="孙鲁东" scheme="inventor"><meta name="DC.contributor" content="王佩龙" scheme="inventor"><meta name="DC.contributor" content="杭州华三通信技术有限公司" scheme="assignee"><meta name="DC.date" content="2009-10-22" scheme="dateSubmitted"><meta name="DC.description" content="本发明公开了一种网络通信中控制报文转发的方法和设备，其中，预先在中心设备上配置至少1个中心隧道接口；该方法包括：A，中心设备接收到中心内网的报文时，确定该报文携带的目的地址；B，中心设备在已建立的分支内网地址、分支隧道源地址和分支隧道接口优先级三者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以上分支隧道源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确定当前需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过已配置的中心隧道接口转发加封装后的报文。采用本发明，解决现有技术中心设备上配置与分支内网的个数相等的中心隧道接口所带来的缺陷。"><meta name="DC.date" content="2011-5-4"><meta name="citation_patent_publication_number" content="CN:102045233:A"><meta name="citation_patent_application_number" content="CN:200910236455"><link rel="canonical" href="https://www.google.com/patents/CN102045233A?cl=zh"/><meta property="og:url" content="https://www.google.com/patents/CN102045233A?cl=zh"/><meta name="title" content="专利 CN102045233A - 一种网络通信中控制报文转发的方法和设备"/><meta name="description" content="本发明公开了一种网络通信中控制报文转发的方法和设备，其中，预先在中心设备上配置至少1个中心隧道接口；该方法包括：A，中心设备接收到中心内网的报文时，确定该报文携带的目的地址；B，中心设备在已建立的分支内网地址、分支隧道源地址和分支隧道接口优先级三者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以上分支隧道源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确定当前需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过已配置的中心隧道接口转发加封装后的报文。采用本发明，解决现有技术中心设备上配置与分支内网的个数相等的中心隧道接口所带来的缺陷。"/><meta property="og:title" content="专利 CN102045233A - 一种网络通信中控制报文转发的方法和设备"/><meta property="og:type" content="book"/><meta property="og:site_name" content="Google Books"/><meta property="og:image" content="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"/><link rel="image_src" href="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"/><script>if (window['_OC_timingAction']) {window['_OC_timingAction']('patents_refpage');}</script><style>#gbar,#guser{font-size:13px;padding-top:1px !important;}#gbar{height:22px}#guser{padding-bottom:7px !important;text-align:right}.gbh,.gbd{border-top:1px solid #c9d7f1;font-size:1px}.gbh{height:0;position:absolute;top:24px;width:100%}@media all{.gb1{height:22px;margin-right:.5em;vertical-align:top}#gbar{float:left}}a.gb1,a.gb4{text-decoration:underline !important}a.gb1,a.gb4{color:#00c !important}.gbi .gb4{color:#dd8e27 !important}.gbf .gb4{color:#900 !important}

#gbar { padding:.3em .6em !important;}</style></head><body ><div id=gbar><nobr><a class=gb1 href="https://www.google.com/search?cl=zh&hl=zh-CN&sa=N&tab=tw">搜索</a> <a class=gb1 href="https://www.google.com/search?cl=zh&hl=zh-CN&tbm=isch&source=og&sa=N&tab=ti">图片</a> <a class=gb1 href="https://maps.google.com/maps?cl=zh&hl=zh-CN&sa=N&tab=tl">地图</a> <a class=gb1 href="https://play.google.com/?cl=zh&hl=zh-CN&sa=N&tab=t8">Play</a> <a class=gb1 href="https://www.youtube.com/results?cl=zh&hl=zh-CN&sa=N&tab=t1">YouTube</a> <a class=gb1 href="https://news.google.com/nwshp?hl=zh-CN&tab=tn">新闻</a> <a class=gb1 href="https://mail.google.com/mail/?tab=tm">Gmail</a> <a class=gb1 href="https://drive.google.com/?tab=to">云端硬盘</a> <a class=gb1 style="text-decoration:none" href="https://www.google.com/intl/zh-CN/options/"><u>更多</u> &raquo;</a></nobr></div><div id=guser width=100%><nobr><span id=gbn class=gbi></span><span id=gbf class=gbf></span><span id=gbe></span><a target=_top id=gb_70 href="https://www.google.com/accounts/Login?service=&continue=https://www.google.com/patents%3Fcl%3Dzh%26hl%3Dzh-CN&hl=zh-CN" class=gb4>登录</a></nobr></div><div class=gbh style=left:0></div><div class=gbh style=right:0></div><div role="alert" style="position: absolute; left: 0; right: 0;"><a href="https://www.google.com/patents/CN102045233A?cl=zh&amp;hl=zh-CN&amp;output=html_text" title="屏幕阅读器用户请注意：点击此链接可进入无障碍模式。阅读器在无障碍模式下具有同样的基本功能，但可让用户获得更好的体验。"><img border="0" src="//www.google.com/images/cleardot.gif"alt="屏幕阅读器用户请注意：点击此链接可进入无障碍模式。阅读器在无障碍模式下具有同样的基本功能，但可让用户获得更好的体验。"></a></div><div class="kd-appbar"><h2 class="kd-appname"><a href="/patents?hl=zh-CN"> 专利</a></h2><div class="kd-buttonbar left" id="left-toolbar-buttons"><a id="appbar-write-review-link" href=""></a><a id="appbar-view-print-sample-link" href=""></a><a id="appbar-view-ebook-sample-link" href=""></a><a id="appbar-patents-prior-art-finder-link" href="https://www.google.com/patents/related/CN102045233A"></a><a id="appbar-patents-discuss-this-link" href="https://www.google.com/url?id=9pqTBwABERAJ&amp;q=http://patents.stackexchange.com/redirect/google-patents%3Fpublication%3DCN102045233A&amp;usg=AFQjCNF7y9yEvQHh22R-GzfS8z7pvZVslg" data-is-grant="false"></a><a id="appbar-read-patent-link" href="//docs.google.com/viewer?url=patentimages.storage.googleapis.com/pdfs/4734634b9016e8995a8e/CN102045233A.pdf"></a><a id="appbar-download-pdf-link" href="//patentimages.storage.googleapis.com/pdfs/4734634b9016e8995a8e/CN102045233A.pdf"></a><a class="appbar-content-language-link" data-selected="true" data-label="中文" href="/patents/CN102045233A?cl=zh&amp;hl=zh-CN"></a><a class="appbar-content-language-link" data-label="英语" href="/patents/CN102045233A?cl=en&amp;hl=zh-CN"></a><a class="appbar-application-grant-link" data-selected="true" data-label="申请" href="/patents/CN102045233A?hl=zh-CN&amp;cl=zh"></a><a class="appbar-application-grant-link" data-label="授权" href="/patents/CN102045233B?hl=zh-CN&amp;cl=zh"></a></div><div class="kd-buttonbar right" id="right-toolbar-buttons"></div></div><div id="books-microdata" itemscope=""itemtype="http://schema.org/Book"itemid="https://www.google.com/patents/CN102045233A?cl=zh" style="display:none"><span itemprop="description">本发明公开了一种网络通信中控制报文转发的方法和设备，其中，预先在中心设备上配置至少1个中心隧道接口；该方法包括：A，中心设备接收到中心内网的报文时，确定该报文携带的目的地址；B，中心设备在已建立的分支内网...</span><span itemprop="url">https://www.google.com/patents/CN102045233A?cl=zh&amp;utm_source=gb-gplus-share</span><span class="main-title" itemprop="name">专利 CN102045233A - 一种网络通信中控制报文转发的方法和设备</span><img itemprop="image" src="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"alt="专利 CN102045233A - 一种网络通信中控制报文转发的方法和设备" title="专利 CN102045233A - 一种网络通信中控制报文转发的方法和设备"></div><div style="display: none"><ol id="ofe-gear-menu-contents" class="gbmcc"><li class="gbe gbmtc"><a class="gbmt goog-menuitem-content" id="" href="https://www.google.com/advanced_patent_search?hl=zh-CN"> 高级专利搜索</a></li></ol></div><div id="volume-main"><div id="volume-center"><div class=vertical_module_list_row><div id=intl_patents class=about_content><div id=intl_patents_v><table class="patent-bibdata patent-drawings-missing"><tr><td class="patent-bibdata-heading"> 公开号</td><td class="single-patent-bibdata">CN102045233 A</td></tr><tr><td class="patent-bibdata-heading">发布类型</td><td class="single-patent-bibdata">申请</td></tr><tr><td class="patent-bibdata-heading"> 专利申请号</td><td class="single-patent-bibdata">CN 200910236455</td></tr><tr><td class="patent-bibdata-heading">公开日</td><td class="single-patent-bibdata">2011年5月4日</td></tr><tr><td class="patent-bibdata-heading"> 申请日期</td><td class="single-patent-bibdata">2009年10月22日</td></tr><tr><td class="patent-bibdata-heading"> 优先权日<span class="patent-tooltip-anchor patent-question-icon"data-tooltip-text="优先日期属于假设性质，不具任何法律效力。Google 对于所列日期的正确性并没有进行法律分析，也不作任何陈述。"></span></td><td class="single-patent-bibdata">2009年10月22日</td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading">公告号</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="/patents/CN102045233B?hl=zh-CN&amp;cl=zh">CN102045233B</a></span></span></td></tr><tr class="patent-bibdata-list-row alternate-patent-number"><td class="patent-bibdata-heading"> 公开号</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value">200910236455.2, </span><span class="patent-bibdata-value">CN 102045233 A, </span><span class="patent-bibdata-value">CN 102045233A, </span><span class="patent-bibdata-value">CN 200910236455, </span><span class="patent-bibdata-value">CN-A-102045233, </span><span class="patent-bibdata-value">CN102045233 A, </span><span class="patent-bibdata-value">CN102045233A, </span><span class="patent-bibdata-value">CN200910236455, </span><span class="patent-bibdata-value">CN200910236455.2</span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading"> 发明者</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=ininventor:%22%E5%88%98%E5%B9%B3%22">刘平</a>, </span><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=ininventor:%22%E5%AD%99%E9%B2%81%E4%B8%9C%22">孙鲁东</a>, </span><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=ininventor:%22%E7%8E%8B%E4%BD%A9%E9%BE%99%22">王佩龙</a></span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading"> 申请人</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=inassignee:%22%E6%9D%AD%E5%B7%9E%E5%8D%8E%E4%B8%89%E9%80%9A%E4%BF%A1%E6%8A%80%E6%9C%AF%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8%22">杭州华三通信技术有限公司</a></span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading">导出引文</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="/patents/CN102045233A.bibtex?cl=zh">BiBTeX</a>, </span><span class="patent-bibdata-value"><a href="/patents/CN102045233A.enw?cl=zh">EndNote</a>, </span><span class="patent-bibdata-value"><a href="/patents/CN102045233A.ris?cl=zh">RefMan</a></span></span></td></tr><tr class="patent-internal-links"><td colspan=2><span class="patent-bibdata-value"><a href="#forward-citations"> 被以下专利引用</a> (5),</span> <span class="patent-bibdata-value"><a href="#classifications">分类</a> (2),</span> <span class="patent-bibdata-value"><a href="#legal-events">法律事件</a> (3)</span> </td></tr><tr><td colspan=2 class="patent-bibdata-external-link-spacer-top"></td></tr><tr class="patent-bibdata-external-link-spacer-bottom"></tr><tr><td colspan=2><span class="patent-bibdata-heading">外部链接:&nbsp;</span><span><span class="patent-bibdata-value"><a href="https://www.google.com/url?id=9pqTBwABERAJ&amp;q=http://211.157.104.87:8080/sipo/zljs/hyjs-yx-new.jsp%3Frecid%3D200910236455&amp;usg=AFQjCNFPUyq0xm4BlDpWmAFYxEf4JDNGig"> 中国国家知识产权局</a>, </span><span class="patent-bibdata-value"><a href="https://www.google.com/url?id=9pqTBwABERAJ&amp;q=http://worldwide.espacenet.com/publicationDetails/biblio%3FCC%3DCN%26NR%3D102045233A%26KC%3DA%26FT%3DD&amp;usg=AFQjCNEKEM8WHTlyJX6LXZiZNAa3BYjqEg"> 欧洲专利数据库 (Espacenet)</a></span></span></td></tr><tr class="patent-bibdata-group-spacer"></tr></table><div class="number-and-title"><span class="patent-title"><invention-title mxw-id="PT102835039" lang="ZH" load-source="patent-office">一种网络通信中控制报文转发的方法和设备</invention-title>
    </span><br><span class="patent-number">CN 102045233 A</span></div><div class="patent-section patent-abstract-section"><div class="patent-section-header"><span class="patent-section-title"> 摘要</span></div><div class="patent-text"><abstract mxw-id="PA84752159" lang="ZH" load-source="patent-office">
    <div class="abstract">本发明公开了一种网络通信中控制报文转发的方法和设备，其中，预先在中心设备上配置至少1个中心隧道接口；该方法包括：A，中心设备接收到中心内网的报文时，确定该报文携带的目的地址；B，中心设备在已建立的分支内网地址、分支隧道源地址和分支隧道接口优先级三者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以上分支隧道源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确定当前需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过已配置的中心隧道接口转发加封装后的报文。采用本发明，解决现有技术中心设备上配置与分支内网的个数相等的中心隧道接口所带来的缺陷。</div>
  </abstract>
  </div></div><div class="patent-section patent-claims-section"><div class="patent-section-header"><span class="patent-section-title">权利要求<span class="patent-section-count">(13)</span></span></div><div class="patent-text"><div mxw-id="PCLM35777531" lang="ZH" load-source="patent-office" class="claims">
    <div class="claim"> <div num="1" class="claim">
      <div class="claim-text">1.	一种网络通信中控制报文转发的方法，所述网络包含连接中心内网的中心设备和连 接分支内网的分支设备，每一分支设备上配置分支隧道接口，所述分支隧道接口包含分支 隧道源地址；其特征在于，预先在中心设备上配置至少1个中心隧道接口 ；该方法包括以下 步骤：A，中心设备接收到来自中心内网的报文时，确定该报文携带的目的地址，所述目的地 址为所述报文要到达分支内网中的主机对应的分支内网地址；B，中心设备在已建立的分支内网地址、分支隧道源地址和分支隧道接口优先级三者之 间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以上分支隧道 源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确定当前需要 使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过已配置的中 心隧道接口转发加封装后的报文。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="2" class="claim">
      <div class="claim-text">2.根据权利要求1所述的方法，其特征在于，所述步骤B中，在查找目的地址对应的分 支隧道源地址之前，进一步包括：B0，根据分支设备通过已配置的分支隧道接口发送的报文建立对应关系，所述通过分 支隧道接口发送的报文携带了分支内网地址、预先为该分支隧道接口配置的优先级、以及 该分支隧道接口包含的分支隧道源地址。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="3" class="claim">
      <div class="claim-text">3.根据权利要求2所述的方法，其特征在于，所述分支隧道接口还包含到达中心设备 的分支隧道目的地址；所述步骤BO包括：Bi，分支设备接收到其所处的分支内网中的主机要发送给中心内网的报文时，所述报 文携带了该主机对应的分支内网地址；将预先为自身上的分支隧道接口配置的优先级、该 分支隧道接口包含的分支隧道源地址和分支隧道目的地址添加在该报文的外部，之后经由 该分支隧道接口发送添加后的报文给公网；B2,公网根据接收的报文携带的分支隧道目的地址转发报文；B3，中心设备通过中心隧道接口接收到报文时，提取出该报文携带的分支内网地址、分 支隧道源地址和分支隧道接口优先级，并记录提取出的分支内网地址、分支隧道源地址和 分支隧道接口的优先级之间的对应关系。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="4" class="claim">
      <div class="claim-text">4.根据权利要求3所述的方法，其特征在于，所述分支内网地址、分支隧道源地址和分 支隧道接口优先级的对应关系中还包括中心设备接收到携带该分支内网地址、分支隧道源 地址和分支隧道接口优先级的报文的时间；所述步骤B3中的记录包括：判断当前是否存在提取出的分支内网地址、分支隧道源地址和分支隧道接口优先级的 对应关系，如果否，则执行所述记录；否则，更新该存在的对应关系中的时间为当前接收到 所述报文的时间，丢弃该提取出的分支内网地址、分支隧道源地址和分支隧道接口的优先级。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="5" class="claim">
      <div class="claim-text">5.根据权利要求4所述的方法，其特征在于，所述步骤B3中，中心设备针对每一存在 的对应关系，根据该对应关系携带的时间以及预设的老化时间判断是否需要更新该对应关 系，如果是，删除该对应关系。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="6" class="claim">
      <div class="claim-text">6.根据权利要求1所述的方法，其特征在于，所述步骤B中，如果查找到1个分支隧道 源地址，则将查找到的分支隧道源地址确定为当前需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，如果配置的中心隧道接口的个数为1，则通过该配置 的中心隧道接口转发加封装后的报文；如果配置的中心隧道接口的个数大于1，则在预先 配置的分支内网地址和中心隧道接口对应关系中查找作为目的地址的分支内网地址所对 应的中心隧道接口 ；通过查找到的中心隧道接口转发加封装后的报文。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="7" class="claim">
      <div class="claim-text">7.根据权利要求1或6所述的方法，其特征在于，所述中心隧道接口包括中心隧道源地 址，所述根据确定的分支隧道源地址对报文进行加封装包括：将确定的分支隧道源地址确 定为中心隧道目的地址，将所述中心隧道源地址和确定的中心隧道目的地址添加到报文的 外部；如果一分支设备通过与所述中心隧道目的地址对应的分支隧道接口接收到报文时，则 进一步包括：去除该报文携带的中心隧道源地址和中心隧道目的地址，转发已去除中心隧 道源地址和中心隧道目的地址的报文给该报文携带的目的地址对应的主机。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="8" class="claim">
      <div class="claim-text">8.根据权利要求1所述的方法，其特征在于，所述中心设备上配置的中心隧道接口，以 及分支设备上配置的分支隧道接口遵守通用路由封装GRE协议；所述分支隧道接口的优先级通过预先配置的GRE密钥Key的取值表示；所述步骤Bl中，将为分支隧道接口配置的优先级添加在报文的外部包括：将预先配置的GRE Key的取值填入到GRE头中的Key字段；之后，将GRE头添加在报文 的外部。</div>
    </div>
    </div> <div class="claim"> <div num="9" class="claim">
      <div class="claim-text">9.	一种网络通信中控制报文转发的设备，其特征在于，该设备包括：中心隧道接口、接 收单元和转发单元；其中，所述中心隧道接口的个数至少为1 ；所述接收单元接收到来自中心内网的报文时，确定该报文携带的目的地址，所述目的 地址为所述报文要到达分支内网中的主机对应的分支内网地址；所述转发单元用于在已建立的分支内网地址、分支隧道源地址和分支隧道接口优先级 三者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以上分 支隧道源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确定当 前需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过对应 的中心隧道接口转发加封装后的报文。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="10" class="claim">
      <div class="claim-text">10.根据权利要求9所述的设备，其特征在于，所述转发单元包括：建立子单元、查找子 单元和转发子单元；其中，所述建立子单元，用于根据分支设备通过已配置的分支隧道接口发送的报文建立分支 内网地址、分支隧道源地址和分支隧道接口优先级的对应关系，所述通过分支隧道接口发 送的报文携带了分支内网地址、预先为该分支隧道接口配置的优先级、以及该分支隧道接 口包含的分支隧道源地址；所述查找子单元，用于在所述建立子单元已建立的对应关系中查找所述目的地址对应 的分支隧道源地址；如果查找到两个以上分支隧道源地址，则根据所述对应关系中分支隧 道源地址对应的分支隧道接口优先级确定当前需要使用的分支隧道源地址；如果查找到 1个分支隧道源地址时，将查找到的分支隧道源地址确定为当前需要使用的分支隧道源地 址；所述转发子单元，用于根据所述查找子单元确定的分支隧道源地址对报文进行加封 装，如果配置的中心隧道接口的个数为1，则通过该配置的中心隧道接口转发加封装后的报文；如果配置的中心隧道接口的个数大于1，则在预先配置的分支内网地址和中心隧道接 口对应关系中查找作为目的地址的分支内网地址所对应的中心隧道接口 ；通过查找到的中 心隧道接口转发加封装后的报文。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="11" class="claim">
      <div class="claim-text">11.根据权利要求10所述的设备，其特征在于，所述建立子单元包括：接收模块，用于通过中心隧道接口接收来自分支设备经由分支隧道接口发送的报文， 所述经由分支隧道接口发送的报文携带了分支内网地址、预先为该分支隧道接口配置的优 先级和该分支隧道接口包含的分支隧道源地址；提取模块，用于提取出该报文所携带的分支内网地址、分支隧道源地址和分支隧道接 口的优先级；建立模块，用于记录提取出的分支内网地址、分支隧道源地址和分支隧道接口的优先 级三者之间的对应关系。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="12" class="claim">
      <div class="claim-text">12.根据权利要求11所述的设备，其特征在于，所述建立模块记录的分支内网地址、分 支隧道源地址和分支隧道接口优先级的对应关系中还包括所述接收模块接收到携带该分 支内网地址、分支隧道源地址和分支隧道接口优先级的报文的时间；所述建立模块还用于判断当前是否存在提取出的分支内网地址、分支隧道源地址和分 支隧道接口优先级的对应关系，如果否，则执行所述记录，否则，更新该存在的对应关系中 的时间为所述接收模块接收到所述报文的时间，并触发所述提取模块丢弃该提取出的分支 内网地址、分支隧道源地址和分支隧道接口的优先级。</div>
    </div>
    </div> <div class="claim-dependent"> <div num="13" class="claim">
      <div class="claim-text">13.根据权利要求10所述的设备，其特征在于，所述中心隧道接口和分支隧道接口遵 守通用路由封装GRE协议；所述分支隧道接口的优先级通过预先配置的GRE密钥Key的取值表示；所述接收模块接收的报文携带了 GRE头，所述GRE头中的Key字段携带预先配置的GRE Key的取值；所述提取模块从接收的报文所携带的GRE头中提取出Key字段中的值；所述建立模块在当前已建立的对应关系中不存在所述提取模块提取出的分支内网地 址、分支隧道源地址和Key值的对应关系时，记录提取出的分支内网地址、分支隧道源地址 和Key值三者之间的对应关系。</div>
    </div>
  </div> </div>
  </div></div><div class="patent-section patent-description-section"><div class="patent-section-header"><span class="patent-section-title"> 说明</span></div><div class="patent-text"><div mxw-id="PDES41559726" lang="ZH" load-source="patent-office" class="description">
    <p>一种网络通信中控制报文转发的方法和设备技术领域</p>
    <p>[0001]	本发明涉及网络通信技术，特别涉及一种网络通信中控制报文转发的方法和设备。背景技术</p>
    <p>[0002]	由于互联网具有传播及时、不受地点限制等诸多优点而在越来越多的企业得到 广泛应用，目前，越来越多的企业利用在作为公网的互联网上建立用以传输企业内部信息 的网络即虚拟私有网络（VPN:Virtual Private Network)，具体是通过在中心内网的节点 (简称为中心设备）和分支内网的节点（简称为分支设备）之间建立点对点模式的隧道构 建VPN实现的。</p>
    <p>[0003]	其中，隧道是一个虚拟的点对点连接，可以看成是仅支持点对点连接的虚拟接口， 为了实现企业中的各个分支都能访问中心，如图1所示，需要在各个分支中的各个分支设 备与中心设备之间单独建立隧道，即各个分支设备上配置各个分支隧道接口，以及中心设 备同时配置对应各个分支隧道接口的各个中心隧道接口。以图1所示的分支1为例，由于 分支1上存在两个分支设备，分别为分支设备A和分支设备B，如此，就需要分别在分支设备 A和分支设备B上建立到达中心设备的隧道，具体为：分支设备A和分支设备B上分别配置 到达中心设备的分支隧道接口，分别为分支隧道接口 A和分支隧道接口 B，中心设备上配置 对应分支隧道接口 A的中心隧道接口 A和对应分支隧道接口 B的中心隧道接口 B。</p>
    <p>[0004]	这里，每一分支隧道接口包括分支隧道源地址和分支隧道目的地址，其中，分支隧 道源地址为该分支设备上与公网正常通信的接口的地址，分支隧道目的地址为对应的中心 隧道接口的源地址；相应地，中心设备上配置的每一中心隧道接口包括中心隧道源地址和 中心隧道目的地址，其中，中心隧道源地址为中心设备上与公网正常通信的接口的地址，中 心隧道目的地址为对应的分支隧道接口的源地址。这样，当中心需要发送报文给分支时，中 心发送报文给中心设备，中心设备确定出接收的报文携带的目的地址，其中，目的地址为报 文要到达分支中主机的分支内网地址，根据目的地址确定对应的中心隧道接口，利用确定 的中心隧道接口包含的中心隧道源地址和中心隧道目的地址对该报文进行加封装，即将中 心隧道源地址和中心隧道目的地址添加在报文的外部，通过确定的中心隧道接口将报文转 发给公网，公网接收到报文后，根据该报文携带的中心隧道目的地址转发该报文给对应的 分支设备，分支设备从分支隧道接口接收到报文后，对该报文进行解封装，即去除报文携带 的中心隧道源地址和中心隧道目的地址，根据去除后的报文携带的目的地址转发该报文， 具体为：将报文转发给目的地址对应的主机。</p>
    <p>[0005]	综上可以看出，现有技术中，由于隧道是一个虚拟的点对点连接，如此，中心设备 上配置的中心隧道接口的个数就会随着分支的增加、以及分支中分支设备的增加而增加。 比如分支的个数为100，如果每个分支包含的分支设备的个数为2，则中心设备上配置的中 心隧道接口的个数就为2*100 = 200。随着企业的不断发展，分支中分支设备的个数随之比 较多，比如3000或者5000等，采用上述现有技术方案，中心设备就需要配置更多的中心隧道接口，过多的配置，给网络解决方案提供商、网络实施人员、以及网络维护人员带来不可 预想的麻烦，同时，也大大增加中心设备的压力。发明内容</p>
    <p>[0006]	本发明提供了一种网络通信中控制报文转发的方法和设备，以解决中心设备上配 置过多中心隧道接口所带来的诸多问题。</p>
    <p>[0007]	一种网络通信中控制报文转发的方法，所述网络包含连接中心内网的中心设备和 连接分支内网的分支设备，每一分支设备上配置分支隧道接口，所述分支隧道接口包含分 支隧道源地址；预先在中心设备上配置至少1个中心隧道接口 ；该方法包括以下步骤：</p>
    <p>[0008]	A，中心设备接收到来自中心内网的报文时，确定该报文携带的目的地址，所述目 的地址为所述报文要到达分支内网中的主机对应的分支内网地址；</p>
    <p>[0009]	B，中心设备在已建立的分支内网地址、分支隧道源地址和分支隧道接口优先级三 者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以上分支 隧道源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确定当前 需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过已配置 的中心隧道接口转发加封装后的报文。</p>
    <p>[0010]	一种网络通信中控制报文转发的设备，该设备包括：中心隧道接口、接收单元和转 发单元；其中，所述中心隧道接口的个数至少为1 ；</p>
    <p>[0011]	所述接收单元接收到来自中心内网的报文时，确定该报文携带的目的地址，所述 目的地址为所述报文要到达分支内网中的主机对应的分支内网地址；</p>
    <p>[0012]	所述转发单元用于在已建立的分支内网地址、分支隧道源地址和分支隧道接口优 先级三者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以 上分支隧道源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确 定当前需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过 对应的中心隧道接口转发加封装后的报文。</p>
    <p>[0013]	由以上技术方案可以看出，本发明仅在中心设备上配置不需要在中心设备上分别 配置对应每一分支内网中每一分支设备的中心隧道接口，实质上中心设备已配置的中心隧 道接口为点对多点的隧道接口，如此，减少了中心设备上中心隧道接口和静态路由的配置， 大大减少了中心设备的压力；</p>
    <p>[0014]	另外，中心设备在进行报文转发时，依据建立的分支内网地址、分支隧道源地址和 分支隧道接口优先级三者之间的对应关系查找分支隧道源地址，即使查找到两个以上的分 支设备上分支隧道接口所包含的分支隧道源地址时，也可以唯一确定出当前需要向哪个分 支设备的分支隧道接口发送报文，如此，可以看出，本发明提供的方法和设备可适用于包含 多分支设备的分支内网，该多分支设备可包含一个以上的分支设备和该分支设备的备份; 或者各个相互之间不具有备份关系的分支设备等，如此，可大大提高了本发明的应用；</p>
    <p>[0015]	进一步地，本发明中的中心隧道接口，对于未来分支机构的接入也具备良好的支 持，不需要重新配置对应未来分支机构的中心隧道接口，大大简化了中心侧的维护代价；</p>
    <p>[0016]	更进一步地，本发明中，中心设备在转发报文时，根据分支隧道优先级别转发报 文，解决了中心设备在查找到多条隧道时不知通过哪一个隧道转发报文的缺陷，能够实现准确、快速、并能结合实际转发报文的目的。 附图说明</p>
    <p>[0017]	图1为现有技术中企业组网结构示意图；</p>
    <p>[0018]	图2为本发明实施例提供的基本流程图；</p>
    <p>[0019]	图3为本发明实施例提供的详细流程图；</p>
    <p>[0020]	图3a为本发明实施例提供的分支设备发送报文给中心内网的示意图；；</p>
    <p>[0021]	图北为本发明实施例提供的中心内网发送报文给分支内网的流程图；</p>
    <p>[0022]	图4为本发明实施例提供的设备结构图。具体实施方式</p>
    <p>[0023]	为了使本发明的目的、技术方案和优点更加清楚，下面结合附图和具体实施例对 本发明进行详细描述。</p>
    <p>[0024]	参见图2，图2为本发明实施例提供的基本流程图。本实施例应用的网络包含连接 中心内网的中心设备和连接分支内网的分支设备，其中，可按照与现有技术类似的操作在 每一分支内网中的分支设备上配置分支隧道接口，每一分支隧道接口包含分支隧道源地址 和隧道目的地址，具体定义与现有技术类似，这里不再详述；如图2所示，该流程可包括以 下步骤：</p>
    <p>[0025]	步骤201，预先在中心设备上配置至少1个中心隧道接口。</p>
    <p>[0026]	这里，本发明实施例可在中心设备上仅配置1个中心隧道接口来实现与多个分支 内网之间的通信，具体可参见图3所示的流程。</p>
    <p>[0027]	优选地，为了提高中心设备转发报文的效率，避免由于一个中心隧道接口导致转 发瓶颈的问题，本实施例还可以在中心设备上配置多个中心隧道接口，需要说明的是，该配 置的多个中心隧道接口并非现有技术那样与分支内网一一对应，而是按照某种策略将这些 中心隧道接口分别与一组作为目的地址的分支内网地址进行映射，比如，根据网段划分一 个以上作为目的地址的分支内网地址与中心隧道接口的对应关系，或者根据地域划分一个 以上作为目的地址的分支内网地址与中心隧道接口的对应关系；比如，北京和上海的分支 机构比较多，本实施例可为上海的所有分支机构和北京的所有分支机构分别单独配置一个 专用的中心隧道接口等等，如此，后续在接收到需要发送到分支内网的报文时，比如接收到 需要发送到北京的一个分支结构的报文时，直接通过与该分支内网地址具有对应关系的中 心隧道接口（即为专门为北京的所有分支机构配置的中心隧道接口）发送该报文。</p>
    <p>[0028]	步骤202，中心设备接收到来自中心内网的报文时，确定该报文携带的目的地址。</p>
    <p>[0029]	这里，目的地址为所述报文要到达分支内网中的主机对应的分支内网地址。</p>
    <p>[0030]	步骤203，中心设备在已建立的分支内网地址、分支隧道源地址和分支隧道接口优 先级三者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到，执行 步骤204 ；否则，执行步骤205 ；</p>
    <p>[0031]	这里，对应关系具体可由中心设备根据从中心隧道接口接收的来自各个分支设备 通过分支隧道接口发送的报文携带的分支内网地址、分支隧道源地址和分支隧道接口优先 级动态建立，其中，该动态建立的流程具体可参见图3中的步骤302至步骤307，这里不再详述。</p>
    <p>[0032]	由于中心设备需要通过中心隧道接口向分支设备上转发报文，因此，对于中心隧 道接口而言，分支设备上配置的分支隧道接口的分支隧道源地址实质上为该中心隧道接口 对应的目的地址（记为中心隧道目的地址）。这里，查找分支隧道源地址，目的就是为了查 找中心隧道目的地址，明确向哪个分支隧道接口发送报文。</p>
    <p>[0033]	步骤204，当查找到两个以上分支隧道源地址时，根据所述对应关系中分支隧道源 地址对应的分支隧道接口的优先级确定当前需要使用的分支隧道源地址，根据确定的分支 隧道源地址对报文进行加封装，通过已配置的中心隧道接口转发加封装后的报文。</p>
    <p>[0034]	这里，步骤204中在查找到两个分支隧道源地址时，根据对应关系中分支隧道源 地址对应的分支隧道接口的优先级可以唯一确定出当前需要向哪个分支隧道接口发送报 文。比如，若步骤203中根据目的地址查找到两个分支隧道源地址，其中一个是：第一分支 内网中分支设备A上配置的分支隧道接口 1包含的分支隧道源地址1，另一个是：第一分支 内网中分支设备B上配置的分支隧道接口 2包含的分支隧道源地址2，如此，中心设备需要 根据分支隧道接口1的优先级和分支隧道接口 2的优先级比如按照优先级高的原则来确定 当前需要使用的是分支隧道源地址1还是分支隧道源地址2，进而可以确定出当前需要向 分支隧道接口 1还是分支隧道接口 2发送报文。当然，本实施例中，如果步骤203查找到1 个分支隧道源地址，则直接根据该分支隧道源地址对报文进行加封装，通过已配置的中心 隧道接口转发加封装后的报文。</p>
    <p>[0035]	其中，上述根据分支隧道源地址对报文进行加封装，转发加封装后的报文具体可 包括：将分支隧道源地址确定为中心隧道目的地址，将确定的中心隧道目的地址和中心隧 道源地址添加到报文的外部，如果配置的中心隧道接口的个数为1，则通过该配置的中心隧 道接口转发添加后的报文；如果配置的中心隧道接口的个数大于1，则在步骤201所述的分 支内网地址和中心隧道接口对应关系中查找作为目的地址的分支内网地址所对应的中心 隧道接口 ；通过查找到的中心隧道接口转发加添加后的报文。</p>
    <p>[0036]	这里，通过中心隧道接口转发添加后的报文会转发到连接在中心内网和分支内网 之间的公网，如此，当公网接收到报文后，根据中心隧道目的地址发送报文给对应的隧道接 口（具体为分支隧道接口），如此，就会有一分支设备从已配置的分支隧道接口接收到报 文。当分支设备接收到报文时，去除接收的报文携带的中心隧道目的地址和中心隧道源地 址，根据去除后的报文携带的目的地址（分支内网地址）发送报文给目的地址对应的设备， 比如地址为目的地址的分支内网主机等。</p>
    <p>[0037]	至此实现了本发明实施例提供的中心内网和分支内网之间的通信流程。</p>
    <p>[0038]	需要说明的是，通过步骤204可以看出，中心隧道目的地址并非与现有技术一样 在配置中心隧道接口时同时配置中心隧道目的地址，而是由中心设备在动态建立对应关系 时动态学习得到，具体可参见图3中的步骤302至步骤307。如此，大大减少了中心设备的配置。</p>
    <p>[0039]	步骤205，丢弃该接收的报文。</p>
    <p>[0040]	这里，由于已建立的对应关系中不存在包含该报文携带的目的地址的对应关系， 如此，中心设备就不知道如何发送该报文，无法实现报文的转发，因此，只能丢弃该报文。</p>
    <p>[0041]	至此，通过上述步骤201至步骤205，实现了本发明实施例提供的方法的基本流程。</p>
    <p>[0042]	上述对本发明实施例提供的方法进行了简单描述，下面对本发明实施例提供的流 程进行详述。</p>
    <p>[0043]	首先需要说明的是，从上述图2所示的流程可以看出，中心设备转发报文时，需要 依据已建立的分支内网地址、分支隧道源地址和分支隧道接口优先级之间的对应关系，其 中，该对应关系可预先根据网络规划建立，也可由中心设备根据分支设备通过已配置的分 支隧道接口发送的报文建立。</p>
    <p>[0044]	以中心设备根据分支设备通过已配置的分支隧道接口发送的报文建立对应关系 为例，为了便于中心设备动态建立所述对应关系，则在分支设备通过分支隧道接口发送携 带了分支内网地址（实质上为报文的源地址）的报文时，需要将预先为该分支隧道接口配 置的优先级、以及该分支隧道接口包含的分支隧道源地址携带在报文中。通常，现有技术中 通过隧道接口封装的报文一般没有额外字段来承载本实施例中分支隧道接口的优先级，为 了能够实现本实施例，优选地，本实施例使中心设备上配置的1个中心隧道接口，以及分支 设备上配置的分支隧道接口为遵守通用路由封装（GRE)协议的隧道接口，本领域技术人员 知道，RFC1701定义的GRE头格式中包含了作为可选字段的密钥（Key)字段，如此，本实施例 通过在分支设备上配置Key值来表示分支设备上分支隧道接口的优先级，具体参见图3所 示的流程。当然，图3所示的只是一种举例，本实施例中也可采用其他方式来使分支设备通 过分支隧道接口发送的报文携带分支隧道接口的优先级，比如，在现有的隧道接口上额外 增加用以承载分支隧道接口优先级的字段等，这里并不具体限定。</p>
    <p>[0045]	参见图3，图3为本发明实施例提供的详细流程图。本实施例中，在各个分支设 备上配置GRE分支隧道接口，每一 GRE分支隧道接口包含分支隧道源地址和分支隧道目的 地址；在中心设备上配置至少1个GRE中心隧道接口，其中，每一 GRE中心隧道接口可只包 含中心隧道源地址，并不包含中心隧道目的地址，这是因为：每一 GRE分支隧道接口包含的 分支隧道源地址即为中心隧道目的地址，该中心隧道目的地址可由中心设备通过下述步骤 302至步骤307动态获得，如此，可减少中心设备的配置。为便于描述，本实施例以在中心设 备上配置1个GRE中心隧道接口为例，其他多个GRE中心隧道接口的情况与该1个GRE中 心隧道接口的情况类似，这里不再一一详述。</p>
    <p>[0046]	如图3所示，该流程可包括以下步骤：</p>
    <p>[0047]	步骤301，针对每一分支内网，在该分支内网中的各个分支设备上配置GRE Key值。</p>
    <p>[0048]	这里，步骤301中配置GRE Key值时可按照同一分支内网中不同分支设备上配置 的GRE Key值不同的原则，以及根据分支设备的网络规划比如分支设备在分支内网中的位 置或者所起的作用等进行。</p>
    <p>[0049]	步骤302，分支内网主机需要和中心内网主机通信时，发送报文给分支设备。</p>
    <p>[0050]	这里，报文中携带了源地址和目的地址；其中，源地址为分支内网主机对应的地 址，记为分支内网地址，目的地址为中心内网主机对应的地址。</p>
    <p>[0051]	步骤303，分支设备根据报文携带的目的地址确定出报文需要发送给中心设备时， 将预先配置的GRE Key值、已配置在自身上的分支隧道接口包含的分支隧道源地址和分支 隧道目的地址添加在该报文的外部，之后经由自身上的分支隧道接口发送添加后的报文给公网。</p>
    <p>[0052]	这里，分支隧道目的地址即为中心隧道源地址。其中，步骤303中将预先配置的 GRE Key值添加在该报文的外部具体为：将预先配置的GRE Key值填入到GRE头中的Key字 段；之后，将GRE头添加在报文的外部。步骤303具体可参见图3a所示。</p>
    <p>[0053]	需要说明的是，本步骤303是以分支设备配置了 GRE Key值为例描述的，优选地， 如果步骤301中没有对本步骤303中的分支设备配置GRE Key值，则执行到本步骤303时， 分支设备仅将已配置在自身上的分支隧道接口包含的分支隧道源地址和分支隧道目的地 址添加在该报文的外部，之后经由自身上的分支隧道接口发送添加后的报文给公网。因此， 可以看出，图3所示的只是一种举例，并非限定本发明实施例的应用。</p>
    <p>[0054]	步骤304，公网根据接收的报文携带的分支隧道目的地址转发报文。</p>
    <p>[0055]	由于分支隧道目的地址实质上为中心隧道源地址，因此，本步骤304中，公网会将 报文转发给中心设备的中心隧道接口，如此，执行完步骤304时，中心设备就会通过GRE中 心隧道接口接收到报文。</p>
    <p>[0056]	步骤305，中心设备对接收的报文进行解封装，提取出该报文所携带的分支内网地 址、分支隧道源地址和GRE Key值，判断当前对应关系中是否存在包含提取出的分支内网地 址、分支隧道源地址和GRE Key值的对应关系，如果不存在，执行步骤306 ；如果存在，执行 步骤307。</p>
    <p>[0057]	步骤306，记录该提取出的分支内网地址、分支隧道源地址和GRE Key值之间的对 应关系。之后，执行步骤308。</p>
    <p>[0058]	需要说明的是，本实施例中，中心设备在记录对应关系后，并非一直保持该对应关 系不变，其可在预设的老化时间到达时删除该对应关系，本实施例中，为便于及时、准确删 除对应关系，优选地，本步骤306在记录分支内网地址、分支隧道源地址和GRE Key值之间 的对应关系时还可进一步记录中心设备接收到携带该分支内网地址、分支隧道源地址和 GRE Key值的报文的时间，即该对应关系实质上为接收到报文的时间、分支内网地址、分支 隧道源地址和GREKey值四者之间的对应关系。</p>
    <p>[0059]	如此，针对每一对应关系，中心设备可根据该对应关系携带的时间和预设的老化 时间来判断当前是否需要更新该对应关系，比如，若已记录的对应关系包括时间1、分支内 网地址1、分支隧道源地址1和GRE Key值Xl的对应关系和时间2、分支内网地址2、分支隧 道源地址2和GRE Key值X2的对应关系，如果中心隧道接口在时间1之后、且预设老化时 间到达时还未接收到源地址为分支内网地址1的报文，则在已记录的对应关系中删除时间 1、分支内网地址1、分支隧道源地址1和GRE Key值Xl的对应关系，以便节省资源，之后，当 再次接收到源地址为分支内网地址1的报文时，转至步骤306。</p>
    <p>[0060]	步骤307，丢弃该提取出的分支内网地址、分支隧道源地址和GRE Key值。之后，执 行步骤308。</p>
    <p>[0061]	这里，步骤307是在中心设备判断出当前存在包含提取出的分支内网地址、分支 隧道源地址和GRE Key值的对应关系时执行的。优选地，如果存在的对应关系中还包含接 收到报文的时间，则本步骤307可进一步包括：更新该存在的对应关系中的时间为当前接 收到报文的时间。</p>
    <p>[0062]	至此，通过上述步骤302至步骤307实现了中心设备动态建立分支内网地址、分支隧道源地址和GRE Key值之间的对应关系的操作。由于分支隧道源地址实质上为中心隧道 目的地址，因此，上述步骤实质上也可为中心设备动态学习中心隧道目的地址的操作。 [0063] 这里，经过上述步骤302至步骤307后，若以建立的对应关系仅包含分支内网地 址、分支隧道源地址和GRE Key值，则以图1所示的组网，中心设备建立如下表1所示的对 应关系： 表1</p>
    <p>[0064]</p>
    <div class="patent-image small-patent-image"> <a href="//patentimages.storage.googleapis.com/CN102045233A/CN102045233AD00111.png"> <img id="idf0001" file="CN102045233AD00111.tif" img-content="drawing" img-format="tif" src="//patentimages.storage.googleapis.com/CN102045233A/CN102045233AD00111.png" class="patent-full-image" alt="Figure CN102045233AD00111"> </a> </div>
    <p>[0065]	需要说明的是，如果步骤303中分支设备发送的报文没有添加GRE Key值，则表1 中，可使该报文携带的分支内网地址和分支隧道源地址对应的GRE Key值为空，这里不进行 具体限定。</p>
    <p>[0066]	步骤308，中心内网主机需要向分支内网主机比如PCl发送报文时，则将报文先发 送给中心设备。</p>
    <p>[0067]	这里，中心内网主机发送给中心设备的报文携带了目的地址，即PCl地址。</p>
    <p>[0068]	步骤309，中心设备确定出接收的报文携带的目的地址即PCl地址，在建立的对应 关系中查找PCl地址对应的分支隧道源地址，如果查找到，则执行步骤310 ；否则，拒绝该报 文的转发。</p>
    <p>[0069]	这里，中心设备查找到分支隧道源地址为发送报文所要使用的中心隧道目的地 址，也就是说，中心设备需要将报文发送给具有查找到的分支隧道源地址的GRE分支隧道接口。</p>
    <p>[0070]	步骤310，判断查找到的分支隧道源地址的个数是否大于1，如果是，执行步骤 311 ；如果等于，执行步骤312。</p>
    <p>[0071]	步骤311，根据对应关系中分支隧道源地址对应的GRE Key值确定当前需要使用 的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过GRE中心隧道接 口转发加封装后的报文给公网。之后，执行步骤313。</p>
    <p>[0072]	这里，步骤311中根据对应关系中分支隧道源地址对应的GRE Key值确定当前需 要使用的分支隧道源地址具体实现时可有多种实现形式，比如：当查找到的分支隧道源地 址都存在对应的GRE Key值时，如果以分支设备上的GRE Key值越小，表示该分支设备上 的分支隧道接口的优先级越高，则步骤311中根据对应关系中分支隧道源地址对应的GREKey值确定当前需要使用的分支隧道源地址具体可为：在查找到的分支隧道源地址对应的 GRE Key值中选择出最小的GRE Key值，将该最小的GRE Key值对应的分支隧道源地址确定 当前需要使用的分支隧道源地址。比如，在表1所示的对应关系中，如果查找到PCl地址对 应的分支隧道源地址分别为分支设备A上GRE分支隧道接口 A包含的分支隧道源地址和分 支设备B上GRE分支隧道接口 B包含的分支隧道源地址，为了保证中心设备知道需要发送 报文给分支设备A还是分支设备B，这里就需要根据分支设备的GRE Key值进一步决定，如 果以分支设备上的GRE Key值越小，表示该分支设备上的GRE分支隧道接口的优先级越高， 则选择分支设备B上GRE分支隧道接口 B包含的分支隧道源地址为当前需要使用的分支隧 道源地址。当然，如果中心设备查找到分支隧道源地址中有一个分支隧道源地址对应的GRE Key值为空，则中心设备可将该分支隧道源地址确定为当前需要使用的分支隧道源地址，或 者依然按照上述的选择最小的GRE Key值对应的分支隧道源地址为当前需要使用的分支隧 道源地址，具体情况具体实现，这里不进行具体限定。</p>
    <p>[0073]	步骤312，中心设备根据查找到的分支隧道源地址对报文进行加封装，通过GRE中 心隧道接口转发加封装后的报文给公网。</p>
    <p>[0074]	这里，步骤311和步骤312中，中心设备根据分支隧道源地址对报文进行加封装具 体可为：中心设备将分支隧道源地址确定为中心隧道目的地址，将中心隧道源地址和确定 的中心隧道目的地址添加到报文的外部。</p>
    <p>[0075]	步骤313，公网根据接收的报文携带的中心隧道目的地址转发报文给对应的隧道接口。</p>
    <p>[0076]	由于中心隧道目的地址实质上为分支隧道源地址，因此，步骤313中对应的隧道 接口实质上为GRE分支隧道接口。如此，执行到步骤313时，就会有一分支设备通过配置在 自身上的GRE分支隧道接口接收到报文。</p>
    <p>[0077]	步骤314，分支设备通过自身上的GRE分支隧道接口接收到报文时，去除该报文携 带的中心隧道源地址和中心隧道目的地址，还原为步骤308中的报文。</p>
    <p>[0078]	步骤315，分支设备根据还原后的报文携带的目的地址即PC2地址将报文转发给 PC2。</p>
    <p>[0079]	可以看出，步骤308至步骤315具体为中心内网发送报文给分支内网的流程，为便 于理解，其可参见图北所示的示意图，这里不再详述。</p>
    <p>[0080]	至此，通过上述步骤实现了本发明实施例提供的通过中心设备设置的一个中心隧 道接口发送报文给分支内网的流程。</p>
    <p>[0081]	以上对本发明实施例提供的流程进行了详细描述，下面结合具体实施例对本发明 提供的设备进行描述。</p>
    <p>[0082]	参见图4，图4为本发明实施例提供的设备结构图。如图4所示，该设备包括：接 收单元401、转发单元402和中心隧道接口 403，中心隧道接口 403的个数至少为1 ；</p>
    <p>[0083]	其中，接收单元401接收到来自中心内网的报文时，确定该报文携带的目的地址， 所述目的地址为所述报文要到达分支内网中的主机对应的分支内网地址；</p>
    <p>[0084]	转发单元402用于在已建立的分支内网地址、分支隧道源地址和分支隧道接口优 先级三者之间的对应关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以 上分支隧道源地址，则根据所述对应关系中分支隧道源地址对应的分支隧道接口优先级确定当前需要使用的分支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过 对应的中心隧道接口转发加封装后的报文。</p>
    <p>[0085]	如图4所示，转发单元402可包括：建立子单元4021、查找子单元4022和转发子 单元4023 ；</p>
    <p>[0086]	其中，建立子单元4021，用于根据分支设备通过已配置的分支隧道接口发送的报 文建立分支内网地址、分支隧道源地址和分支隧道接口优先级的对应关系，所述通过分支 隧道接口发送的报文携带了分支内网地址、预先为该分支隧道接口配置的优先级、以及该 分支隧道接口包含的分支隧道源地址；</p>
    <p>[0087]	查找子单元4022用于在建立子单元4021已建立的对应关系中查找所述目的地址 对应的分支隧道源地址；如果查找到两个以上分支隧道源地址，则根据所述对应关系中分 支隧道源地址对应的分支隧道接口优先级确定当前需要使用的分支隧道源地址；如果查找 到1个分支隧道源地址时，将查找到的分支隧道源地址确定为当前需要使用的分支隧道源 地址；</p>
    <p>[0088]	转发子单元4023，用于根据查找子单元4022确定的分支隧道源地址对报文进行 加封装，如果配置的中心隧道接口的个数为1，则通过该配置的中心隧道接口转发加封装后 的报文；如果配置的中心隧道接口的个数大于1，则在预先配置的分支内网地址和中心隧 道接口对应关系中查找作为目的地址的分支内网地址所对应的中心隧道接口 ；通过查找到 的中心隧道接口转发加封装后的报文。</p>
    <p>[0089]	其中，建立子单元4021具体实现时可有多种实现形式，图4示出了其中一种结构， 如图4所示，建立子单元4021具体可包括：接收模块40211、提取模块40212和建立模块 40213。</p>
    <p>[0090]	其中，接收模块40211，用于通过中心隧道接口 403接收来自分支设备经由分支隧 道接口发送的报文，所述经由分支隧道接口发送的报文携带了分支内网地址、预先为该分 支隧道接口配置的优先级和该分支隧道接口包含的分支隧道源地址；</p>
    <p>[0091]	提取模块40212，用于提取出接收模块40211接收的报文所携带的分支内网地址、 分支隧道源地址和分支隧道接口的优先级；</p>
    <p>[0092]	建立模块40213，用于记录提取出的分支内网地址、分支隧道源地址和分支隧道接 口的优先级三者之间的对应关系。</p>
    <p>[0093]	优选地，建立模块40213记录的分支内网地址、分支隧道源地址和分支隧道接口 优先级的对应关系中还包括接收模块40211接收到携带该分支内网地址、分支隧道源地址 和分支隧道接口优先级的报文的时间；如此，建立模块40213还用于判断当前是否存在提 取出的分支内网地址、分支隧道源地址和分支隧道接口优先级的对应关系，如果否，则执行 所述记录，否则，更新该存在的对应关系中的时间为接收模块40211接收到所述报文的时 间，并触发提取模块40212丢弃该提取出的分支内网地址、分支隧道源地址和分支隧道接 口的优先级。</p>
    <p>[0094]	本实施例中，中心隧道接口 403可包含中心隧道源地址；转发子单元4023将确定 的分支隧道源地址确定为中心隧道目的地址，将所述中心隧道源地址和确定的中心隧道目 的地址添加到报文的外部，通过中心隧道接口 403转发添加后的报文。</p>
    <p>[0095]	优选地，本实施例中，中心隧道接口和分支隧道接口可遵守GRE协议，其中，分支隧道接口的优先级可通过预先配置的GRE Key值来表示，如此，分支设备在发送报文时，将 预先配置的GRE Key的取值填入到GRE头中的Key字段；之后，将GRE头和分支隧道源地 址添加在报文的外部发送给中心设备，如此，接收模块40211接收的报文携带了包含Key字 段的GRE头，提取模块40212即可从报文中提取出分支内网地址和分支隧道源地址，以及从 报文的GRE头中的Key字段提取出用于表示分支隧道接口优先级的Key值，之后，建立模块 40213在当前已建立的对应关系中不存在包含提取模块40212提取出的分支内网地址、分 支隧道源地址和Key值的对应关系时，记录提取出的分支内网地址、分支隧道源地址和Key 值三者之间的对应关系。</p>
    <p>[0096]	由以上技术方案可以看出，本发明提供的网络通信中控制报文转发的方法和设备 中，预先在中心设备配置1个中心隧道接口 ；中心设备接收到来自中心内网的报文时，确 定该报文携带的目的地址，所述目的地址为所述报文要到达的分支内网对应的分支内网地 址；之后，在已建立的分支隧道源地址、分支隧道优先级别和分支内网地址三者之间的对应 关系中查找所述目的地址对应的分支隧道源地址，如果查找到两个以上分支隧道源地址， 则根据所述对应关系中分支隧道源地址对应的分支隧道优先级别确定当前需要使用的分 支隧道源地址，根据确定的分支隧道源地址对报文进行加封装，通过所述中心隧道接口转 发加封装后的报文。可以看出，本发明仅在中心设备上配置一个中心隧道接口即可实现与 多个分支内网之间的通信，即实质上该中心隧道接口为点对多点的隧道接口，如此，就不需 要在中心设备上分别配置对应每一分支内网的中心隧道接口，减少了中心设备上中心隧道 接口和静态路由的配置，大大减少了中心设备的压力；</p>
    <p>[0097]	进一步地，本实施例中，在配置中心隧道接口时，不需要现有技术中配置中心隧道 接口包含的中心隧道目的地址，而是通过中心隧道接口自动学习获取中心隧道目的地址， 如此，对于一些采用ADSL拨号之类的动态地址没有特殊要求，便于分支机构接入网络；</p>
    <p>[0098]	另外，本实施例中并非现有技术中需要配置与分支内网的个数相等的中心隧道接 口，根据上述图3所示的步骤301至步骤315的描述可以知道，本实施例提供的中心隧道接 口实质上为点对多点的隧道接口，如此，大大减少中心侧隧道口和静态路由的配置，简化中 心侧的维护代价；</p>
    <p>[0099]	还有，本实施例提供的方法中只要保证分支设备遵守RFC协议即可，不需要特殊 的协议或者私有协议来配合使用，增加互通性；避免用户网络设备的重复投资；</p>
    <p>[0100]	最后，本发明实施例提供的方法中的中心隧道接口，对于未来分支机构的接入也 具备良好的支持，不需要重新配置对应未来分支机构的中心隧道接口，大大简化了中心侧 的维护代价。</p>
    <p>[0101]	以上所述仅为本发明的较佳实施例而已，并不用以限制本发明，凡在本发明的精 神和原则之内，所做的任何修改、等同替换、改进等，均应包含在本发明保护的范围之内。</p>
  </div>
  </div></div><div class="patent-section patent-tabular-section"><a id="forward-citations"></a><div class="patent-section-header"><span class="patent-section-title"> 被以下专利引用</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th">引用专利</th><th class="patent-data-table-th"> 申请日期</th><th class="patent-data-table-th">公开日</th><th class="patent-data-table-th"> 申请人</th><th class="patent-data-table-th">专利名</th></tr></thead><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102325077A?cl=zh">CN102325077A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年5月25日</td><td class="patent-data-table-td patent-date-value">2012年1月18日</td><td class="patent-data-table-td ">杭州华三通信技术有限公司</td><td class="patent-data-table-td ">分支机构间的通信方法及分支机构的出口路由器</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102325077B?cl=zh">CN102325077B</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年5月25日</td><td class="patent-data-table-td patent-date-value">2015年2月4日</td><td class="patent-data-table-td ">杭州华三通信技术有限公司</td><td class="patent-data-table-td ">分支机构间的通信方法及分支机构的出口路由器</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102739540A?cl=zh">CN102739540A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2012年6月29日</td><td class="patent-data-table-td patent-date-value">2012年10月17日</td><td class="patent-data-table-td ">华为技术有限公司</td><td class="patent-data-table-td ">分支接入总部的方法、系统和分支设备</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102739540B?cl=zh">CN102739540B</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2012年6月29日</td><td class="patent-data-table-td patent-date-value">2015年5月6日</td><td class="patent-data-table-td ">华为技术有限公司</td><td class="patent-data-table-td ">分支接入总部的方法、系统和分支设备</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN103365957A?cl=zh">CN103365957A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2013年4月24日</td><td class="patent-data-table-td patent-date-value">2013年10月23日</td><td class="patent-data-table-td ">微软公司</td><td class="patent-data-table-td ">基于邻近度和连接的照片共享</td></tr></table><div class="patent-section-footer">* 由审查员引用</div></div><div class="patent-section patent-tabular-section"><a id="classifications"></a><div class="patent-section-header"><span class="patent-section-title">分类</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th"> </th><th class="patent-data-table-th"> </th></tr></thead><tr><td class="patent-data-table-td ">国际分类号</td><td class="patent-data-table-td "><span class="nested-value"><a href="https://www.google.com/url?id=9pqTBwABERAJ&amp;q=http://web2.wipo.int/ipcpub/&amp;usg=AFQjCNER44F5jlVoswCkvW3YEcB5lW4moA#refresh=page&amp;notion=scheme&amp;version=20130101&amp;symbol=H04L0029120000">H04L29/12</a></span>, <span class="nested-value"><a href="https://www.google.com/url?id=9pqTBwABERAJ&amp;q=http://web2.wipo.int/ipcpub/&amp;usg=AFQjCNER44F5jlVoswCkvW3YEcB5lW4moA#refresh=page&amp;notion=scheme&amp;version=20130101&amp;symbol=H04L0012460000">H04L12/46</a></span></td></tr></table><div class="patent-section-footer"></div></div><div class="patent-section patent-tabular-section"><a id="legal-events"></a><div class="patent-section-header"><span class="patent-section-title">法律事件</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th"> 日期</th><th class="patent-data-table-th">代码</th><th class="patent-data-table-th">事件</th><th class="patent-data-table-th">说明</th></tr></thead><tr><td class="patent-data-table-td patent-date-value">2011年5月4日</td><td class="patent-data-table-td ">C06</td><td class="patent-data-table-td ">Publication</td><td class="patent-data-table-td "></td></tr><tr><td class="patent-data-table-td patent-date-value">2011年7月13日</td><td class="patent-data-table-td ">C10</td><td class="patent-data-table-td ">Request of examination as to substance</td><td class="patent-data-table-td "></td></tr><tr><td class="patent-data-table-td patent-date-value">2013年3月13日</td><td class="patent-data-table-td ">C14</td><td class="patent-data-table-td ">Granted</td><td class="patent-data-table-td "></td></tr></table><div class="patent-section-footer"></div></div><div class="modal-dialog" id="patent-images-lightbox"><div class="patent-lightbox-controls"><div class="patent-lightbox-rotate-controls"><div class="patent-lightbox-rotation-text">旋转</div><div class="rotate-icon rotate-ccw-icon"></div><div class="rotate-icon rotate-cw-icon"></div></div><div class="patent-lightbox-index-counter"></div><a class="patent-lightbox-fullsize-link" target="_blank">原始图片</a><div class="patent-drawings-control patent-drawings-next"><img class="patent-drawings-button-img"src="/googlebooks/images/kennedy/page_right.png" alt="Next page"width="21" height="21" /></div><div class="patent-drawings-control patent-drawings-prev"><img class="patent-drawings-button-img"src="/googlebooks/images/kennedy/page_left.png" alt="Previous page"width="21" height="21" /></div></div><div class="modal-dialog-content"><div class="patent-lightbox-image-holder"><div class="patent-lightbox-placeholder"></div></div></div></div><script>_OC_initPatentsAtb({image_not_available_html: " 未提供图片。\x3ca href\x3d//docs.google.com/viewer?url\x3dpatentimages.storage.googleapis.com/pdfs/4734634b9016e8995a8e/CN102045233A.pdf\x3e查看 PDF\x3c/a\x3e"});</script></div></div></div></div></div><script>(function() {var href = window.location.href;if (href.indexOf('?') !== -1) {var parameters = href.split('?')[1].split('&');for (var i = 0; i < parameters.length; i++) {var param = parameters[i].split('=');if (param[0] == 'focus') {var elem = document.getElementById(param[1]);if (elem) {elem.focus();}}}}})();</script><script>_OC_addFlags({LockSrc:"/books/javascript/lock_6e802a6b2b28d51711baddc2f3bec198.js", Host:"https://www.google.com/", IsBooksRentalEnabled:1, IsBrowsingHistoryEnabled:1, IsWebReaderSvgEnabled:0, IsImageModeNotesEnabled:1, IsOfflineBubbleEnabled:1, IsFutureOnSaleVolumesEnabled:1, IsBooksUnifiedLeftNavEnabled:1, IsMobileRequest:0, IsZipitFolderCollectionEnabled:1, IsAdsDisabled:0, IsEmbeddedMediaEnabled:1, IsImageModeAnnotationsEnabled:1, IsMyLibraryGooglePlusEnabled:1, IsImagePageProviderEnabled:1, IsBookcardListPriceSmall:0, IsInternalUser:0, IsBooksShareButtonEnabled:0, IsDisabledRandomBookshelves:0});_OC_Run({"enable_p13n":false,"is_cobrand":false,"sign_in_url":"https://www.google.com/accounts/Login?service=\u0026continue=https://www.google.com/patents%3Fcl%3Dzh%26hl%3Dzh-CN\u0026hl=zh-CN"}, {"volume_id":"","is_ebook":true,"volumeresult":{"has_flowing_text":false,"has_scanned_text":true,"can_download_pdf":false,"can_download_epub":false,"is_pdf_drm_enabled":false,"is_epub_drm_enabled":false,"download_pdf_url":"https://www.google.com/patents/download/%E4%B8%80%E7%A7%8D%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E4%B8%AD%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E8%BD%AC%E5%8F%91.pdf?id=9pqTBwABERAJ\u0026hl=zh-CN\u0026output=pdf\u0026sig=ACfU3U00DzAici3yha3zOoov63b1Eepw2Q"},"sample_url":"https://www.google.com/patents/reader?id=9pqTBwABERAJ\u0026hl=zh-CN\u0026printsec=frontcover\u0026output=reader\u0026source=gbs_atb_hover","is_browsable":true,"is_public_domain":true}, {});</script><div id="footer_table" style="font-size:83%;text-align:center;position:relative;top:20px;height:4.5em;margin-top:2em"><div style="margin-bottom:8px"><a href="https://www.google.com/search?hl=zh-CN"><nobr>Google&nbsp;首页</nobr></a> - <a href="//www.google.com/patents/sitemap/"><nobr>站点地图</nobr></a> - <a href="http://www.google.com/googlebooks/uspto.html"><nobr>美国专利商标局 (USPTO) 专利信息批量下载</nobr></a> - <a href="/intl/zh-CN/privacy/"><nobr>隐私权政策</nobr></a> - <a href="/intl/zh-CN/policies/terms/"><nobr>服务条款</nobr></a> - <a href="https://support.google.com/faqs/answer/2539193?hl=zh-CN"><nobr> 关于 Google 专利</nobr></a> - <a href="//www.google.com/tools/feedback/intl/zh-CN/error.html" onclick="try{_OC_startFeedback({productId: '72792',locale: 'zh-CN'});return false;}catch(e){}"><nobr>发送反馈</nobr></a></div></div> <script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">var pageTracker = _gat._getTracker("UA-27188110-1");pageTracker._setCookiePath("/patents/");pageTracker._trackPageview();</script> </body></html>