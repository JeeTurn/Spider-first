<!DOCTYPE html><html><head><title>专利 CN101917492A - 一种新型网的通信方法及系统 -  Google 专利</title><script>(function(){(function(){function e(a){this.t={};this.tick=function(a,c,b){var d=void 0!=b?b:(new Date).getTime();this.t[a]=[d,c];if(void 0==b)try{window.console.timeStamp("CSI/"+a)}catch(e){}};this.tick("start",null,a)}var a;window.performance&&(a=window.performance.timing);var f=a?new e(a.responseStart):new e;window.jstiming={Timer:e,load:f};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick("_wtsrt",void 0,c),b.tick("wtsrt_",
"_wtsrt",d),b.tick("tbsd_","wtsrt_"))}try{a=null,window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick("_tbnd",void 0,window.chrome.csi().startE),b.tick("tbnd_","_tbnd",c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick("_tbnd",void 0,window.external.startE),b.tick("tbnd_","_tbnd",c))),a&&(window.jstiming.pt=a)}catch(g){}})();})();
</script><link rel="stylesheet" href="/patents/css/_5115ea495017d9115e613207d3810e5a/kl_intl_patents_bundle.css" type="text/css" /><script src="/books/javascript/atb_5115ea495017d9115e613207d3810e5a__zh_cn.js"></script><script>function googleTranslateElementInit() {new google.translate.TranslateElement({pageLanguage: "zh",gaTrack: true,gaId: "UA-27188110-1",multilanguagePage: true});}</script><script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script><meta name="DC.type" content="Patent"><meta name="DC.title" content="一种新型网的通信方法及系统"><meta name="DC.contributor" content="杨春晖" scheme="inventor"><meta name="DC.contributor" content="陆宏成" scheme="inventor"><meta name="DC.contributor" content="北京乾唐视联网络科技有限公司" scheme="assignee"><meta name="DC.date" content="2010-8-6" scheme="dateSubmitted"><meta name="DC.description" content="本发明公开了一种新型网的通信方法，所述新型网为具有集中控制功能的网络，包括主控服务器和下级网络设备，所述下级网络设备包括终端，所述的方法包括：主控服务器配置当次服务的下行通信链路；将源终端发送的当次服务的数据包，按照所述下行通信链路传送至目标终端。本发明可以保证传输通路的稳定和通畅，避免多媒体业务的延时，保证国家信息安全的需求，节约硬件资源，从而保证网络传输品质。"><meta name="DC.date" content="2010-12-15"><meta name="DC.relation" content="CN:101557303:A" scheme="references"><meta name="DC.relation" content="CN:101674221:A" scheme="references"><meta name="DC.relation" content="US:20080049621:A1" scheme="references"><meta name="DC.relation" content="WO:2008058477:A1" scheme="references"><meta name="citation_patent_publication_number" content="CN:101917492:A"><meta name="citation_patent_application_number" content="CN:201010248194"><link rel="canonical" href="https://www.google.com/patents/CN101917492A?cl=zh"/><meta property="og:url" content="https://www.google.com/patents/CN101917492A?cl=zh"/><meta name="title" content="专利 CN101917492A - 一种新型网的通信方法及系统"/><meta name="description" content="本发明公开了一种新型网的通信方法，所述新型网为具有集中控制功能的网络，包括主控服务器和下级网络设备，所述下级网络设备包括终端，所述的方法包括：主控服务器配置当次服务的下行通信链路；将源终端发送的当次服务的数据包，按照所述下行通信链路传送至目标终端。本发明可以保证传输通路的稳定和通畅，避免多媒体业务的延时，保证国家信息安全的需求，节约硬件资源，从而保证网络传输品质。"/><meta property="og:title" content="专利 CN101917492A - 一种新型网的通信方法及系统"/><meta property="og:type" content="book"/><meta property="og:site_name" content="Google Books"/><meta property="og:image" content="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"/><link rel="image_src" href="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"/><script>if (window['_OC_timingAction']) {window['_OC_timingAction']('patents_refpage');}</script><style>#gbar,#guser{font-size:13px;padding-top:1px !important;}#gbar{height:22px}#guser{padding-bottom:7px !important;text-align:right}.gbh,.gbd{border-top:1px solid #c9d7f1;font-size:1px}.gbh{height:0;position:absolute;top:24px;width:100%}@media all{.gb1{height:22px;margin-right:.5em;vertical-align:top}#gbar{float:left}}a.gb1,a.gb4{text-decoration:underline !important}a.gb1,a.gb4{color:#00c !important}.gbi .gb4{color:#dd8e27 !important}.gbf .gb4{color:#900 !important}

#gbar { padding:.3em .6em !important;}</style></head><body ><div id=gbar><nobr><a class=gb1 href="https://www.google.com/search?cl=zh&hl=zh-CN&sa=N&tab=tw">搜索</a> <a class=gb1 href="https://www.google.com/search?cl=zh&hl=zh-CN&tbm=isch&source=og&sa=N&tab=ti">图片</a> <a class=gb1 href="https://maps.google.com/maps?cl=zh&hl=zh-CN&sa=N&tab=tl">地图</a> <a class=gb1 href="https://play.google.com/?cl=zh&hl=zh-CN&sa=N&tab=t8">Play</a> <a class=gb1 href="https://www.youtube.com/results?cl=zh&hl=zh-CN&sa=N&tab=t1">YouTube</a> <a class=gb1 href="https://news.google.com/nwshp?hl=zh-CN&tab=tn">新闻</a> <a class=gb1 href="https://mail.google.com/mail/?tab=tm">Gmail</a> <a class=gb1 href="https://drive.google.com/?tab=to">云端硬盘</a> <a class=gb1 style="text-decoration:none" href="https://www.google.com/intl/zh-CN/options/"><u>更多</u> &raquo;</a></nobr></div><div id=guser width=100%><nobr><span id=gbn class=gbi></span><span id=gbf class=gbf></span><span id=gbe></span><a target=_top id=gb_70 href="https://www.google.com/accounts/Login?service=&continue=https://www.google.com/patents%3Fcl%3Dzh%26hl%3Dzh-CN&hl=zh-CN" class=gb4>登录</a></nobr></div><div class=gbh style=left:0></div><div class=gbh style=right:0></div><div role="alert" style="position: absolute; left: 0; right: 0;"><a href="https://www.google.com/patents/CN101917492A?cl=zh&amp;hl=zh-CN&amp;output=html_text" title="屏幕阅读器用户请注意：点击此链接可进入无障碍模式。阅读器在无障碍模式下具有同样的基本功能，但可让用户获得更好的体验。"><img border="0" src="//www.google.com/images/cleardot.gif"alt="屏幕阅读器用户请注意：点击此链接可进入无障碍模式。阅读器在无障碍模式下具有同样的基本功能，但可让用户获得更好的体验。"></a></div><div class="kd-appbar"><h2 class="kd-appname"><a href="/patents?hl=zh-CN"> 专利</a></h2><div class="kd-buttonbar left" id="left-toolbar-buttons"><a id="appbar-write-review-link" href=""></a><a id="appbar-view-print-sample-link" href=""></a><a id="appbar-view-ebook-sample-link" href=""></a><a id="appbar-patents-prior-art-finder-link" href="https://www.google.com/patents/related/CN101917492A"></a><a id="appbar-patents-discuss-this-link" href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://patents.stackexchange.com/redirect/google-patents%3Fpublication%3DCN101917492A&amp;usg=AFQjCNGCHlpjqIMWqo3pQApb7uw_TW0Ipw" data-is-grant="false"></a><a id="appbar-read-patent-link" href="//docs.google.com/viewer?url=patentimages.storage.googleapis.com/pdfs/d198f78df1930caeec94/CN101917492A.pdf"></a><a id="appbar-download-pdf-link" href="//patentimages.storage.googleapis.com/pdfs/d198f78df1930caeec94/CN101917492A.pdf"></a><a class="appbar-content-language-link" data-selected="true" data-label="中文" href="/patents/CN101917492A?cl=zh&amp;hl=zh-CN"></a><a class="appbar-content-language-link" data-label="英语" href="/patents/CN101917492A?cl=en&amp;hl=zh-CN"></a><a class="appbar-application-grant-link" data-selected="true" data-label="申请" href="/patents/CN101917492A?hl=zh-CN&amp;cl=zh"></a><a class="appbar-application-grant-link" data-label="授权" href="/patents/CN101917492B?hl=zh-CN&amp;cl=zh"></a></div><div class="kd-buttonbar right" id="right-toolbar-buttons"></div></div><div id="books-microdata" itemscope=""itemtype="http://schema.org/Book"itemid="https://www.google.com/patents/CN101917492A?cl=zh" style="display:none"><span itemprop="description">本发明公开了一种新型网的通信方法，所述新型网为具有集中控制功能的网络，包括主控服务器和下级网络设备，所述下级网络设备包括终端，所述的方法包括：主控服务器配置当次服务的下行通信链路；将源终端发送的当次服...</span><span itemprop="url">https://www.google.com/patents/CN101917492A?cl=zh&amp;utm_source=gb-gplus-share</span><span class="main-title" itemprop="name">专利 CN101917492A - 一种新型网的通信方法及系统</span><img itemprop="image" src="https://www.google.com/patents?id=&amp;printsec=frontcover&amp;img=1&amp;zoom=1"alt="专利 CN101917492A - 一种新型网的通信方法及系统" title="专利 CN101917492A - 一种新型网的通信方法及系统"></div><div style="display: none"><ol id="ofe-gear-menu-contents" class="gbmcc"><li class="gbe gbmtc"><a class="gbmt goog-menuitem-content" id="" href="https://www.google.com/advanced_patent_search?hl=zh-CN"> 高级专利搜索</a></li></ol></div><div id="volume-main"><div id="volume-center"><div class=vertical_module_list_row><div id=intl_patents class=about_content><div id=intl_patents_v><table class="patent-bibdata patent-drawings-missing"><tr><td class="patent-bibdata-heading"> 公开号</td><td class="single-patent-bibdata">CN101917492 A</td></tr><tr><td class="patent-bibdata-heading">发布类型</td><td class="single-patent-bibdata">申请</td></tr><tr><td class="patent-bibdata-heading"> 专利申请号</td><td class="single-patent-bibdata">CN 201010248194</td></tr><tr><td class="patent-bibdata-heading">公开日</td><td class="single-patent-bibdata">2010年12月15日</td></tr><tr><td class="patent-bibdata-heading"> 申请日期</td><td class="single-patent-bibdata">2010年8月6日</td></tr><tr><td class="patent-bibdata-heading"> 优先权日<span class="patent-tooltip-anchor patent-question-icon"data-tooltip-text="优先日期属于假设性质，不具任何法律效力。Google 对于所列日期的正确性并没有进行法律分析，也不作任何陈述。"></span></td><td class="single-patent-bibdata">2010年8月6日</td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading">公告号</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="/patents/CN101917492B?hl=zh-CN&amp;cl=zh">CN101917492B</a>, </span><span class="patent-bibdata-value"><a href="/patents/EP2602960A1?hl=zh-CN&amp;cl=zh">EP2602960A1</a>, </span><span class="patent-bibdata-value"><a href="/patents/EP2602960A4?hl=zh-CN&amp;cl=zh">EP2602960A4</a>, </span><span class="patent-bibdata-value"><a href="/patents/US9219685?hl=zh-CN&amp;cl=zh">US9219685</a>, </span><span class="patent-bibdata-value"><a href="/patents/US20130170492?hl=zh-CN&amp;cl=zh">US20130170492</a>, </span><span class="patent-bibdata-value"><a href="/patents/WO2012016533A1?hl=zh-CN&amp;cl=zh">WO2012016533A1</a></span></span></td></tr><tr class="patent-bibdata-list-row alternate-patent-number"><td class="patent-bibdata-heading"> 公开号</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value">201010248194.9, </span><span class="patent-bibdata-value">CN 101917492 A, </span><span class="patent-bibdata-value">CN 101917492A, </span><span class="patent-bibdata-value">CN 201010248194, </span><span class="patent-bibdata-value">CN-A-101917492, </span><span class="patent-bibdata-value">CN101917492 A, </span><span class="patent-bibdata-value">CN101917492A, </span><span class="patent-bibdata-value">CN201010248194, </span><span class="patent-bibdata-value">CN201010248194.9</span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading"> 发明者</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=ininventor:%22%E6%9D%A8%E6%98%A5%E6%99%96%22">杨春晖</a>, </span><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=ininventor:%22%E9%99%86%E5%AE%8F%E6%88%90%22">陆宏成</a></span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading"> 申请人</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="https://www.google.com/search?tbo=p&amp;tbm=pts&amp;hl=en&amp;q=inassignee:%22%E5%8C%97%E4%BA%AC%E4%B9%BE%E5%94%90%E8%A7%86%E8%81%94%E7%BD%91%E7%BB%9C%E7%A7%91%E6%8A%80%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8%22">北京乾唐视联网络科技有限公司</a></span></span></td></tr><tr class="patent-bibdata-list-row "><td class="patent-bibdata-heading">导出引文</td><td><span class="patent-bibdata-value-list"><span class="patent-bibdata-value"><a href="/patents/CN101917492A.bibtex?cl=zh">BiBTeX</a>, </span><span class="patent-bibdata-value"><a href="/patents/CN101917492A.enw?cl=zh">EndNote</a>, </span><span class="patent-bibdata-value"><a href="/patents/CN101917492A.ris?cl=zh">RefMan</a></span></span></td></tr><tr class="patent-internal-links"><td colspan=2><span class="patent-bibdata-value"><a href="#backward-citations">专利引用</a> (4),</span> <span class="patent-bibdata-value"><a href="#forward-citations"> 被以下专利引用</a> (17),</span> <span class="patent-bibdata-value"><a href="#classifications">分类</a> (9),</span> <span class="patent-bibdata-value"><a href="#legal-events">法律事件</a> (3)</span> </td></tr><tr><td colspan=2 class="patent-bibdata-external-link-spacer-top"></td></tr><tr class="patent-bibdata-external-link-spacer-bottom"></tr><tr><td colspan=2><span class="patent-bibdata-heading">外部链接:&nbsp;</span><span><span class="patent-bibdata-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://211.157.104.87:8080/sipo/zljs/hyjs-yx-new.jsp%3Frecid%3D201010248194&amp;usg=AFQjCNEZMC5IH3gmzYRjj8zQ4vNL9SKyHg"> 中国国家知识产权局</a>, </span><span class="patent-bibdata-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://worldwide.espacenet.com/publicationDetails/biblio%3FCC%3DCN%26NR%3D101917492A%26KC%3DA%26FT%3DD&amp;usg=AFQjCNFyQlPHlbTu_ZjZr8t4GqNUDPtWiw"> 欧洲专利数据库 (Espacenet)</a></span></span></td></tr><tr class="patent-bibdata-group-spacer"></tr></table><div class="number-and-title"><span class="patent-title"><invention-title mxw-id="PT99292983" lang="ZH" load-source="patent-office">一种新型网的通信方法及系统</invention-title>
      </span><br><span class="patent-number">CN 101917492 A</span></div><div class="patent-section patent-abstract-section"><div class="patent-section-header"><span class="patent-section-title"> 摘要</span></div><div class="patent-text"><abstract mxw-id="PA81742331" lang="ZH" load-source="patent-office">
    <div class="abstract">本发明公开了一种新型网的通信方法，所述新型网为具有集中控制功能的网络，包括主控服务器和下级网络设备，所述下级网络设备包括终端，所述的方法包括：主控服务器配置当次服务的下行通信链路；将源终端发送的当次服务的数据包，按照所述下行通信链路传送至目标终端。本发明可以保证传输通路的稳定和通畅，避免多媒体业务的延时，保证国家信息安全的需求，节约硬件资源，从而保证网络传输品质。</div>
  </abstract>
  </div></div><div class="patent-section patent-claims-section"><div class="patent-section-header"><span class="patent-section-title">权利要求<span class="patent-section-count">(118)</span></span></div><div class="patent-text"><ol mxw-id="PCLM34023833" lang="ZH" load-source="patent-office" class="claims">
    <li class="claim"> <div num="1" class="claim">
      <div class="claim-text">一种新型网的通信方法，其特征在于，所述新型网为具有集中控制功能的网络，包括主控服务器和下级网络设备，所述下级网络设备包括终端，所述的方法包括：主控服务器配置当次服务的下行通信链路；将源终端发送的当次服务的数据包，按照所述下行通信链路传送至目标终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="2" class="claim">
      <div class="claim-text">2.如权利要求1所述的方法，其特征在于，所述配置当次服务的下行通信链路包括：通 知当次服务的下行通信链路所涉及的交换设备配表；所述按照所述下行通信链路传送包括：查询所配置的表，交换设备对所接收的数据包 通过相应端口进行传送。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="3" class="claim">
      <div class="claim-text">3.如权利要求1所述的方法，其特征在于，所述服务包括单播通信服务和组播通信服务。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="4" class="claim">
      <div class="claim-text">4.如权利要求1、2或3所述的方法，其特征在于，所述新型网包括接入网部分，在接入 网中，所述主控服务器为节点服务器，所述下级网络设备包括接入交换机和终端，所述主控 服务器配置当次服务的下行通信链路的步骤包括：主控服务器依据源终端发起的服务请求协议包，获取当次服务的下行通信链路信息， 所述下行通信链路信息包括，参与当次服务的主控服务器和接入交换机的下行通信端口信 息；主控服务器依据所述主控服务器的下行通信端口信息，在其内部的数据包地址表中设 置当次服务的数据包所导向的下行端口 ；并依据所述接入交换机的下行通信端口信息，向 相应的接入交换机发送端口配置命令；所述接入交换机依据端口配置命令在其内部的数据包地址表中，设置当次服务的数据 包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="5" class="claim">
      <div class="claim-text">5.如权利要求4所述的方法，其特征在于，所述下级网络设备地址分别具有对应的接 入网地址，所述主控服务器获取当次服务的下行通信链路信息的步骤包括：主控服务器获得源终端发起的、用于与目标终端建立单播通信服务的服务请求协议 包，所述服务请求协议包中包括服务类型信息，服务内容信息，以及，源终端的接入网地址， 其中，所述服务内容信息包括服务号码；主控服务器依据所述服务号码在预置的内容_地址映射表中提取目标终端的接入网 地址；主控服务器依据所述服务类型信息、源终端和目标终端的接入网地址，获取当次服务 的下行通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="6" class="claim">
      <div class="claim-text">6.如权利要求5所述的方法，其特征在于，所述主控服务器在其内部的单播数据包地 址表中设置当次服务的单播数据包所导向的下行端口包括：目的地址为源终端的单播数据包所导向的下行端口；和/或，目的地址为目标终端的单播数据包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="7" class="claim">
      <div class="claim-text">7.如权利要求6所述的方法，其特征在于，当所述通信链路信息为单向通信链路信息 时，所述接入交换机的通信端口信息包括上行链路中接入交换机的上行端口信息，以及，下 行链路中接入交换机的下行端口信息；所述接入交换机依据端口配置命令在其内部的单播数据包地址表中设置的当次服务 的单播数据包所导向的端口包括：目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口和下 行链路中接入交换机的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="8" class="claim">
      <div class="claim-text">8.如权利要求6所述的方法，其特征在于，当所述通信链路信息为双向下行通信链路 信息时，所述接入交换机的通信端口信息包括上行链路中接入交换机的上行端口和下行端 口信息，以及，下行链路中接入交换机的上行端口和下行端口信息；所述接入交换机依据所述端口配置命令在其内部的单播数据包地址表中设置的当次 服务的单播数据包所导向的端口包括：目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口和下 行端口 ；以及，目的地址为源终端的单播数据包所导向的下行链路中接入交换机的上行端 口的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="9" class="claim">
      <div class="claim-text">9.如权利要求4所述的方法，其特征在于，所述当次服务的数据包中包括目标终端的 接入网地址，所述按照下行通信链路传送当次服务的数据包至目标终端的步骤包括：主控服务器依据所述目标终端的接入网地址，在其内部的数据包地址表中查找当次服 务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至相应的接入交换机；所述接入交换机依据所述目标终端的接入网地址，在其内部的数据包地址表中查找当 次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至目标终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="10" class="claim">
      <div class="claim-text">10.如权利要求1所述的方法，其特征在于，还包括：将目标终端发送的当次服务的数据包，按照所述下行通信链路传送至源终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="11" class="claim">
      <div class="claim-text">11.如权利要求10所述的方法，其特征在于，所述当次服务的数据包中包括源终端的 接入网地址，所述按照下行通信链路传送当次服务的数据包至源终端的步骤包括：主控服务器依据所述源终端的接入网地址，在其内部的数据包地址表中查找当次服务 的数据包所导向的下行端口，并将该数据包通过该下行端口传送至相应的接入交换机；所述接入交换机依据所述源终端的接入网地址，在其内部的数据包地址表中查找当次 服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至源终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="12" class="claim">
      <div class="claim-text">12.如权利要求4所述的方法，其特征在于，所述下级网络设备地址分别具有对应的接 入网地址，所述主控服务器获取当次服务的下行通信链路信息的步骤包括：主控服务器获得目标终端发起的申请组播通信服务的服务请求协议包，所述服务请求 协议包中包括服务类型信息、服务内容信息和目标终端的接入网地址；其中，所述服务内容 信息中包括服务号码；主控服务器依据所述服务号码在预置的内容-地址映射表中，提取源终端的接入网地址；主控服务器获取所述源终端对应的组播地址，并分配给目标终端；以及，依据所述服务 类型信息、源终端和目标终端的接入网地址，获取当次组播服务的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="13" class="claim">
      <div class="claim-text">13.如权利要求12所述的方法，其特征在于，所述主控服务器获取当次服务的下行通 信链路信息的步骤还包括：主控服务器获得源终端提交的发起组播通信服务的服务请求协议包，并依据所述服务 请求协议包向源终端分配组播地址；所述服务请求协议包中包括服务类型信息，服务内容 信息，以及，源终端的接入网地址，其中，所述服务内容信息中包括服务号码；依据服务类型信息，以及，主控服务器与所述源终端的接入网地址，获取当次组播服务上行的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="14" class="claim">
      <div class="claim-text">14.如权利要求13所述的方法，其特征在于，所述主控服务器获取当次服务的下行通 信链路信息的步骤还包括：依据服务类型信息，以及，主控服务器与所述源终端的接入网地址，获取当次组播服务 下行的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="15" class="claim">
      <div class="claim-text">15.如权利要求12所述的方法，其特征在于，所述主控服务器在其内部的组播数据包 地址表中设置当次服务的组播数据包所导向的端口包括：目的地址为组播地址的组播数据包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="16" class="claim">
      <div class="claim-text">16.如权利要求15所述的方法，其特征在于，所述接入交换机的通信端口信息包括上 行链路中接入交换机的上行端口信息，以及，下行链路中接入交换机的下行端口信息；所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的当次 服务的组播数据包所导向的端口包括：目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的上行端口和下 行链路中接入交换机的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="17" class="claim">
      <div class="claim-text">17.如权利要求16所述的方法，其特征在于，所述接入交换机的通信端口信息还包括 上行链路中接入交换机的下行端口信息；所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的当次 服务的组播数据包所导向的端口包括：目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="18" class="claim">
      <div class="claim-text">18.如权利要求12所述的方法，其特征在于，所述当次服务的数据包中包括组播地址， 所述按照下行通信链路传送当次服务的数据包的步骤包括：主控服务器依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据包所 导向的下行端口，并将该数据包通过该下行端口传送至下行链路中相应的接入交换机；所述接入交换机依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据 包所导向的下行端口，并将该数据包通过该下行端口传送至目标终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="19" class="claim">
      <div class="claim-text">19.如权利要求18所述的方法，其特征在于，所述按照下行通信链路传送当次服务的 数据包的步骤还包括：依据源终端发送的当次服务数据包中的组播地址，将所述数据包导向至上行链路中的 接入交换机；所述接入交换机依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据 包所导向的上行端口，并将该数据包通过该上行端口传送至主控服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="20" class="claim">
      <div class="claim-text">20.如权利要求19所述的方法，其特征在于，所述按照下行通信链路传送当次服务的 数据包的步骤还包括：主控服务器依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据包所 导向的下行端口，并将该数据包通过该下行端口传送至上行链路中相应的接入交换机；所述接入交换机依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据 包所导向的下行端口，并将该数据包通过该下行端口传送至源终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="21" class="claim">
      <div class="claim-text">21.如权利要求4所述的方法，其特征在于，所述主控服务器获取当次服务的通信链路 信息的步骤还包括：若获得多条当次服务的通信链路信息，则主控服务器按照预置规则选择其中一条通信 链路信息为当次服务的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="22" class="claim">
      <div class="claim-text">22.如权利要求21所述的方法，其特征在于，所述预置规则为节点服务器获取各条通 信链路的流量信息，以及，当次服务的流量信息，确定已用流量最小的通信链路为当次服务 的通信链路信息；或者，所述预置规则为节点服务器获取各条通信链路的带宽信息，以及，当次服务的带 宽信息，确定带宽最大的通信链路为当次服务的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="23" class="claim">
      <div class="claim-text">23.如权利要求4所述的方法，其特征在于，所述端口配置命令记录在协议包中，所述 主控服务器依据其内部预置的下行协议包地址表的设置，通过连接相应接入交换机的下行 端口将所述协议包导向至对应的接入交换机；其中，所述下行协议包地址表中设置有，目的地址为下级网络设备地址的协议包所导 向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="24" class="claim">
      <div class="claim-text">24.如权利要求23所述的方法，其特征在于，还包括：在完成当次服务后，主控服务器在其内部的数据包地址表中，将所设置的当次服务数 据包导向的端口释放；并向参与当次服务的接入交换机发送端口释放命令；所述接入交换机依据所述端口释放命令在其内部的数据包地址表中，将所设置的当次 服务数据包导向的端口释放。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="25" class="claim">
      <div class="claim-text">25.如权利要求1所述的方法，其特征在于，所述主控服务器为节点服务器，具有自己 的接入网地址，并维护下级网络设备的接入网地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="26" class="claim">
      <div class="claim-text">26.如权利要求25所述的方法，其特征在于，所述下级网络设备包括接入交换机，所述 的方法还包括：接入交换机通过以下步骤接入新型网：接入交换机上电，在其内部的下行协议包地址表中设置所有下行协议包导向CPU模块；所述接入交换机接收主控服务器发送的下行协议包，依据所述下行协议包地址表的设 置，将所述下行协议包导向该接入交换机的CPU模块，所述CPU模块生成上行协议包，并发 送给主控服务器；所述下行协议包中包括一个待分配的接入网地址；主控服务器向该接入交换机发送入网命令，所述入网命令中包括该接入交换机的接入 网地址，所述接入网地址即为该接入交换机所接收下行协议包中的待分配接入网地址；所述接入交换机更新其内部的下行协议包地址表为，仅目的地址为自己接入网地址的 协议包导向CPU模块。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="27" class="claim">
      <div class="claim-text">27.如权利要求26所述的方法，其特征在于，当已入网的接入交换机接收到主控服务 器发送的端口分配包时，所述接入交换机接入新型网的步骤还包括：已入网的接入交换机将目的地址为自己接入网地址的端口分配包导向CPU模块；依据包中的端口分配信息，在其内部的下行协议包地址表中，设置各个端口下行协议 包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="28" class="claim">
      <div class="claim-text">28.如权利要求27所述的方法，其特征在于，当已入网的接入交换机接收到主控服务 器发送的端口下行协议包时，所述接入交换机接入新型网的步骤还包括：所述接入交换机依据其内部下行协议包地址表的设置，将所述端口下行协议包导向对应的下行端口 ；所述端口下行协议包中包括一个待分配的接入网地址；若主控服务器接收到连接在所述接入交换机下行端口的某个下级网络设备发送的端 口上行协议包，并向该下级网络设备发送入网命令，所述入网命令中包括该下级网络设备 的接入网地址，所述接入网地址即为该下级网络设备所接收的端口下行协议包中待分配的 接入网地址；其中，所述下级网络设备包括接入交换机或终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="29" class="claim">
      <div class="claim-text">29.如权利要求25所述的方法，其特征在于，所述下级网络设备包括接入交换机、终 端，以及，连接在所述接入交换机与终端之间的以太网协转网关和以太网，所述的方法还包 括：所述以太网协转网关通过以下步骤接入新型网： 主控服务器下发查询包；以太网协转网关上电初始化后，收到查询包，返回包含以太网协转网关序列号的应答包；主控服务器在注册信息表中查找与所述序列号对应的以太网协转网关信息，所述以太 网协转网关信息包括以太网协转网关MAC地址和该以太网协转网关下绑定的终端MAC地 址；主控服务器向所述以太网协转网关发送入网命令，所述入网命令中包含以太网协转网 关在新型网的地址和以太网协转网关的MAC地址；所述以太网协转网关收到入网命令后返回应答，以太网协转网关接入新型网。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="30" class="claim">
      <div class="claim-text">30.如权利要求29所述的方法，其特征在于：终端MAC地址和以太网协转网关的绑定关系在终端和以太网协转网关售出时预设在 节点服务器中。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="31" class="claim">
      <div class="claim-text">31.如权利要求30所述的方法，其特征在于，在所述以太网协转网关接入新型网，获得 以太网协转网关的MAC地址和该以太网协转网关下绑定的终端MAC地址之后，所述的方法 还包括：以太网协转网关下绑定的终端通过以下步骤接入新型网： 主控服务器下发查询包；以太网协转网关收到查询包，根据协议包地址表，将查询包导向到相应端口，然后在所 述查询包中添加以太网协转网关的MAC地址和目标终端的MAC地址，并转发； 终端上电初始化后，收到查询包，返回包含终端序列号的应答包； 以太网协转网关去掉所述应答包中的以太网协转网关MAC地址和终端MAC地址，然后 转发给主控服务器；主控服务器在注册信息表中找到与所述终端序列号对应的终端信息，发送入网命令， 所述入网命令中包含终端在新型网的地址；以太网协转网关收到所述入网命令，添加以太网协转网关的MAC地址和目标终端的 MAC地址后进行转发；终端收到入网命令后返回应答，以太网协转网关去掉所述应答中的以太网协转网关 MAC地址和终端MAC地址后转发给主控服务器，终端接入新型网。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="32" class="claim">
      <div class="claim-text">32.如权利要求31所述的方法，其特征在于，还包括：所述以太网协转网关接收新型网发来的数据包或协议包，在所述数据包或协议包中添 加以太网协转网关的MAC地址和目标终端的MAC地址，然后发送给以太网；所述以太网协转网关接收以太网发来的数据包或协议包，去掉所述数据包或协议包中 以太网协转网关的MAC地址和源终端的MAC地址，然后发送给新型网； 其中，所述目标终端和源终端遵循新型网协议。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="33" class="claim">
      <div class="claim-text">33.如权利要求32所述的方法，其特征在于：添加了以太网协转网关MAC地址和目标终端MAC地址的数据包，在以太网中采用以太 网协议进行传输；去掉了以太网协转网关MAC地址和源终端MAC地址的数据包，在新型网中采用新型网 协议进行传输。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="34" class="claim">
      <div class="claim-text">34.如权利要求33所述的方法，其特征在于：新型网发来的数据包和以太网发来的数 据包，包头都包含传输两端在新型网的地址，所述地址为数据包的源地址和目的地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="35" class="claim">
      <div class="claim-text">35.如权利要求34所述的方法，其特征在于，还包括：获得以太网协转网关下绑定的终端MAC地址与终端在新型网的地址的映射； 则所述以太网协转网关接收新型网发来的数据包，根据数据包的目的地址与MAC地址 的映射，在数据包中添加对应的目标终端的MAC地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="36" class="claim">
      <div class="claim-text">36.如权利要求34所述的方法，其特征在于，所述以太网协转网关接收以太网发来的 数据包之后，去掉所述数据包中以太网协转网关的MAC地址和源终端的MAC地址之前，所述 的方法还包括：对接收的数据包进行检测，如果符合检测要求，则分配相应的流标识符。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="37" class="claim">
      <div class="claim-text">37.如权利要求36所述的方法，其特征在于，所述检测包括：检测数据包的以太网协转网关MAC地址、源终端MAC地址、目的地址、源地址、数据包类 型和包长度是否符合要求。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="38" class="claim">
      <div class="claim-text">38.如权利要求37所述的方法，其特征在于，去掉所述数据包中以太网协转网关的MAC 地址和源终端的MAC地址之后，发送给新型网之前，所述的方法还包括：根据流标识符将数据包放入相应的端口接收缓存； 从端口接收缓存读取数据包，并根据流标识符放入相应流的包缓存队列； 轮询包缓存队列，当产生发送令牌后，根据发送令牌中的流标识符，从相应流的包缓存 队列中顺序读取数据包，并放入端口发送缓存； 从端口发送缓存读取数据包发送。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="39" class="claim">
      <div class="claim-text">39.如权利要求38所述的方法，其特征在于，所述根据发送令牌中的流标识符，从相应 流的包缓存队列中顺序读取数据包，并放入端口发送缓存之前，还包括：判断是否同时满足以下两个条件：第一，端口发送缓存未满；第二，相应流的包缓存队列中的包计数器大于零；如果同时满足，则根据发送令牌中的流标识符，从相应流的包缓存队列中顺序读取数 据包，并放入端口发送缓存。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="40" class="claim">
      <div class="claim-text">40.如权利要求39所述的方法，其特征在于，所述产生发送令牌包括：主控服务器根据终端发起的服务申请协议包，生成流量控制信息，并发送给上行链路上进行流量控制的以太网协转网关，所述流量控制信息包括发送时间间隔和发送的数据大以太网协转网关根据流量控制信息产生发送令牌，所述令牌中包含流标识符。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="41" class="claim">
      <div class="claim-text">41.如权利要求1、2或3所述的方法，其特征在于，所述新型网包括城域网部分，在城域 网中，所述主控服务器为城域服务器，所述下级网络设备包括节点交换机和节点服务器，其 中所述节点交换机连接在城域服务器和节点服务器之间；所述的方法还包括：下级网络设备接入城域网，由城域服务器为入网的设备分配协议标签和城域网地址； 其中，所述协议标签用于描述下级网络设备与城域服务器之间的连接；当同一个下级 网络设备与城域服务器之间有多个连接时，城域服务器为每个连接分配不同的协议标签；针对每个跨越城域网的服务申请，城域服务器分配对应服务的数据标签，所述数据标 签用于描述服务所涉及的节点服务器之间的连接。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="42" class="claim">
      <div class="claim-text">42.如权利要求4	1所述的方法，其特征在于，下级网络设备接入城域网，由城域服务 器分配协议标签和城域网地址的步骤包括：城域服务器向其所有下行端口发送城域查询标签包，每个城域查询标签包中包含一个 城域服务器分配的待用协议标签；某个下级网络设备上电后，收到城域服务器发送的城域查询标签包，然后向城域服务 器返回城域应答标签包，所述城域应答标签包中包含该下级网络设备的序列号和收到城域 查询标签包的端口号；城域服务器收到城域应答标签包后，根据包中的序列号验证该下级网络设备是否注 册，如果已注册，则向该下级网络设备收到城域查询标签包的端口发送入网命令，所述入网 命令中包含城域服务器为该下级网络设备分配的城域网地址和所述待用协议标签；该下级网络设备的相应端口收到入网命令后，返回入网命令应答，该下级网络设备接 入城域网。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="43" class="claim">
      <div class="claim-text">43.如权利要求42所述的方法，其特征在于：当同一个下级网络设备与城域服务器之间有多个连接时，所述同一个下级网络设备的 多个端口会收到多个城域查询标签包，每个城域查询标签包中的待用协议标签不同；城域服务器通过多个不同的协议标签，向同一个下级网络设备的多个端口发送多个入 网命令，但每个入网命令中为该下级网络设备分配的城域网地址相同。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="44" class="claim">
      <div class="claim-text">44.如权利要求43所述的方法，其特征在于，还包括：下级网络设备设置有协议包标签表，下级网络设备上电时，在其内部的协议包标签表 中设置所有的城域协议包导向到CPU模块；当下级网络设备为节点交换机时，节点交换机接入城域网后，根据城域服务器的指令， 修改自身的协议包标签表，将城域服务器新分配的各待用协议标签对应的城域协议包分别 导向到节点交换机的相应下行端口；其中，所述新分配的待用协议标签用于描述城域服务器到所述节点交换机的下级连接 设备的连接，所述城域协议包包括城域服务器发送的城域查询标签包。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="45" class="claim">
      <div class="claim-text">45.如权利要求44所述的方法，其特征在于，还包括：下级网络设备设置有应答包标签表，下级网络设备上电时，在其内部的应答包标签表 中设置所有城域应答标签包的导向关闭；当下级网络设备收到城域服务器发送的城域查询标签包后，修改自身的应答包标签 表，将所述协议标签对应的城域应答标签包导向到接收该城域查询标签包的上行端口 ；当下级网络设备为节点交换机时，节点交换机接入城域网后，根据城域服务器的指令， 修改自身的应答包标签表，将城域服务器新分配的各待用协议标签对应的城域应答标签包 分别导向到节点交换机的相应上行端口；其中，所述新分配的待用协议标签用于描述所述节点交换机的下级连接设备到城域服 务器的连接。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="46" class="claim">
      <div class="claim-text">46.如权利要求44或45所述的方法，其特征在于，还包括：城域服务器中设置有协议包标签表，城域服务器上电时，在其内部的协议包标签表中 设置所有城域协议包的导向关闭；城域服务器对应其自身下行端口个数分配待用协议标签，并修改自身的协议包标签 表，将所分配的各待用协议标签对应的城域协议包分别导向到城域服务器的相应下行端口 ；其中，所述待用协议标签用于描述城域服务器到所述下级网络设备的连接，所述城域 协议包包括城域服务器发送的城域查询标签包；所述城域服务器根据自身的协议包标签表 向其下行端口发送城域查询标签包。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="47" class="claim">
      <div class="claim-text">47.如权利要求46所述的方法，其特征在于，还包括：当下级网络设备入网之后，城域服务器为所述下级网络设备的下级连接设备新分配待 用协议标签，并修改自身的协议包标签表，将新分配的各待用协议标签对应的城域协议包 分别导向到城域服务器的相应下行端口；其中，所述新分配的待用协议标签用于描述城域服务器到所述下级网络设备的下级连 接设备的连接，所述城域协议包包括城域服务器发送的城域查询标签包；所述城域服务器 根据自身的协议包标签表向其下行端口发送城域查询标签包。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="48" class="claim">
      <div class="claim-text">48.如权利要求46所述的方法，其特征在于，还包括：城域服务器设置有应答包标签表，城域服务器上电时，在其内部的应答包标签表中设 置所有的城域应答标签包导向CPU模块。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="49" class="claim">
      <div class="claim-text">49.如权利要求42所述的方法，其特征在于，还包括：当入网的下级网络设备为节点交换机时，该节点交换机的某个下级连接设备接入城域 网，所述下级连接设备包括节点交换机和节点服务器，具体包括以下步骤：城域服务器使用新分配的待用协议标签向各下级连接设备发送城域查询标签包，所述 城域查询标签包根据协议包标签表被分别导向到城域服务器的相应下行端口；下级连接设备上电后，收到所述城域查询标签包，然后向城域服务器返回城域应答标 签包，所述城域应答标签包中包含该下级连接设备的序列号和收到城域查询标签包的端口 号；城域服务器收到所述城域应答标签包后，根据包中的序列号验证下级连接设备是否注 册，如果已注册，则向下级连接设备发送入网命令，所述入网命令中包含城域服务器为下级 连接设备分配的城域网地址和所述待分配的协议标签；下级连接设备收到入网命令后，返回入网命令应答，下级连接设备接入城域网。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="50" class="claim">
      <div class="claim-text">50.如权利要求49所述的方法，其特征在于，还包括：城域服务器与下级连接设备之间的下级网络设备接收到所述城域查询标签包和入网 命令后，根据自身的协议包标签表，将所述城域查询标签包和入网命令导向到相应下行端 口进行转发；城域服务器与下级连接设备之间的下级网络设备接收到所述城域应答标签包和入网 命令应答后，根据自身的应答包标签表，将所述城域应答标签包和入网命令应答导向到相 应上行端口进行转发。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="51" class="claim">
      <div class="claim-text">51.如权利要求41所述的方法，其特征在于，还包括：城域服务器设置有标签信息表，标签信息表的每个表项记录了标签占用信息、标签描 述信息和标签路由信息，其中所述标签路由信息包括该标签上一跳交换机的城域网地址及 端口号。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="52" class="claim">
      <div class="claim-text">52.如权利要求41所述的方法，其特征在于，还包括：城域服务器设置有地址信息表，地址信息表的每个表项记录了城域网地址占用信息、 设备描述信息和设备资源信息，其中设备资源信息包括该设备各个网络端口连接的下级网 络设备的城域网地址和该设备各个网络端口的上下行流量计数。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="53" class="claim">
      <div class="claim-text">53.如权利要求41所述的方法，其特征在于，还包括：城域服务器设置有设备信息表，设备信息表的每个表项记录了设备标识、设备状态和 设备地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="54" class="claim">
      <div class="claim-text">54.如权利要求42所述的方法，其特征在于，针对每个跨越城域网的服务申请，城域服 务器分配对应服务的数据标签包括：所述跨越城域网的服务申请涉及第一终端和第二终端；连接在某个节点服务器下的第一终端发起服务申请包，该节点服务器根据所述服务申 请包判断第二终端不连接在该节点服务器下，则添加协议标签向城域服务器发出服务申请 包；城域服务器根据收到的服务申请包判断第二终端连接在另一节点服务器下；城域服务器获得当次服务在城域网的通信链路信息，然后分配当次服务的数据标签， 并分别向通信链路上的下级网络设备发送包含所述数据标签信息的标签分配包；其中，所述标签分配包包含入标签、出标签和导向端口，所述下级网络设备包括节点交 换机和节点服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="55" class="claim">
      <div class="claim-text">55.如权利要求54所述的方法，其特征在于，还包括：城域服务器根据分配的数据标签在其内部的数据包标签表中设置当次服务的入标签、 出标签和导向端口；当通信链路上的下级网络设备收到所述标签分配包后，下级网络设备根据标签分配包 在其内部的数据包标签表中设置入标签、出标签和导向端口 ；其中，城域服务器和节点交换机内部的数据包标签表用于将各自以所设置的入标签接 收的标签数据包导向到相应端口，并使用所设置的对应出标签发送；其中，节点服务器内部的数据包标签表用于将节点服务器从接入网接收的数据包导向 到相应端口，并添加所设置的对应出标签发送到城域网。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="56" class="claim">
      <div class="claim-text">56.如权利要求55所述的方法，其特征在于，还包括：城域服务器发给节点服务器的标签分配包还包括当次服务的第一终端接入网地址、第二终端接入网地址与出标签的绑定关系；通信链路两端的节点服务器分别收到标签分配包后，在各自内部的地址_标签映射表 中设置所述绑定关系；其中，接入网地址为每个节点服务器为其下连接的入网设备分配的地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="57" class="claim">
      <div class="claim-text">57.如权利要求56所述的方法，其特征在于，通信链路两端的节点服务器分别收到标 签分配包后，还包括：连接第二终端的节点服务器根据包中的接入网目的地址，在其内部的数据包地址表中 设置目的地址是该接入网目的地址的数据包导向的端口；连接第一终端的节点服务器根据包中的接入网源地址，在其内部的数据包地址表中设 置目的地址是该接入网源地址的数据包导向的端口。</div>
    </div>
    </li> <li class="claim"> <div num="58" class="claim">
      <div class="claim-text">58.	一种新型网的通信系统，其特征在于，所述新型网为具有集中控制功能的网络，包 括主控服务器和下级网络设备，所述下级网络设备包括终端，所述的系统包括：位于主控服务器的路径配置模块，用于配置当次服务的下行通信链路；以及，第一通信模块组，用于将源终端发送的当次服务的数据包，按照所述下行通信链路传 送至目标终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="59" class="claim">
      <div class="claim-text">59.如权利要求58所述的系统，其特征在于，所述配置当次服务的下行通信链路包括： 通知当次服务的下行通信链路所涉及的交换设备配表；所述按照所述下行通信链路传送包括：查询所配置的表，交换设备对所接收的数据包 通过相应端口进行传送。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="60" class="claim">
      <div class="claim-text">60.如权利要求58所述的系统，其特征在于，所述服务包括单播通信服务和组播通信 服务。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="61" class="claim">
      <div class="claim-text">61.如权利要求58、59或60所述的系统，其特征在于，所述新型网包括接入网部分，在 接入网中，所述主控服务器为节点服务器，所述下级网络设备包括接入交换机和终端，所述 路径配置模块包括：下行链路获取子模块，用于依据源终端发起的服务请求协议包，获取当次服务的下行 通信链路信息，所述下行通信链路信息包括，参与当次服务的主控服务器和接入交换机的 下行通信端口信息；配表子模块，用于依据所述主控服务器的下行通信端口信息，在其内部的数据包地址 表中设置当次服务的数据包所导向的下行端口；通知子模块，用于依据所述接入交换机的下行通信端口信息，向相应的接入交换机发 送端口配置命令；由所述接入交换机依据端口配置命令在其内部的数据包地址表中，设置 当次服务的数据包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="62" class="claim">
      <div class="claim-text">62.如权利要求61所述的系统，其特征在于，所述下级网络设备地址分别具有对应的 接入网地址，所述下行链路获取子模块包括：单播服务请求接收单元，用于获得源终端发起的、用于与目标终端建立单播通信服务 的服务请求协议包，所述服务请求协议包中包括服务类型信息，服务内容信息，以及，源终 端的接入网地址，其中，所述服务内容信息包括服务号码；目标终端地址提取单元，用于依据所述服务号码在预置的内容-地址映射表中提取目 标终端的接入网地址；单播链路计算单元，用于依据所述服务类型信息、源终端和目标终端的接入网地址，获 取当次服务的下行通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="63" class="claim">
      <div class="claim-text">63.如权利要求62所述的系统，其特征在于，所述主控服务器在其内部的单播数据包 地址表中设置当次服务的单播数据包所导向的下行端口包括：目的地址为源终端的单播数据包所导向的下行端口；和/或，目的地址为目标终端的单播数据包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="64" class="claim">
      <div class="claim-text">64.如权利要求63所述的系统，其特征在于，当所述通信链路信息为单向通信链路信 息时，所述接入交换机的通信端口信息包括上行链路中接入交换机的上行端口信息，以及， 下行链路中接入交换机的下行端口信息；所述接入交换机依据端口配置命令在其内部的单播数据包地址表中设置的当次服务 的单播数据包所导向的端口包括：目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口和下 行链路中接入交换机的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="65" class="claim">
      <div class="claim-text">65.如权利要求63所述的系统，其特征在于，当所述通信链路信息为双向下行通信链 路信息时，所述接入交换机的通信端口信息包括上行链路中接入交换机的上行端口和下行 端口信息，以及，下行链路中接入交换机的上行端口和下行端口信息；所述接入交换机依据所述端口配置命令在其内部的单播数据包地址表中设置的当次 服务的单播数据包所导向的端口包括：目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口和下 行端口 ；以及，目的地址为源终端的单播数据包所导向的下行链路中接入交换机的上行端 口的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="66" class="claim">
      <div class="claim-text">66.如权利要求61所述的系统，其特征在于，所述当次服务的数据包中包括目标终端 的接入网地址，所述第一通信模块组包括：位于主控服务器的第一查表导向模块，用于依据所述目标终端的接入网地址，在其内 部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行 端口传送至相应的接入交换机；位于接入交换机的第一查表传送模块，用于依据所述目标终端的接入网地址，在其内 部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行 端口传送至目标终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="67" class="claim">
      <div class="claim-text">67.如权利要求58所述的系统，其特征在于，还包括：第二通信模块组，用于将目标终端发送的当次服务的数据包，按照所述下行通信链路 传送至源终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="68" class="claim">
      <div class="claim-text">68.如权利要求67所述的系统，其特征在于，所述当次服务的数据包中包括源终端的 接入网地址，所述第二通信模块组包括：位于主控服务器的第二查表导向模块，用于依据所述源终端的接入网地址，在其内部 的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端 口传送至相应的接入交换机；位于接入交换机的第二查表传送模块，用于依据所述源终端的接入网地址，在其内部 的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至源终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="69" class="claim">
      <div class="claim-text">69.如权利要求61所述的系统，其特征在于，所述下级网络设备地址分别具有对应的 接入网地址，所述下行链路获取子模块包括：第一组播服务请求接收单元，用于获得目标终端发起的申请组播通信服务的服务请求 协议包，所述服务请求协议包中包括服务类型信息、服务内容信息和目标终端的接入网地 址；其中，所述服务内容信息中包括服务号码；源终端地址提取单元，用于依据所述服务号码在预置的内容-地址映射表中，提取源 终端的接入网地址；第一组播地址分配单元，用于获取所述源终端对应的组播地址，并分配给目标终端；以及，第一组播链路计算单元，用于依据所述服务类型信息、源终端和目标终端的接入网地 址，获取当次组播服务的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="70" class="claim">
      <div class="claim-text">70.如权利要求69所述的系统，其特征在于，所述下行链路获取子模块还包括：第二组播服务请求接收单元，用于获得源终端提交的发起组播通信服务的服务请求协 议包；所述服务请求协议包中包括服务类型信息，服务内容信息，以及，源终端的接入网地 址，其中，所述服务内容信息中包括服务号码；第二组播地址分配单元，用于依据所述服务请求协议包向源终端分配组播地址；第二组播链路计算单元，用于依据服务类型信息，以及，主控服务器与所述源终端的接 入网地址，获取当次组播服务上行的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="71" class="claim">
      <div class="claim-text">71.如权利要求70所述的系统，其特征在于，所述下行链路获取子模块还包括：第三组播链路计算单元，用于依据服务类型信息，以及，主控服务器与所述源终端的接 入网地址，获取当次组播服务下行的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="72" class="claim">
      <div class="claim-text">72.如权利要求69所述的系统，其特征在于，所述主控服务器在其内部的组播数据包 地址表中设置当次服务的组播数据包所导向的端口包括：目的地址为组播地址的组播数据包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="73" class="claim">
      <div class="claim-text">73.如权利要求72所述的系统，其特征在于，所述接入交换机的通信端口信息包括上 行链路中接入交换机的上行端口信息，以及，下行链路中接入交换机的下行端口信息；所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的当次 服务的组播数据包所导向的端口包括：目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的上行端口和下 行链路中接入交换机的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="74" class="claim">
      <div class="claim-text">74.如权利要求73所述的系统，其特征在于，所述接入交换机的通信端口信息还包括 上行链路中接入交换机的下行端口信息；所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的当次 服务的组播数据包所导向的端口包括：目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="75" class="claim">
      <div class="claim-text">75.如权利要求69所述的系统，其特征在于，所述当次服务的数据包中包括组播地址， 所述第一通信模块组包括：位于主控服务器的第一端口导向模块，用于依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至下 行链路中相应的接入交换机；位于接入交换机的第一下行端口传送模块，用于依据所述组播地址，在其内部的数据 包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送 至目标终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="76" class="claim">
      <div class="claim-text">76.如权利要求75所述的系统，其特征在于，所述第一通信模块组还包括：位于终端的发送模块，用于依据源终端发送的当次服务数据包中的组播地址，将所述 数据包导向至上行链路中的接入交换机；位于接入交换机的上行端口传送模块，用于依据所述组播地址，在其内部的数据包地 址表中查找当次服务的数据包所导向的上行端口，并将该数据包通过该上行端口传送至主 控服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="77" class="claim">
      <div class="claim-text">77.如权利要求76所述的系统，其特征在于，所述第一通信模块组还包括：位于主控服务器的第二端口导向模块，用于依据所述组播地址，在其内部的数据包地 址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至上 行链路中相应的接入交换机；位于接入交换机的第二下行端口传送模块，用于依据所述组播地址，在其内部的数据 包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送 至源终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="78" class="claim">
      <div class="claim-text">78.如权利要求61所述的系统，其特征在于，所述下行链路获取子模块还包括：链路选择单元，用于在获得多条当次服务的通信链路信息时，按照预置规则选择其中 一条通信链路信息为当次服务的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="79" class="claim">
      <div class="claim-text">79.如权利要求78所述的系统，其特征在于，所述预置规则为节点服务器获取各条通 信链路的流量信息，以及，当次服务的流量信息，确定已用流量最小的通信链路为当次服务 的通信链路信息；或者，所述预置规则为节点服务器获取各条通信链路的带宽信息，以及，当次服务的带 宽信息，确定带宽最大的通信链路为当次服务的通信链路信息。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="80" class="claim">
      <div class="claim-text">80.如权利要求61所述的系统，其特征在于，所述端口配置命令记录在协议包中，所述 主控服务器还包括：协议包导向模块，用于依据其内部预置的下行协议包地址表的设置，通过连接相应接 入交换机的下行端口将所述协议包导向至对应的接入交换机；其中，所述下行协议包地址表中设置有，目的地址为下级网络设备地址的协议包所导 向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="81" class="claim">
      <div class="claim-text">81.如权利要求80所述的系统，其特征在于，所述的系统还包括：位于主控服务器的资源释放模块，用于在完成当次服务后，在其内部的数据包地址表 中，将所设置的当次服务数据包导向的端口释放；并向参与当次服务的接入交换机发送端 口释放命令；位于接入交换机的端口释放模块，用于依据所述端口释放命令在其内部的数据包地址 表中，将所设置的当次服务数据包导向的端口释放。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="82" class="claim">
      <div class="claim-text">82.如权利要求58所述的系统，其特征在于，所述主控服务器为节点服务器，具有自己的接入网地址，并维护下级网络设备的接入网地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="83" class="claim">
      <div class="claim-text">83.如权利要求82所述的系统，其特征在于，所述下级网络设备包括接入交换机，所述 的系统还包括接入交换机入网处理模块，所述接入交换机入网处理模块包括：位于节点服务器的向接入交换机发送下行协议包的下行协议包发送子模块，以及，依 据接入交换机回复的上行协议包发送入网命令的第一入网命令发送子模块； 位于接入交换机的以下子模块：0号表初始化配置子模块，用于在上电时，在其内部的下行协议包地址表中设置所有下 行协议包导向CPU模块；下行协议包接收子模块，用于依据所述下行协议包地址表的设置，将接收到的下行协 议包导向该接入交换机的CPU模块，所述下行协议包中包括一个待分配的接入网地址； 上行协议包回复子模块，用于由所述CPU模块生成上行协议包，并发送给节点服务器； 第一入网命令接收子模块，用于接收节点服务器发送的入网命令，所述入网命令中包 括该接入交换机的接入网地址，所述接入网地址即为该接入交换机所接收下行协议包中的 待分配接入网地址；0号表第一设置子模块，用于更新其内部的下行协议包地址表为，仅目的地址为自己接 入网地址的协议包导向CPU模块。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="84" class="claim">
      <div class="claim-text">84.如权利要求83所述的系统，其特征在于，所述接入交换机入网处理模块还包括： 位于节点服务器的用于向已入网的接入交换机发送端口分配包的端口分配包发送子模块，所述端口分配包中包括端口分配信息，所述端口分配信息为各个端口下行协议包导 向所述接入交换机各个下行端口的信息； 位于接入交换机的以下子模块：第一导向子模块，用于将目的地址为自己接入网地址的端口分配包导向CPU模块； 0号表第二设置子模块，用于依据所述端口分配信息，在其内部的下行协议包地址表 中，设置各个端口下行协议包所导向的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="85" class="claim">
      <div class="claim-text">85.如权利要求84所述的系统，其特征在于，所述接入交换机入网处理模块还包括： 位于节点服务器的用于向已入网的接入交换机发送端口下行协议包的端口下行协议包发送子模块，所述端口下行协议包中包括一个待分配的接入网地址； 位于接入交换机的以下子模块：第二导向子模块，用于依据其内部下行协议包地址表的设置，将所述端口下行协议包 导向对应的下行端口。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="86" class="claim">
      <div class="claim-text">86.如权利要求85所述的系统，其特征在于，所述接入网设备还包括连接在已入网接 入交换机下行端口的下级接入网设备，所述接入交换机入网处理模块还包括：位于节点服务器的用于向所述下级接入网设备发送入网命令的第二入网命令发送子 模块；位于所述下级接入网设备的以下子模块：端口上行协议包回复子模块，用于针对接收到的端口下行协议包生成端口上行协议 包，并发送给节点服务器；第二入网命令接收子模块，用于接收节点服务器发送的入网命令，所述入网命令中包 括该下级接入交换机的接入网地址，所述接入网地址即为该下级接入交换机所接收端口下行协议包中的待分配接入网地址；其中，所述下级网络设备包括接入交换机或终端。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="87" class="claim">
      <div class="claim-text">87.如权利要求82所述的系统，其特征在于，所述下级网络设备包括接入交换机、终 端，以及，连接在所述接入交换机与终端之间的以太网协转网关和以太网，所述的系统还包 括以太网协转网关入网处理模块，所述以太网协转网关入网处理模块包括：位于主控服务器的以下子模块： 查询包发送子模块，用于下发查询包；信息查找子模块，用于在注册信息表中查找与所述序列号对应的以太网协转网关信 息，所述以太网协转网关信息包括以太网协转网关MAC地址和该以太网协转网关下绑定的 终端MAC地址；入网命令发送子模块，用于向所述以太网协转网关发送入网命令，所述入网命令中包 含以太网协转网关在新型网的地址和以太网协转网关的MAC地址； 位于以太网协转网关的以下子模块：查询应答子模块，用于在上电初始化后，收到查询包，返回包含以太网协转网关序列号 的应答包；入网应答子模块，用于收到入网命令后返回应答，以太网协转网关接入新型网。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="88" class="claim">
      <div class="claim-text">88.如权利要求87所述的系统，其特征在于：终端MAC地址和以太网协转网关的绑定关系在终端和以太网协转网关售出时预设在 节点服务器中。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="89" class="claim">
      <div class="claim-text">89.如权利要求88所述的系统，其特征在于，还包括以太网协转网关绑定终端入网处 理模块，所述以太网协转网关绑定终端入网处理模块包括：位于主控服务器的查询包发送子模块，用于下发查询包；位于以太网协转网关的查询包导向子模块，用于收到查询包，根据协议包地址表，将查 询包导向到相应端口；位于以太网协转网关的第一 MAC地址添加子模块，用于在所述查询包中添加以太网协 转网关的MAC地址和目标终端的MAC地址，并转发；位于终端的初始化子模块，用于上电初始化后，收到查询包，返回包含终端序列号的应 答包；位于以太网协转网关的第一 MAC地址删除子模块，用于去掉所述应答包中的以太网协 转网关MAC地址和终端MAC地址，然后转发给主控服务器；位于主控服务器的入网通知子模块，用于在注册信息表中找到与所述终端序列号对应 的终端信息，发送入网命令，所述入网命令中包含终端在新型网的地址；位于以太网协转网关的第二 MAC地址添加子模块，用于在收到所述入网命令时，添加 以太网协转网关的MAC地址和目标终端的MAC地址后进行转发； 位于终端的入网应答子模块，用于在收到入网命令后返回应答； 位于以太网协转网关的第二 MAC地址删除子模块，用于去掉所述应答中的以太网协转 网关MAC地址和终端MAC地址后转发给主控服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="90" class="claim">
      <div class="claim-text">90.如权利要求89所述的系统，其特征在于，所述节点服务器用于向入网的以太网协 转网关发送该以太网协转网关下绑定的终端MAC地址；所述以太网协转网关通过以太网和终端相连，包括：MAC获取模块，用于接入新型网，从具有集中控制功能的节点服务器获得该以太网协转 网关下绑定的终端MAC地址；MAC添加模块，用于接收新型网发来的数据包，在所述数据包中添加以太网协转网关的 MAC地址和目标终端的MAC地址，然后发送至以太网；MAC删除模块，用于接收以太网发来的数据包，去掉所述数据包中以太网协转网关的 MAC地址和源终端的MAC地址，然后发送至新型网； 其中，所述目标终端和源终端遵循新型网协议；终端，连接在以太网中，通过以太网与新型网连接，并与以太网协转网关绑定。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="91" class="claim">
      <div class="claim-text">91.如权利要求90所述的系统，其特征在于：添加了以太网协转网关MAC地址和目标终端MAC地址的数据包，在以太网中采用以太 网协议进行传输；去掉了以太网协转网关MAC地址和源终端MAC地址的数据包，在新型网中采用新型网 协议进行传输。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="92" class="claim">
      <div class="claim-text">92.如权利要求91所述的系统，其特征在于：新型网发来的数据包和以太网发来的数 据包，包头都包含传输两端在新型网的地址，所述地址为数据包的源地址和目的地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="93" class="claim">
      <div class="claim-text">93.如权利要求92所述的系统，其特征在于，还包括：位于所述以太网协转网关的映射关系获取模块，用于在以太网协转网关接入新型网 后，从节点服务器获得以太网协转网关下绑定的终端MAC地址与终端在新型网的地址的映 射；则所述MAC添加模块接收新型网发来的数据包，根据数据包的目的地址与MAC地址的 映射，在数据包中添加对应的目标终端的MAC地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="94" class="claim">
      <div class="claim-text">94.如权利要求92所述的系统，其特征在于，还包括：位于所述以太网协转网关的包检测模块，用于对接收的数据包进行检测，如果符合检 测要求，则分配相应的流标识符，所述检测包括：检测数据包的以太网协转网关MAC地址、源终端MAC地址、目的地址、源地址、数据包类 型和包长度是否符合要求。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="95" class="claim">
      <div class="claim-text">95.如权利要求94所述的系统，其特征在于，还包括： 位于所述以太网协转网关的以下模块：端口接收缓存，用于按照流标识符存放相应的数据包； 包缓存器，用于存放从端口接收缓存读取的数据包； 端口发送缓存，用于存放从包缓存器读取的数据包；交换引擎，用于从端口接收缓存读取数据包，并根据流标识符放入相应流的包缓存器 队列；轮询包缓存器队列，当获得发送令牌后，根据发送令牌中的流标识符，从相应流的包 缓存器队列中顺序读取数据包，并放入端口发送缓存；从端口发送缓存读取数据包发送。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="96" class="claim">
      <div class="claim-text">96.如权利要求95所述的系统，其特征在于，所述交换引擎还用于判断是否同时满足 以下两个条件：第一，端口发送缓存未满；第二，相应流的包缓存队列中的包计数器大于零；如果同时满足，则根据发送令牌中的流标识符，从相应流的包缓存队列中顺序读取数 据包，并放入端口发送缓存。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="97" class="claim">
      <div class="claim-text">97.如权利要求96所述的系统，其特征在于，所述节点服务器还用于根据终端发起的 服务申请协议包，生成流量控制信息，并发送给上行链路上进行流量控制的以太网协转网 关，所述流量控制信息包括发送时间间隔和发送的数据大小。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="98" class="claim">
      <div class="claim-text">98.如权利要求97所述的系统，其特征在于，所述以太网协转网关还包括：码率控制模块，用于由CPU模块配置，根据流量控制信息产生发送令牌，并发送给交换 引擎，所述令牌中包含流标识符。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="99" class="claim">
      <div class="claim-text">99.如权利要求58、59或60所述的系统，其特征在于，所述新型网包括城域网部分，在 城域网中，所述主控服务器为城域服务器，所述下级网络设备包括节点交换机和节点服务 器，其中所述节点交换机连接在城域服务器和节点服务器之间；所述的系统还包括：位于所述城域服务器的以下模块：协议标签分配模块，用于在下级网络设备接入城域网时，为入网的设备分配协议标签； 当同一个下级网络设备与城域服务器之间有多个连接时，为每个连接分配不同的协议标 签；其中，所述协议标签用于描述下级网络设备与城域服务器之间的连接，所述下级网络设 备包括节点交换机和节点服务器；数据标签分配模块，用于针对每个跨越城域网的服务申请，分配对应服务的数据标签， 所述数据标签用于描述服务所涉及的节点服务器之间的连接；城域网地址分配模块，用于下级网络设备接入城域网时，为入网的设备分配城域网地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="100" class="claim">
      <div class="claim-text">100.如权利要求99所述的系统，其特征在于，所述城域服务器还包括：端口查询模块，用于向其所有下行端口发送城域查询标签包，每个城域查询标签包中 包含一个协议标签分配模块分配的待用协议标签；端口应答模块，用于接收下级网络设备发送的城域应答标签包，所述城域应答标签包 中包含下级网络设备的序列号和收到城域查询标签包的端口号；入网验证模块，用于根据城域应答标签包中的序列号验证下级网络设备是否注册； 入网命令发送模块，用于当下级网络设备已注册时，向下级网络设备收到城域查询标 签包的端口发送入网命令，所述入网命令中包含城域服务器为下级网络设备分配的城域网 地址和所述待用协议标签；入网命令应答接收模块，用于接收下级网络设备返回的入网命令应答，下级网络设备 接入城域网；其中，所述下级网络设备为节点交换机或节点服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="101" class="claim">
      <div class="claim-text">101.如权利要求100所述的系统，其特征在于：当同一个下级网络设备与城域服务器之间有多个连接时，所述同一个下级网络设备的 多个端口会收到多个城域查询标签包，每个城域查询标签包中的待用协议标签不同；城域服务器通过多个不同的协议标签，向同一个下级网络设备的多个端口发送多个入 网命令，但每个入网命令中为该下级网络设备分配的城域网地址相同。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="102" class="claim">
      <div class="claim-text">102.如权利要求101所述的系统，其特征在于，所述节点交换机包括：协议包标签表，用于将接收的城域协议包分别导向到相应下行端口，所述城域协议包包括城域服务器发送的城域查询标签包；协议包标签表初始化模块，用于当节点交换机上电时，设置所有的城域协议包导向到 CPU模块；协议包标签表更新模块，用于当节点交换机接入城域网后，根据城域服务器的指令，修 改自身的协议包标签表，将城域服务器新分配的各待用协议标签对应的城域协议包分别导 向到节点交换机的相应下行端口 ；其中，所述新分配的待用协议标签用于描述城域服务器 到所述节点交换机的下级连接设备的连接，所述下级连接设备包括下级节点交换机和节点 服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="103" class="claim">
      <div class="claim-text">103.如权利要求102所述的系统，其特征在于，所述节点交换机还包括：应答包标签表，用于将接收的城域应答标签包分别导向到相应上行端口 ；应答包标签表初始化模块，用于当节点交换机上电时，设置所有城域应答标签包的导 向关闭；应答包标签表更新模块，用于当节点交换机收到城域服务器发送的城域查询标签包 后，修改自身的应答包标签表，将所述协议标签对应的城域应答标签包导向到接收该城域 查询标签包的上行端口 ；还用于当节点交换机接入城域网后，根据城域服务器的指令，修改 自身的应答包标签表，将城域服务器新分配的各待用协议标签对应的城域应答标签包分别 导向到相应上行端口 ；其中，所述新分配的待用协议标签用于描述所述下级网络设备的下 级连接设备到城域服务器的连接，所述下级连接设备包括下级节点交换机和节点服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="104" class="claim">
      <div class="claim-text">104.如权利要求102或103所述的系统，其特征在于，所述城域服务器还包括：协议包标签表，用于将城域协议包分别导向到相应下行端口，所述城域协议包包括城 域服务器发送的城域查询标签包；协议包标签表初始化模块，用于当城域服务器上电时，在其内部的协议包标签表中设 置所有城域协议包的导向关闭；协议包标签表配置模块，用于在所述下级网络设备入网时，协议标签分配模块对应下 行端口个数分配待用协议标签后，修改所述协议包标签表，将所分配的各待用协议标签对 应的城域协议包分别导向到城域服务器的相应下行端口 ；其中，所述待用协议标签用于描 述城域服务器到所述下级网络设备的连接。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="105" class="claim">
      <div class="claim-text">105.如权利要求104所述的系统，其特征在于，所述城域服务器还包括：所述协议标签分配模块，还用于当所述下级网络设备入网之后，为所述下级网络设备 的下级连接设备新分配待用协议标签；所述协议包标签表更新模块，还用于修改城域服务器的协议包标签表，将新分配的各 待用协议标签对应的城域协议包分别导向到城域服务器的相应下行端口；其中，所述新分配的待用协议标签用于描述城域服务器到所述下级网络设备的下级连 接设备的连接，所述城域协议包包括城域服务器发送的城域查询标签包。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="106" class="claim">
      <div class="claim-text">106.如权利要求104所述的系统，其特征在于，所述城域服务器还包括：应答包标签表，用于城域服务器上电时，设置所有的城域应答标签包导向CPU模块。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="107" class="claim">
      <div class="claim-text">107.如权利要求100所述的系统，其特征在于，当入网的下级网络设备为节点交换机 时，该节点交换机的某个下级连接设备接入城域网，所述下级连接设备包括节点交换机和 节点服务器，所述系统还包括：位于城域服务器的城域查询标签包发送模块，用于使用新分配的待用协议标签向各下 级连接设备发送城域查询标签包，所述城域查询标签包根据协议包标签表被分别导向到城 域服务器的相应下行端口；位于下级连接设备的城域应答标签包回复模块，用于在上电后，收到所述城域查询标 签包，然后向城域服务器返回城域应答标签包，所述城域应答标签包中包含该下级连接设 备的序列号和收到城域查询标签包的端口号；位于城域服务器的注册验证模块，用于在收到所述城域应答标签包后，根据包中的序 列号验证下级连接设备是否注册；位于城域服务器的入网通知模块，用于在所述下级连接设备已注册时，向下级连接设 备发送入网命令，所述入网命令中包含城域服务器为下级连接设备分配的城域网地址和所 述待分配的协议标签；位于下级连接设备的入网应答模块，用于在收到入网命令后，返回入网命令应答。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="108" class="claim">
      <div class="claim-text">108.如权利要求107所述的系统，其特征在于，城域服务器与下级连接设备之间的下 级网络设备接收到所述城域查询标签包和入网命令后，根据自身的协议包标签表，将所述 城域查询标签包和入网命令导向到相应下行端口进行转发；城域服务器与下级连接设备之间的下级网络设备接收到所述城域应答标签包和入网 命令应答后，根据自身的应答包标签表，将所述城域应答标签包和入网命令应答导向到相 应上行端口进行转发。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="109" class="claim">
      <div class="claim-text">109.如权利要求99所述的系统，其特征在于，城域服务器设置有标签信息表，标签信 息表的每个表项记录了标签占用信息、标签描述信息和标签路由信息，其中所述标签路由 信息包括该标签上一跳交换机的城域网地址及端口号。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="110" class="claim">
      <div class="claim-text">110.如权利要求99所述的系统，其特征在于，城域服务器设置有地址信息表，地址信 息表的每个表项记录了城域网地址占用信息、设备描述信息和设备资源信息，其中设备资 源信息包括该设备各个网络端口连接的下级网络设备的城域网地址和该设备各个网络端 口的上下行流量计数。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="111" class="claim">
      <div class="claim-text">111.如权利要求99所述的系统，其特征在于，城域服务器设置有设备信息表，设备信 息表的每个表项记录了设备标识、设备状态和设备地址。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="112" class="claim">
      <div class="claim-text">112.如权利要求111所述的系统，其特征在于，所述节点服务器还包括：内容-地址映射表，用于记录服务内容与接入网地址的映射关系，所述服务内容信息 包括服务号码；其中，接入网地址为每个节点服务器为其下连接的入网设备分配的地址；所述跨越城域网的服务申请涉及第一终端和第二终端；当节点服务器收到连接其下的 第一终端发起的服务申请包，包中包含服务类型信息、服务内容信息以及第一终端接入网 地址，在内容-地址映射表中查找所述服务号码，如果没有查找到，则判断第二终端不连接 在该节点服务器下，则添加协议标签向城域服务器发出服务申请包；否则，第二终端连接在 该节点服务器下。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="113" class="claim">
      <div class="claim-text">113.根据权利要求112所述的系统，其特征在于，所述城域服务器还包括：内容-地址映射表，用于记录服务内容与城域网地址的映射关系，所述服务内容信息 包括服务号码；当城域服务器收到连接第一终端的节点服务器发送的包含服务类型信息、服务内容信息以及第一终端接入网地址的服务申请包时，在内容-地址映射表中查找所述服务号码对 应的城域网地址，并判断第二终端连接在另一节点服务器下。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="114" class="claim">
      <div class="claim-text">114.根据权利要求113所述的系统，其特征在于，所述城域服务器还包括：通信链路获取模块，用于根据地址信息表中设备各个网络端口连接的下级网络设备的 城域网地址，获得当次服务在城域网的通信链路信息；所述通信链路信息为单向通信链路 信息，或者为双向通信链路信息；则数据标签分配模块分配当次服务的数据标签，并分别向通信链路上的下级网络设备 发送包含所述数据标签信息的标签分配包；所述标签分配包包含入标签、出标签和导向端 口，所述下级网络设备包括节点交换机和节点服务器。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="115" class="claim">
      <div class="claim-text">115.根据权利要求114所述的系统，其特征在于，所述节点服务器还包括：数据包标签表，用于将节点服务器发给城域网的数据包分别导向到相应上行端口 ；数据包标签表配置模块，用于针对每个跨越城域网的服务申请，根据城域服务器发送 的标签分配包，设置针对该服务的入标签、出标签和导向端口 ；所述数据包标签表用于将节 点服务器从接入网接收的数据包导向到相应端口，并添加所设置的对应出标签发送到城域 网；所述数据包标签表包括单播数据包标签表和组播数据包标签表，分别用于导向单播标 签数据包和组播数据标签包。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="116" class="claim">
      <div class="claim-text">116.根据权利要求114所述的系统，其特征在于，所述节点交换机还包括：数据包标签表，用于将接收的标签数据包分别导向到相应端口 ；数据包标签表配置模块，用于针对每个跨越城域网的服务申请，根据城域服务器发送 的标签分配包，设置针对该服务的入标签、出标签和导向端口 ；所述数据包标签表用于将节 点交换机以所设置的入标签接收的标签数据包导向到相应端口，并使用所设置的对应出标 签发送。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="117" class="claim">
      <div class="claim-text">117.根据权利要求115所述的系统，其特征在于，所述节点服务器还包括：地址-标签映射表，用于针对每个跨越城域网的服务，记录跨越城域网的两个终端的 接入网地址与出标签的绑定关系；其中，接入网地址为每个节点服务器为其下连接的入网 设备分配的地址；则所述标签添加模块依据地址_标签映射表，查找节点服务器发给城域网的协议包或 数据包对应的出标签，并添加查找到的出标签发送。</div>
    </div>
    </li> <li class="claim-dependent"> <div num="118" class="claim">
      <div class="claim-text">118.根据权利要求117所述的系统，其特征在于，所述节点服务器还包括：数据包地址表，用于将数据包导向到相应下行端口，所述数据包包括从城域网接收的 数据包；连接第二终端的节点服务器根据包中的接入网目的地址，在其内部的数据包地址表中 设置目的地址是该接入网目的地址的数据包导向的端口 ；连接第一终端的节点服务器根据 包中的接入网源地址，在其内部的数据包地址表中设置目的地址是该接入网源地址的数据 包导向的端口。</div>
    </div>
  </li> </ol>
  </div></div><div class="patent-section patent-description-section"><div class="patent-section-header"><span class="patent-section-title"> 说明</span></div><div class="patent-text"><div mxw-id="PDES39930876" lang="ZH" load-source="patent-office" class="description">
    <p>一种新型网的通信方法及系统</p>
    <p>技术领域</p>
    <p>[0001]	本发明涉及通信网络的技术领域，特别是涉及一种新型网的通信方法及一种新型 网的通信系统。</p>
    <p>背景技术</p>
    <p>[0002]	新型网络（包括互联网）使得不同的个人和机构之间能够交换信息和其他信 息资源。网络通常包括通路、传输、信令以及网络管理等技术。这些技术已广泛地见诸 于各类文献。对此作了概括介绍的有：Steven Sh印herd所著的《Telecommunications Convergence》 （McGrgw&#8212;Hill，2000)， Armabel Ζ. Dodd PJf M 白勺《The Essential Guide, to Telecommunications》第三版（Prentice Hall PRT,2001),或 Ray Horak 所著的 ((Communications Systems and Networks》第二版(M&amp;T Books，2000)。这些技术以往取得 的进展已经充分地增进了信息传输的速度和质量，并降低了其费用。</p>
    <p>[0003]	连接终端到一个广域传输网络的通路技术（如终端装置和网络边缘的局域环路） 已经从14. 4,28. 8和56K的调制解调器发展到包括ISDN、T1、线缆调制解调器、DSL、以太网 和无线连接在内的技术。</p>
    <p>[0004]	现今用在广域网中的传输技术包括：同步光纤网（SONET)、密集波分复用（DWDM)、 帧中继、异步传输模式（ATM)和弹性分组环（RPR)。</p>
    <p>[0005]	在所有不同的信令技术中（如在网络中用来建立、维持和终结通信的协议和方 法），互联网协议（IP)的应用最为广泛。事实上，几乎所有的通信和网络专家认为集声音 (如电话）、视频和数据网于一体的一个基于IP协议的网络（如互联网）将是不可避免的。 就像一位作者所阐述的那样：“有一件事是清楚的，那就是以IP为基础的整合各类网络于 一体的列车已经驶离了车站，有些乘客对此次旅行极具热情，而另一些则很不情愿地被拖 拽而行，并哭、叫、踢打着列举IP的种种缺陷。但是不管它有着何种缺陷，IP已被采纳为 一种行业标准，除了它以外没有任何其他的技术具有如此大的潜力和发展的空间。”（摘自 1998 年 8 月 10 日((Network World》上的 “IP Convergence =Building the Future”，作者 Susan Breidenbach)。</p>
    <p>[0006]	随着Internet的业务爆炸式增长，其应用范围已扩展到社会的各个领域和各个 行业。从电信业来看，传统的电信业务已越来越多地采用IP传输，即所谓的Everything Over IP。现有的电信网的框架将从电路交换及其组网技术，逐步转向以分组交换特别是IP 为基础的新框架，电信网承载的业务将从以电话为主，转向以数据业务为主。</p>
    <p>[0007]	TCP/IP网络协议</p>
    <p>[0008]	TCP/IP (Transmission Control Protocol/Internet Protocol，传输控制协议 / 网间网协议）是目前世界上应用最为广泛的协议，它的流行与Internet的迅猛发展密切相 关-TCP/IP最初是为互联网的原型ARPANET所设计的，目的是提供一整套方便实用、能应用 于多种网络上的协议，事实证明TCP/IP做到了这一点，它使网络互联变得容易起来，并且 使越来越多的网络加入其中，成为Internet的事实标准。[0009]	*应用层-应用层是所有用户所面向的应用程序的统称。TCP/IP协议族在这一层 面有着很多协议来支持不同的应用，许多大家所熟悉的基于Internet的应用的实现就离 不开这些协议。如我们进行万维网（WWW)访问用到了 HTTP协议、文件传输用FTP协议、电子 邮件发送用SMTP、域名的解析用DNS协议、远程登录用Telnet协议等等，都是属于TCP/IP 应用层的；就用户而言，看到的是由一个个软件所构筑的大多为图形化的操作界面，而实际 后台运行的便是上述协议。</p>
    <p>[0010]	*传输层-这一层的的功能主要是提供应用程序间的通信，TCP/IP协议族在这一 层的协议有TCP和UDP。</p>
    <p>[0011]	*网络层-是TCP/IP协议族中非常关键的一层，主要定义了 IP地址格式，从而能 够使得不同应用类型的数据在Internet上通畅地传输，IP协议就是一个网络层协议。</p>
    <p>[0012]	*网络接口层_这是TCP/IP软件的最低层，负责接收IP数据包并通过网络发送 之，或者从网络上接收物理帧，抽出IP数据报，交给IP层。</p>
    <p>[0013]	IP是怎样实现网络互连的？各个厂家生产的网络系统和设备，如以太网、分组交 换网等，它们相互之间不能互通，不能互通的主要原因是因为它们所传送数据的基本单元 (技术上称之为“帧”）的格式不同。IP协议实际上是一套由软件程序组成的协议软件，它 把各种不同“帧”统一转换成“IP数据包”格式，这种转换是因特网的一个最重要的特点，使 所有各种计算机都能在因特网上实现互通，即具有“开放性”的特点。</p>
    <p>[0014]	那么，“数据包”是什么？它又有什么特点呢？数据包也是分组交换的一种形式， 就是把所传送的数据分段打成“包”，再传送出去。但是，它属于“无连接型”，是把打成的每 个“包”（分组）都作为一个“独立的报文”传送出去，所以叫做“数据包”。这样，在开始通 信之前就不需要先连接好一条电路，各个数据包不一定都通过同一条路径传输，所以叫做 “无连接型”。这一特点非常重要，在文本信息传输的情况下，它大大提高了网络的坚固性和 安全性。</p>
    <p>[0015]	每个数据包都有报头和报文这两个部分，报头中有目的地址等必要内容，使每个 数据包不经过同样的路径都能准确地到达目的地。在目的地重新组合还原成原来发送的数 据。这就要IP具有分组打包和集合组装的功能。</p>
    <p>[0016]	在实际传送过程中，数据包还要能根据所经过网络规定的分组大小来改变数据包 的长度，IP数据包的最大长度可达65535个字节。</p>
    <p>[0017]	服务品质保证（QoS)是IP互联网的一个主要问题。尽管长期以来无数个研究报 告试图解决这一难题，如果我们将QoS主要里程碑按时间排列，不难看出互联网QoS是不断 降低要求，并不断失败的无奈历史。从“Inte Serv" (1990)到“Diff Serv，，（1997)，再至Ij “Lightload”（2001)，各种看似有效的QoS局部改善方案加起来，距离全网范围品质保证的 目标还是像水中的月亮。QoS看起来很近，其实遥不可达。</p>
    <p>[0018]	早在IP互联网初期阶段，视讯应用已经成为网络服务的目标，如MBone。由于缺 乏有效的品质保证，长期无法开展有商业价值的视频通讯服务，削弱了 IP互联网的盈利能 力。因此，解决网络传输品质难题，具有很大的商业价值。网络传输品质具体表现为丢包和 误码。电脑文件对于传输中的错误不敏感，就算传输过程中大部分数据包都丢掉了，只要有 TCP的重发机制，电脑还是会认为网络是可用的。但是，若丢包和误码率高于千分之一，对同 步视讯将会造成视音品质下降。经验数据告诉我们，高品质视频通讯甚至要求丢包和误码少于十万分之一。当前网络环境的测试数据显示，绝大部分丢包发生在路由器内部，在光纤 传输中产生的误码几乎可以忽略不计。</p>
    <p>[0019]	*为什么“ Inte Serv”不成功？</p>
    <p>[0020]	"Inte Serv”建立在独立流资源预留的基础上，采用Resource Reservation SetupProtocol (RSVP)。在一个大规模网络环境中，如果能在两个视讯终端之间预留一部分 带宽资源，为该视讯业务专用。听起来很好，但实际上行不通。</p>
    <p>[0021]	首先，这个方案要求全网设备改造，等于重新建网，实际操作几乎不可能。</p>
    <p>[0022]	其次，就算实现了全网改造，比如能够在每一台交换机内，为2Mbps的视讯业务保 留2Mbps带宽，能否解决品质保证呢？答案是否定的。</p>
    <p>[0023]	所谓RSVP的2Mbps带宽只能对宏观而言，如果1秒钟的数据集中在前半秒发送， 就会造成问题，形成周期性的突发流量。由于，IP互联网的核心理念是尽力而为，在每一个 网络节点，交换机总是试图以最快速度转发数据。当一个视讯流通过多级交换机后必然导 致流量分布不均&#21243;。多个不均&#21243;的非同步流合在一起，在一段时间内将产生更大的不均&#21243;， 也就是说，网络流量一定有周期性的阻塞。随着视讯用户数增加，周期性的阻塞没有上限， 当超过交换机内部储存量，直接导致丢包后果。</p>
    <p>[0024]	*为什么“Diff Serv”不成功？</p>
    <p>[0025]	在“Inte Serv”问世7年后，一种新方法“Diff Serv”开始流行。"Diff Serv”试 图提供一种优于尽力而为的网络服务。这一方法不需要复杂的全网资源预留，实施很简单。 只要在每个数据包中打上“优先级”标记，网络交换机首先处理带有“优先级”的视讯数据。 其基本原理好比银行为VIP客户发放金卡，能够有效减少高端客户的排队时间。这个方法 听起来也很好，但实际上还是行不通。</p>
    <p>[0026]	我们不能忽视一个简单的事实，单一视讯业务流量远远大于传统非视讯业务（百 倍以上）。</p>
    <p>[0027]	只要有少量视讯用户，网络上看到的几乎都是视讯数据包。如果大部分数据包都 有金卡，也就谈不上VIP 了。另外由于IP互联入网理不是强制性的，尽管QoS为用户制定 了一套独善其身的道德标准，但要求别人都自觉执行根本不现实。</p>
    <p>[0028]	因此，“Diff Serv”除了在少数企业专网中有用，难以在大规模公网中有效推广。</p>
    <p>[0029]	* 为什么 “Light load” 不成功？</p>
    <p>[0030]	自从IP互联网逐步普及以来，人们不间断地寻找解决网络品质保证的良方。网络 技术专家们经过10多年搜肠刮肚，两大QoS方案均不理想。在对于解决QoS失去信心的大 环境下，一些不愿留名的人提出了不是办法的办法，即“Light load”。其基本设想是所谓的 轻载网络，认为只要给足带宽，光纤入户，就不担心网络拥塞。</p>
    <p>[0031]	轻载网络的设想可行吗？答案还是否定的。</p>
    <p>[0032]	当前的网络技术专家们似乎没有意识到一个基本原理，网络丢包现象的根源是流 量不均&#21243;性造成的。从宏观上看，在一个时间段发送略快一点，必然导致另一时间段的拥 挤，只要网络流量不均&#21243;，网络可能达到的峰值流量就没有上限，在短时间内可以占满任意 大的带宽。</p>
    <p>[0033]	其实，只要有2Mbps带宽就可以传输相当不错的视讯节目，若有8Mbps带宽，就可 以传输HDTV品质的视讯内容。然而，如果我们在普通网站上随意点看一段文字或一幅照片，现今的网站服务器多数使用千兆网口，其瞬间流量是HDTV的数十倍。如果有许多个类 似网站，刚巧碰撞在一起，在某个短时间产生的突发流量会超过全网用户使用HDTV所需， 能够占满任意宽的网络。统计分析显示，这种碰撞是很频繁的。</p>
    <p>[0034]	IP互联网试图采用储存器来吸收瞬间流量，其后果是增加了传输时延。由于储存 能力有限，而突发流量没有上限。因此，采用储存方法只能改善本设备丢包的机会，在本节 点吸收的突发流量将对下一个节点造成更大的压力。视讯流量源源不断，交换机储存方式 加剧了突发流向薄弱节点汇聚，网络丢包不可避免。</p>
    <p>[0035]	当前的网络建设者们，采用轻载加上“Diff Serv”技术，可以应付窄带的VoIP语 音业务。这是因为语音在网络总流量中不占主要部分，一旦发生拥挤，牺牲电脑文件，对语 音优先。但是，对于高带宽的视频通讯而言，局部扩容只能收到暂时改善的效果。如果其他 地方也扩容，网络流量的不均&#21243;性跟着水涨船高，导致原先已扩容部分的效果下降。如果全 网都平均扩容的话，传输品质又将恢复到原先没有扩容前的样子。也就是说，整体扩容是无 效的。</p>
    <p>[0036]	当前的设备厂商推荐每户数十，乃至上百兆的超宽带接入网，就算每家都有了光 纤到户，还是难以向消费者展示品质保证的视频通讯服务。再复杂的QoS手段充其量只能 “改善” IP互联网的传输品质，而无法“保证”网络传输品质。</p>
    <p>发明内容</p>
    <p>[0037]	本发明所要解决的技术问题是提供一种新型网的通信方法，用以保证传输通路的 稳定和通畅，避免多媒体业务的延时，保证国家信息安全的需求，节约硬件资源，从而保证 网络传输品质。</p>
    <p>[0038]	本发明实施例还提供了一种新型网的通信系统，用以保证上述方法在实际中的实 现及应用。</p>
    <p>[0039]	为了解决上述技术问题，本发明实施例公开了一种新型网的通信方法，所述新型 网为具有集中控制功能的网络，包括主控服务器和下级网络设备，所述下级网络设备包括 终端，所述的方法包括：</p>
    <p>[0040]	主控服务器配置当次服务的下行通信链路；</p>
    <p>[0041]	将源终端发送的当次服务的数据包，按照所述下行通信链路传送至目标终端。</p>
    <p>[0042]	本发明所指新型网是一种集中控制的网络结构，该网络可以是树型网、星型网、环 状网等等类型，但在此基础上网络中需要有集中控制节点来控制整个网络。</p>
    <p>[0043]	新型网分为接入网和城域网两部分。接入网部分的设备主要可以分为3类：节点 服务器，接入交换机，终端（包括各种机顶盒、编码板、存储器等）。其中，节点服务器是接入 网中起集中控制功能的节点，可控制接入交换机和终端。节点服务器可直接与接入交换机 相连，也可以直接与终端相连。类似的，城域网部分的设备也可以分为3类：城域服务器，节 点交换机，节点服务器。其中，节点服务器即为接入网部分的节点服务器，即节点服务器既 属于接入网部分，又属于城域网部分。城域服务器是城域网中起集中控制功能的节点，可控 制节点交换机和节点服务器。城域服务器可直接连接节点交换机，也可直接连接节点服务 器。由此可见，整个新型网络是一种分层集中控制的网络结构，而节点服务器和城域服务器 下控制的网络可以是树型、星型、环状等各种结构。[0044]	需要说明的是，在本发明实施例中，对于所述通信链路的配置方式、上行通信链 路的配置及使用方式，以及，数据包的类型均不加以限制，例如，所述上行通信链路可以采 用由主控服务器通知上行链路中的接入交换机开放固定端口的方式，也可以采用广播的方 式，本领域技术人员根据实际情况任意采用均可。</p>
    <p>[0045]	作为本发明的一种优选实施例，所述配置当次服务的下行通信链路包括：通知当 次服务的下行通信链路所涉及的交换设备配表；</p>
    <p>[0046]	所述按照所述下行通信链路传送包括：查询所配置的表，交换设备对所接收的数 据包通过相应端口进行传送。</p>
    <p>[0047]	即本发明实施例的核心构思之一在于，通过由主控服务器通知交换设备针对当次 服务的下行通信链路配表，然后基于该配置的表进行数据包的传送。</p>
    <p>[0048]	在具体实现中，所述服务包括单播通信服务和组播通信服务。即无论是组播通信 还是单播通信，都可以采用上述配表-用表的核心构思实现新型网中的通信。</p>
    <p>[0049]	如前所述，本发明的新型网包括接入网部分，在接入网中，所述主控服务器为节点 服务器，所述下级网络设备包括接入交换机和终端。</p>
    <p>[0050]	对于接入网中的单播通信服务而言，所述主控服务器配置当次服务的下行通信链 路的步骤可以包括以下步骤：</p>
    <p>[0051]	主控服务器依据源终端发起的服务请求协议包，获取当次服务的下行通信链路信 息，所述下行通信链路信息包括，参与当次服务的主控服务器和接入交换机的下行通信端 口信息；</p>
    <p>[0052]	主控服务器依据所述主控服务器的下行通信端口信息，在其内部的数据包地址表 中设置当次服务的数据包所导向的下行端口；并依据所述接入交换机的下行通信端口信 息，向相应的接入交换机发送端口配置命令；</p>
    <p>[0053]	所述接入交换机依据端口配置命令在其内部的数据包地址表中，设置当次服务的 数据包所导向的下行端口。</p>
    <p>[0054]	即由节点服务器主控，依据获取的下行通信链路自己配表，并通知接入交换机配表。</p>
    <p>[0055]	优选的，通信链路信息也可以不包括参与当次服务的节点服务器的通信端口信 息。例如，如果源终端和目标终端接在同一个接入交换机下，则节点服务器可以仅配置接入 交换机的数据包导向端口，在源终端和目标终端进行服务通信时，接入交换机依据该内部 的数据包地址表的设置，直接通过该接入交换机相应的下行端口传送数据包，即源终端和 目标终端可以在其共同连接的接入交换机下直接进行服务通信，而无需将数据包上传至节 点服务器，再由节点服务器下发至相应的终端，有效节省了带宽和路由资源。</p>
    <p>[0056]	在本发明实施例中，所述下级网络设备地址分别具有对应的接入网地址，作为一 种具体应用的示例，所述主控服务器获取当次服务的下行通信链路信息的步骤可以包括如 下子步骤：</p>
    <p>[0057]	主控服务器获得源终端发起的、用于与目标终端建立单播通信服务的服务请求协 议包，所述服务请求协议包中包括服务类型信息，服务内容信息，以及，源终端的接入网地 址，其中，所述服务内容信息包括服务号码；</p>
    <p>[0058]	主控服务器依据所述服务号码在预置的内容_地址映射表中提取目标终端的接</p>
    <p>26入网地址；</p>
    <p>[0059]	主控服务器依据所述服务类型信息、源终端和目标终端的接入网地址，获取当次 服务的下行通信链路信息。</p>
    <p>[0060]	在实际中，所述主控服务器在其内部的单播数据包地址表中设置当次服务的单播 数据包所导向的下行端口包括：</p>
    <p>[0061]	目的地址为源终端的单播数据包所导向的下行端口 ；</p>
    <p>[0062]	和/或，目的地址为目标终端的单播数据包所导向的下行端口。</p>
    <p>[0063]	对于单播通信服务而言，所述通信链路信息可以为单向通信链路信息，如源终端 向目标终端发起单播服务请求，或者，目标终端向源终端发起单播服务请求；或者，所述通 信链路信息也可以为双向通信链路信息，如源终端和目标终端互相向对端发起单播服务请 求。</p>
    <p>[0064]	当所述通信链路信息为单向通信链路信息时，所述接入交换机的通信端口信息 包括上行链路中接入交换机的上行端口信息，以及，下行链路中接入交换机的下行端口信 息；</p>
    <p>[0065]	所述接入交换机依据端口配置命令在其内部的单播数据包地址表中设置的当次 服务的单播数据包所导向的端口包括：</p>
    <p>[0066]	目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口 和下行链路中接入交换机的下行端口。</p>
    <p>[0067]	当所述通信链路信息为双向下行通信链路信息时，所述接入交换机的通信端口信 息包括上行链路中接入交换机的上行端口和下行端口信息，以及，下行链路中接入交换机 的上行端口和下行端口信息；</p>
    <p>[0068]	所述接入交换机依据所述端口配置命令在其内部的单播数据包地址表中设置的 当次服务的单播数据包所导向的端口包括：</p>
    <p>[0069]	目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口 和下行端口 ；以及，目的地址为源终端的单播数据包所导向的下行链路中接入交换机的上 行端口的下行端口。</p>
    <p>[0070]	作为本发明的一种优选实施例，所述当次服务的数据包中包括目标终端的接入网 地址，所述按照下行通信链路传送当次服务的数据包至目标终端的步骤包括以下子步骤：</p>
    <p>[0071]	主控服务器依据所述目标终端的接入网地址，在其内部的数据包地址表中查找当 次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至相应的接入交换 机；</p>
    <p>[0072]	所述接入交换机依据所述目标终端的接入网地址，在其内部的数据包地址表中查 找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至目标终端。</p>
    <p>[0073]	对于单播通信服务而言，数据包不仅可以由源终端传送至目标终端，也可以由目 标终端传送至源终端，即作为本发明另一优选实施例，所述的方法还包括以下步骤：</p>
    <p>[0074]	将目标终端发送的当次服务的数据包，按照所述下行通信链路传送至源终端。</p>
    <p>[0075]	在这种情况下，所述当次服务的数据包中包括源终端的接入网地址，所述按照下 行通信链路传送当次服务的数据包至源终端的步骤可以包括以下子步骤：</p>
    <p>[0076]	主控服务器依据所述源终端的接入网地址，在其内部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至相应的接入交换 机；</p>
    <p>[0077]	所述接入交换机依据所述源终端的接入网地址，在其内部的数据包地址表中查找 当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送至源终端。</p>
    <p>[0078]	对于接入网中的组播通信服务而言，所述主控服务器获取当次服务的下行通信链 路信息的步骤可以包括以下子步骤：</p>
    <p>[0079]	主控服务器获得目标终端发起的申请组播通信服务的服务请求协议包，所述服务 请求协议包中包括服务类型信息、服务内容信息和目标终端的接入网地址；其中，所述服务 内容信息中包括服务号码；</p>
    <p>[0080]	主控服务器依据所述服务号码在预置的内容-地址映射表中，提取源终端的接入 网地址；</p>
    <p>[0081]	主控服务器获取所述源终端对应的组播地址，并分配给目标终端；以及，依据所述 服务类型信息、源终端和目标终端的接入网地址，获取当次组播服务的通信链路信息。</p>
    <p>[0082]	作为另一种组播通信服务的示例，所述主控服务器获取当次服务的下行通信链路 信息的步骤还可以包括以下子步骤：</p>
    <p>[0083]	主控服务器获得源终端提交的发起组播通信服务的服务请求协议包，并依据所述 服务请求协议包向源终端分配组播地址；所述服务请求协议包中包括服务类型信息，服务 内容信息，以及，源终端的接入网地址，其中，所述服务内容信息中包括服务号码；</p>
    <p>[0084]	依据服务类型信息，以及，主控服务器与所述源终端的接入网地址，获取当次组播 服务上行的通信链路信息。</p>
    <p>[0085]	作为另一种组播通信服务的示例，所述主控服务器获取当次服务的下行通信链路 信息的步骤还可以包括以下子步骤：</p>
    <p>[0086]	依据服务类型信息，以及，主控服务器与所述源终端的接入网地址，获取当次组播 服务下行的通信链路信息。</p>
    <p>[0087]	由于节点服务器作为接入网中的主控节点，组播服务通信只涉及节点服务器的下 行端口，因而所述主控服务器在其内部的组播数据包地址表中设置当次服务的组播数据包 所导向的端口包括：</p>
    <p>[0088]	目的地址为组播地址的组播数据包所导向的下行端口。</p>
    <p>[0089]	在一种典型组播服务的示例中，如目标终端请求收看直播，所述接入交换机的通 信端口信息包括上行链路中接入交换机的上行端口信息，以及，下行链路中接入交换机的 下行端口信息；</p>
    <p>[0090]	所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的 当次服务的组播数据包所导向的端口包括：</p>
    <p>[0091]	目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的上行端口 和下行链路中接入交换机的下行端口。</p>
    <p>[0092]	作为另一种组播服务器的示例，如源终端发起直播时自己收看直播，所述接入交 换机的通信端口信息还包括上行链路中接入交换机的下行端口信息；</p>
    <p>[0093]	所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的 当次服务的组播数据包所导向的端口包括：[0094]	目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的下行端口。</p>
    <p>[0095]	对于组播通信服务而言，所述当次服务的数据包中通常包括有组播地址，在本发 明的一种优选实施例中，所述按照下行通信链路传送当次服务的数据包的步骤可以包括以 下子步骤：</p>
    <p>[0096]	主控服务器依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据 包所导向的下行端口，并将该数据包通过该下行端口传送至下行链路中相应的接入交换 机；</p>
    <p>[0097]	所述接入交换机依据所述组播地址，在其内部的数据包地址表中查找当次服务的 数据包所导向的下行端口，并将该数据包通过该下行端口传送至目标终端。</p>
    <p>[0098]	对于不同的组播通信服务，所述按照下行通信链路传送当次服务的数据包的步骤 还可以包括以下子步骤：</p>
    <p>[0099]	依据源终端发送的当次服务数据包中的组播地址，将所述数据包导向至上行链路 中的接入交换机；</p>
    <p>[0100]	所述接入交换机依据所述组播地址，在其内部的数据包地址表中查找当次服务的 数据包所导向的上行端口，并将该数据包通过该上行端口传送至主控服务器。</p>
    <p>[0101]	或者，所述按照下行通信链路传送当次服务的数据包的步骤还可以进一步包括以 下子步骤：</p>
    <p>[0102]	主控服务器依据所述组播地址，在其内部的数据包地址表中查找当次服务的数据 包所导向的下行端口，并将该数据包通过该下行端口传送至上行链路中相应的接入交换 机；</p>
    <p>[0103]	所述接入交换机依据所述组播地址，在其内部的数据包地址表中查找当次服务的 数据包所导向的下行端口，并将该数据包通过该下行端口传送至源终端。</p>
    <p>[0104]	在具体实现中，如果主控服务器获得多条当次服务的通信链路信息，则按照预置 规则选择其中一条通信链路信息为当次服务的通信链路信息。作为示例，所述预置规则可 以为节点服务器获取各条通信链路的流量信息，以及，当次服务的流量信息，确定已用流量 最小的通信链路为当次服务的通信链路信息；或者，所述预置规则还可以为节点服务器获 取各条通信链路的带宽信息，以及，当次服务的带宽信息，确定带宽最大的通信链路为当次 服务的通信链路信息。</p>
    <p>[0105]	当然，上述预置规则的设置仅仅用作示例，本发明对此不作限制。</p>
    <p>[0106]	作为一种优选的实现方式，所述端口配置命令可以记录在协议包中，所述主控服 务器依据其内部预置的下行协议包地址表的设置，通过连接相应接入交换机的下行端口将 所述协议包导向至对应的接入交换机；</p>
    <p>[0107]	其中，所述下行协议包地址表中设置有，目的地址为下级网络设备地址的协议包 所导向的下行端口。</p>
    <p>[0108]	为更好地利用资源，在完成当次服务后，本发明主控服务器还可以在其内部的数 据包地址表中，将所设置的当次服务数据包导向的端口释放；并向参与当次服务的接入交 换机发送端口释放命令；</p>
    <p>[0109]	所述接入交换机依据所述端口释放命令在其内部的数据包地址表中，将所设置的 当次服务数据包导向的端口释放。</p>
    <p>29[0110]	本发明节点服务器进行集中控制的一个主要方面在于，其具有自己的接入网地 址，并维护下级网络设备的接入网地址。在这种情况下，作为下级网络设备的接入交换机， 可以通过以下步骤接入新型网：</p>
    <p>[0111]	接入交换机上电，在其内部的下行协议包地址表中设置所有下行协议包导向CPU 模块；</p>
    <p>[0112]	所述接入交换机接收主控服务器发送的下行协议包，依据所述下行协议包地址表 的设置，将所述下行协议包导向该接入交换机的CPU模块，所述CPU模块生成上行协议包， 并发送给主控服务器；所述下行协议包中包括一个待分配的接入网地址；</p>
    <p>[0113]	主控服务器向该接入交换机发送入网命令，所述入网命令中包括该接入交换机的 接入网地址，所述接入网地址即为该接入交换机所接收下行协议包中的待分配接入网地 址；</p>
    <p>[0114]	所述接入交换机更新其内部的下行协议包地址表为，仅目的地址为自己接入网地 址的协议包导向CPU模块。</p>
    <p>[0115]	在具体实现中，往往接入交换机下还连接有其它下级接入网设备，在这种情况下， 节点服务器会向已入网的接入交换机发送端口分配包，即作为本发明的一种优选实施例， 当已入网的接入交换机接收到节点服务器发送的端口分配包时，所述接入交换机入网的过 程还包括以下步骤：</p>
    <p>[0116]	已入网的接入交换机将目的地址为自己接入网地址的端口分配包导向CPU模块；</p>
    <p>[0117]	依据包中的端口分配信息，在其内部的下行协议包地址表中，设置各个端口下行 协议包所导向的下行端口。</p>
    <p>[0118]	进一步而言，当已入网的接入交换机接收到节点服务器发送的端口下行协议包 时，所述接入交换机入网的过程还包括以下步骤：</p>
    <p>[0119]	所述接入交换机依据其内部下行协议包地址表的设置，将所述端口下行协议包导 向对应的下行端口 ；所述端口下行协议包中包括一个待分配的接入网地址；</p>
    <p>[0120]	若主控服务器接收到连接在所述接入交换机下行端口的某个下级网络设备发送 的端口上行协议包，并向该下级网络设备发送入网命令，所述入网命令中包括该下级网络 设备的接入网地址，所述接入网地址即为该下级网络设备所接收的端口下行协议包中待分 配的接入网地址；</p>
    <p>[0121]	其中，所述下级网络设备包括接入交换机或终端。</p>
    <p>[0122]	为了实现本发明的新型网与现有以太网的融合，所述接入网设备还包括，连接在 所述接入交换机与源终端、目标终端之间的以太网协转网关和局域以太网，本发明实施例 还可以包括以下步骤：</p>
    <p>[0123]	以太网协转网关入新型网，从节点服务器获得以太网协转网关的MAC地址和该以 太网协转网关下绑定的终端MAC地址；</p>
    <p>[0124]	所述以太网协转网关接收新型网发来的数据包或协议包，在所述数据包或协议包 中添加以太网协转网关的MAC地址和目标终端的MAC地址，然后发送给局域以太网；</p>
    <p>[0125]	所述以太网协转网关接收局域以太网发来的数据包或协议包，去掉所述数据包或 协议包中以太网协转网关的MAC地址和源终端的MAC地址，然后发送给新型网；</p>
    <p>[0126]	其中，所述目标终端和源终端遵循新型网协议。[0127]	需要说明的是，为了实现上述新型网与现有以太网的融合，同时为了充分利用现 有以太网协转网关的功能，本发明对标准的以太网网关进行了改造，使其成为一种特殊类 型的接入交换机，在新型网和以太网之间起着连接转换的作用。改造后的以太网网关称为 以太网协转网关。在新型网中，以太网协转网关位于接入网部分，可以与接入交换机相连， 也可以直接与节点服务器相连。在以太网中，以太网协转网关与标准的以太网交换机相连， 以太网交换机连接着终端。</p>
    <p>[0128]	即在本发明实施例中，还包括以太网协转网关接入新型网的步骤，具体为：</p>
    <p>[0129]	主控服务器下发查询包；</p>
    <p>[0130]	以太网协转网关上电初始化后，收到查询包，返回包含以太网协转网关序列号的 应答包；</p>
    <p>[0131]	主控服务器在注册信息表中查找与所述序列号对应的以太网协转网关信息，所述 以太网协转网关信息包括以太网协转网关MAC地址和该以太网协转网关下绑定的终端MAC 地址；</p>
    <p>[0132]	主控服务器向所述以太网协转网关发送入网命令，所述入网命令中包含以太网协 转网关在新型网的地址和以太网协转网关的MAC地址；</p>
    <p>[0133]	所述以太网协转网关收到入网命令后返回应答，以太网协转网关接入新型网。</p>
    <p>[0134]	在实际中，终端MAC地址和以太网协转网关的绑定关系在终端和以太网协转网关 售出时预设在节点服务器中。</p>
    <p>[0135]	在所述以太网协转网关接入新型网，获得以太网协转网关的MAC地址和该以太网 协转网关下绑定的终端MAC地址之后，所述以太网协转网关下绑定的终端还可以通过以下 步骤接入新型网：</p>
    <p>[0136]	主控服务器下发查询包；</p>
    <p>[0137]	以太网协转网关收到查询包，根据协议包地址表，将查询包导向到相应端口，然后 在所述查询包中添加以太网协转网关的MAC地址和目标终端的MAC地址，并转发；</p>
    <p>[0138]	终端上电初始化后，收到查询包，返回包含终端序列号的应答包；</p>
    <p>[0139]	以太网协转网关去掉所述应答包中的以太网协转网关MAC地址和终端MAC地址， 然后转发给主控服务器；</p>
    <p>[0140]	主控服务器在注册信息表中找到与所述终端序列号对应的终端信息，发送入网命 令，所述入网命令中包含终端在新型网的地址；</p>
    <p>[0141]	以太网协转网关收到所述入网命令，添加以太网协转网关的MAC地址和目标终端 的MAC地址后进行转发；</p>
    <p>[0142]	终端收到入网命令后返回应答，以太网协转网关去掉所述应答中的以太网协转网 关MAC地址和终端MAC地址后转发给主控服务器，终端接入新型网。</p>
    <p>[0143]	由上可知，以太网协转网关接入新型网后，会从具有集中控制功能的节点服务器 获得以太网协转网关的MAC地址和该以太网协转网关下注册的终端MAC地址，在这种情况 下，本发明实施例还可以包括以下步骤：</p>
    <p>[0144]	所述以太网协转网关接收新型网发来的数据包或协议包，在所述数据包或协议包 中添加以太网协转网关的MAC地址和目标终端的MAC地址，然后发送给以太网；</p>
    <p>[0145]	所述以太网协转网关接收以太网发来的数据包或协议包，去掉所述数据包或协议包中以太网协转网关的MAC地址和源终端的MAC地址，然后发送给新型网；</p>
    <p>[0146]	其中，所述目标终端和源终端遵循新型网协议。</p>
    <p>[0147]	即以太网协转网关接入新型网后，就可以对数据包或协议包进行加减MAC。</p>
    <p>[0148]	更具体而言，在本发明实施例中优选的是，对于添加了以太网协转网关MAC地址 和目标终端MAC地址的数据包，在以太网中采用以太网协议进行传输；对于去掉了以太网 协转网关MAC地址和源终端MAC地址的数据包，在新型网中采用新型网协议进行传输。</p>
    <p>[0149]	优选的，新型网发来的数据包和以太网发来的数据包，包头都包含传输两端在新 型网的地址，所述地址为数据包的源地址和目的地址。</p>
    <p>[0150]	在本实施例中还可以包括以下步骤：</p>
    <p>[0151]	获得以太网协转网关下绑定的终端MAC地址与终端在新型网的地址的映射；</p>
    <p>[0152]	则所述以太网协转网关接收新型网发来的数据包，根据数据包的目的地址与MAC 地址的映射，在数据包中添加对应的目标终端的MAC地址。</p>
    <p>[0153]	通过上述内容，新型网和以太网通过以太网协转网关实现了良好的兼容。此外，所 述以太网协转网关还可以具有上述接入交换机所具有的功能，例如实现精确的流量控制， 具体实现方式如下：</p>
    <p>[0154]	所述以太网协转网关接收以太网发来的数据包之后，去掉所述数据包中以太网协 转网关的MAC地址和源终端的MAC地址之前，所述的方法还包括：</p>
    <p>[0155]	对接收的数据包进行检测，如果符合检测要求，则分配相应的流标识符，所述检测 可以是：检测数据包的以太网协转网关MAC地址、源终端MAC地址、目的地址、源地址、数据 包类型和包长度是否符合要求。</p>
    <p>[0156]	进一步，所述以太网协转网关去掉所述数据包中以太网协转网关的MAC地址和源 终端的MAC地址之后，发送之前，还包括：根据流标识符将数据包放入相应的端口接收缓 存；从端口接收缓存读取数据包，并根据流标识符放入相应流的包缓存队列；轮询包缓存 队列，当产生发送令牌后，根据发送令牌中的流标识符，从相应流的包缓存队列中顺序读取 数据包，并放入端口发送缓存；从端口发送缓存读取数据包发送。</p>
    <p>[0157]	此夕卜，所述以太网协转网关还可以判断是否同时满足以下两个条件：第一，端口发 送缓存未满；第二，相应流的包缓存队列中的包计数器大于零；如果同时满足，则根据发送 令牌中的流标识符，从相应流的包缓存队列中顺序读取数据包，并放入端口发送缓存。</p>
    <p>[0158]	上述流量控制过程中，所述发送令牌通过以下方式产生：新型网中具有集中控制 功能的节点服务器根据终端发起的服务申请协议包，生成流量控制信息，并发送给上行链 路上进行流量控制的以太网协转网关，所述流量控制信息包括发送时间间隔和发送的数据 大小；以太网协转网关根据流量控制信息产生发送令牌，所述令牌中包含流标识符。</p>
    <p>[0159]	如前所述，所述新型网包括城域网部分，在城域网中，所述主控服务器为城域服务 器，所述下级网络设备包括节点交换机和节点服务器，其中所述节点交换机连接在城域服 务器和节点服务器之间；本发明实施例还可以包括以下步骤：</p>
    <p>[0160]	下级网络设备接入城域网，由城域服务器为入网的设备分配协议标签和城域网地 址；</p>
    <p>[0161]	其中，所述协议标签用于描述下级网络设备与城域服务器之间的连接；当同一个 下级网络设备与城域服务器之间有多个连接时，城域服务器为每个连接分配不同的协议标</p>
    <p>32签；</p>
    <p>[0162]	针对每个跨越城域网的服务申请，城域服务器分配对应服务的数据标签，所述数 据标签用于描述服务所涉及的节点服务器之间的连接。</p>
    <p>[0163]	其中，所述标签可以复用，包括以下两种复用情况：</p>
    <p>[0164]	其一，下级网络设备到城域服务器的协议标签与城域服务器到该下级网络设备的 协议标签为不同的标签，或者为相同标签；服务所涉及的节点服务器之间，一个节点服务器 到另一个节点服务器的数据标签与另一个节点服务器到一个节点服务器的数据标签为不 同的标签，或者为相同标签。</p>
    <p>[0165]	其二，所述标签分为入标签和出标签，入标签指数据包进入城域服务器或节点交 换机的标签，出标签指该数据包离开城域服务器或节点交换机的标签；同一个数据包的入 标签和出标签为不同的标签，或者为相同标签。</p>
    <p>[0166]	优选的，本发明的一个数据标签可以用来描述一个节点服务器到另一个节点服务 器的连接，即使这两个节点服务器的连接路径上还有节点交换机的存在；当然，对此，本发 明也可以用多个数据标签来描述这两个节点服务器的连接，每个数据标签描述该连接路径 中的一段，例如，1号节点服务器到1号节点交换机的连接用1号数据标签，1号节点交换机 到2号节点交换机的连接用2号数据标签，2号节点交换机到2号节点服务器的连接采用3 号数据标签等。</p>
    <p>[0167]	首先，说明协议标签的分配和使用，如下：</p>
    <p>[0168]	下级网络设备接入城域网，由城域服务器分配协议标签和城域网地址包括：城域 服务器向其所有下行端口发送城域查询标签包，每个城域查询标签包中包含一个城域服务 器分配的待用协议标签；某个下级网络设备上电后，收到城域服务器发送的城域查询标签 包，然后向城域服务器返回城域应答标签包，所述城域应答标签包中包含下级网络设备的 序列号和收到城域查询标签包的端口号；城域服务器收到城域应答标签包后，根据包中的 序列号验证下级网络设备是否注册，如果已注册，则向下级网络设备收到城域查询标签包 的端口发送入网命令，所述入网命令中包含城域服务器为下级网络设备分配的城域网地址 和所述待用协议标签；下级网络设备的相应端口收到入网命令后，返回入网命令应答，下级 网络设备接入城域网；其中，所述下级网络设备为节点交换机或节点服务器。</p>
    <p>[0169]	在上述下级网络设备入网过程中，标签的复用方式是：所述城域应答标签包中的 协议标签与所述城域查询标签包中的协议标签相同，所述入网命令应答中的协议标签与所 述入网命令中的协议标签相同。</p>
    <p>[0170]	特殊的，当同一个下级网络设备与城域服务器之间有多个连接时，所述同一个下 级网络设备的多个端口会收到多个城域查询标签包，每个城域查询标签包中的待用协议标 签不同；城域服务器通过多个不同的协议标签，向同一个下级网络设备的多个端口发送多 个入网命令，但每个入网命令中为该下级网络设备分配的城域网地址相同。</p>
    <p>[0171]	下级网络设备入网后，还可以配置协议包标签表，具体包括：下级网络设备设置有 协议包标签表，下级网络设备上电时，在其内部的协议包标签表中设置所有的城域协议包 导向到CPU模块；当下级网络设备为节点交换机时，节点交换机接入城域网后，根据城域服 务器的指令，修改自身的协议包标签表，将城域服务器新分配的各待用协议标签对应的城 域协议包分别导向到节点交换机的相应下行端口 ；其中，所述新分配的待用协议标签用于描述城域服务器到所述节点交换机的下级连接设备的连接，所述城域协议包包括城域服务 器发送的城域查询标签包。</p>
    <p>[0172]	下级网络设备入网后，还可以配置应答包标签表，具体包括：下级网络设备设置有 应答包标签表，下级网络设备上电时，在其内部的应答包标签表中设置所有城域应答标签 包的导向关闭；当下级网络设备收到城域服务器发送的城域查询标签包后，修改自身的应 答包标签表，将所述协议标签对应的城域应答标签包导向到接收该城域查询标签包的上行 端口 ；当下级网络设备为节点交换机时，节点交换机接入城域网后，根据城域服务器的指 令，修改自身的应答包标签表，将城域服务器新分配的各待用协议标签对应的城域应答标 签包分别导向到节点交换机的相应上行端口 ；其中，所述新分配的待用协议标签用于描述 所述节点交换机的下级连接设备到城域服务器的连接。</p>
    <p>[0173]	在本发明的一个优选实施例中，城域服务器中设置有协议包标签表，城域服务器 上电时，在其内部的协议包标签表中设置所有城域协议包的导向关闭；</p>
    <p>[0174]	城域服务器对应其自身下行端口个数分配待用协议标签，并修改自身的协议包标 签表，将所分配的各待用协议标签对应的城域协议包分别导向到城域服务器的相应下行端 Π ；</p>
    <p>[0175]	其中，所述待用协议标签用于描述城域服务器到所述下级网络设备的连接，所述 城域协议包包括城域服务器发送的城域查询标签包；所述城域服务器根据自身的协议包标 签表向其下行端口发送城域查询标签包。</p>
    <p>[0176]	相应的，下级网络设备入网后，城域服务器也可以配置自身的协议包标签表，具体 包括：</p>
    <p>[0177]	其一，城域服务器中设置有协议包标签表，城域服务器上电时，在其内部的协议包 标签表中设置所有城域协议包的导向关闭；城域服务器对应其自身下行端口个数分配待用 协议标签，并修改自身的协议包标签表，将所分配的各待用协议标签对应的城域协议包分 别导向到城域服务器的相应下行端口 ；其中，所述待用协议标签用于描述城域服务器到所 述下级网络设备的连接，所述城域协议包包括城域服务器发送的城域查询标签包；所述城 域服务器根据自身的协议包标签表向其下行端口发送城域查询标签包。</p>
    <p>[0178]	其二，当下级网络设备入网之后，城域服务器还可以为所述下级网络设备的下级 连接设备新分配待用协议标签，并修改自身的协议包标签表，将新分配的各待用协议标签 对应的城域协议包分别导向到城域服务器的相应下行端口 ；其中，所述新分配的待用协议 标签用于描述城域服务器到所述下级网络设备的下级连接设备的连接，所述城域协议包包 括城域服务器发送的城域查询标签包；所述城域服务器根据自身的协议包标签表向其下行 端口发送城域查询标签包。</p>
    <p>[0179]	相应的，下级网络设备入网后，城域服务器也可以配置自身的应答包标签表，具体 包括：城域服务器设置有应答包标签表，城域服务器上电时，在其内部的应答包标签表中设 置所有的城域应答标签包导向CPU模块。</p>
    <p>[0180]	其中，当入网的下级网络设备为节点交换机时，该节点交换机的某个下级连接设 备接入城域网，所述下级连接设备包括节点交换机和节点服务器，具体包括以下步骤：城域 服务器使用新分配的待用协议标签向各下级连接设备发送城域查询标签包，所述城域查询 标签包根据协议包标签表被分别导向到城域服务器的相应下行端口 ；下级连接设备上电</p>
    <p>34后，收到所述城域查询标签包，然后向城域服务器返回城域应答标签包，所述城域应答标签 包中包含该下级连接设备的序列号和收到城域查询标签包的端口号；城域服务器收到所述 城域应答标签包后，根据包中的序列号验证下级连接设备是否注册，如果已注册，则向下级 连接设备发送入网命令，所述入网命令中包含城域服务器为下级连接设备分配的城域网地 址和所述待分配的协议标签；下级连接设备收到入网命令后，返回入网命令应答，下级连接 设备接入城域网。</p>
    <p>[0181]	当下级网络设备配置自身的协议包标签表和应答包标签表之后，城域服务器与下 级连接设备之间的下级网络设备接收到所述城域查询标签包和入网命令后，根据自身的协 议包标签表，将所述城域查询标签包和入网命令导向到相应下行端口进行转发；城域服务 器与下级连接设备之间的下级网络设备接收到所述城域应答标签包和入网命令应答后，根 据自身的应答包标签表，将所述城域应答标签包和入网命令应答导向到相应上行端口进行 转发。</p>
    <p>[0182]	优选的，城域服务器设置有标签信息表，标签信息表的每个表项记录了标签占用 信息、标签描述信息和标签路由信息，其中所述标签路由信息包括该标签上一跳交换机的 城域网地址及端口号。</p>
    <p>[0183]	标签信息表的使用包括：</p>
    <p>[0184]	其一，当城域服务器为下级网络设备分配一个待用标签时，修改所述标签信息表 中对应该标签的表项：将标签占用信息由未用改为待用，将标签路由信息中上一跳交换机 的城域网地址及端口设为城域服务器的地址及相应端口，所述标签描述信息不做修改；当 所述下级网络设备入网后，修改所述标签信息表中对应该标签的表项：将标签占用信息改 为已用，所述标签描述信息和标签路由信息不做修改。</p>
    <p>[0185]	其二，当城域服务器为所述下级网络设备的下级连接设备分配一个待用标签时， 修改所述标签信息表中对应该标签的表项：将标签占用信息由未用改为待用，将标签路由 信息中上一跳交换机的城域网地址及端口设为所述下级网络设备的地址及相应端口，所述 标签描述信息不做修改；当所述下级连接设备入网后，修改所述标签信息表中对应该标签 的表项：将标签占用信息改为已用，所述标签描述信息和标签路由信息不做修改。</p>
    <p>[0186]	优选的，城域服务器设置有地址信息表，地址信息表的每个表项记录了城域网地 址占用信息、设备描述信息和设备资源信息，其中设备资源信息包括该设备各个网络端口 连接的下级网络设备的城域网地址和该设备各个网络端口的上下行流量计数。</p>
    <p>[0187]	地址信息表的使用包括：</p>
    <p>[0188]	其一，城域服务器上电后，为自己分配一个城域网地址，并修改所述地址信息表中 对应该地址的表项：将地址占用信息由未用改为已用，将设备描述信息改为所述城域服务 器，将设备资源信息改为所述城域服务器的资源描述。</p>
    <p>[0189]	其二，当城域服务器为下级网络设备分配城域网地址，发送包含该城域网地址的 入网命令时，修改所述地址信息表中对应该地址的表项：将地址占用信息由未用改为待用， 所述设备描述信息和设备资源信息不做修改；当城域服务器收到下级网络设备发送的入网 命令应答后，修改所述地址信息表中对应该地址的表项：将地址占用信息改为已用，将设备 描述信息改为所述下级网络设备，将设备资源信息改为所述下级网络设备的某个上行端口 连接着城域服务器的某个下行端口 ；同时，修改地址信息表中对应所述城域服务器地址的表项：将设备资源信息改为所述城域服务器的某个下行端口连接着下级网络设备的某个上 行端口，所述地址占用信息和设备描述信息不做修改；其中，所述下级网络设备的某个上行 端口根据下级网络设备返回的城域应答标签包获知，所述城域服务器的某个下行端口根据 协议包标签表获知。</p>
    <p>[0190]	其三，当城域服务器为下级网络设备的下级连接设备分配城域网地址，发送包含 该城域网地址的入网命令时，修改所述地址信息表中对应该地址的表项：将地址占用信息 由未用改为待用，所述设备描述信息和设备资源信息不做修改；当城域服务器收到所述下 级连接设备发送的入网命令应答后，修改所述地址信息表中对应该地址的表项：将地址占 用信息改为已用，将设备描述信息改为所述下级连接设备，将设备资源信息改为所述下级 连接设备的某个上行端口连接着所述下级网络设备的某个下行端口 ；同时，修改地址信息 表中对应所述下级网络设备地址的表项：将设备资源信息改为所述下级网络设备的某个 下行端口连接着下级连接设备的某个上行端口，所述地址占用信息和设备描述信息不做修 改；其中，所述下级连接设备的某个上行端口根据下级连接设备返回的城域应答标签包获 知，所述下级网络设备的某个下行端口根据协议包标签表获知。</p>
    <p>[0191]	优选的，城域服务器设置有设备信息表，设备信息表的每个表项记录了设备标识、 设备状态和设备地址。</p>
    <p>[0192]	设备信息表的使用包括：当城域服务器为下级网络设备或该下级网络设备的下级 连接设备分配城域网地址，发送包含该城域网地址的入网命令时，修改所述设备信息表中 对应设备的表项：将设备状态改为待入网，将设备地址改为所分配的城域网地址，所述设备 标识不做修改；当城域服务器收到下级网络设备或该下级网络设备的下级连接设备发送的 入网命令应答后，修改所述设备信息表中对应设备的表项：将设备状态改为已入网，所述设 备标识和设备地址不做修改。</p>
    <p>[0193]	其次，说明数据标签的分配和使用，如下：</p>
    <p>[0194]	针对每个跨越城域网的服务申请，城域服务器分配对应服务的数据标签包括：所 述跨越城域网的服务申请涉及第一终端和第二终端；连接在某个节点服务器下的第一终端 发起服务申请包，该节点服务器根据所述服务申请包判断第二终端不连接在该节点服务器 下，则添加协议标签向城域服务器发出服务申请包；城域服务器根据收到的服务申请包判 断第二终端连接在另一节点服务器下；城域服务器获得当次服务在城域网的通信链路信 息，然后分配当次服务的数据标签，并分别向通信链路上的下级网络设备发送包含所述数 据标签信息的标签分配包；其中，所述标签分配包包含入标签、出标签和导向端口，所述下 级网络设备包括节点交换机和节点服务器。</p>
    <p>[0195]	上述服务申请过程中，还可以配置数据包标签表，具体包括：城域服务器根据分配 的数据标签在其内部的数据包标签表中设置当次服务的入标签、出标签和导向端口 ；当通 信链路上的下级网络设备收到所述标签分配包后，下级网络设备根据标签分配包在其内部 的数据包标签表中设置入标签、出标签和导向端口 ；其中，城域服务器和节点交换机内部的 数据包标签表用于将各自以所设置的入标签接收的标签数据包导向到相应端口，并使用所 设置的对应出标签发送；其中，节点服务器内部的数据包标签表用于将节点服务器从接入 网接收的数据包导向到相应端口，并添加所设置的对应出标签发送到城域网。</p>
    <p>[0196]	上述服务申请过程中，节点服务器还可以配置地址-标签映射表，具体包括：城域服务器发给节点服务器的标签分配包还包括当次服务的第一终端接入网地址、第二终端接 入网地址与出标签的绑定关系；通信链路两端的节点服务器分别收到标签分配包后，在各 自内部的地址-标签映射表中设置所述绑定关系；其中，接入网地址为每个节点服务器为 其下连接的入网设备分配的地址。</p>
    <p>[0197]	上述服务申请过程中，节点服务器还可以配置自身的数据包地址表，具体包括：通 信链路两端的节点服务器分别收到标签分配包后，连接第二终端的节点服务器根据包中的 接入网目的地址，在其内部的数据包地址表中设置目的地址是该接入网目的地址的数据包 导向的端口 ；连接第一终端的节点服务器根据包中的接入网源地址，在其内部的数据包地 址表中设置目的地址是该接入网源地址的数据包导向的端口。</p>
    <p>[0198]	上述服务申请过程还包括：连接第一终端的节点服务器根据其内部的数据包地址 表，向第一终端发送服务处理命令；连接第二终端的节点服务器根据其内部的数据包地址 表，向第二终端发送服务处理命令；第一终端和第二终端分别根据接收到的服务处理命令 执行相应操作。</p>
    <p>[0199]	其中，所述通信链路信息为单向通信链路信息，或者为双向通信链路信息。</p>
    <p>[0200]	再次，在上述服务申请过程中，还可以进行流量控制，并通过流量控制来分配合适 的通信链路，具体如下：</p>
    <p>[0201]	优选的，在上述服务申请过程中，连接在某个节点服务器下的第一终端发起服务 申请包后，还包括：该节点服务器根据服务申请包的内容，检查节点服务器与第一终端之间 通信链路的剩余流量资源是否满足服务所需的流量资源，如果不满足，则向第一终端发送 服务拒绝包；如果满足，则继续判断第二终端是否连接在该节点服务器下。</p>
    <p>[0202]	优选的，在上述服务申请过程中，城域服务器获得当次服务在城域网的通信链路 信息之后，还包括：城域服务器根据服务申请包的内容，检查当次服务在城域网的通信链路 的剩余流量资源是否满足服务所需的流量资源，如果不满足，则向连接第一终端的节点服 务器发送服务拒绝包。</p>
    <p>[0203]	优选的，在上述服务申请过程中，还包括：如果满足，则城域服务器向连接第二终 端的节点服务器发送服务申请包；该节点服务器根据服务申请包的内容，检查节点服务器 与第二终端之间通信链路的剩余流量资源是否满足服务所需的流量资源，如果不满足，则 向城域服务器发送服务拒绝包。</p>
    <p>[0204]	优选的，在上述服务申请过程中，还包括：如果满足，则连接第二终端的节点服务 器向第二终端发送菜单包；第二终端收到所述菜单包，返回接受通信的应答包；该节点服 务器收到所述应答包，添加协议标签向城域服务器发送服务允许包。</p>
    <p>[0205]	其中，城域服务器设置有地址信息表，地址信息表的每个表项记录了城域网地址 占用信息、设备描述信息和设备资源信息，其中设备资源信息包括该设备各个网络端口连 接的下级网络设备的城域网地址和该设备各个网络端口的上下行流量计数；城域服务器根 据地址信息表中设备各个网络端口连接的下级网络设备的城域网地址，获得当次服务在城 域网的通信链路信息；并根据设备各个网络端口的上下行流量计数，获得当次服务在城域 网的通信链路的剩余流量资源。</p>
    <p>[0206]	其中，节点服务器设置有地址信息表，地址信息表的每个表项记录了接入网地址 占用信息、设备描述信息和设备资源信息，其中设备资源信息包括该设备各个网络端口连接的接入网设备的接入网地址和该设备各个网络端口的上下行流量计数；节点服务器根据 地址信息表中设备各个网络端口连接的接入网设备的接入网地址，获得节点服务器与终端 间的通信链路信息；并根据设备各个网络端口的上下行流量计数，获得节点服务器与终端 间的通信链路的剩余流量资源。</p>
    <p>[0207]	此外，节点服务器还设置有内容-地址映射表，其使用如下：第一终端发起的服务 申请包中包含服务类型信息、服务内容信息以及第一终端的接入网地址，其中，所述服务内 容信息包括服务号码；连接第一终端的节点服务器在其内部预置的内容_地址映射表中查 找所述服务号码，如果没有查找到，则判断第二终端不连接在该节点服务器下；否则，第二 终端连接在该节点服务器下。</p>
    <p>[0208]	此外，城域服务器还设置有内容-地址映射表，其使用如下：城域服务器收到的服 务申请包中包含服务类型信息、服务内容信息以及第一终端的接入网地址，其中，所述服务 内容信息包括服务号码；城域服务器在其内部预置的内容_地址映射表中查找所述服务号 码对应的城域网地址，并判断第二终端连接在另一节点服务器下。</p>
    <p>[0209]	本发明实施例还公开了一种新型网的通信系统，其中，所述新型网为具有集中控 制功能的网络，包括主控服务器和下级网络设备，所述下级网络设备包括终端，所述的系统 包括：</p>
    <p>[0210]	位于主控服务器的路径配置模块，用于配置当次服务的下行通信链路；以及，</p>
    <p>[0211]	第一通信模块组，用于将源终端发送的当次服务的数据包，按照所述下行通信链 路传送至目标终端。</p>
    <p>[0212]	作为本发明的一种优选实施例，所述配置当次服务的下行通信链路包括：通知当 次服务的下行通信链路所涉及的交换设备配表；</p>
    <p>[0213]	所述按照所述下行通信链路传送包括：查询所配置的表，交换设备对所接收的数 据包通过相应端口进行传送。</p>
    <p>[0214]	即本发明实施例的核心构思之一在于，通过由主控服务器通知交换设备针对当次 服务的下行通信链路配表，然后基于该配置的表进行数据包的传送。</p>
    <p>[0215]	在具体实现中，所述服务包括单播通信服务和组播通信服务。即无论是组播通信 还是单播通信，都可以采用上述配表-用表的核心构思实现新型网中的通信。</p>
    <p>[0216]	如前所述，本发明的新型网包括接入网部分，在接入网中，所述主控服务器为节点 服务器，所述下级网络设备包括接入交换机和终端。</p>
    <p>[0217]	对于接入网中的单播通信服务而言，所述路径配置模块包括：</p>
    <p>[0218]	下行链路获取子模块，用于依据源终端发起的服务请求协议包，获取当次服务的 下行通信链路信息，所述下行通信链路信息包括，参与当次服务的主控服务器和接入交换 机的下行通信端口信息；</p>
    <p>[0219]	配表子模块，用于依据所述主控服务器的下行通信端口信息，在其内部的数据包 地址表中设置当次服务的数据包所导向的下行端口；</p>
    <p>[0220]	通知子模块，用于依据所述接入交换机的下行通信端口信息，向相应的接入交换 机发送端口配置命令；由所述接入交换机依据端口配置命令在其内部的数据包地址表中， 设置当次服务的数据包所导向的下行端口。</p>
    <p>[0221]	即由节点服务器主控，依据获取的下行通信链路自己配表，并通知接入交换机配</p>
    <p>38表。</p>
    <p>[0222]	在本发明实施例中，所述下级网络设备地址分别具有对应的接入网地址，作为一 种具体应用的示例，所述下行链路获取子模块包括：</p>
    <p>[0223]	单播服务请求接收单元，用于获得源终端发起的、用于与目标终端建立单播通信 服务的服务请求协议包，所述服务请求协议包中包括服务类型信息，服务内容信息，以及， 源终端的接入网地址，其中，所述服务内容信息包括服务号码；</p>
    <p>[0224]	目标终端地址提取单元，用于依据所述服务号码在预置的内容-地址映射表中提 取目标终端的接入网地址；</p>
    <p>[0225]	单播链路计算单元，用于依据所述服务类型信息、源终端和目标终端的接入网地 址，获取当次服务的下行通信链路信息。</p>
    <p>[0226]	在实际中，所述主控服务器在其内部的单播数据包地址表中设置当次服务的单播 数据包所导向的下行端口包括：</p>
    <p>[0227]	目的地址为源终端的单播数据包所导向的下行端口 ；</p>
    <p>[0228]	和/或，目的地址为目标终端的单播数据包所导向的下行端口。</p>
    <p>[0229]	对于单播通信服务而言，所述通信链路信息可以为单向通信链路信息，如源终端 向目标终端发起单播服务请求，或者，目标终端向源终端发起单播服务请求；或者，所述通 信链路信息也可以为双向通信链路信息，如源终端和目标终端互相向对端发起单播服务请 求。</p>
    <p>[0230]	当所述通信链路信息为单向通信链路信息时，所述接入交换机的通信端口信息 包括上行链路中接入交换机的上行端口信息，以及，下行链路中接入交换机的下行端口信 息；</p>
    <p>[0231]	所述接入交换机依据端口配置命令在其内部的单播数据包地址表中设置的当次 服务的单播数据包所导向的端口包括：</p>
    <p>[0232]	目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口 和下行链路中接入交换机的下行端口。</p>
    <p>[0233]	当所述通信链路信息为双向下行通信链路信息时，所述接入交换机的通信端口信 息包括上行链路中接入交换机的上行端口和下行端口信息，以及，下行链路中接入交换机 的上行端口和下行端口信息；</p>
    <p>[0234]	所述接入交换机依据所述端口配置命令在其内部的单播数据包地址表中设置的 当次服务的单播数据包所导向的端口包括：</p>
    <p>[0235]	目的地址为目标终端的单播数据包所导向的上行链路中接入交换机的上行端口 和下行端口 ；以及，目的地址为源终端的单播数据包所导向的下行链路中接入交换机的上 行端口的下行端口。</p>
    <p>[0236]	作为本发明的一种优选实施例，所述当次服务的数据包中包括目标终端的接入网 地址，所述第一通信模块组包括：</p>
    <p>[0237]	位于主控服务器的第一查表导向模块，用于依据所述目标终端的接入网地址，在 其内部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该 下行端口传送至相应的接入交换机；</p>
    <p>[0238]	位于接入交换机的第一查表传送模块，用于依据所述目标终端的接入网地址，在其内部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该 下行端口传送至目标终端。</p>
    <p>[0239]	对于单播通信服务而言，数据包不仅可以由源终端传送至目标终端，也可以由目 标终端传送至源终端，即作为本发明另一优选实施例，所述的系统还可以包括第二通信模 块组，用于将目标终端发送的当次服务的数据包，按照所述下行通信链路传送至源终端。</p>
    <p>[0240]	在这种情况下，所述当次服务的数据包中包括源终端的接入网地址，所述第二通 信模块组包括：</p>
    <p>[0241]	位于主控服务器的第二查表导向模块，用于依据所述源终端的接入网地址，在其 内部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该 下行端口传送至相应的接入交换机；</p>
    <p>[0242]	位于接入交换机的第二查表传送模块，用于依据所述源终端的接入网地址，在其 内部的数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下 行端口传送至源终端。</p>
    <p>[0243]	对于接入网中的组播通信服务而言，所述下行链路获取子模块包括：</p>
    <p>[0244]	第一组播服务请求接收单元，用于获得目标终端发起的申请组播通信服务的服务 请求协议包，所述服务请求协议包中包括服务类型信息、服务内容信息和目标终端的接入 网地址；其中，所述服务内容信息中包括服务号码；</p>
    <p>[0245]	源终端地址提取单元，用于依据所述服务号码在预置的内容-地址映射表中，提 取源终端的接入网地址；</p>
    <p>[0246]	第一组播地址分配单元，用于获取所述源终端对应的组播地址，并分配给目标终 端；以及，</p>
    <p>[0247]	第一组播链路计算单元，用于依据所述服务类型信息、源终端和目标终端的接入 网地址，获取当次组播服务的通信链路信息。</p>
    <p>[0248]	作为另一种组播通信服务的示例，所述下行链路获取子模块还包括：</p>
    <p>[0249]	第二组播服务请求接收单元，用于获得源终端提交的发起组播通信服务的服务请 求协议包；所述服务请求协议包中包括服务类型信息，服务内容信息，以及，源终端的接入 网地址，其中，所述服务内容信息中包括服务号码；</p>
    <p>[0250]	第二组播地址分配单元，用于依据所述服务请求协议包向源终端分配组播地址；</p>
    <p>[0251]	第二组播链路计算单元，用于依据服务类型信息，以及，主控服务器与所述源终端 的接入网地址，获取当次组播服务上行的通信链路信息。</p>
    <p>[0252]	作为另一种组播通信服务的示例，所述下行链路获取子模块还包括：</p>
    <p>[0253]	第三组播链路计算单元，用于依据服务类型信息，以及，主控服务器与所述源终端 的接入网地址，获取当次组播服务下行的通信链路信息。</p>
    <p>[0254]	由于节点服务器作为接入网中的主控节点，组播服务通信只涉及节点服务器的下 行端口，因而所述主控服务器在其内部的组播数据包地址表中设置当次服务的组播数据包 所导向的端口包括：</p>
    <p>[0255]	目的地址为组播地址的组播数据包所导向的下行端口。</p>
    <p>[0256]	在一种典型组播服务的示例中，如目标终端请求收看直播，所述接入交换机的通 信端口信息包括上行链路中接入交换机的上行端口信息，以及，下行链路中接入交换机的</p>
    <p>40下行端口信息；</p>
    <p>[0257]	所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的 当次服务的组播数据包所导向的端口包括：</p>
    <p>[0258]	目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的上行端口 和下行链路中接入交换机的下行端口。</p>
    <p>[0259]	作为另一种组播服务器的示例，如源终端发起直播时自己收看直播，所述接入交 换机的通信端口信息还包括上行链路中接入交换机的下行端口信息；</p>
    <p>[0260]	所述接入交换机依据所述端口配置命令在其内部的组播数据包地址表中设置的 当次服务的组播数据包所导向的端口包括：</p>
    <p>[0261]	目的地址为组播地址的组播数据包所导向的上行链路中接入交换机的下行端口。</p>
    <p>[0262]	对于组播通信服务而言，所述当次服务的数据包中通常包括有组播地址，在本发 明的一种优选实施例中，所述第一通信模块组包括：</p>
    <p>[0263]	位于主控服务器的第一端口导向模块，用于依据所述组播地址，在其内部的数据 包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送 至下行链路中相应的接入交换机；</p>
    <p>[0264]	位于接入交换机的第一下行端口传送模块，用于依据所述组播地址，在其内部的 数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口 传送至目标终端。</p>
    <p>[0265]	对于不同的组播通信服务，所述第一通信模块组还包括：</p>
    <p>[0266]	位于终端的发送模块，用于依据源终端发送的当次服务数据包中的组播地址，将 所述数据包导向至上行链路中的接入交换机；</p>
    <p>[0267]	位于接入交换机的上行端口传送模块，用于依据所述组播地址，在其内部的数据 包地址表中查找当次服务的数据包所导向的上行端口，并将该数据包通过该上行端口传送 至主控服务器。</p>
    <p>[0268]	更为优选的，所述第一通信模块组还可以包括：</p>
    <p>[0269]	位于主控服务器的第二端口导向模块，用于依据所述组播地址，在其内部的数据 包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口传送 至上行链路中相应的接入交换机；</p>
    <p>[0270]	位于接入交换机的第二下行端口传送模块，用于依据所述组播地址，在其内部的 数据包地址表中查找当次服务的数据包所导向的下行端口，并将该数据包通过该下行端口 传送至源终端。</p>
    <p>[0271]	在具体实现中，所述下行链路获取子模块还包括：</p>
    <p>[0272]	链路选择单元，用于在获得多条当次服务的通信链路信息时，按照预置规则选择 其中一条通信链路信息为当次服务的通信链路信息。作为示例，所述预置规则为节点服务 器获取各条通信链路的流量信息，以及，当次服务的流量信息，确定已用流量最小的通信链 路为当次服务的通信链路信息；或者，所述预置规则为节点服务器获取各条通信链路的带 宽信息，以及，当次服务的带宽信息，确定带宽最大的通信链路为当次服务的通信链路信 肩、ο</p>
    <p>[0273]	作为一种优选的实现方式，所述端口配置命令记录在协议包中，所述主控服务器还包括：</p>
    <p>[0274]	协议包导向模块，用于依据其内部预置的下行协议包地址表的设置，通过连接相 应接入交换机的下行端口将所述协议包导向至对应的接入交换机；</p>
    <p>[0275]	其中，所述下行协议包地址表中设置有，目的地址为下级网络设备地址的协议包 所导向的下行端口。</p>
    <p>[0276]	为更好地利用资源，在完成当次服务后，所述的系统还包括：</p>
    <p>[0277]	位于主控服务器的资源释放模块，用于在完成当次服务后，在其内部的数据包地 址表中，将所设置的当次服务数据包导向的端口释放；并向参与当次服务的接入交换机发 送端口释放命令；</p>
    <p>[0278]	位于接入交换机的端口释放模块，用于依据所述端口释放命令在其内部的数据包 地址表中，将所设置的当次服务数据包导向的端口释放。</p>
    <p>[0279]	本发明节点服务器进行集中控制的一个主要方面在于，其具有自己的接入网地 址，并维护下级网络设备的接入网地址。在这种情况下，所述下级网络设备包括接入交换 机，所述的系统还包括接入交换机入网处理模块，所述接入交换机入网处理模块包括：</p>
    <p>[0280]	位于节点服务器的向接入交换机发送下行协议包的下行协议包发送子模块，以 及，依据接入交换机回复的上行协议包发送入网命令的第一入网命令发送子模块；</p>
    <p>[0281]	位于接入交换机的以下子模块：</p>
    <p>[0282]	0号表初始化配置子模块，用于在上电时，在其内部的下行协议包地址表中设置所 有下行协议包导向CPU模块；</p>
    <p>[0283]	下行协议包接收子模块，用于依据所述下行协议包地址表的设置，将接收到的下 行协议包导向该接入交换机的CPU模块，所述下行协议包中包括一个待分配的接入网地 址；</p>
    <p>[0284]	上行协议包回复子模块，用于由所述CPU模块生成上行协议包，并发送给节点服 务器；</p>
    <p>[0285]	第一入网命令接收子模块，用于接收节点服务器发送的入网命令，所述入网命令 中包括该接入交换机的接入网地址，所述接入网地址即为该接入交换机所接收下行协议包 中的待分配接入网地址；</p>
    <p>[0286]	0号表第一设置子模块，用于更新其内部的下行协议包地址表为，仅目的地址为自 己接入网地址的协议包导向CPU模块。</p>
    <p>[0287]	在具体实现中，往往接入交换机下还连接有其它下级接入网设备，在这种情况下， 所述接入交换机入网处理模块还包括：</p>
    <p>[0288]	位于节点服务器的用于向已入网的接入交换机发送端口分配包的端口分配包发 送子模块，所述端口分配包中包括端口分配信息，所述端口分配信息为各个端口下行协议 包导向所述接入交换机各个下行端口的信息；</p>
    <p>[0289]	位于接入交换机的以下子模块：</p>
    <p>[0290]	第一导向子模块，用于将目的地址为自己接入网地址的端口分配包导向CPU模 块；</p>
    <p>[0291]	0号表第二设置子模块，用于依据所述端口分配信息，在其内部的下行协议包地址 表中，设置各个端口下行协议包所导向的下行端口。</p>
    <p>42[0292]	更为优选的是，所述接入交换机入网处理模块还包括：</p>
    <p>[0293]	位于节点服务器的用于向已入网的接入交换机发送端口下行协议包的端口下行 协议包发送子模块，所述端口下行协议包中包括一个待分配的接入网地址；</p>
    <p>[0294]	位于接入交换机的以下子模块：</p>
    <p>[0295]	第二导向子模块，用于依据其内部下行协议包地址表的设置，将所述端口下行协 议包导向对应的下行端口。</p>
    <p>[0296]	更为优选的是，所述接入网设备还包括连接在已入网接入交换机下行端口的下级 接入网设备，所述接入交换机入网处理模块还包括：</p>
    <p>[0297]	位于节点服务器的用于向所述下级接入网设备发送入网命令的第二入网命令发 送子模块；</p>
    <p>[0298]	位于所述下级接入网设备的以下子模块：</p>
    <p>[0299]	端口上行协议包回复子模块，用于针对接收到的端口下行协议包生成端口上行协 议包，并发送给节点服务器；</p>
    <p>[0300]	第二入网命令接收子模块，用于接收节点服务器发送的入网命令，所述入网命令 中包括该下级接入交换机的接入网地址，所述接入网地址即为该下级接入交换机所接收端 口下行协议包中的待分配接入网地址；</p>
    <p>[0301]	其中，所述下级网络设备包括接入交换机或终端。</p>
    <p>[0302]	为了实现本发明的新型网与现有以太网的融合，所述接入网设备还包括，连接在 所述接入交换机与源终端、目标终端之间的以太网协转网关和局域以太网，所述的系统还 包括以太网协转网关入网处理模块，所述以太网协转网关入网处理模块包括：</p>
    <p>[0303]	位于主控服务器的以下子模块：</p>
    <p>[0304]	查询包发送子模块，用于下发查询包；</p>
    <p>[0305]	信息查找子模块，用于在注册信息表中查找与所述序列号对应的以太网协转网关 信息，所述以太网协转网关信息包括以太网协转网关MAC地址和该以太网协转网关下绑定 的终端MAC地址；</p>
    <p>[0306]	入网命令发送子模块，用于向所述以太网协转网关发送入网命令，所述入网命令 中包含以太网协转网关在新型网的地址和以太网协转网关的MAC地址；</p>
    <p>[0307]	位于以太网协转网关的以下子模块：</p>
    <p>[0308]	查询应答子模块，用于在上电初始化后，收到查询包，返回包含以太网协转网关序 列号的应答包；</p>
    <p>[0309]	入网应答子模块，用于收到入网命令后返回应答，以太网协转网关接入新型网。</p>
    <p>[0310]	在实际中，终端MAC地址和以太网协转网关的绑定关系在终端和以太网协转网关 售出时预设在节点服务器中。</p>
    <p>[0311]	在本发明的一种优选实施例中，还包括以太网协转网关绑定终端入网处理模块， 所述以太网协转网关绑定终端入网处理模块包括：</p>
    <p>[0312]	位于主控服务器的查询包发送子模块，用于下发查询包；</p>
    <p>[0313]	位于以太网协转网关的查询包导向子模块，用于收到查询包，根据协议包地址表， 将查询包导向到相应端口；</p>
    <p>[0314]	位于以太网协转网关的第一 MAC地址添加子模块，用于在所述查询包中添加以太网协转网关的MAC地址和目标终端的MAC地址，并转发；</p>
    <p>[0315]	位于终端的初始化子模块，用于上电初始化后，收到查询包，返回包含终端序列号 的应答包；</p>
    <p>[0316]	位于以太网协转网关的第一 MAC地址删除子模块，用于去掉所述应答包中的以太 网协转网关MAC地址和终端MAC地址，然后转发给主控服务器；</p>
    <p>[0317]	位于主控服务器的入网通知子模块，用于在注册信息表中找到与所述终端序列号 对应的终端信息，发送入网命令，所述入网命令中包含终端在新型网的地址；</p>
    <p>[0318]	位于以太网协转网关的第二 MAC地址添加子模块，用于在收到所述入网命令时， 添加以太网协转网关的MAC地址和目标终端的MAC地址后进行转发；</p>
    <p>[0319]	位于终端的入网应答子模块，用于在收到入网命令后返回应答；</p>
    <p>[0320]	位于以太网协转网关的第二 MAC地址删除子模块，用于去掉所述应答中的以太网 协转网关MAC地址和终端MAC地址后转发给主控服务器。</p>
    <p>[0321]	由上可知，以太网协转网关接入新型网后，会从具有集中控制功能的节点服务器 获得以太网协转网关的MAC地址和该以太网协转网关下注册的终端MAC地址，在这种情况 下，就可以采用以下模块进行通信：所述节点服务器用于向入网的以太网协转网关发送该 以太网协转网关下绑定的终端MAC地址；</p>
    <p>[0322]	所述以太网协转网关通过以太网和终端相连，包括：</p>
    <p>[0323]	MAC获取模块，用于接入新型网，从具有集中控制功能的节点服务器获得该以太网 协转网关下绑定的终端MAC地址；</p>
    <p>[0324]	MAC添加模块，用于接收新型网发来的数据包，在所述数据包中添加以太网协转网 关的MAC地址和目标终端的MAC地址，然后发送至以太网；</p>
    <p>[0325]	MAC删除模块，用于接收以太网发来的数据包，去掉所述数据包中以太网协转网关 的MAC地址和源终端的MAC地址，然后发送至新型网；</p>
    <p>[0326]	其中，所述目标终端和源终端遵循新型网协议；</p>
    <p>[0327]	终端，连接在以太网中，通过以太网与新型网连接，并与以太网协转网关绑定。</p>
    <p>[0328]	即以太网协转网关接入新型网后，就可以对数据包或协议包进行加减MAC。</p>
    <p>[0329]	更具体而言，在本发明实施例中优选的是，对于添加了以太网协转网关MAC地址 和目标终端MAC地址的数据包，在以太网中采用以太网协议进行传输；对于去掉了以太网 协转网关MAC地址和源终端MAC地址的数据包，在新型网中采用新型网协议进行传输。</p>
    <p>[0330]	优选的，新型网发来的数据包和以太网发来的数据包，包头都包含传输两端在新 型网的地址，所述地址为数据包的源地址和目的地址。</p>
    <p>[0331]	优选的，所述系统还包括，位于所述以太网协转网关的映射关系获取模块，用于在 以太网协转网关接入新型网后，从节点服务器获得以太网协转网关下绑定的终端MAC地址 与终端在新型网的地址的映射；</p>
    <p>[0332]	则所述MAC添加模块接收新型网发来的数据包，根据数据包的目的地址与MAC地 址的映射，在数据包中添加对应的目标终端的MAC地址。</p>
    <p>[0333]	所述以太网协转网关还具有流量精确控制的功能，其实现如下：</p>
    <p>[0334]	所述的系统还包括位于所述以太网协转网关的包检测模块，用于对接收的数据包 进行检测，如果符合检测要求，则分配相应的流标识符，所述检测包括：[0335]	检测数据包的以太网协转网关MAC地址、源终端MAC地址、目的地址、源地址、数据 包类型和包长度是否符合要求。</p>
    <p>[0336]	更为优选的，所述的系统还包括：</p>
    <p>[0337]	位于所述以太网协转网关的以下模块：</p>
    <p>[0338]	端口接收缓存，用于按照流标识符存放相应的数据包；</p>
    <p>[0339]	包缓存器，用于存放从端口接收缓存读取的数据包；</p>
    <p>[0340]	端口发送缓存，用于存放从包缓存器读取的数据包；</p>
    <p>[0341]	交换引擎，用于从端口接收缓存读取数据包，并根据流标识符放入相应流的包缓 存器队列；轮询包缓存器队列，当获得发送令牌后，根据发送令牌中的流标识符，从相应流 的包缓存器队列中顺序读取数据包，并放入端口发送缓存；从端口发送缓存读取数据包发 送。</p>
    <p>[0342]	更为优选的，所述交换引擎还用于判断是否同时满足以下两个条件：</p>
    <p>[0343]	第一，端口发送缓存未满；</p>
    <p>[0344]	第二，相应流的包缓存队列中的包计数器大于零；</p>
    <p>[0345]	如果同时满足，则根据发送令牌中的流标识符，从相应流的包缓存队列中顺序读 取数据包，并放入端口发送缓存。</p>
    <p>[0346]	在具体实现中，所述节点服务器还用于根据终端发起的服务申请协议包，生成流 量控制信息，并发送给上行链路上进行流量控制的以太网协转网关，所述流量控制信息包 括发送时间间隔和发送的数据大小；</p>
    <p>[0347]	所述以太网协转网关还包括码率控制模块，用于由CPU模块配置，根据流量控制 信息产生发送令牌，并发送给交换引擎，所述令牌中包含流标识符。</p>
    <p>[0348]	如前所述，所述新型网包括城域网部分，在城域网中，所述主控服务器为城域服务 器，所述下级网络设备包括节点交换机和节点服务器，其中所述节点交换机连接在城域服 务器和节点服务器之间；所述的系统还包括：</p>
    <p>[0349]	位于所述城域服务器的以下模块：</p>
    <p>[0350]	协议标签分配模块，用于在下级网络设备接入城域网时，为入网的设备分配协议 标签；当同一个下级网络设备与城域服务器之间有多个连接时，为每个连接分配不同的协 议标签；其中，所述协议标签用于描述下级网络设备与城域服务器之间的连接，所述下级网 络设备包括节点交换机和节点服务器；</p>
    <p>[0351]	数据标签分配模块，用于针对每个跨越城域网的服务申请，分配对应服务的数据 标签，所述数据标签用于描述服务所涉及的节点服务器之间的连接；</p>
    <p>[0352]	城域网地址分配模块，用于下级网络设备接入城域网时，为入网的设备分配城域 网地址。</p>
    <p>[0353]	所述城域服务器还包括以下模块，用于下级网络设备的入网：</p>
    <p>[0354]	端口查询模块，用于向其所有下行端口发送城域查询标签包，每个城域查询标签 包中包含一个协议标签分配模块分配的待用协议标签；</p>
    <p>[0355]	端口应答模块，用于接收下级网络设备发送的城域应答标签包，所述城域应答标 签包中包含下级网络设备的序列号和收到城域查询标签包的端口号；</p>
    <p>[0356]	入网验证模块，用于根据城域应答标签包中的序列号验证下级网络设备是否注</p>
    <p>45册；</p>
    <p>[0357]	入网命令发送模块，用于当下级网络设备已注册时，向下级网络设备收到城域查 询标签包的端口发送入网命令，所述入网命令中包含城域服务器为下级网络设备分配的城 域网地址和所述待用协议标签；</p>
    <p>[0358]	入网命令应答接收模块，用于接收下级网络设备返回的入网命令应答，下级网络 设备接入城域网；</p>
    <p>[0359]	其中，所述下级网络设备为节点交换机或节点服务器。</p>
    <p>[0360]	特殊地，当同一个下级网络设备与城域服务器之间有多个连接时，所述同一个下 级网络设备的多个端口会收到多个城域查询标签包，每个城域查询标签包中的待用协议标 签不同；</p>
    <p>[0361]	城域服务器通过多个不同的协议标签，向同一个下级网络设备的多个端口发送多 个入网命令，但每个入网命令中为该下级网络设备分配的城域网地址相同。</p>
    <p>[0362]	在具体实现中，所述节点交换机包括：</p>
    <p>[0363]	协议包标签表，用于将接收的城域协议包分别导向到相应下行端口，所述城域协 议包包括城域服务器发送的城域查询标签包；</p>
    <p>[0364]	协议包标签表初始化模块，用于当节点交换机上电时，设置所有的城域协议包导 向到CPU模块；</p>
    <p>[0365]	协议包标签表更新模块，用于当节点交换机接入城域网后，根据城域服务器的指 令，修改自身的协议包标签表，将城域服务器新分配的各待用协议标签对应的城域协议包 分别导向到节点交换机的相应下行端口 ；其中，所述新分配的待用协议标签用于描述城域 服务器到所述节点交换机的下级连接设备的连接，所述下级连接设备包括下级节点交换机 和节点服务器。</p>
    <p>[0366]	更为优选的，所述节点交换机还包括：</p>
    <p>[0367]	应答包标签表，用于将接收的城域应答标签包分别导向到相应上行端口 ；</p>
    <p>[0368]	应答包标签表初始化模块，用于当节点交换机上电时，设置所有城域应答标签包 的导向关闭；</p>
    <p>[0369]	应答包标签表更新模块，用于当节点交换机收到城域服务器发送的城域查询标签 包后，修改自身的应答包标签表，将所述协议标签对应的城域应答标签包导向到接收该城 域查询标签包的上行端口 ；还用于当节点交换机接入城域网后，根据城域服务器的指令， 修改自身的应答包标签表，将城域服务器新分配的各待用协议标签对应的城域应答标签包 分别导向到相应上行端口 ；其中，所述新分配的待用协议标签用于描述所述下级网络设备 的下级连接设备到城域服务器的连接，所述下级连接设备包括下级节点交换机和节点服务器。</p>
    <p>[0370]	所述城域服务器设置有协议包标签表和应答包标签表，分别说如下：</p>
    <p>[0371]	协议包标签表，用于将城域协议包分别导向到相应下行端口，所述城域协议包包 括城域服务器发送的城域查询标签包。</p>
    <p>[0372]	应答包标签表，用于城域服务器上电时，设置所有的城域应答标签包导向CPU模 块。</p>
    <p>[0373]	相应的，所述城域服务器还包括：协议包标签表初始化模块，用于当城域服务器上电时，在其内部的协议包标签表中设置所有城域协议包的导向关闭；协议包标签表配置模 块，用于在所述下级网络设备入网时，协议标签分配模块对应下行端口个数分配待用协议 标签后，修改所述协议包标签表，将所分配的各待用协议标签对应的城域协议包分别导向 到城域服务器的相应下行端口 ；其中，所述待用协议标签用于描述城域服务器到所述下级 网络设备的连接。</p>
    <p>[0374]	当入网的下级网络设备为节点交换机时，该节点交换机的某个下级连接设备接入 城域网，所述下级连接设备包括节点交换机和节点服务器，所述系统还包括：</p>
    <p>[0375]	位于城域服务器的城域查询标签包发送模块，用于使用新分配的待用协议标签向 各下级连接设备发送城域查询标签包，所述城域查询标签包根据协议包标签表被分别导向 到城域服务器的相应下行端口；</p>
    <p>[0376]	位于下级连接设备的城域应答标签包回复模块，用于在上电后，收到所述城域查 询标签包，然后向城域服务器返回城域应答标签包，所述城域应答标签包中包含该下级连 接设备的序列号和收到城域查询标签包的端口号；</p>
    <p>[0377]	位于城域服务器的注册验证模块，用于在收到所述城域应答标签包后，根据包中 的序列号验证下级连接设备是否注册；</p>
    <p>[0378]	位于城域服务器的入网通知模块，用于在所述下级连接设备已注册时，向下级连 接设备发送入网命令，所述入网命令中包含城域服务器为下级连接设备分配的城域网地址 和所述待分配的协议标签；</p>
    <p>[0379]	位于下级连接设备的入网应答模块，用于在收到入网命令后，返回入网命令应答。</p>
    <p>[0380]	作为一种优选的实现方式，城域服务器与下级连接设备之间的下级网络设备接收 到所述城域查询标签包和入网命令后，根据自身的协议包标签表，将所述城域查询标签包 和入网命令导向到相应下行端口进行转发；</p>
    <p>[0381]	城域服务器与下级连接设备之间的下级网络设备接收到所述城域应答标签包和 入网命令应答后，根据自身的应答包标签表，将所述城域应答标签包和入网命令应答导向 到相应上行端口进行转发。</p>
    <p>[0382]	优选的，所述城域服务器设置有标签信息表，每个表项记录了标签占用信息、标签 描述信息和标签路由信息，其中所述标签路由信息包括该标签上一跳交换机的城域网地址 及端口号。</p>
    <p>[0383]	相应的，所述城域服务器还包括：标签信息表更新模块，用于当协议标签分配模块 为下级网络设备分配一个待用标签时，修改所述标签信息表中对应该标签的表项：将标签 占用信息由未用改为待用，将标签路由信息中上一跳交换机的城域网地址及端口设为城域 服务器的地址及相应端口，所述标签描述信息不做修改；当所述下级网络设备入网后，修改 所述标签信息表中对应该标签的表项：将标签占用信息改为已用，所述标签描述信息和标 签路由信息不做修改。</p>
    <p>[0384]	此外，所述标签信息表更新模块，还用于当协议标签分配模块为所述下级网络设 备的下级连接设备分配一个待用标签时，修改所述标签信息表中对应该标签的表项：将标 签占用信息由未用改为待用，将标签路由信息中上一跳交换机的城域网地址及端口设为所 述下级网络设备的地址及相应端口，所述标签描述信息不做修改；当所述下级连接设备入 网后，修改所述标签信息表中对应该标签的表项：将标签占用信息改为已用，所述标签描述信息和标签路由信息不做修改。</p>
    <p>[0385]	优选的，所述城域服务器设置有地址信息表，每个表项记录了城域网地址占用信 息、设备描述信息和设备资源信息，其中设备资源信息包括该设备各个网络端口连接的下 级网络设备的城域网地址和该设备各个网络端口的上下行流量计数。</p>
    <p>[0386]	相应的，所述城域服务器还包括：</p>
    <p>[0387]	地址信息表初始化模块，用于城域服务器上电，城域网地址分配模块为自己分配 一个城域网地址后，修改所述地址信息表中对应该地址的表项：将地址占用信息由未用改 为已用，将设备描述信息改为所述城域服务器，将设备资源信息改为所述城域服务器的资 源描述；</p>
    <p>[0388]	地址信息表更新模块，用于当城域网地址分配模块为下级网络设备分配城域网地 址，发送包含该城域网地址的入网命令时，修改所述地址信息表中对应该地址的表项：将地 址占用信息由未用改为待用，所述设备描述信息和设备资源信息不做修改；当城域服务器 收到下级网络设备发送的入网命令应答后，修改所述地址信息表中对应该地址的表项：将 地址占用信息改为已用，将设备描述信息改为所述下级网络设备，将设备资源信息改为所 述下级网络设备的某个上行端口连接着城域服务器的某个下行端口；同时，修改地址信息 表中对应所述城域服务器地址的表项：将设备资源信息改为所述城域服务器的某个下行端 口连接着下级网络设备的某个上行端口，所述地址占用信息和设备描述信息不做修改；其 中，所述下级网络设备的某个上行端口根据下级网络设备返回的城域应答标签包获知，所 述城域服务器的某个下行端口根据协议包标签表获知。</p>
    <p>[0389]	此外，地址信息表更新模块，还用于当城域网地址分配模块为下级网络设备的下 级连接设备分配城域网地址，发送包含该城域网地址的入网命令时，修改所述地址信息表 中对应该地址的表项：将地址占用信息由未用改为待用，所述设备描述信息和设备资源信 息不做修改；当城域服务器收到所述下级连接设备发送的入网命令应答后，修改所述地址 信息表中对应该地址的表项：将地址占用信息改为已用，将设备描述信息改为所述下级连 接设备，将设备资源信息改为所述下级连接设备的某个上行端口连接着所述下级网络设备 的某个下行端口 ；同时，修改地址信息表中对应所述下级网络设备地址的表项：将设备资 源信息改为所述下级网络设备的某个下行端口连接着下级连接设备的某个上行端口，所述 地址占用信息和设备描述信息不做修改；其中，所述下级连接设备的某个上行端口根据下 级连接设备返回的城域应答标签包获知，所述下级网络设备的某个下行端口根据协议包标 签表获知。</p>
    <p>[0390]	优选的，所述城域服务器设置有设备信息表，设备信息表的每个表项记录了设备 标识、设备状态和设备地址。</p>
    <p>[0391]	相应的，所述城域服务器还包括：设备信息表更新模块，用于当城域网地址分配模 块为下级网络设备或该下级网络设备的下级连接设备分配城域网地址，发送包含该城域网 地址的入网命令时，修改所述设备信息表中对应设备的表项：将设备状态改为待入网，将设 备地址改为所分配的城域网地址，所述设备标识不做修改；还用于当城域服务器收到下级 网络设备或该下级网络设备的下级连接设备发送的入网命令应答后，修改所述设备信息表 中对应设备的表项：将设备状态改为已入网，所述设备标识和设备地址不做修改。</p>
    <p>[0392]	优选的，所述城域服务器还包括：内容-地址映射表，用于记录服务内容与城域网地址的映射关系，所述服务内容信息包括服务号码；</p>
    <p>[0393]	内容-地址映射表的使用如下：所述跨越城域网的服务申请涉及第一终端和第二 终端；当城域服务器收到连接第一终端的节点服务器发送的包含服务类型信息、服务内容 信息以及第一终端接入网地址的服务申请包时，在内容-地址映射表中查找所述服务号码 对应的城域网地址，并判断第二终端连接在另一节点服务器下。</p>
    <p>[0394]	此外，城域服务器还可以在服务申请过程中进行流量控制，并通过流量控制来分 配合适的通信链路，具体如下：</p>
    <p>[0395]	所述城域服务器还包括：通信链路获取模块，用于根据地址信息表中设备各个网 络端口连接的下级网络设备的城域网地址，获得当次服务在城域网的通信链路信息；所述 通信链路信息为单向通信链路信息，或者为双向通信链路信息；则数据标签分配模块分配 当次服务的数据标签，并分别向通信链路上的下级网络设备发送包含所述数据标签信息的 标签分配包；所述标签分配包包含入标签、出标签和导向端口，所述下级网络设备包括节点 交换机和节点服务器。</p>
    <p>[0396]	与现有技术相比，本发明具有以下优点：</p>
    <p>[0397]	1、本发明通过主控服务器，在发起服务请求时（通信过程建立的协议交互过程 中），针对服务请求的情况以针对各个接入交换机配表的方式，对本次服务数据的传输路径 进行实现设置，在数据包的传输过程中，直接按照该传输路径进行传输即可，而无需采用现 有IP协议的解决方案，由每个数据包自行协商传输路由。总之，本发明可以保证传输通路 的稳定和通畅，避免多媒体业务的延时。</p>
    <p>[0398]	2、本发明对所有数据业务（尤其是单播数据包）都采用配表的方式，事先设定路 径，这样可以满足国家信息安全的需要。例如，对于国家信息安全而言，其需要对新型网络 中的某些数据进行监控，而采用本发明配表的方式，可以非常容易的将本次业务所传输的 数据导向监控通道，以保证国家信息安全的需求。</p>
    <p>[0399]	3、在本发明中，接入交换机不需要针对每个数据包进行路由的计算，也不需要维 护其周围的网络设备拓扑，只要按照实现配置的数据包地址表进行导向传输即可，而该导 向过程可以由硬件实现，可以大大提高交换机的导向效率，并可以大大降低交换机的运算 需求，节约硬件资源。</p>
    <p>[0400]	4、本发明提供了一种以太网协转网关，能够接入新型网络，从新型网的节点服务 器获得以太网协转网关的MAC地址和该以太网协转网关下绑定的终端MAC地址。因此，针对 从新型网发往以太网的数据包，通过在该数据包中加入以太网协转网关的MAC地址和目标 终端的MAC地址，就可以根据终端MAC地址将该数据包转发到以太网中的目标终端；同样， 对于从以太网发往新型网的数据包，通过去掉该数据包中以太网协转网关的MAC地址和目 标终端的MAC地址，就可以根据数据包中的新型网目的地址（DA)将该数据包转发到新型 网。这样，就实现了新型网与以太网的融合。</p>
    <p>[0401]	5、本发明所述的新型网和以太网协转网关是通过查地址表的方式实现数据传输。 新型网的节点服务器、接入交换机和以太网协转网关中都分别配置了协议包地址表、应答 包地址查找表、单播数据包地址表和组播数据包地址表，分别用于导向协议包（包括查询 包）、应答包、单播数据包和组播数据包的传输。</p>
    <p>[0402]	6、以太网协转网关还可以进行精确的流量控制。针对每个服务，节点服务器生成CN 流量控制信息（发送时间间隔和发送的数据大小），并发送给上行链路上的以太网协转网 关；以太网协转网关根据流量控制信息产生发送令牌，对上行数据包进行流量控制。以太网 协转网关可以将输入不均&#21243;的数据流变成均&#21243;的数据流发送。</p>
    <p>[0403]	7、本发明构建的新型网络包括接入网和城域网两部分，其中城域网是一种集中控 制的星型网、环状网等网络结构，因此两个设备之间可能有2种甚至2种以上的连接，但是 两个设备的地址都只有一个，因此，仅仅采用地址无法描述二者之间的多种连接。为了精 确描述下级网络设备之间的连接关系，本发明引入标签来唯一描述一个下级网络设备。但 与传统的MPLS标签相比，本发明中标签的分配是由城域网服务器主导，节点交换机、节点 服务器都是被动的执行而已，这一点与MPLS的标签分配是不同的，MPLS的标签分配是交换 机、服务器互相协商的结果。</p>
    <p>[0404]	8、本发明是一种分层控制的网络结构，城域服务器控制着其下的节点交换机和节 点服务器的网管流程和服务流程，而节点服务器控制着其下的接入交换机和终端的网管流 程和服务流程。其中，城域服务器或节点服务器以主控的方式，通过向各个通信端口发送查 询包，对各个网络设备的地址进行分配，并且在分配的过程中在主控服务器端建立了清晰 的网络拓扑。这样，在具体数据包的传输过程中，就可以直接由主控服务器（城域服务器或 节点服务器）分配相应的通信链路即可（因为其明晰整个网络的设备拓扑），不需要各个网 络设备之间再进行路由协商（现有IP协议的方案），这样可以保证稳定的传输速率，避免延 时。</p>
    <p>[0405]	9、在一次服务数据的传输中，该服务的各个数据包通过相同的通信链路进行传 输，而不像现有IP协议的方案，每个数据包依靠自行协商解决路由问题，在数据包发出之 前并不知道其会经过哪条路径，即同一业务的两个数据包可能通过不同的路径传输至目标 终端。这样，本发明与之相比，可以保证稳定的传输速率，避免延时。</p>
    <p>附图说明</p>
    <p>[0406]	图1是本发明的一种节点服务器的硬件结构示意图；</p>
    <p>[0407]	图2是本发明的一种接入交换机的硬件结构示意图；</p>
    <p>[0408]	图3是本发明的一种以太网协转网关的硬件结构示意图；</p>
    <p>[0409]	图4是本发明的一种接入交换机入网过程的示意图：</p>
    <p>[0410]	图5是本发明的一种节点服务器与接入交换机的连接示意图；</p>
    <p>[0411]	图6是本发明的一种终端入网过程的示意图：</p>
    <p>[0412]	图7是本发明的一种节点服务器、接入交换机、终端的连接示意图；</p>
    <p>[0413]	图8是本发明实施例中以太网协转网关接入新型网的流程图；</p>
    <p>[0414]	图9是本发明实施例中终端接入新型网的流程图；</p>
    <p>[0415]	图10是本发明实施例所述节点服务器与以太网协转网关、终端在入网过程中的 交互示例连接图；</p>
    <p>[0416]	图11是本发明实施例所述节点服务器与接入交换机、终端在入网过程中的交互 示例连接图；</p>
    <p>[0417]	图12是本发明实施例所述以太网协转网关进行流量控制的流程图；</p>
    <p>[0418]	图13是本发明的一种节点交换机入网过程的示意图：</p>
    <p>50[0419]	图14是本发明实施例所述城域服务器与节点交换机、节点服务器的网管交互示 例连接图；</p>
    <p>[0420]	图15是本发明实施例所述城域服务器与节点交换机、节点服务器的服务交互示 例连接图。</p>
    <p>具体实施方式</p>
    <p>[0421]	为使本发明的上述目的、特征和优点能够更加明显易懂，下面结合附图和具体实 施方式对本发明作进一步详细的说明。</p>
    <p>[0422]	一、以下简单介绍本发明的核心构思：</p>
    <p>[0423]	本专利发明人认为，本发明实现全网品质保证的充分条件有以下几点：</p>
    <p>[0424]	第一，IP互联网核心理论中关于“尽力而为”（Best Efforts)的机制必然导致网 络流量不均&#21243;和频繁的丢包。实际上，TCP协议正是利用网络丢包状态来调节发送流量。</p>
    <p>[0425]	第二，IP互联网核心理论中关于“储存转发”（Store &amp; Forward)的机制在吸收本 地突发流量的同时，将造成下一个节点网络流量更大的不均&#21243;。</p>
    <p>[0426]	第三，IP互联网核心理论中关于“检错重发”（Error Detection &amp;Retransmission)的机制在同步视频通讯中，将造成不可容忍的延时，因此没有实用价值。</p>
    <p>[0427]	第四，连续性的网络流量不均&#21243;或突发流量必然导致周期性交换机（路由器）丢 包。</p>
    <p>[0428]	由此可见，由于电脑文件突发流量本质是离散性，没有后继，上述IP互联网核心 理论曾经使互联网高效率传输文件。但是，面对连续性同步流媒体传输中的品质保证，昔日 的功臣却成了破坏网络传输品质的元凶。我们已经从前面论述中得出结论，任何资源预留、 优先级别和轻载方案都不能从根本上解决同步流媒体的品质保证。</p>
    <p>[0429]	既然前述方法无一可行，那么，解决网络传输品质保证的出路在哪里？</p>
    <p>[0430]	本专利发明人认为，当前各种QoS方法，都建立在一种错误的假设上。根据这种假 设，QoS的解决方法是为视讯流量提供优先处理的特权。但事实是，由于不同媒体形式所需 的网络流量极度不&#21243;，只要有少数人使用视讯服务，网络上的视讯流量将占据绝对主体。</p>
    <p>[0431]	如果换一角度看，专门为大部分网络流量提供好的品质，等效于专门为少部分非 视讯流量提供差的品质。既然，大部分网络流量必须要求品质保证，那么，剩下少数不要求 品质保证的业务流量也都给于品质保证何尝不可。假设1000位旅客订飞机票时都要求头 等舱，只有少数几位可以接受经济舱，那么，航空公司的自然措施是取消经济舱。因为，为 了满足极少数差异化的经济舱，航空公司所花的代价远大于给这些旅客提供免费升舱。实 际上，网络传输品质完全不保证，或者完全有保证都很简单，难就难在部分保证和部分不保 证，尤其还不知道这“部分”两字的界线划在哪里。因此，只要为全部网络业务都提供品质 保证，QoS问题就不存在了。</p>
    <p>[0432]	IP互联网初期好比是乡间小路，在民风淳朴的小镇不需要交通警察。但是到了繁 华的大都市，有些热闹路段的红绿灯和交通警察都控制不了混乱局面，出行赴约难以确定 时间，就像今天的IP互联网。</p>
    <p>[0433]	本发明好比是高速公路，不需要警察和红绿灯，水泥隔开的车道和立交桥确保汽 车在规定的道路行驶。根据加州交通局的经验，避免高速公路堵车的办法是关闭入口匝道。A[0434]	加州高速公路的设计思路有三个特点：</p>
    <p>[0435]	&#8226;在公路入口匝道设置开关，控制宏观车流量。</p>
    <p>[0436]	&#8226;保持车速稳定，提高道路通车率。</p>
    <p>[0437]	&#8226;采用水泥结构的道路分隔和立交桥，而不是警察和红绿灯来规范车辆行驶。</p>
    <p>[0438]	本发明实施例遵循电话网的原理，采取类似上述高速公路的三项措施：</p>
    <p>[0439]	&#8226;每条通路都计算和实测流量，一旦流量接近饱和，采取绕道或拒绝新用户加入。</p>
    <p>[0440]	&#8226;严格均流发送，本发明实施例TV能够在90%重载流量下，达到百万分之一的丢 包率。</p>
    <p>[0441]	&#8226;上行数据匹配和流量控制，从结构上确保用户严格遵守交通规则，因为品质保 证措施不可能指望用户自觉执行。</p>
    <p>[0442]	电脑文件与流媒体是两种截然不同的媒体形式，处理方式相互排斥。本发明的网 络理论和实践揭示了两项成果：</p>
    <p>[0443]	&#8226;本发明实施例百倍于IP互联网的性价比优势</p>
    <p>[0444]	&#8226;发展高品质对称电视不干扰现有IP互联网业务的实施方法</p>
    <p>[0445]	尤其在大流量的骨干网络，电脑文件和流媒体通过不同波长合用一根光纤。如果 一定要统一到单一网络，如接入网，那么应该是将电脑文件统一到视讯流媒体网络。本发明 实施例提供了完整的透明承载IP互联网的解决方案。</p>
    <p>[0446]	将流媒体与文件分开处理只是第一步，如何保证独立的流媒体网络品质？</p>
    <p>[0447]	前面说过，PSTN电话网络采用严格的同步机制，当流量百分之百用满之前，不会出 现网络阻塞现象。从理论上讲，多个均&#21243;流合并以后，还是均&#21243;流。实践进一步证明，在均 &#21243;流的前提下，网络流量可以接近于极限值，而不发生丢包现象。由于占据未来网络流量中 九成以上的视讯媒体流，本身具备均&#21243;流特征。因此，以视讯业务为主要目标的本发明互联 网品质保证的途径自然是消除信源流量不均&#21243;，尤其在意从根本上防止重载条件下网络交 换机的丢包现象。</p>
    <p>[0448]	本发明实施例是用改良以太网建立面向连接的电路，全网统一采用定长度数据 包。只要改变发包时间间隔，就可以得到任意带宽的媒体流。为了保证网络均流特征，本发 明互联网要求终端设计必须具备均流能力。但是，在实际网络环境中，显然不可能寄希望于 用户自觉遵守均流规定。因此，本发明实施例节点服务器向网络交换机发放通行证，只允许 用户数据包在很细的时间精度下均&#21243;通过。对于符合规定要求设计的用户终端，通行证是 完全透明的。</p>
    <p>[0449]	在上述前提下，网络实践得出令人满意的结果，本发明的交换机能够在90%带宽 利用率的条件下，获得优于百万分之一的重载丢包率。</p>
    <p>[0450]	综上所述，品质保证是下一代网络不可回避的问题，流媒体网络是不同于传统电 脑文件的另外一个物种。因此，修改IP互联网去适应视讯业务是没有前途的，创立新的网 络是唯一的出路。</p>
    <p>[0451]	二、以下对本发明提出的一种新型网进行介绍：</p>
    <p>[0452]	新型网是一种集中控制的网络结构，该网络可以是树型网、星型网、环状网等等类 型，但在此基础上网络中需要有集中控制节点来控制整个网络。</p>
    <p>[0453]	新型网分为接入网和城域网两部分。接入网部分的设备主要可以分为3类：节点</p>
    <p>52服务器，接入交换机，终端（包括各种机顶盒、编码板、存储器等）。其中，节点服务器是接入 网中起集中控制功能的节点，可控制接入交换机和终端。节点服务器可直接与接入交换机 相连，也可以直接与终端相连。类似的，城域网部分的设备也可以分为3类：城域服务器，节 点交换机，节点服务器。其中，节点服务器即为接入网部分的节点服务器，即节点服务器既 属于接入网部分，又属于城域网部分。城域服务器是城域网中起集中控制功能的节点，可控 制节点交换机和节点服务器。城域服务器可直接连接节点交换机，也可直接连接节点服务 器。由此可见，整个新型网络是一种分层集中控制的网络结构，而节点服务器和城域服务器 下控制的网络可以是树型、星型、环状等各种结构。</p>
    <p>[0454]	1、新型网设备分类</p>
    <p>[0455]	1.1本发明的新型网系统中的设备主要可以分为3类：服务器，交换机（包括以 太网网关），终端（包括各种机顶盒，编码板，存储器等）。新型网整体上可以分为城域网 (或者国家网、全球网等）和接入网。</p>
    <p>[0456]	1.2其中接入网部分的设备主要可以分为3类：节点服务器，接入交换机（包括 以太网网关），终端（包括各种机顶盒，编码板，存储器等）。</p>
    <p>[0457]	各接入网设备的具体硬件结构为：</p>
    <p>[0458]	节点服各器：</p>
    <p>[0459]	如图1所示，主要包括网络接口模块101、交换引擎模块102、CPU模块103、磁盘阵 列模块；</p>
    <p>[0460]	其中，网络接口模块101，CPU模块103、磁盘阵列模块104进来的包均进入交换引 擎模块102 ；交换引擎模块102对进来的包进行查地址表105的操作，从而获得包的导向 信息；并根据包的导向信息把该包存入对应的包缓存器106的队列；如果包缓存器106的 队列接近满，则丢弃；交换引擎模块102轮询所有包缓存器队列，如果满足以下条件进行转 发：1)该端口发送缓存未满；2)该队列包计数器大于零。磁盘阵列模块104主要实现对硬 盘的控制，包括对硬盘的初始化、读写等操作；CPU模块103主要负责与接入交换机、终端 (图中未示出）之间的协议处理，对地址表105 (包括下行协议包地址表、上行协议包地址 表、数据包地址表)的配置，以及，对磁盘阵列模块104的配置。</p>
    <p>[0461]	接入交换机：</p>
    <p>[0462]	如图2所示，主要包括网络接口模块（下行网络接口模块201、上行网络接口模块 202)、交换引擎模块203和CPU模块204 ；</p>
    <p>[0463]	其中，下行网络接口模块201进来的包（上行数据）进入包检测模块205 ；包检测 模块205检测包的目地地址（DA)、源地址（SA)、数据包类型及包长度是否符合要求，如果符 合，则分配相应的流标识符（stream-id)，并进入交换引擎模块203，否则丢弃；上行网络接 口模块202进来的包（下行数据）进入交换引擎模块203 ；CPU模块204进来的数据包进 入交换引擎模块203 ；交换引擎模块203对进来的包进行查地址表206的操作，从而获得包 的导向信息；如果进入交换引擎模块203的包是下行网络接口往上行网络接口去的，则结 合流标识符（stream-id)把该包存入对应的包缓存器207的队列；如果该包缓存器207的 队列接近满，则丢弃；如果进入交换引擎模块203的包不是下行网络接口往上行网络接口 去的，则根据包的导向信息，把该数据包存入对应的包缓存器207的队列；如果该包缓存器 207的队列接近满，则丢弃。[0464]	交换引擎模块203轮询所有包缓存器队列，在本发明实施例中分两种情形：</p>
    <p>[0465]	如果该队列是下行网络接口往上行网络接口去的，则满足以下条件进行转发：1) 该端口发送缓存未满；2)该队列包计数器大于零；3)获得码率控制模块产生的令牌；</p>
    <p>[0466]	如果该队列不是下行网络接口往上行网络接口去的，则满足以下条件进行转发： 1)该端口发送缓存未满；2)该队列包计数器大于零。</p>
    <p>[0467]	码率控制模块208是由CPU模块204来配置的，在可编程的间隔内对所有下行网 络接口往上行网络接口去的包缓存器队列产生令牌，用以控制上行转发的码率。</p>
    <p>[0468]	CPU模块204主要负责与节点服务器之间的协议处理，对地址表206的配置，以及， 对码率控制模块208的配置。</p>
    <p>[0469]	以太网协转网关：</p>
    <p>[0470]	如图3所示，主要包括网络接口模块（下行网络接口模块31、上行网络接口模块 32)、交换引擎模块33、CPU模块34、包检测模块35、码率控制模块38、地址表36、包缓存器 37和MAC添加模块39、MAC删除模块40。</p>
    <p>[0471]	其中，下行网络接口模块31进来的数据包进入包检测模块35 ；包检测模块35检 测数据包的以太网MAC DA、以太网MAC SA、以太网length or frame type、新型网目地地 址DA、新型网源地址SA、新型网数据包类型及包长度是否符合要求，如果符合则分配相应 的流标识符（stream-id)；然后，由MAC删除模块40减去MAC DA,MAC SAUength or frame type (2byte)，并进入相应的接收缓存，否则丢弃；</p>
    <p>[0472]	下行网络接口模块31检测该端口的发送缓存，如果有包则根据包的新型网目地 地址DA获知对应的终端的以太网MAC DA，添加终端的以太网MAC DA、以太网协转网关的 MAC SA、以太网 length or frame type，并发送。</p>
    <p>[0473]	以太网协转网关中其他模块的功能与接入交换机类似。</p>
    <p>[0474]终端：</p>
    <p>[0475]	主要包括网络接口模块、业务处理模块和CPU模块；例如，机顶盒主要包括网络接 口模块、视音频编解码引擎模块、CPU模块；编码板主要包括网络接口模块、视音频编码引 擎模块、CPU模块；存储器主要包括网络接口模块、CPU模块和磁盘阵列模块。</p>
    <p>[0476]	1. 3 城域网部分的设备主要可以分为2类：节点服务器，节点交换机，城域服务 器。其中，节点交换机主要包括网络接口模块、交换引擎模块和CPU模块；城域服务器主要 包括网络接口模块、交换引擎模块和CPU模块构成。</p>
    <p>[0477]	2、新型网数据包定义</p>
    <p>[0478]	2. 1接入网数据包定义</p>
    <p>[0479]	接入网的数据包主要包括以下几部分：目的地址（DA)、源地址（SA)、保留字节、 payload (PDU)、CRC。</p>
    <p>[0480]	如下表所示，接入网的数据包主要包括以下几部分：</p>
    <p>[0481]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0482]其中：</p>
    <p>[0483]	目的地址（DA)由8个字节（byte)组成，第一个字节表示数据包的类型（例如各种协议包、组播数据包、单播数据包等），最多有256种可能，第二字节到第六字节为城域网 地址，第七、第八字节为接入网地址；</p>
    <p>[0484]	源地址（SA)也是由8个字节（byte)组成，定义与目的地址（DA)相同；</p>
    <p>[0485]	保留字节由2个字节组成；</p>
    <p>[0486]	payload部分根据不同的数据报的类型有不同的长度，如果是各种协议包的话是 64个字节，如果是单组播数据包话是32+1024 = 1056个字节，当然并不仅仅限于以上2种；</p>
    <p>[0487]	CRC有4个字节组成，其计算方法遵循标准的以太网CRC算法。</p>
    <p>[0488]	2. 2城域网数据包定义</p>
    <p>[0489]	城域网的拓扑是图型，两个设备之间可能有2种、甚至2种以上的连接，即节点交 换机和节点服务器、节点交换机和节点交换机、节点交换机和节点服务器之间都可能超过2 种连接。但是，城域网设备的城域网地址却是唯一的，为了精确描述城域网设备之间的连接 关系，在本发明实施例中引入参数：标签，来唯一描述一个城域网设备。</p>
    <p>[0490]	本说明书中标签的定义和MPLS(Multi_Protocol Label Switch，多协议标签交 换)的标签的定义类似，假设设备A和设备B之间有两个连接，那么数据包从设备A到设备 B就有2个标签，数据包从设备B到设备A也有2个标签。标签分入标签、出标签，假设数 据包进入设备A的标签（入标签）是0x0000，这个数据包离开设备A时的标签（出标签） 可能就变成了 0x0001。城域网的入网流程是集中控制下的入网过程，也就意味着城域网的 地址分配、标签分配都是由城域服务器主导的，节点交换机、节点服务器都是被动的执行而 已，这一点与MPLS的标签分配是不同的，MPLS的标签分配是交换机、服务器互相协商的结</p>
    <p>：^ ο</p>
    <p>[0491]	如下表所示，城域网的数据包主要包括以下几部分：</p>
    <p>[0492]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0493]即目的地址(DA)、源地址(SA)、保留字节(Reserved)、标签、payload	(PDU)、CRC0 其中，标签的格式可以参考如下定义：标签是32bit，其中高16bit保留，只用低16bit，它的 位置是在数据包的保留字节和payload之间。</p>
    <p>[0494]	3、新型网的实现</p>
    <p>[0495]	以下讨论节点服务器与接入交换机、节点服务器与终端的入网流程。为了简化设 计，定义在接入网中的数据包类型为4种，分别是：</p>
    <p>[0496]	下行协议包（由节点服务器发往接入交换机、终端的协议包）；</p>
    <p>[0497]	上行协议包（由接入交换机、终端回应给节点服务器的协议包）；</p>
    <p>[0498]	单播数据包；</p>
    <p>[0499]	组播数据包；</p>
    <p>[0500]	接入网的地址总共是16bit，所以总共可以接入的接入交换机、终端数为65536， 假设下行协议包的数据报类型为“ 1000 0000”（ 二进制），也就是0x80 (十六进制），上行协 议包的数据报类型为“0000 1000 ”（ 二进制），也就是0x08 (十六进制），单播数据包的数据 报类型为“0001 0000” ( 二进制），也就是0x10 (十六进制），组播数据包的数据报类型为 “01111000” ( 二进制），也就是0x78 (十六进制），通过合并同类项，可以把Sbit长的地址表映射为2bit长的地址表，例如：</p>
    <p>[0501]	“1000	0000，'		‘00”，下行协议包的地址表，在本发明实施例中定义为0号表；[0502]	“0000	1000，'		‘01”，上行协议包的地址表，在本发明实施例中定义为1号表；[0503]	“0001	0000，'		‘10”，单播数据包的地址表，在本发明实施例中定义为2号表；[0504]	“0111	1000，'	=&gt;，	’ 11”，组播数据包的地址表，在本发明实施例中定义为3号表；[0505]	结合16bit的接入网地址，在实际中只需4张64K = 4x65536，也就是256K的地			</p>
    <p>址表，地址表的输出就表示数据包导向的端口。例如，其中的一种接入交换机BX-008，它具 有1个上行的百兆网口，8个下行百兆网口，1个CPU模块接口。如果8个下行百兆网口依 次定义为0号端口到7号端口，CPU模块接口定义为8号端口，1个上行的百兆网口定义为 9号端口，则总共需要256Kxl0bit的地址表，例如地址表的输出为“00 0000 0001”表示数 据包导向的0号端口，“11 0000 0000”表示数据包导向的8号、9号端口，以此类推。</p>
    <p>[0506]	假设9号端口进来一个数据包它的目的地址（DA)是0x8056 0x15000x0000 0X55aa，那么它的数据包类型为0x80，接入网地址为0x55aa，根据查表规则这时查0号表， 即地址为“00 0101 0101 1010 1010”，此地址对应的地址表的输出为“01 0000 0000”，表 示数据包导向8号端口。</p>
    <p>[0507]	3. 1接入网设备的入网流程</p>
    <p>[0508]	3.1.1接入交换机的入网过程：</p>
    <p>[0509]	首先每台允许入网的接入交换机都必须在节点服务器里注册，没有注册的接入交 换机无法入网。如图4所示，所述接入交换机入网的过程涉及以下步骤：</p>
    <p>[0510]	Si、节点服务器向每个端口发送查询包，接入交换机收到查询包后发送应答包，应 答包中包含当前接入交换机的注册信息；</p>
    <p>[0511]	S2、节点服务器收到接入交换机发出的应答包后，就知道哪个端口下接了一台接 入交换机，然后在节点服务器内部的注册信息表里找到该接入交换机信息，向该接入交换 机发送入网命令（告知接入网地址），该接入交换机收到入网命令后就入网了，同时向节点 服务器发送入网命令应答；</p>
    <p>[0512]	S3、节点服务器收到接入交换机发出的入网命令应答就知道该接入交换机已经入 网了，以后定时向这个端口发送状态查询包，检查这台接入交换机是否正常工作，同时还要 向该接入交换机的下行端口发送端口查询包，检查是否有其他接入网设备接在该接入交换 机下面。如果当前接入交换机正常工作，收到设备状态查询指令后会发送状态查询应答给 节点服务器。当节点服务器一段时间之内没有收到状态查询应答，就认为该接入交换机已 经被移出网络，不再发送状态查询包，而继续向本端口发送查询包。</p>
    <p>[0513]	3. 1. 2节点服务器与接入交换机在入网过程中的交互示例：</p>
    <p>[0514]	为了简单起见，假设节点服务器并未和节点交换机相连，忽略城域网的入网过程， 为了方便讨论，假设此节点服务器有8个下行百兆网口依次定义为0号端口到7号端口，1 个CPU模块接口定义为8号端口，1个磁盘阵列模块接口定义为9号端口，1个上行千兆光 口定义为10号端口，此节点服务器型号为MSS-400。如图5所示，MSS-400的0号端口接了 1 台 BX-008-0，BX-008-0 的 1 号端口接了 1 台 BX-008-1。</p>
    <p>[0515]	Si、MSS-400服务器上电后初始化硬件，获得默认城域网地址（假设为0x00 0x0000 0x0000)，从硬盘导入配置文件到CPU内存（例如交换机的注册信息、终端的注册信</p>
    <p>56息等等），MSS-400服务器配置自己的接入网地址为0x0000 ；</p>
    <p>[0516]</p>
    <p>[0517]</p>
    <p>[0518]</p>
    <p>[0519]</p>
    <p>[0520]</p>
    <p>为：</p>
    <p>[0521]</p>
    <p>52、MSS-400服务器初始化0、1、2、3号表：</p>
    <p>&#8226;配置0号表为“000 0000 0000 “，即所有查询包传送关闭；</p>
    <p>&#8226;配置1号表为“001 0000 0000”，即所有的应答包导向CPU ；</p>
    <p>&#8226;配置2号、3号表为“000 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>53、MSS-400服务器知道自己有8个下行端口，所以它配置8个0号表的表项分别</p>
    <p>&#8226; “00 0000 0000 0000 0001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0001的查询包导向0号端口 ；</p>
    <p>[0522]</p>
    <p>iOO 0000 0000 0000 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0002的查询包导向1号端口 ；</p>
    <p>[0523]</p>
    <p>iOO 0000 0000 0000 0011" = &gt;"000 0000 0100”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0003的查询包导向2号端口 ；</p>
    <p>[0524]</p>
    <p>iOO 0000 0000 0000 0100" = &gt;"000 0000 1000”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0004的查询包导向3号端口 ；</p>
    <p>[0525]</p>
    <p>iOO 0000 0000 0000 0101" = &gt;"000 0001 0000”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0005的查询包导向4号端口 ；</p>
    <p>[0526]</p>
    <p>iOO 0000 0000 0000 0110" = &gt;"000 0010 0000”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0006的查询包导向5号端口 ；</p>
    <p>[0527]</p>
    <p>iOO 0000 0000 0000 0111" = &gt;‘‘000 0100 0000”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0007的查询包导向6号端口 ；</p>
    <p>[0528]	#"00 0000 0000 0000 1000" = &gt;"000 1000 0000”，即目的地址（DA)是 0x8000 0x0000 0x0000 0x0008的查询包导向7号端口 ；</p>
    <p>[0529]	S4、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0001,0x8000 0x0000 0x0000 0x0002,0x8000 0x0000 0x0000 0x0003,0x8000 0x0000 0x0000 0x0004、 0x8000 0x0000 0x0000 0x0005,0x80000x0000 0x0000 0x0006,0x8000 0x0000 0x0000 0x0007、0x8000 0x00000x0000 0x0008 的查询包（SA 都为 0x0000 0x0000 0x0000 0x0000)，根据0号表的配置，所述查询包会依次导向0到7号端口；</p>
    <p>[0530]	S5、BX-008-0、BX-008-l交换机上电后初始化硬件，</p>
    <p>[0531]	&#8226;配置 0 号表”00 xxxx xxxx xxxx xxxx”为“01 0000 0000”，即所有查询包导向 CPU ；</p>
    <p>[0532]	&#8226;配置 1 号表”01 xxxx xxxx xxxx xxxx”为“10 0000 0000”，即所有的应答包导 向上行的百兆网口；</p>
    <p>[0533]	&#8226;配置2号、3号表为“000 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>[0534]	S6、BX-008-0交换机收到查询包后，根据其0号表的配置，该查询包被接收至其 CPU模块，由CPU解析该查询包后生成应答包（应答包中包含本交换机的注册信息），并 发送给 MSS-400 服务器，该应答包的 DA 是 0x0800 0x0000 0x0000 0x0000, SA 是 0x0000 0x0000 0x00000x0001 ；</p>
    <p>[0535]	S7、MSS-400服务器收到BX-008-0交换机发出的应答包后，对比应答包的源地址</p>
    <p>57(SA)及设备类型就知道它的0号端口下接了一台接入交换机，然后在节点服务器内部的注 册信息表里找到这台接入交换机的信息，向这台接入交换机发送入网命令（告知其接入网 地址为0x0001)；</p>
    <p>[0536]	S8、BX-008-0交换机收到入网命令后，知道自己的接入网地址是0x0001就入网 了，于是配置其0号表”00 0000 0000 0000 0001”为“010000 0000”，并0号表其余表项配 置为” 00 0000 0000 “，即只有本交换机的下行协议包导入CPU，同时向MSS-400服务器发 送入网命令应答（入网命令应答包）；</p>
    <p>[0537]	S9、MSS_400服务器收到BX-008-0交换机发出的入网命令应答就知道BX-008-0交 换机已经入网了，以后每秒钟向这个端口发送设备状态查询指令，检查BX-008-0交换机是 否正常工作，同时还要向BX-008-0交换机的下行端口发送端口下行协议包，检查是否有其 它接入网设备接在本接入交换机下面，在这种情况下，MSS-400服务器会在其0号表中做如 下配置：</p>
    <p>[0538]</p>
    <p>iOO 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0009的端口下行协议包导向0号端口 ；</p>
    <p>[0539]</p>
    <p>iOO 0000 0000 0000 1010" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOa的端口下行协议包导向0号端口 ；</p>
    <p>[0540]</p>
    <p>iOO 0000 0000 0000 1011" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOb的端口下行协议包导向0号端口 ；</p>
    <p>[0541]</p>
    <p>iOO 0000 0000 0000 1100" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOc的端口下行协议包导向0号端口 ；</p>
    <p>[0542]</p>
    <p>iOO 0000 0000 0000 1101" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOd的端口下行协议包导向0号端口 ；</p>
    <p>[0543]</p>
    <p>iOO 0000 0000 0000 1110" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOe的端口下行协议包导向0号端口 ；</p>
    <p>[0544]</p>
    <p>iOO 0000 0000 0000 1111" = &gt;‘‘000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOf的端口下行协议包导向0号端口 ；</p>
    <p>[0545]</p>
    <p>iOO 0000 0000 0001 0000" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0010的端口下行协议包导向0号端口 ；</p>
    <p>[0546]	MSS-400服务器会通过包括端口分配信息的端口分配包，通知BX-008-0交换机在 其0号表中做如下配置：</p>
    <p>[0547]	&#21443;“00 0000 0000 0000 1001 " = &gt;"00 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0009的端口下行协议包导向0号端口 ；</p>
    <p>[0548]	#"00 0000 0000 0000 1010 " = &gt;"00 0000 0010”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOa的端口下行协议包导向1号端口 ；</p>
    <p>[0549]	#"00 0000 0000 0000 1011 " = &gt;"00 0000 0100”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOb的端口下行协议包导向2号端口 ；</p>
    <p>[0550]	#"00 0000 0000 0000 1100 " = &gt;"00 0000 1000”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOc的端口下行协议包导向3号端口 ；</p>
    <p>[0551]	#"00 0000 0000 0000 1101 " = &gt;"00 0001 0000”，即目的地址(DA)是 0x80000x0000 0x0000 OxOOOd的端口下行协议包导向4号端口 ；</p>
    <p>[0552]	#"00 0000 0000 0000 1110 ‘‘ = &gt;‘‘00 0010 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOe的端口下行协议包导向5号端口 ；</p>
    <p>[0553]	&#21443;“00 0000 0000 0000 1111 “ = &gt;“00 0100 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOf的端口下行协议包导向6号端口 ；</p>
    <p>[0554]	#"00 0000 0000 0001 0000 " = &gt;"00 1000 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0010的端口下行协议包导向7号端口 ；</p>
    <p>[0555]	S10、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0009,0x8000 0x0000 0x0000 0x000a、0x8000 0x0000 0x0000 0x000b、0x8000 0x0000 0x0000 0x000c、 0x8000 0x0000 0x0000 OxOOOd,0x80000x0000 0x0000 OxOOOe,0x8000 0x0000 0x0000 OxOOOf、0x8000 0x00000x0000 0x0010 的端口下行协议包（SA 都为 0x0000 0x0000 0x00000x0000)，根据MSS-400服务器中0号表的配置，端口下行协议包会依次导向MSS-400 服务器0号端口，根据BX-008-0交换机中0号表的配置，端口下行协议包会依次导向 BX-008-0交换机0到7号端口 ；</p>
    <p>[0556]	S1UBX-008-1交换机从BX-008-0交换机的1号端口收到端口下行协议包（即目 的地址是0x8000 0x0000 0x0000 0x000a的端口下行协议包）后发送端口上行协议包（该 端口上行协议包中包含本交换机的注册信息），包的DA是0x0800 0x0000 0x0000 0x0000, SA 是 0x0000 0x00000x0000 0x000a ；</p>
    <p>[0557]	S12、MSS-400服务器收到BX_008_1交换机发出的端口上行协议包后，对比上行 协议包的源地址（SA)及设备类型就知道BX-008-0的1号端口下接了一台接入交换机，然 后在服务器内部的注册信息表里找到这台接交换机信息，并向该接入交换机发送入网命令 (告知其接入网地址为0x000a)；</p>
    <p>[0558]	S13、BX-008-1交换机收到入网命令后，知道自己的接入网地址是0x000a就入网 了，配置其0号表”00 0000 0000 0000 1010”为“01 00000000”，0号表其余表项配置为”00 0000 0000 “，即只有本交换机的下行协议包导入CPU，同时向服务器发送入网命令应答；</p>
    <p>[0559]	S14、MSS-400服务器收到交换机发出的入网命令应答就知道BX_008_1交换机已 经入网了，以后每秒钟向这个端口发送设备状态查询指令，检查BX-008-1交换机是否正常 工作，同时还要向BX-008-1交换机的下行端口发送端口下行协议包，检查是否有其他接入 网设备接在本接入交换机下面。如果当前接入交换机正常工作，收到设备状态查询指令后 会发送状态查询应答给服务器。当服务器6秒之内没有收到状态查询应答，就认为这台接 入交换机已经被移出网络，不再发送设备状态查询指令，继续向本端口发送查询包。</p>
    <p>[0560]	3.1.3终端的入网过程：</p>
    <p>[0561]	首先每台允许入网的终端都必须在节点服务器中注册，没有注册的终端无法入 网。如图6所示，所述终端入网的过程涉及以下步骤：</p>
    <p>[0562]	Si、节点服务器向每个端口发送查询包，终端收到查询包后发送应答包，该应答包 中包含终端的注册信息；</p>
    <p>[0563]	S2、节点服务器收到终端发出的应答包后就知道哪个端口下接了哪种终端（机顶 盒，编码板还是存储器），然后在节点服务器内部的注册信息表里找到该终端的信息，向该 终端发送入网命令（告诉终端的接入网地址），终端收到入网命令后就入网了，同时向节点服务器发送入网命令应答；</p>
    <p>[0564]	S3、节点服务器收到终端发出的入网命令应答就知道本终端已经入网了，以后定 时向这个端口发送状态查询包，检查终端是否正常工作。如果终端正常工作，收到状态查询 包后会发送状态查询应答给节点服务器。当节点服务器一段时间之内没有收到状态查询应 答，就认为本终端已经被移出网络，不再发送状态查询包，继续向本端口发送查询包。</p>
    <p>[0565]	3. 1. 4节点服务器与接入交换机、终端在入网过程中的交互示例：</p>
    <p>[0566]	接入网的地址可以设置为16bit，所有接入网设备都有唯一的接入网地址（包括 机顶盒、接入交换机、存储器，甚至节点服务器本身）。为方便管理所有接入网设备的接入网 地址，在节点服务器的CPU模块中可以维护一张地址信息表，该表的大小为2的16次方，也 即64K，每个表的表项由如下构成：</p>
    <p>[0567]	1)地址占用描述符：“00”表示此地址未用，“01”表示此地址待用（节点服务器用 此地址发出了端口下行协议包，但未收到入网上行协议包)，“10”表示此地址已用（节点服 务器收到入网上行协议包后设置）；</p>
    <p>[0568]	2)设备描述符：例如，“000000”表示节点服务器，“000001”表示其中一种接入交 换机BX-008，“000010”表示其中一种存储器，“000011 ”表示其中一种终端；</p>
    <p>[0569]	3)设备资源描述信息：例如，该设备是接入交换机的话，它的网络端口连接的设 备的接入网地址，它的各个网络端口的上下行流量计数；如果该设备是存储器的话，它的网 络端口连接的设备的接入网地址，它的读写通道的计数以及网络端口的上下行流量计数； 等等，所有这些信息是为了服务流程提供决策依据，而且每次的服务流程中都会修改这些 fn息ο</p>
    <p>[0570]	如图7所示，假设一台节点服务器MSS-400，它的0号端口接了一台接入交换机 BX-008-0，它的1号端口接了一台接入交换机BX-008-1，BX-008-0的0号端口接了一台机 顶盒STB-0，BX_008-1的1号端口接了一台机顶盒STB-1。</p>
    <p>[0571]	Si、MSS-400服务器上电后初始化硬件，获得默认城域网地址（假设为0x00 0x0000 0x0000)，从硬盘导入配置文件到CPU内存（例如交换机的注册信息、终端的注册信 息等等)，MSS-400服务器初始化地址信息表，全部清零（表示所有地址未用)，MSS-400服 务器配置自己的接入网地址为0x0000，也即地址信息表的第0x0000项被配置成如下：</p>
    <p>[0572]	&#8226;地址占用描述符：“10”表示此地址已用；</p>
    <p>[0573]	&#8226;设备描述符：“000000”表示节点服务器；</p>
    <p>[0574]	&#8226;设备资源描述信息：此节点服务器有8个下行百兆网口依次定义为0号端口到 7号端口，1个CPU模块接口定义为8号端口，1个磁盘阵列接口定义为9号端口，1个上行 千兆光口定义为10号端口，此节点服务器型号为MSS-400，它的网络端口连接的设备的接 入网地址未分配，它的各个网络端口的上下行流量计数为0 ；</p>
    <p>[0575]	地址信息表下一个可用地址为0x0001 ；</p>
    <p>[0576]	S2、MSS-400服务器初始化0、1、2、3号表：</p>
    <p>[0577]	&#8226;配置0号表为“000 0000 0000 “，即所有下行协议包传送关闭；</p>
    <p>[0578]	&#8226;配置1号表为“001 0000 0000”，即所有上行协议包导向CPU ；</p>
    <p>[0579]	&#8226;配置2号、3号表为“000 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>[0580]	S3、MSS-400服务器知道自己有8个下行端口，下一个可用地址为0x0001，所以它配置8个0号表的表项分别为：</p>
    <p>[0581]	#"00 0000 0000 0000 0001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0001的查询包导向0号端口 ；</p>
    <p>[0582]	#"00 0000 0000 0000 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0002的查询包导向1号端口 ；</p>
    <p>[0583]	#"00 0000 0000 0000 0011" = &gt;"000 0000 0100”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0003的查询包导向2号端口 ；</p>
    <p>[0584]	#"00 0000 0000 0000 0100" = &gt;"000 0000 1000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0004的查询包导向3号端口 ；</p>
    <p>[0585]	#"00 0000 0000 0000 0101" = &gt;"000 0001 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0005的查询包导向4号端口 ；</p>
    <p>[0586]	#"00 0000 0000 0000 0110" = &gt;"000 0010 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0006的查询包导向5号端口 ；</p>
    <p>[0587]	&#21443;“00 0000 0000 0000 0111“ = &gt;“000 0100 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0007的查询包导向6号端口 ；</p>
    <p>[0588]	#"00 0000 0000 0000 1000" = &gt;"000 1000 0000”，即目的地址（DA)是 0x8000 0x0000 0x0000 0x0008的查询包导向7号端口 ；</p>
    <p>[0589]	S4、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0001,0x8000 0x0000 0x0000 0x0002,0x8000 0x0000 0x0000 0x0003,0x8000 0x0000 0x0000 0x0004、 0x8000 0x0000 0x0000 0x0005,0x80000x0000 0x0000 0x0006,0x8000 0x0000 0x0000 0x0007、0x8000 0x00000x0000 0x0008 的查询包（SA 都为 0x0000 0x0000 0x0000 0x0000)，根据其0号表的配置，所述查询包会依次导向0到7号端口 ；此时，地址信息表的 第0x0001至0x0008项被配置成：</p>
    <p>[0590]	&#8226;地址占用描述符：‘‘01”表示此地址待用；</p>
    <p>[0591]	&#8226;设备描述符：不做修改；</p>
    <p>[0592]	&#8226;设备资源描述信息：不做修改；</p>
    <p>[0593]	地址信息表的下一个可用地址为0x0009 ；</p>
    <p>[0594]	S5、BX-008-0、BX-008-l交换机上电后初始化硬件，</p>
    <p>[0595]	&#8226;配置其 0 号表”00 xxxx xxxx xxxx xxxx”为“01 0000 0000”，即所有下行协议 包包导向CPU ；</p>
    <p>[0596]	&#8226;配置其 1 号表”01 xxxx xxxx xxxx xxxx”为“10 0000 0000”，即所有的上行协 议包导向上行的百兆网口；</p>
    <p>[0597]	&#8226;配置其2号、3号表为“00 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>[0598]	S6、BX-008-0交换机收到查询包后，根据其0号表的配置，该查询包被接收至其 CPU模块，由CPU模块解析该查询包并生成应答包（该应答中包含本接入交换机的注册 信息）发送给 MSS-400 服务器，包的 DA 是 0x0800 0x0000 0x0000 0x0000, SA 是 0x0000 0x0000 0x00000x0001 ；</p>
    <p>[0599]	S7、MSS-400服务器收到BX-008-0交换机发出的应答包后，对比应答包的源地址 (SA)、及设备类型就知道其0号端口下接了一台接入交换机，然后在节点服务器内部的注</p>
    <p>61册信息表里找到这台接入交换机的信息，向该接入交换机发送入网命令（告知其接入网地 址为 0x0001)；</p>
    <p>[0600]	S8、BX-008-0交换机收到入网命令后，知道自己的接入网地址是0x0001就入网 了，于是配置其0号表”00 0000 0000 0000 0001”为“010000 0000”，0号表其余表项配置 为” 00 0000 0000 “，即只有本交换机的下行协议包导入CPU，同时向服务器发送入网命令</p>
    <p>应答；</p>
    <p>[0601]	S9、MSS-400服务器收到BX-008-0交换机发出的入网命令应答就知道BX-008-0交 换机已经入网了，于是将服务器内部的地址信息表的第0x0001项被配置成：</p>
    <p>[0602]	&#8226;地址占用描述符：“10”表示此地址已用；</p>
    <p>[0603]	&#183;设备描述符：“ 000001，，表示其中一种接入交换机BX-008 ；</p>
    <p>[0604]	&#8226;设备资源描述信息：此接入交换机有8个下行百兆网口依次定义为0号端口到 7号端口，1个CPU模块接口定义为8号端口，1个上行百兆网口定义为9号端口，此接入交换 机型号为BX-008，它的上行网络端口连接的设备的接入网地址是0x0000 (即MSS-400)，下 行网络端口连接的设备的接入网地址未分配，它的各个网络端口的上下行流量计数为0 ；</p>
    <p>[0605]	以后每秒钟向这个端口发送设备状态查询指令，检查BX-008-0交换机是否正常 工作，同时还要向BX-008-0交换机的下行端口发送端口下行协议包，检查是否有其他接入 网设备接在本接入交换机下面。在这种情况下，MSS-400服务器会在其0号表中做如下配 置：</p>
    <p>[0606]	#"00 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0009的端口下行协议包导向0号端口 ；</p>
    <p>[0607]</p>
    <p>iOO 0000 0000 0000 1010" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOa的端口下行协议包导向0号端口 ；</p>
    <p>[0608]</p>
    <p>iOO 0000 0000 0000 1011" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOb的端口下行协议包导向0号端口 ；</p>
    <p>[0609]</p>
    <p>iOO 0000 0000 0000 1100" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOc的端口下行协议包导向0号端口 ；</p>
    <p>[0610]</p>
    <p>iOO 0000 0000 0000 1101" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOd的端口下行协议包导向0号端口 ；</p>
    <p>[0611]</p>
    <p>iOO 0000 0000 0000 1110" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOe的端口下行协议包导向0号端口 ；</p>
    <p>[0612]</p>
    <p>iOO 0000 0000 0000 1111" = &gt;‘‘000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOf的端口下行协议包导向0号端口 ；</p>
    <p>[0613]	#"00 0000 0000 0001 0000" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0010的端口下行协议包导向0号端口 ；</p>
    <p>[0614]	MSS-400服务器会通过包括端口分配信息的端口分配包，通知BX-008-0交换机在 其0号表中做如下配置：</p>
    <p>[0615]	#"00 0000 0000 0000 1001 " = &gt;"00 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0009的端口下行协议包导向0号端口 ；</p>
    <p>[0616]	#"00 0000 0000 0000 1010 " = &gt;"00 0000 0010”，即目的地址(DA)是 0x80000x0000 0x0000 OxOOOa的端口下行协议包导向1号端口 ；</p>
    <p>[0617]	#"00 0000 0000 0000 1011 " = &gt;"00 0000 0100”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOb的端口下行协议包导向2号端口 ；</p>
    <p>[0618]	#"00 0000 0000 0000 1100 " = &gt;"00 0000 1000”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOc的端口下行协议包导向3号端口 ；</p>
    <p>[0619]	#"00 0000 0000 0000 1101 " = &gt;"00 0001 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOd的端口下行协议包导向4号端口 ；</p>
    <p>[0620]	#"00 0000 0000 0000 1110 ‘‘ = &gt;‘‘00 0010 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOe的端口下行协议包导向5号端口 ；</p>
    <p>[0621]	&#21443;“00 0000 0000 0000 1111 “ = &gt;“00 0100 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOf的端口下行协议包导向6号端口 ；</p>
    <p>[0622]	#"00 0000 0000 0001 0000 " = &gt;"00 1000 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0010的端口下行协议包导向7号端口 ；</p>
    <p>[0623]	S10、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0009,0x8000 0x0000 0x0000 0x000a、0x8000 0x0000 0x0000 0x000b、0x8000 0x0000 0x0000 0x000c、 0x8000 0x0000 0x0000 OxOOOd,0x80000x0000 0x0000 OxOOOe,0x8000 0x0000 0x0000 OxOOOf、0x8000 0x00000x0000 0x0010 的端口下行协议包（SA 都为 0x0000 0x0000 0x00000x0000)，根据MSS-400服务器中0号表的配置，所述端口下行协议包会依次导向 MSS-400服务器0号端口，根据BX-008-0交换机中0号表配置，端口下行协议包会依次导 向BX-008-0交换机0到7号端口 ；并且，MSS-400服务器中的地址信息表的第0x0009至 0x0010项被配置成：</p>
    <p>[0624]	&#8226;地址占用描述符：‘‘01”表示此地址待用；</p>
    <p>[0625]	&#8226;设备描述符：不做修改；</p>
    <p>[0626]	&#8226;设备资源描述信息：不做修改；</p>
    <p>[0627]	下一个可用地址为0x0011 ；</p>
    <p>[0628]	Sl 1、STB-O从BX-008-0交换机的0号端口收到端口下行协议包（即目的地址是 0x8000 0x0000 0x0000 0x0009的端口下行协议包）收到端口下行协议包后发送端口上行 协议包（包含本终端的注册信息），包的DA是0x0800 0x0000 0x0000 0x0000，SA是0x0000 0x0000 0x0000 0x0009 (交换机的 0 号端口 )；</p>
    <p>[0629]	S12、MSS-400服务器收到STB-O交换机发出的端口上行协议包后，对比上行协议 包的源地址（SA)及设备类型就知道BX-008-0的0号端口下接了一台终端，然后在服务 器内部的注册信息表里找到终端信息，向终端发送入网命令（告诉终端的接入网地址为 0x0009)；</p>
    <p>[0630]	S13、STB-O收到入网命令后，知道自己的接入网地址是0x0009就入网了，同时向 服务器发送入网命令应答；</p>
    <p>[0631]	S14、MSS_400服务器收到STB-0发出的入网命令应答就知道STB-0交换机已经入 网了，于是将地址信息表的第0x0009项配置成：</p>
    <p>[0632]	&#8226;地址占用描述符：‘‘10”表示此地址已用；</p>
    <p>[0633]	&#8226;设备描述符：“000011”表示其中一种终端；[0634]	&#8226;设备资源描述信息：此终端有视音频编解码引擎，1个百兆网口，此终端型号为 STB，它的网络端口连接的设备的接入网地址是0x0001 (即BX-008-0)，它的网络端口的上 下行流量计数为0 ；</p>
    <p>[0635]	地址信息表的第0x0001项被配置成：</p>
    <p>[0636]	&#8226;地址占用描述符：不做修改；</p>
    <p>[0637]	&#8226;设备描述符：不做修改；</p>
    <p>[0638]	&#8226;设备资源描述信息：此接入交换机有8个下行百兆网口依次定义为0号端口到 7号端口，1个CPU模块接口定义为8号端口，1个上行百兆网口定义为9号端口，此接入交 换机型号为BX-008，它的上行网络端口连接的设备的接入网地址是0x0000 (即MSS-400)， 下行网络端口 0连接的设备的接入网地址是0x0009，其余未分配，它的各个网络端口的上 下行流量计数为0 ；</p>
    <p>[0639]	以后MSS-400服务器每秒钟向这个端口发送设备状态查询指令，检查STB-O是否 正常工作，当服务器6秒之内没有收到状态查询应答，就认为STB-O已经被移出网络，不再 发送设备状态查询指令，继续向本端口发送查询包。</p>
    <p>[0640]	参照上述第S6-S14步骤，BX-008-1也会入网，获得其接入网地址为0x0002 ；STB-I 也会入网，获得其接入网地址为0x0012。</p>
    <p>[0641]	3. 1. 5接入网设备入网过程中的数据格式定义：</p>
    <p>[0642]	PDU是用户终端和服务器的信息交互方式，两者使用原始套接字（Raw Socket)传 递PDU，其数据格式如下：</p>
    <p>[0643]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0644]	3.2接入网设备的通信连接流程：</p>
    <p>[0645]	3. 2. 1接入网设备执行单播通信服务的通信连接流程示例：</p>
    <p>[0646]	如图7所示，假设一台节点服务器MSS-400 (接入网地址为0x0000)，它的0号端口 接了一台接入交换机BX-008-0(接入网地址为0x0001)，它的1号端口接了一台接入交换机 BX-008-1 (接入网地址为0x0002)，BX-008-0的0号端口接了一台机顶盒STB-0 (接入网地 址为0x0009)，BX_008-1的1号端口接了一台机顶盒STB-I (接入网地址为0x0012)。机顶 盒STB_0向节点服务器MSS-400发出申请和机顶盒STB_1进行可视通信的单播通信服务， 步骤如下：</p>
    <p>[0647]	Si、机顶盒STB_0发出服务请求协议包，包的DA(目的地址)为0x0800 0x0000 0x0000 0x0000 (即 MSS-400 的地址)、SA (源地址)为 0x0000 0x0000 0x0000 0x0009 ；在 该包中，还可以包括reserved 0x0000 (保留字），PDU部分如下表所示：</p>
    <p>[0648]</p>
    <p>64</p>
    <span class="patent-image-not-available"> </span>
    <p>[0649]</p>
    <p>[0650]</p>
    <p>[0651]</p>
    <p>[0652]</p>
    <p>[0653]</p>
    <p>[0654]</p>
    <p>[0655]</p>
    <p>[0656]</p>
    <p>[0657]</p>
    <p>[0658]</p>
    <p>[0659]</p>
    <p>[0660] [0661]</p>
    <p>停继续 [0662]</p>
    <p>[0663]</p>
    <p>[0664]</p>
    <p>[0665]</p>
    <p>[0666]</p>
    <p>[0667]</p>
    <p>[0668]</p>
    <p>服务申请所涉及到的节目号码，广播频道号全放在服务参数中，例如：</p>
    <p>#define SERVICE_TYPE_GTML_REQUEST 0x8000 申请一张菜单</p>
    <p>#define SERVICE_TYPE_VOD_REQUEST 0x8001 申请点播节目</p>
    <p>#define SERVICE_TYPE_CHANGE_MENU 0x8002 申请改变背景菜单</p>
    <p>#define SERVICE_TYPE_BROADCAST_REQUEST 0x8003 申请收看广播</p>
    <p>#define SERVICE_TYPE_CHANGE_CHANNEL 0x8004 申请频道切换</p>
    <p>#define SERVICE_TYPE_TELEPHONE_DIRECT 0x8005 申请拨打可视电话</p>
    <p>#define SERVICE_TYPE_PERMISSION 0x8006 是否允许接入的应答</p>
    <p>#define SERVICE_TYPE_RECORD_REQUEST 0x8007 申请录制</p>
    <p>#define SERVICE_TYPE_END_REQUEST 0x8008 申请结束当前服务</p>
    <p>#define SERVICE_TYPE_ORG_CAST_REQUEST 0x8009 申请发起直播</p>
    <p>#define SERVICE_TYPE_DDB_REQUEST 0x800b 申请收看延时电视</p>
    <p>#define SERVICE_TYPE_SKIP 0x800c收看点播或延时电视的过程中快进快退暂</p>
    <p>#define SERVICE_TYPE_RECORD_END 0x800e 申请结束录制 #define SERVICE_TYPE_VIEff_Monitor_DIRECT 0x8024 申请收看监控 #define SERVICE_TYPE_RCV_CAST_DIRECT 0x8025 申请收看直播 #define SERVICE_TYPE_TELEPHONE_REQUEST 0 申请拨打可视电话 #define SERVICE_TYPE_RCV_CAST_REQUEST Oxa 申请收看直播 #define SERVICE_TYPE_VIEff_Monitor Oxc 申请收看监控</p>
    <p>在本例中，服务参数为 SERVICE_TYPE_TELEPHONE_REQUEST 或 SERVICE_TYPE_ TELEPHONE_DIRECT。</p>
    <p>[0669]	S2、根据连接在机顶盒STB_0与节点服务器MSS-400之间的接入交换机ΒΧ_008_0 中1号表的配置，该服务请求协议包被导向至节点服务器MSS-400，节点服务器MSS-400根 据包的内容，判断收到可视通信的申请（服务类型），根据服务号码查CAM表（内容-地址 映射表）知道被叫（目标终端）是STB_1，根据其内部的地址信息表，就知道了本次服务 涉及的链路拓扑，判断出链路允许，双方可以进行通信。于是分别发送菜单协议包给主叫 (STB_0)和被叫（STB_1)，并等待被叫应答：</p>
    <p>[0670]其中，发向	STB_0 的菜单协议包：DA 为 0x8000 0x0000 0x00000x0009、SA 为</p>
    <p>650x0000 0x0000 0x0000 0x0000、reserved 0x0000、PDU 部分如下表所示： [0671]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0672]发向	STB_1 的菜单协议包:DA 为 0x8000 0x0000 0x0000 0x0012、SA 为 0x0000 0x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如上表所示。</p>
    <p>[0673]	S3、根据节点服务器MSS-400中0号表的配置，以及，接入交换机BX-008-0和 BX-008-1中0号表的配置，这2个菜单协议包会分别导向至机顶盒STB_0和STB_1，被叫 STB_1发出申请SERVICE_TYPE_PERMISSION接STB_1受通信，并向节点服务器MSS-400发 送应答协议包，该包的 DA 为 0x0800 0x0000 0x0000 0x0000、SA 0x0000 0x0000 0x0000 0x0012、reserved 0x0000，服务参数是 SERVICE_TYPE_PERMISSION，PDU 部分如下表所示：</p>
    <p>[0674]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0675] S4、根据接入交换机BX-008-1中1号表的配置，所述应答协议包导向节点服务器 MSS-400,节点服务器MSS-400根据包的内容判断收到接受可视通信的申请，根据服务号码查CAM表知道被叫是STB_1，根据其内部的地址信息表，节点服务器MSS-400就知道了本次 服务涉及的链路拓扑，判断出链路允许，双方可以进行通信。</p>
    <p>[0676]	在这种情况下，节点服务器MSS-400配置自己的2号表如下：</p>
    <p>[0677]	#"10 0000 0000 0001 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012 (即机顶盒BX-008-1)的单播数据包导向1号端口 ；</p>
    <p>[0678]	&#21443;“10 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0009 (即机顶盒BX-008-0)的单播数据包导向0号端口 ；</p>
    <p>[0679]	并且，节点服务器MSS-400给上行链路（主叫通路)和下行链路（被叫通路)上 的所有接入交换机发送端口配置命令。要求同时开放对方地址的上行和自身地址的下行。</p>
    <p>[0680]	发向接入交换机BX-008-0的两个包：</p>
    <p>[0681]	1)第一个包的 DA 0x8000 0x0000 0x0000 0x0001、SA 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如下表所示：</p>
    <p>[0682]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0683]	2)第二个包的 DA 为 0x8000 0x0000 0x0000 0x0001、SA 为 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如下表所示：</p>
    <p>[0684]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0685]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0686]	发向接入交换机BX-008-1的两个包：</p>
    <p>[0687]	1)第一个包的 DA 为 0x8000 0x0000 0x0000 0x0002、SA 为 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如下表所示：</p>
    <p>[0688]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0689]	2)第二个包的 DA 为 0x8000 0x0000 0x0000 0x0002、SA 为 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如下表所示：</p>
    <p>[0690]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0691]	发向机顶盒STB-O的包（服务处理命令，本例中为编解码命令）：</p>
    <p>[0692]包的	DA 0x8000 0x0000 0x0000 0x0009、 SA 0x0000 0x0000 0x00000x0000、 reserved 0x0000, PDU部分如下表所示：</p>
    <p>[0693]</p>
    <p>[0694]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0695]	发向STB-I的包（服务处理命令，本例中为编解码命令）：</p>
    <p>[0696]包的	DA 为 0x8000 0x0000 0x0000 0x0012、SA 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：[0697]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0698]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0699]	上述编解码命令的PDU中，字段号13表示编码类型：0 =停止编码，Offff =维持 原状，Oxfffe将解码的数据返回，不进行本地编码；字段号14表示解码类型：0 =停止解 码，Offff =维持原状；字段号15-18表示编码地址（DA或组播地址）=OxfTfT =维持原状； 字段号19-22表示解码地址（DA或组播地址）=OxfTfT =维持原状；字段号23表示：HB ：编 码HDA，LB ：解码的HAD ；Oxffff =维持原状；字段号24表示响铃参数：0 =关闭响铃，1 = 开始响铃，Oxffff =维持原状；字段号25表示云台操作参数=Oxffff =维持原状；字段号 26表示辅助信道操作参数=OxfTfT =维持原状。</p>
    <p>[0700]	其中，编码类型如下表所示：</p>
    <p>[0701]</p>
    <p>代码	视频压缩	视频制式	音频压缩	流量等级0x3215	MPEG4	PAL	MP3	1. 7M</p>
    <span class="patent-image-not-available"> </span>
    <p>[0702]	S5、根据节点服务器MSS-400中0号表的配置，以及，接入交换机BX-008-0、 BX-008-1中0号表的配置，前面4个发给接入交换机的包会分别导向ΒΧ-008-0、ΒΧ-008-1。</p>
    <p>[0703]	在这种情况下，接入交换机BX-008-0配置自己的2号表如下：</p>
    <p>[0704]	&#21443;“10 0000 0000 0001 0010 “ = &gt;“10 0000 0000”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012的单播数据包导向9号端口 ；</p>
    <p>[0705]	#"10 0000 0000 0000 1001 " = &gt;"00 0000 0001”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向0号端口 ；</p>
    <p>[0706]	接入交换机BX-008-1配置自己的2号表如下：</p>
    <p>[0707]	&#21443;“10 0000 0000 0001 0010 “ = &gt;“00 0000 0010”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012的单播数据包导向1号端口 ；</p>
    <p>[0708]	#"10 0000 0000 0000 1001 " = &gt;"10 0000 0000”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向9号端口 ；</p>
    <p>[0709]	根据节点服务器MSS-400中0号表的配置，以及，接入交换机ΒΧ-008-0、ΒΧ-008_1 中0号表的配置，后面2个发向机顶盒的包会分别导向至机顶盒STB-0、STB-1。收到包后， 机顶盒STB-0、STB-I就可以根据包的内容开始编解码，并接收、发送单播数据。</p>
    <p>[0710]	具体而言，在配置好当次服务的通信链路后，所述机顶盒STB-0、STB-I基于所述 通信链路收发单播数据的过程为：</p>
    <p>[0711]	1)机顶盒STB-O向机顶盒STB-I发送单播数据包，该包的DA是0x1000 0x0000 0x0000 0x0012 ;SA 是0x0000 0x0000 0x0000 0x0009 ；</p>
    <p>[0712]	2)该单播数据包进入接入交换机BX-008-0，接入交换机BX-008-0的交换引擎模 块根据组合地址域查2号表，表的地址是“10 0000 00000001 0010”，该表项的输出是“10 0000 0000"("10 0000 0000 00010010" = &gt;"10 0000 0000”，即目的地址(DA)是 0x1000 0x0000 0x00000x0012的单播数据包导向9号端口），表示打开上行9号端口，当前单播数 据包通过该9号端口进入了节点服务器MSS-400 ；</p>
    <p>[0713]	3)节点服务器MSS-400收到所述单播数据包后，其交换引擎根据组合地址域查2 号表,表的地址是“10 0000 0000 0001 0010”，该表项的输出是“000 0000 0010，，（"10 0000 0000 0001 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012的单播数据包导向1号端口），表示打开下行1号端口，当前单播数据包通过该1号 端口进入了接入交换机BX-008-1 ；</p>
    <p>[0714]	4)接入交换机BX-008-1收到所述单播数据包后，其交换引擎模块根据组合 地址域查2号表，表的地址是“10 0000 0000 0001 0010”，该表项的输出是“00 0000 0010” ( “10 0000 0000 0001 0010 “=&gt;“00 00000010”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012的单播数据包导向1号端口），表示打开下行1号端口，当前单播数 据包通过该1号端口进入了机顶盒STB-I ；</p>
    <p>[0715]	5)机顶盒STB-I向机顶盒STB-O发送单播数据包，该包的DA是0x1000 0x0000 0x0000 0x0009 ;SA 是0x0000 0x0000 0x0000 0x0012 ；[0716]	6)该单播数据包进入接入交换机BX-008-1，接入交换机BX-008-1的交换引擎模 块根据组合地址域查2号表，表的地址是“10 0000 00000000 1001”，该表项的输出是“10 0000 0000"("10 0000 0000 00001001 " = &gt;"10 0000 0000”，即目的地址(DA)是 0x1000 0x0000 0x00000x0009的单播数据包导向9号端口），表示打开上行9号端口，当前单播数 据包通过该9号端口进入了节点服务器MSS-400 ；</p>
    <p>[0717]	7)节点服务器MSS-400收到所述单播数据包后，其交换引擎根据组合地址域查2 号表,表的地址是“10 0000 0000 0000 1001”，该表项的输出是“000 0000 0001”（“10 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向0号端口），表示打开下行0号端口，当前单播数据包通过该0号 端口进入了接入交换机BX-008-0 ；</p>
    <p>[0718]	8)接入交换机BX-008-0收到所述单播数据包后，其交换引擎模块根据组合 地址域查2号表，表的地址是“10 0000 0000 0000 1001”，该表项的输出是“00 0000 0001”（“10 0000 0000 0000 1001 “=&gt;“00 00000001”，即目的地址（DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向0号端口），表示打开下行0号端口，当前单播数 据包通过该0号端口进入了机顶盒STB-O。</p>
    <p>[0719]	应用上述过程进行单播服务通信的一种简单示例如下：</p>
    <p>[0720]	假设STB-O向MSS-400服务器申请打可视电话给STB-1，在STB-0发向MSS-400的 服务申请包中含有所申请服务的类型（本例是可视电话，所以含有对方的号码，例如8888 8888 8888)；</p>
    <p>[0721 ] MSS-400服务器收到服务申请包后，检查服务类型知道是可视电话，就跳入可视电 话服务流程，根据对方的号码（8888 8888 8888)，MSS-400服务器通过CAM查找可以得到 STB-I的接入网地址（因为在STB-I入网时，MSS-400服务器会更新CAM的内容，把地址为 0x0012更新为8888 8888 8888)，根据STB-O、STB-I的接入网地址，查地址信息表可以知道 他们的拓扑信息，由0x0009知道STB-O连着BX-008-0的0号端口，而且上下行流量为0， 而链路流量为100Mbit/s，BX-008-0的接入网地址是0x0001，查地址信息表知BX-008-0连 着MSS-400的0号端口，而且上下行流量为0，而链路流量为100Mbit/S，同理可知STB-I的 链路的流量信息，而申请的可视电话的上下行带宽是2Mbit/s，满足要求，再检查其他信息 如果满足，服务器将被叫机顶盒和主叫机顶盒之间的所有交换机的针对这2路单播数据的 通路打开（包括对BX-008-0的0号端口、BX-008-1的1号端口的地址匹配及精确流量控 制），修改查地址信息表的链路的流量信息，服务器发送编解码命令给双方机顶盒。</p>
    <p>[0722]	3. 2. 2接入网设备执行组播通信服务的通信连接流程示例：</p>
    <p>[0723]	如图7所示，假设一台节点服务器MSS-400 (接入网地址为0x0000)，它的0号端口 接了一台接入交换机BX-008-0(接入网地址为0x0001)，它的1号端口接了一台接入交换机 BX-008-1 (接入网地址为0x0002)，BX-008-0的0号端口接了一台机顶盒STB-0 (接入网地 址为 0x0009)，STB_0 的号码是 0x6666 0x6666 0x6666，BX_008-1 的 1 号端口接了一台机 顶盒STB-1(接入网地址为0x0012)，STB_1的号码是0x8888 0x88880x8888。机顶盒STB_0 向节点服务器MSS-400申请发起直播，步骤如下：</p>
    <p>[0724]	Si、机顶盒STB_0发出发起直播的服务请求协议包，包的DA是0x0800 0x0000 0x0000 0x0000、SA 是 0x0000 0x0000 0x0000 0x0009,reserved 0x0000 (保留字），PDU 部</p>
    <p>73分如下表所示： [0725]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0726]	S2、根据连接在机顶盒STB_0与节点服务器MSS-400之间的接入交换机ΒΧ_008_0 中1号表的配置，该服务请求协议包被导向节点服务器MSS-400，节点服务器MSS-400根据 包的内容，判断收到发起直播的申请（服务类型），根据服务号码查CAM表（内容-地址映 射表）知道用户（源终端）是STB_0，根据其内部的地址信息表，就知道了本次服务涉及的 链路拓扑，判断出链路允许，可以进行发起直播，于是分配组播地址为0x0008。并且，节点服 务器给当前通信链路上的所有接入交换机发送端口配置命令，要求同时开放对方地址的上 行和自身地址的下行。此时，通过链路拓扑判断，获知当前只需配置接入交换机BX-008-0。</p>
    <p>[0727]	在这种情况下，节点服务器MSS-400向接入交换机BX-008-0发包：</p>
    <p>[0728]包的	DA 为 0x8000 0x0000 0x0000 0x0001、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000 (保留字)，PDU部分如下表所示：</p>
    <p>[0729]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0730]	节点服务器MSS-400向机顶盒STB-O发包（服务处理命令，本例为编解码命令）：</p>
    <span class="patent-image-not-available"> </span>
    <p>[0733]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0734]	S3、根据节点服务器MSS-400中0号表的配置，发向接入交换机BX-008-0的包会 导向至BX-008-0。在这种情况下，BX-008-0配置自己的3号表如下：</p>
    <p>[0735]	#"11 0000 0000 0000 1000 " = &gt;"00 0000 0001”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向0号端口 ；</p>
    <p>[0736]	S4、根据节点服务器MSS-400中0号表的配置，以及，接入交换机BX-008-0中0号 表的配置，发向机顶盒STB-O的包会导向至STB-0。STB-O根据包的内容开始编解码，并开 始接收、发送组播数据。</p>
    <p>[0737]	具体而言，所述机顶盒STB-O基于当前的直播发起通信链路收发组播数据的过程 为：</p>
    <p>[0738]	1)机顶盒STB-O发出组播数据包，该包的DA是0x7800 0x00000x0000 0x0008 (组 播地址）；SA 是 0x0000 0x0000 0x0000 0x0009 ；</p>
    <p>[0739]	2)所述组播数据包进入接入交换机BX-008-0，接入交换机BX-008-0的交换引擎 模块根据组合地址域查3号表，表的地址是“11 0000 00000000 1000”，该表项的输出是 “00 0000 0001”（ “11 0000 0000 00001000 “ = &gt;“00 0000 0001”，即目的地址(DA)是 0x7800 0x0000 0x00000x0008的组播数据包导向0号端口 )，表示打开下行0号端口，当前</p>
    <p>组播数据包通过该O号端口进入了机顶盒STB-O。[0740]	机顶盒STB_1向节点服务器MSS-400申请收看直播，号码是0x66660x6666 0x6666，步骤如下：</p>
    <p>[0741]	Si、机顶盒STB_1发出收看直播的服务请求协议包，包的DA是0x0800 0x0000 0x0000 0x0000、SA 是 0x0000 0x0000 0x0000 0x0012、reserved 0x0000，PDU 部分如下表</p>
    <p>所示：</p>
    <p>[0742]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0743]	S2、根据连接在机顶盒STB_1与节点服务器MSS-400之间的接入交换机BX_008_1 中1号表的配置，该服务请求协议包被导向节点服务器MSS-400，节点服务器MSS-400根 据包的内容，判断收到收看直播的申请，根据服务号码查CAM表知道发起者（源终端）是 STB_0，根据其内部的地址信息表，就知道了本次服务涉及的链路拓扑，判断出链路允许，可 以进行收看直播，于是分配组播地址（对应分配给源终端的组播地址）是0x0008。并且，节 点服务器给当前通信链路上的所有接入交换机发送端口配置命令，要求同时开放对方地址 的上行和自身地址的下行。在这种情况下，节点服务器MSS-400配置自己的3号表如下：</p>
    <p>[0744]	&#21443;“11 0000 0000 0000 1000" = &gt;"000 0000 0010”，即目的地址（DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口 ；</p>
    <p>[0745]	同时，节点服务器MSS-400向接入交换机BX-008-0发包：</p>
    <p>[0746]包的	DA 为 0x8000 0x0000 0x0000 0x0001、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：</p>
    <p>[0747]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0748]	同时，节点服务器MSS-400向接入交换机BX-008-1发包：</p>
    <p>[0749]包的	DA 为 0x8000 0x0000 0x0000 0x0002、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：</p>
    <p>[0750]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0751]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0752]	同时，节点服务器MSS-400向机顶盒STB-I发包：</p>
    <p>[0753]包的	DA 为 0x8000 0x0000 0x0000 0x0012、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：</p>
    <p>[0754] </p>
    <p>[0755]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0756]	S3、根据节点服务器MSS-400中0号表的配置，发向接入交换机BX-008-0、 BX-008-1会分别导向至接入交换机BX-008-0和BX-008-1。</p>
    <p>[0757]	在这种情况下，接入交换机BX-008-0配置自己的3号表如下：</p>
    <p>[0758]	&#21443;“11 0000 0000 0000 1000 “ = &gt;“10 0000 0001”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向0号、9号端口 ；</p>
    <p>[0759]	接入交换机BX-008-1配置自己的3号表如下：</p>
    <p>[0760]	#"11 0000 0000 0000 1000 " = &gt;"00 0000 0010”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口 ；</p>
    <p>[0761]	S4、根据节点服务器MSS-400中0号表的配置，以及，接入交换机BX-008-1中0号 表的配置，发向机顶盒STB-I的包会导向至STB-1。STB-I根据包的内容接收组播数据、解码。</p>
    <p>[0762]	具体而言，所述机顶盒STB-I基于当前的收看直播的通信链路接收组播数据的过 程为：</p>
    <p>[0763]	1)机顶盒STB-O发出组播数据包，该包的DA是0x7800 0x00000x0000 0x0008 (组 播地址)；SA 是 0x0000 0x0000 0x0000 0x0009 ；</p>
    <p>[0764]	2)所述组播数据包进入接入交换机BX-008-0，接入交换机BX-008-0的交换引擎 模块根据组合地址域查3号表，表的地址是“11 0000 00000000 1000”，该表项的输出是 “10 0000 0001”（ “11 0000 0000 00001000 “ = &gt;“10 0000 0001”，即目的地址(DA)是 0x7800 0x0000 0x00000x0008的组播数据包导向0号、9号端口 )；表示打开下行0号端口</p>
    <p>和上行9号端口，当前组播数据包通过该0号端口进入了机顶盒STB-O ；通过该9号端口进 入了节点服务器MSS-400 ；</p>
    <p>[0765]	3)节点服务器MSS-400收到该组播数据包后，其交换引擎模块根据组合地址域查 3号表，表的地址是“11 0000 0000 0000 1000”，该表项的输出是“000 0000 0010”（“11 0000 0000 0000 1000 “ = &gt;“000 00000010”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口），表示打开下行1号端口，当前组播数据包通过该1号 端口进入了接入交换机BX-008-1 ；</p>
    <p>[0766]	4)接入交换机BX-008-1收到该组播数据包后，其交换引擎模块根据组合地址域 查3号表，表的地址是“11 0000 0000 0000 1000”，该表项的输出是“00 0000 0010，，( “11 0000 0000 0000 1000 “ = &gt;“00 0000 0010”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口），表示打开下行1号端口，当前组播数据包通过该1号 端口进入了机顶盒STB-I。</p>
    <p>[0767]	当然，上述的单播服务通信过程和组播服务通信过程仅仅用作示例。在实际中，应 用本发明实施例执行任一种单播服务通信或组播服务通信均是可行的。</p>
    <p>[0768]	为使本领域技术人员更好地理解本发明，以下提供几种应用本发明实施例进行服 务通信的示例：</p>
    <p>[0769]	3.2.3接入网的服务流程示例：</p>
    <p>[0770]	3. 2. 3. 1 广播交互流程：</p>
    <p>[0771]	广播流程中的涉及终端设备有2种：编码板（广播源），机顶盒（收看广播的一 方）。</p>
    <p>[0772]	当编码板通过入网流程入网之后，节点服务器会发送命令让编码板开始编码。每 个编码板编一路广播数据。</p>
    <p>[0773]	开始收看：</p>
    <p>[0774]	进入广播流程后，首先是机顶盒发出申请命令，节点服务器收到机顶盒的申请命 令后就知道机顶盒要看广播，并且知道了机顶盒要看哪一路广播。这时候节点服务器找到 编码板和机顶盒之间的路径。向路径上的所有交换机发命令，将编码板和机顶盒之间的的 所有交换机的针对这路广播数据的通路打开，同时发送解码命令给机顶盒。机顶盒就可以 收看到广播了。</p>
    <p>[0775]	停止收看：</p>
    <p>[0776]	机顶盒发出停止命令，节点服务器收到机顶盒的停止命令后找到编码板和机顶盒之间的路径，将编码板和机顶盒之间的的所有交换机的针对这路广播数据的通路有针对性 的关闭（有可能路径上的交换机还有其他机顶盒在收看本广播，所以不能直接全部关闭）， 同时发送停止解码的命令给机顶盒，发送上一页菜单，让机顶盒返回到菜单。</p>
    <p>[0777]	注意：机顶盒收到的广播数据和编码板发出的广播数据是一模一样的。</p>
    <p>[0778]	3. 2. 3. 2点播交互流程</p>
    <p>[0779]	点播流程中的涉及终端设备有2种：存储器（节目源），机顶盒（收看点播的一 方）。</p>
    <p>[0780]	开始收看：</p>
    <p>[0781]	进入点播流程，首先是机顶盒发出申请命令，命令中给出点播的节目号。节点服务 器收到机顶盒的申请命令后就知道机顶盒要看点播，并且知道了机顶盒要看哪一个节目。 在节点服务器的内部信息表中可以查出本节目是放在哪个存储器上面的</p>
    <p>[0782]	因为机顶盒入网之后，地址就固定了，收看点播的数据是单播数据，数据地址就是 机顶盒的地址。</p>
    <p>[0783]	节点服务器发送读盘命令给存储器（命令中有节目号和单播数据地址），命令存 储器发送单播数据。存储器查到本存储器上确实有该节目，就开始发送节目，同时发读盘命 令应答给节点服务器，表示存储器已经开始发送节目了。</p>
    <p>[0784]	节点服务器收到存储器的应答后，要找到存储器和机顶盒之间的路径，将存储器 和机顶盒之间的的所有交换机的针对这路单播数据的通路打开，同时发送解码命令给机顶 盒。机顶盒就可以收看到点播了。</p>
    <p>[0785]	停止收看：</p>
    <p>[0786]	机顶盒发出停止命令，节点服务器收到机顶盒的停止命令后发送停止读盘命令给 存储器，命令存储器停止发送单播数据。存储器停止发送，同时发停止读盘命令应答给节点 服务器，表示存储器已经停止发送节目了。</p>
    <p>[0787]	节点服务器收到后找到存储器和机顶盒之间的路径，将存储器和机顶盒之间的的 所有交换机的针对这路单播数据的通路关闭，同时发送停止解码的命令给机顶盒，发送上 一页菜单，让机顶盒返回到菜单。</p>
    <p>[0788]	3. 2. 3. 3可视通信交互流程</p>
    <p>[0789]	开始可视通信：</p>
    <p>[0790]	主叫机顶盒发出申请命令，命令中有被叫机顶盒的号码。</p>
    <p>[0791]	节点服务器收到机顶盒的申请命令后先去查询被叫机顶盒是否入网，未入网则告 知主叫机顶盒申请失败。</p>
    <p>[0792]	若是被叫机顶盒已入网则查询被叫机顶盒是否空闲，若是不空闲告知主叫机顶盒 申请失败。</p>
    <p>[0793]	若是被叫机顶盒已入网并且处于空闲状态，节点服务器发送呼叫菜单给被叫机顶 盒，等待被叫机顶盒应答。被叫机顶盒可以选择接受或者拒接，应答发送给节点服务器。</p>
    <p>[0794]	节点服务器收到被叫机顶盒的应答。如果是拒接，告知主叫机顶盒申请失败。</p>
    <p>[0795]	如果是接受，节点服务器发送编解码命令给双方机顶盒。可视通信要求，双方机顶 盒要同时编解码。数据是单播数据，编码地址是对方地址，解码地址是自己的地址</p>
    <p>[0796]	节点服务器将被叫机顶盒和主叫机顶盒之间的的所有交换机的针对这2路单播数据的通路打开。</p>
    <p>[0797]	停止可视通信</p>
    <p>[0798]	被叫机顶盒和主叫机顶盒都可以提出停止申请。节点服务器收到机顶盒的停止命 令后将被叫机顶盒和主叫机顶盒之间的的所有交换机的针对这2路单播数据的通路关闭。 然后给被叫机顶盒和主叫机顶盒分别发送停止编解码的命令，发送上一页菜单，让机顶盒 返回到菜单。</p>
    <p>[0799]	3. 2. 3. 4现场直播交互流程</p>
    <p>[0800]	发起直播</p>
    <p>[0801]	直播的数据也是一路广播数据</p>
    <p>[0802]	机顶盒发出申请命令，节点服务器收到申请后自动分配一路广播数据，向机顶盒 发编解码命令，同时命令本机顶盒的上层交换机打开这路广播数据的通路。机顶盒就可以 收看到自己发起的广播了。发起方同时也是收看方。</p>
    <p>[0803]	收看直播</p>
    <p>[0804]	收看机顶盒发出申请命令，命令中包含发起直播方的号码。节点服务器收到申请 后先查询发起直播方是否已入网，是否已发起直播。条件不满足，告知收看机顶盒收看失 败。</p>
    <p>[0805]	如果条件满足，节点服务器要找到发起直播方和收看机顶盒之间的路径，将发起 直播方和收看机顶盒之间的的所有交换机的针对这路广播数据的通路打开，同时发送解码 命令给收看机顶盒。机顶盒就可以收看到直播了。</p>
    <p>[0806]	停止收看直播</p>
    <p>[0807]	收看机顶盒发出停止命令，节点服务器收到收看机顶盒的停止命令后找到发起直 播方和收看机顶盒之间的路径，将发起直播方和收看机顶盒之间的的所有交换机的针对这 路广播数据的通路有针对性的关闭（有可能路径上的交换机还有其他机顶盒在收看本直 播，所以不能直接全部关闭），同时发送停止解码的命令给收看机顶盒，发送上一页菜单，让 收看机顶盒返回到菜单</p>
    <p>[0808]	停止发起直播</p>
    <p>[0809]	发起直播方发出停止命令。节点服务器收到后先查询有多少用户在收看本直播， 将所有的收看直播的用户按照停止收看的流程结束后，向发起直播方发停止编解码命令， 同时命令本机顶盒的上层交换机关闭这路广播数据的通路。</p>
    <p>[0810]	3. 2. 3. 5除上述示例外，本发明实施例还可以实现以下服务通信应用：</p>
    <p>[0811]	一、可控广播：</p>
    <p>[0812]	1)广播和限量广播：（组播业务)</p>
    <p>[0813]	节点服务器，维护广播操作表。</p>
    <p>[0814]	广播源：实时模拟编码器、实时数字转换器、储存节目。</p>
    <p>[0815]	节点服务器，限量广播观众计数器，超过设定值后拒绝新增观众。</p>
    <p>[0816]	节点服务器，限量广播用户群审核。</p>
    <p>[0817]	用户终端进入收看后，根据HLP键显示OSD菜单，可将广播内容存入个人邮箱。</p>
    <p>[0818]	可控广播：可有选择地只向一部分用户提供服务（如收费台）。</p>
    <p>[0819]	可控广播：可随时统计收视率（甚至观众分类收视率）。[0820]	限量广播：能将上千个广播频道，根据不同限量值，设置很宽的价格范围，大量租 给商业客户（广告、教育等）。</p>
    <p>[0821]	2)投票反馈（可按次计费)：</p>
    <p>[0822]	媒体中心MPC，编辑及记录OSD内容。</p>
    <p>[0823]	节点服务器，定期发送与广播远源相同地址（DA)的OSD内容。</p>
    <p>[0824]	用户机顶盒，根据HLP键显示OSD内容，转发遥控器反馈值。</p>
    <p>[0825]	用户代理服务器，接收用户反馈，用户信息表记录（组播DA、节目时间码、评分和</p>
    <p>票数)ο</p>
    <p>[0826]	用户代理服务器，每秒搜索用户信息表，将用户投票结果发送到节点服务器。</p>
    <p>[0827]	观众反馈信息：总参评人次、每个目标点的分别投票数和观众评级（YES/N0或5分 制）。广播频道的投票反馈：可用于指定问卷民意调查、未来明星海选等。</p>
    <p>[0828]	二、VOD，MOD ：(单播业务)</p>
    <p>[0829]	3) VOD过程操作：</p>
    <p>[0830]	节点服务器，编辑及记录点播确认内容，包括（节目信息、价格信息、观众反馈信</p>
    <p>[0831]	节点服务器，收到用户申请后，发送点播确认菜单和OSD内容。</p>
    <p>[0832]	用户机顶盒，根据HLP键显示OSD内容（节目播放位置、评级提示），转发遥控器反馈值。</p>
    <p>[0833]	用户代理服务器，记录用户信息表，点播结束后时，将用户评级结果发送到节点服 务器。</p>
    <p>[0834]	用户机顶盒，播放操作（暂停/播放、连续快/退、15分钟进/退)</p>
    <p>[0835]	观众反馈信息：总点击数、观众评级（5分制）。</p>
    <p>[0836]	VOD服务：内容可以是大众媒体、或者小众媒体（TV部落格、专业教育和产品操作 维护等）。</p>
    <p>[0837]	4)卡拉 OK ：</p>
    <p>[0838]	与VOD相同，音频采用独立双声道。</p>
    <p>[0839]	5)电视杂志(MOD)：</p>
    <p>[0840]	节点服务器，在VOD基础上，增加有声文字点播和有声图片点播。</p>
    <p>[0841]	节点服务器，将多个媒体内容按序排列或挑选。</p>
    <p>[0842]	6)互动多媒体网站：</p>
    <p>[0843]	用户代理器，在电视杂志的基础上配备面向公众的邮箱，接受读者图、文、音反馈。</p>
    <p>[0844]	互动多媒体网站：可以作为企业和政府面向公众的窗口（电子政务）。</p>
    <p>[0845]	三、TVOD (可控广播+V0D)：(组播+单播业务）</p>
    <p>[0846]	7)集中监控：</p>
    <p>[0847]	媒体中心或用户代理服务器MPC，编辑及维护监控操作表，可选择定时开关录像。</p>
    <p>[0848]	用户终端进入收看后，根据HLP键显示OSD菜单，可将监控内容存入个人邮箱。</p>
    <p>[0849]	集中监控：适合大规模远程监控，可通过用户群分隔，向许多公司同时提供保安服 务。</p>
    <p>[0850]	8) 电视回放（网络TiVo)：</p>
    <p>83[0851]  用户代理服务储存器，可储存数十频道，3&#8212;7天全部内容。[0852]  用户终端进入收看后，根据HLP键显示。SD菜单，可将节目内容存入个人邮箱。[0853]  电视回放：用户采用V。D方式看电视，随时选看从7天前至当前的任何节目内容。[0854]  9)节目精选：[0855]  媒体中心MPC，编辑及维护广播节目精选表，定时分类节目自动录像。[0856]  用户代理服务储存器，可储存数十个精彩栏目，60天全部内容。[0857]  用户终端进入收看后，根据HLP键显示。SD菜单，可将节目内容存入个人邮箱。[0858]  节目精选：自动将电视台节目分类储存，编辑成菜单形式，方便消费者观看。[0859]  四、现场直播：(组播业务)[0860]  1)简单直播：[0861]  用户代理服务器，与限量广播相同。[0862]  用户代理服务器，在直播终端控制下，直播内容可录像。[0863]  现场直播：观众可达全网，广播源设在用户现场。[0864]  2)视频聊天，网上教室，市民热线：[0865]  参与方终端进入聊天室后，根据HLP键显示。SD内容，可申请视频上传，向主持送花。[0866]  主持方用户代理服务器，记录用户申请，并向直播终端发送。SD提示。[0867]  直播方终端，可能显示多条视频上传申请。SD，遥控器选择一路上传，并自动关闭上一路。[0868]  用户代理服务器，在关闭视频上传时，向计费流水帐发送特别计费包。[0869]  用户代理服务器，记录该用户送花值，通知直播方，并向计费流水帐发送特别计费包。[0870]  用户进入聊天室，送花，参与音频，开通视频对话所付费用，自动安比例存入个人邮箱。[0871]  视频聊天：主持人在家(现场)播出影像可达全网，主持人可看到观众申请，听到许多观众声音，但只能选择地看到l路观众影像。[0872]  观众通过节目表得知聊天室拨号加入，可向主持人鲜花(额外收费)，可申请通话或视频。[0873]  3)购物频道：[0874]  直播终端或相连的MPC，维护购物信息(商品和客户)。[0875]  用户终端进入购物频道后，根据HLP键显示。SD订单(商品、规格、数量、价格)。[0876]  用户终端通过遥控器填写并提交订单。[0877]  用户代理服务器，收看订单后转发至直播方终端或相连的MPC。[0878]  直播方终端或MPC，审核订单，并向用户发回确认的订单。[0879]  用户终端再次显示订单，并通过遥控器确认。[0880]  用户代理服务器，向直播方发送用户确认，并向计费流水帐发送特别计费包。[0881]  用户终端进入收看后，根据HLP键显示。SD菜单，可将购物内容存入个人邮箱。[0882]  MPC为装载特殊软件的PC机，增强TV机顶盒的操作性能。[0883]  4)拍卖频道：[0884]	直播终端或MPC，维护拍卖信息（商品和客户)。</p>
    <p>[0885]	用户终端进入拍卖频道后，根据HLP键显示OSD介绍（商品、规格、最高价格）。</p>
    <p>[0886]	用户终端通过遥控器填写并提交出价。</p>
    <p>[0887]	用户代理服务器，收到出价后转发至直播方终端或MPC。</p>
    <p>[0888]	直播方终端或相连的MPC，审核用户出价，并向用户发回确认后的出价。</p>
    <p>[0889]	用户终端再次显示出价，并通过遥控器确认。</p>
    <p>[0890]	用户代理服务器，向直播方发送用户确认，并向计费流水帐发送特别计费包。</p>
    <p>[0891]	用户终端进入收看后，根据HLP键显示OSD菜单，可将拍卖内容存入个人邮箱。</p>
    <p>[0892]	MPC为装载特殊软件的PC机，直接与终端连接，增强TV机顶盒的操作性能。</p>
    <p>[0893]	5)视频呼叫中心：</p>
    <p>[0894]	直播方终端或相连的MPC，将多路视频聊天捆绑到一个号码（或名称），共享资源。</p>
    <p>[0895]	视频呼叫中心：可与购物频道或拍卖频道直接链接，提供后续服务。</p>
    <p>[0896]	五、会议（多路现场直播捆绑）：（组播业务）</p>
    <p>[0897]	会议发起方终端或相连的MPC，编辑和维护会议操作表，实现多路进程捆绑。</p>
    <p>[0898]	1)大会发言：</p>
    <p>[0899]	发起方终端直接控制指定参与方的终端，并关闭参与方的遥控操作，强制被动参石。</p>
    <p>[0900]	强制实现发起方发言，参与收看。</p>
    <p>[0901]	发起方终端可在参与方不知情的前提下，收看任一参与方，或者指定其发言。</p>
    <p>[0902]	大会发言：适合上级领导报告，工程事件指挥，企业总部与远程分支间的例行调度 会议。</p>
    <p>[0903]	2)课堂教学：</p>
    <p>[0904]	任意参与方终端，可向发起方终端提出发言申请，获得发起方批准后，即可发言。</p>
    <p>[0905]	课堂教学：实现会议聊天室，与直播聊天室的差别是直播观众永远看支持人，会议 聊天观众看发言方，或者通过多屏终端同时看支持人和发言方。</p>
    <p>[0906]	3)圆桌讨论：</p>
    <p>[0907]	任意参与方终端，按单个ENTER键，即可打断别人而争抢发言（至少10秒不被打 断）。</p>
    <p>[0908]	圆桌讨论：实现会议聊天室，与直播聊天室的差别是直播观众永远看支持人，会议 聊天观众看发言方，或者通过多屏终端同时看支持人和发言方。</p>
    <p>[0909]	4)多屏会议：</p>
    <p>[0910]	用户代理服务器，可插入VOD。</p>
    <p>[0911]	必须使用PBOX终端，可同时显示发起方（主席)、发言方、本地会场、VOD或PC屏</p>
    <p>眷ο</p>
    <p>[0912]	可选择大会发言，课堂教学，圆桌讨论等会议模式。</p>
    <p>[0913]	5)电视墙：</p>
    <p>[0914]	可同时显示发起方（主席）、发言方、多分路会场、VOD或PC屏幕。</p>
    <p>[0915]	可选择大会发言，课堂教学，圆桌讨论等会议模式。</p>
    <p>[0916]	六、电视电话：（单播业务）[0917]	6)普通可视电话：</p>
    <p>[0918]	用户代理服务器，维护电话号码簿，支持普通拨号和强制拨号。</p>
    <p>[0919]	用户终端进入通话后，根据HLP键显示OSD菜单，可将通信内容存入邮箱，可选择 或调整对方摄像头角度。</p>
    <p>[0920]	7)被叫方付费可视电话（Video 800)：</p>
    <p>[0921]	此类号码以800开头，用户免费，其他与普通可视电话相同。</p>
    <p>[0922]	被叫方付费可视电话：适用于广告、客户服务、公益服务等。</p>
    <p>[0923]	8)视讯服务电话(Video 900)：</p>
    <p>[0924]	此类号码以900开头，主叫方为普通用户终端，服务费中除了通信费外，还包含较 高的内容费（按秒计），其他与普通可视电话相同。</p>
    <p>[0925]	被叫方为内容提供商（内容包括实时通讯、V0D、电视杂志）。</p>
    <p>[0926]	9)家庭监控：</p>
    <p>[0927]	用户代理服务器，单向通信，只要视频发送资源不冲突，可与其他服务同时进行。</p>
    <p>[0928]	用户终端拨号进入监控后，根据HLP键显示OSD菜单，可将监控内容存入邮箱，可 选择多路摄像头或调整对方摄像头角度。</p>
    <p>[0929]	被监控终端，可设定监控权限（指定一组可监控号码，开放所有号码，或禁止所有 号码）。</p>
    <p>[0930]	家庭监控：适用于家庭、小商店、银行分理所等。</p>
    <p>[0931]	七、电视邮件，电视部落格：（单播业务)</p>
    <p>[0932]	10)个人网络储存：</p>
    <p>[0933]	用户代理服务器，维护用户邮箱表。</p>
    <p>[0934]	用户终端内容上传，包括视、音、图、文，以草稿形式保存在邮箱内，可随时调看。</p>
    <p>[0935]	上传内容可从USB端口输入（直接连PC、优盘、移动硬盘等）。</p>
    <p>[0936]	11)普通可视邮件：</p>
    <p>[0937]	用户终端指定邮箱中的内容，输入发送对象的号码，申请发送。</p>
    <p>[0938]	用户代理服务器，向发送对象的终端发出新到邮件通知，但实际上不转发邮件内 容。接受方终端收看时才执行VOD操作。</p>
    <p>[0939]	接受方终端若要长期保存邮件内容，根据HLP键显示OSD菜单，可将内容存入邮 箱。</p>
    <p>[0940]	12)短信和语音留言：</p>
    <p>[0941]	与视频邮件同样处理，内容可存入专用VDOS-SD储存设备。</p>
    <p>[0942]	13)电视部落格：</p>
    <p>[0943]	节点服务器，根据内容分类，维护公共大邮箱。</p>
    <p>[0944]	用户终端将邮件上传至媒体中心的公共大邮箱（包括自定价格）。</p>
    <p>[0945]	媒体中心MPC，观看并审核上传邮件，转换成VOD内容，登记存入对应分类部落格。</p>
    <p>[0946]	节点服务器，维护观众反馈信息，维护点播帐单。</p>
    <p>[0947]	接受方终端若要长期保存部落格内容，根据HLP键显示OSD菜单，可将内容存入邮 箱。</p>
    <p>[0948]	电视部落格：内容收费中的一部分可自动转入内容上传方的帐户（百货商场模式)ο</p>
    <p>[0949]	八、电脑网络：</p>
    <p>[0950]	14)因特网宽带上网：</p>
    <p>[0951]	由于以太网网关的存在，使得在用户家里使用普通的以太网交换机就可以接入新 型网，这样在用户家里就实现了互联网和新型网的融合，实现IP数据连接公共因特网。</p>
    <p>[0952]	因特网宽带上网：适合分散社区消费者。</p>
    <p>[0953]	15)多媒体电脑局域网：</p>
    <p>[0954]	由于以太网网关的存在，使得在企业使用普通的以太网交换机就可以接入新型 网，这样在企业就实现了互联网和新型网的融合。</p>
    <p>[0955]	多媒体电脑局域网：适合学校、企业和政府办公室。</p>
    <p>[0956]	九、语音电话：(组播+单播业务）</p>
    <p>[0957]	新型网电话：直接使用未经压缩PCM(G. 711)，具备PSTN品质和低延迟（透传FAX 和Modem)，功能超越PSTN，成本低于IP电话，只需占用百分之一的新型网带宽资源，即可满 足所有用户的电话服务。</p>
    <p>[0958]	16)新型网电话：</p>
    <p>[0959]	新型网电话网内电话：直拨新型网电话号码。</p>
    <p>[0960]	新型网向PSTN网拨号：99+PSTN电话号码。</p>
    <p>[0961]	PSTN网向新型网拨号：077+MP号码，（077或其他号码必须获得电信公司配合）。</p>
    <p>[0962]	用户进入通话后，连续拨“ *** ”，双方通话内容自动存入邮箱。</p>
    <p>[0963]	17)录音电话：</p>
    <p>[0964]	用户可选择：来电未接，自动播放邮箱中的录音，然后在邮箱中记录来电内容。</p>
    <p>[0965]	可选包月收费。</p>
    <p>[0966]	18)语音电话会议：</p>
    <p>[0967]	节点服务器，配备专用多路语音合成设备，音色清晰，延迟低。</p>
    <p>[0968]	会议发起方预约会议时间、人数、对应号码、外网PSTN密码，并可选择全程录音。</p>
    <p>[0969]	节点服务器，向指定用户发送短信通知（包括会议号码）。</p>
    <p>[0970]	用户在指定时间，拨指定号码，加入电话会议。</p>
    <p>[0971]	节点服务器，自动审核时间、会议号码及用户号码，并可自动向参会方呼叫。</p>
    <p>[0972]	19)语音自动服务中心：</p>
    <p>[0973]	与多媒体网站功能类似，只限于语音，此功能一般企业用1台PC即可实现，在新型 网网上每家每户都可自动设立，不需要任何硬件，只收少量月费。</p>
    <p>[0974]	语音自动服务中心：适用于天气、股票、交通、公共服务、客户服务等。</p>
    <p>[0975]	20)语音呼叫中心：</p>
    <p>[0976]	发起方终端或相连的MPC，将多路电话天捆绑到一个号码（或名称），共享资源。</p>
    <p>[0977]	发起方可选择全程录音。</p>
    <p>[0978]	21)有线音乐广播台：</p>
    <p>[0979]	类似电视广播，内容限于音乐。</p>
    <p>[0980]	3. 3本发明的新型网与现有以太网的融合</p>
    <p>[0981]	为了实现上述新型网与现有以太网的融合，同时为了充分利用现有以太网协转网关的功能，本发明对标准的以太网网关进行了改造，使其成为一种特殊类型的接入交换机， 在新型网和以太网之间起着连接转换的作用。改造后的以太网网关称为以太网协转网关。 在新型网中，以太网协转网关位于接入网部分，可以与接入交换机相连，也可以直接与节点 服务器相连。在以太网中，以太网协转网关与标准的以太网交换机（以下简称L2交换机） 相连，以太网交换机连接着终端。</p>
    <p>[0982]	本发明中，新型网与以太网之间的数据传输主要涉及以下4种数据类型：</p>
    <p>[0983]	1)查询包：由节点服务器发往接入交换机、以太网协转网关或终端的协议包；</p>
    <p>[0984]	2)应答包：由接入交换机、以太网协转网关或终端回应给节点服务器的协议包；</p>
    <p>[0985]	3)单播数据包；</p>
    <p>[0986]	4)组播数据包。</p>
    <p>[0987]	以太网协转网关在新型网和以太网之间主要进行上述4种类型数据的转发工作， 其核心实现思路是：</p>
    <p>[0988]	以太网协转网关接入新型网，从具有集中控制功能的节点服务器获得以太网协转 网关的MAC地址和该以太网协转网关下注册的终端MAC地址。当以太网协转网关接收新型 网发来的数据包或协议包时，在所述数据包或协议包中添加以太网协转网关的MAC地址和 目标终端的MAC地址，然后发向以太网，在以太网中采用以太网协议进行传输；当以太网协 转网关接收以太网发来的数据包或协议包时，去掉所述数据包或协议包中以太网协转网关 的MAC地址和源终端的MAC地址，然后发向新型网，在新型网中采用新型网协议进行传输。</p>
    <p>[0989]	其中，所述目标终端和源终端遵循新型网协议，这样，目标终端和源终端既可以通 过MAC地址进入以太网，又可以通过遵循新型网协议而进入新型网，从而实现两种不同类 型网络的兼容传输。</p>
    <p>[0990]	在新型网中，定义了遵循新型网协议的数据结构（2. 1接入网数据包的定义）。上 述4种数据类型（数据包或协议包）都遵循这种数据结构。</p>
    <p>[0991]	目标终端和源终端遵循新型网协议，就需要遵循新型网的上述数据结构。因此， 新型网发向目标终端的数据包或协议包，以及以太网中源终端发向新型网的数据包或协议 包，包头都包含传输两端在新型网的地址，所述地址为数据包或协议包的源地址（SA)和目 的地址（DA)。即：新型网发向目标终端的数据包或协议包，具有新型网的地址，包头的DA和 SA均为新型网地址，如下表所示：</p>
    <p>[0992]</p>
    <span class="patent-image-not-available"> </span>
    <p>[0993]	当经过以太网协转网关时，在包头加入以太网协转网关MAC(即MAC SA)和目标终 端MAC(即MAC DA)，然后进入以太网按照以太网协议传输到目标终端；以太网中源终端发 向新型网的数据包或协议包，同时具有新型网的地址和以太网的MAC地址，即包头不仅包 括新型网的DA和SA，还包括以太网协转网关MAC (即MAC DA)和源终端MAC (即MAC SA)，</p>
    <p>如下表所示：</p>
    <p>[0994]</p>
    <p>88</p>
    <span class="patent-image-not-available"> </span>
    <p>[0995]	当经过以太网协转网关时，在包头去掉以太网协转网关MAC和源终端MAC，然后进 入新型网按照新型网协议传输。</p>
    <p>[0996]	在上述新型网与以太网的兼容过程中，接在L2交换机下的终端还与以太网协转 网关建立了绑定关系，所述绑定是指以太网协转网关的MAC地址与终端的MAC地址是一对 多的映射，即一台以太网协转网关下可以注册多台终端。这种终端MAC地址与以太网协转 网关MAC地址的映射绑定，是在终端和以太网协转网关售出时预设在新型网的节点服务器 中，由节点服务器通知给以太网协转网关，如果需移机则必须到运营商处重新注册。这样， 就可以灵活为准备售出的以太网协转网关和其下绑定的终端分配以太网MAC地址，达到充 分利用MAC地址资源的效果。当然，以太网协转网关的MAC地址可以固化在每个以太网协 转网关中，终端的MAC地址也可以固化在每个终端中，这种情况下不能灵活分配MAC地址。</p>
    <p>[0997]	由上可知，所述以太网协转网关和终端都具有新型网的地址和以太网的MAC地 址。而且，所述新型网地址和以太网的MAC地址还具有一一映射的关系。这种映射关系也 可以由新型网的节点服务器维护，并通知给以太网协转网关。这样，以太网协转网关当接收 到新型网发来的数据包或协议包时，就可以根据这种映射，查找与包中的新型网目的地址 (DA)相对应的目标终端MAC地址，并添加到包中。</p>
    <p>[0998]	以上内容综述了新型网如何兼容以太网，下面将通过具体举例，通过新型网节点 服务器与以太网协转网关、节点服务器与终端的入网流程和服务流程，详细说明整个兼容 过程。</p>
    <p>[0999]	3. 3. 1节点服务器与以太网协转网关的入网流程：</p>
    <p>[1000]	参照图8，是本发明实施例中以太网协转网关接入新型网的流程图。</p>
    <p>[1001]	首先，每台允许入网的以太网协转网关都在节点服务器里注册，以太网协转网关 的注册信息有以太网协转网关的序列号（包括设备类型和设备标识信息）、下行端口数、掩 码区间等固有信息，没有注册的以太网协转网关无法入网。</p>
    <p>[1002]	步骤601，新型网中具有集中控制功能的节点服务器下发查询包；</p>
    <p>[1003]	节点服务器向每个端口发送查询包。</p>
    <p>[1004]	步骤602，以太网协转网关上电初始化后，收到查询包，返回包含以太网协转网关 序列号的应答包；</p>
    <p>[1005]	假设以太网协转网关收到某个端口（如端口 0)下发的查询包。</p>
    <p>[1006]	步骤603，节点服务器在注册信息表中查找与所述序列号对应的以太网协转网关 信息，所述以太网协转网关信息包括以太网协转网关MAC地址和该以太网协转网关下绑定 的终端MAC地址；</p>
    <p>[1007]	节点服务器收到以太网协转网关发出的应答包后就知道端口 0下接了一台以太 网协转网关，然后查找内部的注册信息表。[1008]	步骤604，节点服务器向所述以太网协转网关发送入网命令，所述入网命令中包含 以太网协转网关在新型网的地址和以太网协转网关的MAC地址；</p>
    <p>[1009]	即节点服务器将分配给以太网协转网关的新型网地址和预先注册的以太网MAC 地址，通过入网命令通知以太网协转网关。</p>
    <p>[1010]	步骤605，所述以太网协转网关收到入网命令后返回应答，以太网协转网关接入新 型网；</p>
    <p>[1011]	以太网协转网关收到入网命令后，就知道了自己接入新型网的地址以及在以太网 的MAC地址。</p>
    <p>[1012]	步骤606，节点服务器定时向入网的以太网协转网关下发设备状态查询指令，检查 该以太网协转网关是否正常工作；</p>
    <p>[1013]	节点服务器收到入网命令应答，就知道该以太网协转网关已经入网，以后会定时 (如每秒）向端口O发设备状态查询指令。如果节点服务器在一定时间内（如6秒）没有 收到状态查询应答，就认为该以太网协转网关已经被移出网络，不再发送设备状态查询指 令，继续向端口 0发送查询包。</p>
    <p>[1014]	步骤607，节点服务器将所述以太网协转网关下绑定的终端MAC地址，以及终端 MAC地址与待分配给终端的新型网地址的映射，都通知该以太网协转网关。</p>
    <p>[1015]	节点服务器根据注册信息表知道该以太网协转网关下还绑定有终端，因此会将以 太网协转网关下绑定的终端MAC地址，以及终端MAC地址与待分配的新型网地址的映射，发 送给该以太网协转网关。</p>
    <p>[1016]	通过以上入网流程，以太网协转网关知道了自己的新型网地址、以太网MAC地址、 其下绑定的终端MAC地址以及终端MAC地址与待分配给终端的新型网地址的映射。</p>
    <p>[1017]	基于以上流程，优选的，新型网的数据传输具体可以采用查地址表的方式实现。新 型网中的每个节点，包括节点服务器、接入交换机和以太网协转网关，都维护着自己的地址 表，每当接收到数据后，都根据地址表进行数据的传输导向。由于新型网与以太网之间的数 据传输主要涉及查询包、应答包、单播数据包和组播数据包的传输，因此地址表也分为：</p>
    <p>[1018]	1)协议包地址表：以下简称为0号表，用于传输导向查询包或服务申请协议包；</p>
    <p>[1019]	2)应答包地址查找表：以下简称为1号表，用于传输导向应答包；</p>
    <p>[1020]	3)单播数据包地址表：以下简称为2号表，用于传输导向单播数据包；</p>
    <p>[1021]	4)组播数据包地址表：以下简称为3号表，用于传输导向组播数据包。</p>
    <p>[1022]	结合上述以太网协转网关的入网流程，以太网协转网关在步骤302的上电初始化 过程中，会初始化配置0号表、1号表、2号表和3号表。然后，以太网协转网关在步骤305 收到入网命令后，会配置0号表：将发给本机的查询包或服务申请协议包导向本机的CPU模 块端口。此后，以太网协转网关发送应答入网后，节点服务器还会向以太网协转网关发送配 置指令，配置以太网协转网关中的0号表：将发向该以太网协转网关下绑定的终端的查询 包或服务申请协议包分别导向到以太网协转网关的相应端口。</p>
    <p>[1023]	3. 3. 2节点服务器与终端的入网流程：</p>
    <p>[1024]	以太网协转网关接入新型网后，与其绑定的终端也接入新型网。</p>
    <p>[1025]	参照图9，是本发明实施例中终端接入新型网的流程图。</p>
    <p>[1026]	同样，每台允许入网的终端都在节点服务器里注册，并注册到所绑定的以太网协转网关下，终端的注册信息有终端序列号（包括设备类型和设备标识信息）和固有信息，没 有注册的终端无法入网。</p>
    <p>[1027]	步骤701，新型网中具有集中控制功能的节点服务器下发查询包；</p>
    <p>[1028]	当以太网协转网关入网后，节点服务器就会向该以太网协转网关的下行端口发送 查询包，检查是否有终端设备接在该以太网协转网关下。</p>
    <p>[1029]	步骤702，以太网协转网关收到查询包，根据协议包地址表，将查询包导向到相应 端口，然后在所述查询包中添加以太网协转网关的MAC地址和目标终端的MAC地址，并转 发；</p>
    <p>[1030]	所述查询包的目的地址（DA)即为节点服务器待分配给终端的新型网地址，因此 以太网协转网关收到查询包后，根据新型网地址与以太网MAC地址的映射，可以查找到相 对应的终端MAC地址，然后添加到包中发送。查询包进入以太网后按照以太网协议进行传 输，最终传给目标终端。</p>
    <p>[1031]	步骤703，终端上电初始化后，收到查询包，返回包含终端序列号的应答包；</p>
    <p>[1032]	步骤704，以太网协转网关去掉所述应答包中的以太网协转网关MAC地址和终端 MAC地址，然后转发给节点服务器；</p>
    <p>[1033]	所述应答包包含以太网协转网关MAC地址、终端MAC地址、新型网的目的地址（DA) 和源地址（SA)，以太网协转网关去掉以太网协转网关MAC地址、终端MAC地址后，查1号表 进行导向，应答包进入新型网，按照新型网协议进行传输。</p>
    <p>[1034]	步骤705，节点服务器在注册信息表中找到与所述终端序列号对应的终端信息，发 送入网命令，所述入网命令中包含终端在新型网的地址；</p>
    <p>[1035]	节点服务器收到终端发出的应答包后就知道以太网协转网关下接了一台终端设 备，然后查找内部的注册信息表。</p>
    <p>[1036]	步骤706，以太网协转网关收到所述入网命令，添加以太网协转网关的MAC地址和 目标终端的MAC地址后进行转发；</p>
    <p>[1037]	步骤707，终端收到入网命令后返回应答，以太网协转网关去掉所述应答中的以太 网协转网关MAC地址和终端MAC地址后转发给节点服务器，终端接入新型网；</p>
    <p>[1038]	终端收到入网命令，就知道了自己接入新型网的地址。</p>
    <p>[1039]	步骤708，节点服务器定时向入网的终端下发设备状态查询指令，检查该终端是否</p>
    <p>正常工作。</p>
    <p>[1040]	节点服务器收到入网命令应答，就知道以太网协转网关下绑定的终端已经入网， 以后会定时（如每秒）向该终端发设备状态查询指令。如果节点服务器在一定时间内（如6 秒）没有收到状态查询应答，就认为该终端已经被移出网络，不再发送设备状态查询指令， 继续向本端口发送查询包。</p>
    <p>[1041]	在上述流程中，以太网内部的数据传输遵循以太网协议。以太网协议中，L2交换机 之所以能够直接对目的节点发送数据包，而不是像集线器一样以广播方式对所有节点发送 数据包，最关键的技术就是交换机可以识别连在网络上的节点的网卡MAC地址，并把它们 放到一个叫做MAC地址表的地方。这个MAC地址表存放于交换机的缓存中，并记住这些地 址，这样一来当需要向目的地址发送数据时，交换机就可在MAC地址表中查找这个MAC地址 的节点位置，然后直接向这个位置的节点发送。所谓MAC地址数量是指交换机的MAC地址表中可以最多存储的MAC地址数量，存储的MAC地址数量越多，那么数据转发的速度和效率也 就就越高。在交换机的每个端口，都需要足够的缓存来记忆这些MAC地址，所以Buffer (缓 存）容量的大小就决定了相应交换机所能记忆的MAC地址数多少。通常交换机只要能够记 忆1024个MAC地址基本上就可以了。在局端上，可以记忆1024个MAC地址。在终端中，由 于FLASH的问题和实际的需要，我们支持16个MAC地址。</p>
    <p>[1042]	以太网协议中，同一个子网中主机之间互相传送信息需要用到MAC地址，而我们 第一次发送信息的时候只有IP地址而没有MAC地址，这时候就发送一个包，其IP地址为目 标机IP地址，MAC地址为ff-ff-ff-ff-ff-ff，这种MAC地址表示广播，也就是该子网中所 有机子都能收到，当其他主机收到后，如果发现IP地址不是自己的，就丢弃该数据包，如果 是自己IP就往源机发送一个数据包，包含了自己的MAC地址，原机收到这个数据包之后就 知道了目标机的MAC地址，这就是MAC地址自学习了。</p>
    <p>[1043]	交换机中MAC地址自学习是指在交换机中有一个MAC地址与交换机每个接口（比 如一般家用的交换机有四个接口）的对应表，每当有数据包经过交换机转发的时候，如果 它的表中没有这个MAC地址的对应关系就会往所有端口转发数据包，当目标机从某个端口 返回信息的时候它就知道了这个MAC地址对应的哪个端口，于是会把这个对应关系加入表 中，这个就是交换机的MAC地址自学习。</p>
    <p>[1044]	3. 3. 3节点服务器与以太网协转网关、终端在入网过程中的交互示例</p>
    <p>[1045]	3. 3. 3. 1 交互示例 1</p>
    <p>[1046]	基于上述以太网协转网关和终端的入网过程，下面通过一个具体的例子进行说明。</p>
    <p>[1047]	为了方便讨论，以太网协转网关可以和接入交换机相连或直接和节点服务器相 连，参照图10，假设一台以太网协转网关gatewayj)的1号端口与节点服务器MSS-400的0 号端口直接相连，0号端口与一组L2交换机相连，在此以太网协转网关下注册有四台终端， 但仅有2台STBJK STB_1连在L2交换机下。</p>
    <p>[1048]	gateway_0 的 MAC 地址为 0x0005 0x5dfd 0x3ebf, gateway_0 下注册的 4 台新 型网终端 MAC 地址分别为 0x0005 0x5dfd 0x0000、0x00050x5dfd 0x0001、0x0005 0x5dfd 0x0002,0x0005 0x5dfd 0x0003，STB_0、STB_1 是其中的前 2 台。</p>
    <p>[1049]	UMSS-400服务器上电后初始化硬件，获得默认城域网地址（假设为0x00 0x0000 0x0000)，从硬盘导入配置文件到CPU内存（例如交换机的注册信息、终端的注册信息等 等），MSS-400服务器配置自己的接入网地址为0x0000 ；</p>
    <p>[1050]	2、MSS-400服务器初始化0、1、2、3号表</p>
    <p>[1051]	&#8226;配置0号表为“000 0000 0000 “，即所有查询包传送关闭；</p>
    <p>[1052]	&#8226;配置1号表为“001 0000 0000”，即所有的应答包导向CPU，</p>
    <p>[1053]	&#8226;配置2号、3号表为“000 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>[1054]	3、MSS-400服务器配置知道自己有8个下行端口，所以它配置8个0号表的表项 分别为</p>
    <p>[1055]	#"00 0000 0000 0000 0001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0001的查询包导向0号端口 ；</p>
    <p>[1056]	#"00 0000 0000 0000 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x80000x0000 0x0000 0x0002的查询包导向1号端口 ；</p>
    <p>[1057]	#"00 0000 0000 0000 0011" = &gt;"000 0000 0100”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0003的查询包导向2号端口 ；</p>
    <p>[1058]	#"00 0000 0000 0000 0100" = &gt;"000 0000 1000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0004的查询包导向3号端口 ；</p>
    <p>[1059]	&#21443; “00 0000 0000 0000 01 01 “ = &gt;“000 0001 0000”，即目的地址（DA)是 0x8000 0x0000 0x0000 0x0005 的查询包导向 4 号端口 ；</p>
    <p>[1060]	&#21443;“00 0000 0000 0000 0110" = &gt;"000 0010 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0006的查询包导向5号端口 ；</p>
    <p>[1061]	&#21443;“00 0000 0000 0000 0111" = &gt;“000 0100 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0007的查询包导向6号端口 ；</p>
    <p>[1062]	#"00 0000 0000 0000 1000" = &gt;"000 1000 0000”，即目的地址（DA)是 0x8000 0x0000 0x0000 0x0008的查询包导向7号端口 ；</p>
    <p>[1063]	4、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0001,0x8000 0x0000 0x0000 0x0002,0x8000 0x0000 0x0000 0x0003,0x8000 0x0000 0x0000 0x0004、 0x8000 0x0000 0x0000 0x0005,0x80000x0000 0x0000 0x0006,0x8000 0x0000 0x0000 0x0007、0x8000 0x00000x0000 0x0008 的端口 查询包（SA 都为 0x0000 0x0000 0x0000 0x0000)，根据0号表配置端口查询包会依次导向0到7号端口；</p>
    <p>[1064]	5、gateway_0以太网协转网关上电后初始化硬件，</p>
    <p>[1065]	&#8226;配置0号表” 00 xxxx xxxx xxxx xxxx”为‘‘ 100”，即所有查询包包导向CPU ；</p>
    <p>[1066]	&#8226;配置1号表” 01 xxxx xxxx xxxx xxxx”为“010”，即所有的应答包导向上行的 百兆网口 ；</p>
    <p>[1067]	&#8226;配置2号、3号表为“000 “，即所有单组播数据包传送关闭；</p>
    <p>[1068]	6,gateway_0以太网协转网关收到端口查询包后发送应答（应答中包含本交换机 的设备类型、设备标识，这是每台交换机的固有信息），包的DA是0x0800 0x0000 0x0000 0x0000，SA 是0x0000 0x00000x0000 0x0001 ；</p>
    <p>[1069]	7、MSS-400服务器收到gatewayj)以太网协转网关发出的应答后，对比应答包的 源地址（SA)及设备类型就知道0号端口下接了一台以太网协转网关，然后在服务器内部 的注册信息表里找到这台以太网协转网关信息，即包括gatewayj)的以太网MAC地址以 及gatewayj)下注册的新型网终端的以太网MAC地址，然后向接入交换机交换机发送入网 命令（告诉gateway_0的接入网地址为0x0001，gateway_0的MAC地址为0x0005 0x5dfd 0x3ebf)；</p>
    <p>[1070]	8、gateway_0以太网协转网关收到入网命令后，知道自己的接入网地址是 0x0001，MAC 地址为 0x0005 0x5dfd 0x3ebf 就入网了，配置 0 号表” 00 0000 0000 0000 0001”为“ 100 ”，0号表其余表项配置为” 000 “，即只有本交换机的查询包导入CPU，其余丢 弃，同时向服务器发送入网命令应答；</p>
    <p>[1071]	9、MSS-400服务器收到gatewayj)以太网协转网关发出的入网命令应答就知道 gateway_0以太网协转网关已经入网了，以后每秒钟向这个端口发送设备状态查询指令，检 查gatewayj)以太网协转网关是否正常工作，同时还要向gatewayj)以太网协转网关的下行端口发送端口查询包，检查是否有终端设备接在gatewayj)以太网协转网关下面，因为 MSS-400服务器知道gatewayj)以太网协转网关下注册有4台新型网终端，所以MSS-400服 务器会做如下配置：</p>
    <p>[1072]	#"00 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0009的查询包导向0号端口 ；</p>
    <p>[1073]	#"00 0000 0000 0000 1010" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOa的查询包导向0号端口 ；</p>
    <p>[1074]	#"00 0000 0000 0000 1011" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOb的查询包导向0号端口 ；</p>
    <p>[1075]	#"00 0000 0000 0000 1100" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 OxOOOc的查询包导向0号端口 ；</p>
    <p>[1076]	MSS-400服务器会通知gatewayj)做如下配置：</p>
    <p>[1077]	#"00 0000 0000 0000 1001 ‘‘ = &gt; “001”，即目的地址（DA)是 0x80000x0000 0x0000 0x0009的查询包导向0号端口，其对应的MAC地址为0x0005 0x5dfd 0x0000 ；</p>
    <p>[1078]	#"00 0000 0000 0000 1010 ‘‘ = &gt; “001”，即目的地址（DA)是 0x80000x0000 0x0000 OxOOOa的查询包导向0号端口，其对应的MAC地址为0x0005 0x5dfd 0x0001 ；</p>
    <p>[1079]	#"00 0000 0000 0000 1011 ‘‘ = &gt; “001”，即目的地址（DA)是 0x80000x0000 0x0000 OxOOOb的查询包导向0号端口，其对应的MAC地址为0x0005 0x5dfd 0x0002 ；</p>
    <p>[1080]	#"00 0000 0000 0000 1100 ‘‘ = &gt;‘‘001”，即目的地址（DA)是 0x80000x0000 0x0000 OxOOOc的查询包导向0号端口，其对应的MAC地址为0x0005 0x5dfd 0x0003 ；</p>
    <p>[1081]	10、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0009,0x8000 0x0000 0x0000 0x000a、0x8000 0x0000 0x0000 0x000b、0x8000 0x0000 0x0000 OxOOOc 的端口查询包(SA都为0x0000 0x00000x0000 0x0000)，根据MSS-400服务器0号表配 置端口查询包会依次导向MSS-400服务器0号端口，，根据gatewayj)以太网协转网关0 号表配置端口查询包会依次导向gatewayj)以太网协转网关0号端口，gatewayj)以太 网协转网关0号端口的发送模块根据包的新型网目地地址DA获知对应的终端的以太网 MAC DA(6byte)，添加终端的以太网MAC DA (6byte)、以太网协转网关的MAC SA(6byte)、 以太网 length or frame type(2byte),艮口 0x0005 0x5dfd 0x0000 0x0005 0x5dfd 0x3ebf0x0000(自定义）0x8000 0x0000 0x0000 0x0009,0x0005 0x5dfd 0x00010x0005 0x5dfd 0x3ebf 0x0000 (自定义）0x8000 0x0000 0x0000 0x000a,0x0005 0x5dfd 0x0002 0x0005 0x5dfd 0x3ebf 0x0000 (自定义）0x80000x0000 0x0000 0x000b,0x0005 0x5dfd 0x0003 0x0005 0x5dfd 0x3ebf0x0000 (自定义）0x8000 0x0000 0x0000 0x000c 并发送;</p>
    <p>[1082]	11、局域网中的L2交换机根据附录可知它们的表中没有这些mac地址（即0x0005 0x5dfd 0x0000,0x0005 0x5dfd 0x0001,0x0005 0x5dfd0x0002、0x0005 0x5dfd 0x0003) 的对应关系就会往所有端口转发这些包。STB_0、STB_1都会收到这4个包，它们比对包的 MAC DA和自己的MAC地址（出厂时烧录在终端的flash中），一样的才会接收否则丢弃。 STB_0收到端口查询包后发送应答（应答中包含本终端的设备类型、设备标识，这是每台终 端的固有信息），包的头部是 0x0005 0x5dfd 0x3ebf0x0005 0x5dfd 0x0000 0x0000 (自 定义）0x0800 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x000a ;STB_1 收到端口查询包后发送应答（应答中包含本终端的设备类型、设备标识，这是每台终端的固有信息)， 包的头部是 0x0005 0x5dfd 0x3ebf 0x0005 0x5dfd 0x0001 0x0000 (自定义）0x0800 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 OxOOOb0</p>
    <p>[1083]	12、局域网中的L2交换机根据附录可知这2个包会导向gatewayj)以太网协转网 关的0号端口。0号端口的包匹检测模块检测完后去掉MAC DA(6byte)、MAC SA(6byte)、 length or frame type (2byte)共14byte，进入相应的接收缓存，交换引擎对各个接收缓存 进行轮询，如果有则对其进行组合地址域查表，从而获得包的导向信息，根据gatewayj)的 1号表，去掉MAC的包会导向1号端口；</p>
    <p>[1084]	13、MSS_400服务器收到STB_0、STB_1发出的应答后，对比应答包的源地址（SA)及 设备类型就知道gatewayj)下接了 2台已注册终端，然后在服务器内部的注册信息表里找 到终端信息，向STBJK STB_1发送入网命令（告诉STBJK STB_1的接入网地址为0x000a、 0x000b)；根据10，gateway_0添加MAC后导向0号端口。</p>
    <p>[1085]	14、局域网中的L2交换机根据附录可知这2个包会分别导向STBJK STB_1，而不</p>
    <p>会广播。</p>
    <p>[1086]	15、STB_0、STB_1收到入网命令后，知道自己的接入网地址是0x000a、0x000b就入 网了，同时向服务器发送入网命令应答；</p>
    <p>[1087]	MSS-400服务器收到STB_0、STB_1发出的入网命令应答就知道STB_0、STB_1已经 入网了，以后每秒钟向这个端口发送设备状态查询指令，检查STBJK STB_1是否正常工作。 当服务器6秒之内没有收到状态查询应答，就认为终端已经被移出网络，不再发送设备状 态查询指令，继续向本端口发送端口查询包。</p>
    <p>[1088]	3. 3. 3. 2 交互示例 2</p>
    <p>[1089]	节点服务器与以太网协转网关、终端在入网过程中，节点服务器通过自身维护的 地址信息表来管理入网地址。下面通过另一个例子来说明地址信息表的管理。</p>
    <p>[1090]	接入网的地址可以设置为16bit，所有接入网设备都有唯一的接入网地址（包括 机顶盒、接入交换机、存储器，甚至节点服务器本身）。为方便管理所有接入网设备的接入网 地址，在节点服务器的CPU模块中可以维护一张地址信息表，该表的大小为2的16次方，也 即64K，每个表的表项由如下构成：</p>
    <p>[1091]	1)地址占用描述符：“00”表示此地址未用，“01”表示此地址待用（节点服务器用 此地址发出了端口下行协议包，但未收到入网上行协议包)，“10”表示此地址已用（节点服 务器收到入网上行协议包后设置）；</p>
    <p>[1092]	2)设备描述符：例如，“000000”表示节点服务器，“000001”表示其中一种接入交 换机BX-008，“000010”表示其中一种存储器，“000011 ”表示其中一种终端；</p>
    <p>[1093]	3)设备资源描述信息：例如，该设备是接入交换机的话，它的网络端口连接的设 备的接入网地址，它的各个网络端口的上下行流量计数；如果该设备是存储器的话，它的网 络端口连接的设备的接入网地址，它的读写通道的计数以及网络端口的上下行流量计数； 等等，所有这些信息是为了服务流程提供决策依据，而且每次的服务流程中都会修改这些 fn息ο</p>
    <p>[1094]	如图11所示，假设一台节点服务器MSS-400，它的0号端口接了一台接入交换机 BX-008-0 (实际上，在BX-008-0上增加本发明的MAC加减功能，就可以作为本发明的以太网协转网关），它的1号端口接了一台接入交换机BX-008-1，BX-008-0的0号端口接了一台 机顶盒STB-0，BX_008-1的1号端口接了一台机顶盒STB-1。</p>
    <p>[1095]	UMSS-400服务器上电后初始化硬件，获得默认城域网地址（假设为0x00 0x0000 0x0000)，从硬盘导入配置文件到CPU内存（例如交换机的注册信息、终端的注册信息等 等)，MSS-400服务器初始化地址信息表，全部清零（表示所有地址未用)，MSS-400服务器 配置自己的接入网地址为0x0000，也即地址信息表的第0x0000项被配置成如下：</p>
    <p>[1096]	&#8226;地址占用描述符：“10”表示此地址已用；</p>
    <p>[1097]	&#8226;设备描述符：“000000”表示节点服务器；</p>
    <p>[1098]	&#8226;设备资源描述信息：此节点服务器有8个下行百兆网口依次定义为0号端口到 7号端口，1个CPU模块接口定义为8号端口，1个磁盘阵列接口定义为9号端口，1个上行 千兆光口定义为10号端口，此节点服务器型号为MSS-400，它的网络端口连接的设备的接 入网地址未分配，它的各个网络端口的上下行流量计数为0 ；</p>
    <p>[1099]	地址信息表下一个可用地址为0x0001 ；</p>
    <p>[1100]	2、MSS-400服务器初始化0、1、2、3号表：</p>
    <p>[1101]	&#8226;配置0号表为“000 0000 0000 “，即所有下行协议包传送关闭；</p>
    <p>[1102]	&#8226;配置1号表为“001 0000 0000”，即所有上行协议包导向CPU ；</p>
    <p>[1103]	&#8226;配置2号、3号表为“000 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>[1104]	3,MSS-400服务器知道自己有8个下行端口，下一个可用地址为0x0001，所以它配 置8个0号表的表项分别为：</p>
    <p>[1105]	#"00 0000 0000 0000 0001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0001的查询包导向0号端口 ；</p>
    <p>[1106]	#"00 0000 0000 0000 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0002的查询包导向1号端口 ；</p>
    <p>[1107]	&#21443;“00 0000 0000 0000 0011" = &gt;"000 0000 0100”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0003的查询包导向2号端口 ；</p>
    <p>[1108]	&#21443; “00 0000 0000 0000 01 00 “ = &gt;“000 0000 1000”，即目的地址（DA)是 0x8000 0x0000 0x0000 0x0004 的查询包导向 3 号端口 ；</p>
    <p>[1109]	&#21443;“00 0000 0000 0000 0101" = &gt;"000 0001 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0005的查询包导向4号端口 ；</p>
    <p>[1110]	&#21443;“00 0000 0000 0000 0110" = &gt;"000 0010 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0006的查询包导向5号端口 ；</p>
    <p>[1111]	&#21443;“00 0000 0000 0000 0111" = &gt;“000 0100 0000”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0007的查询包导向6号端口 ；</p>
    <p>[1112]	#"00 0000 0000 0000 1000" = &gt;"000 1000 0000”，即目的地址（DA)是 0x8000 0x0000 0x0000 0x0008的查询包导向7号端口 ；</p>
    <p>[1113]	4、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0001,0x8000 0x0000 0x0000 0x0002,0x8000 0x0000 0x0000 0x0003,0x8000 0x0000 0x0000 0x0004、 0x8000 0x0000 0x0000 0x0005,0x80000x0000 0x0000 0x0006,0x8000 0x0000 0x0000 0x0007、0x8000 0x00000x0000 0x0008 的查询包（SA 都为 0x0000 0x0000 0x00000x0000)，根据其0号表的配置，所述查询包会依次导向0到7号端口 ；此时，地址信息表的 第0x0001至0x0008项被配置成：</p>
    <p>[1114]	&#8226;地址占用描述符：“01”表示此地址待用；</p>
    <p>[1115]	&#8226;设备描述符：不做修改；</p>
    <p>[1116]	&#8226;设备资源描述信息：不做修改；</p>
    <p>[1117]	地址信息表的下一个可用地址为0x0009 ；</p>
    <p>[1118]	5、ΒΧ-008-0、ΒΧ-008-1交换机上电后初始化硬件，</p>
    <p>[1119]	&#8226;配置其 0 号表”00 xxxx xxxx xxxx xxxx”为“01 0000 0000”，即所有下行协议 包包导向CPU ；</p>
    <p>[1120]	&#8226;配置其 1 号表”01 xxxx xxxx xxxx xxxx”为“10 0000 0000”，即所有的上行协 议包导向上行的百兆网口；</p>
    <p>[1121]	&#8226;配置其2号、3号表为“00 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>[1122]	6、BX-008-0交换机收到查询包后，根据其0号表的配置，该查询包被接收至其CPU 模块，由CPU模块解析该查询包并生成应答包（该应答中包含本接入交换机的注册信息） 发送给 MSS-400 服务器，包的 DA 是 0x0800 0x0000 0x0000 0x0000，SA 是 0x0000 0x0000 0x00000x0001 ；</p>
    <p>[1123]	7、MSS-400服务器收到BX-008-0交换机发出的应答包后，对比应答包的源地址 (SA)、及设备类型就知道其0号端口下接了一台接入交换机，然后在节点服务器内部的注 册信息表里找到这台接入交换机的信息，向该接入交换机发送入网命令（告知其接入网地 址为 0x0001)；</p>
    <p>[1124]	8、BX-008-0交换机收到入网命令后，知道自己的接入网地址是0x0001就入网了， 于是配置其0号表” 00 0000 0000 0000 0001”为“010000 0000”，0号表其余表项配置 为”00 0000 0000 “，即只有本交换机的下行协议包导入CPU，同时向服务器发送入网命令</p>
    <p>应答；</p>
    <p>[1125]	9,MSS-400服务器收到BX-008-0交换机发出的入网命令应答就知道BX-008-0交 换机已经入网了，于是将服务器内部的地址信息表的第0x0001项被配置成：</p>
    <p>[1126]	&#8226;地址占用描述符：“10”表示此地址已用；</p>
    <p>[1127]	&#183;设备描述符：“ 000001，，表示其中一种接入交换机BX-008 ；</p>
    <p>[1128]	&#8226;设备资源描述信息：此接入交换机有8个下行百兆网口依次定义为0号端口到 7号端口，1个CPU模块接口定义为8号端口，1个上行百兆网口定义为9号端口，此接入交换 机型号为BX-008，它的上行网络端口连接的设备的接入网地址是0x0000 (即MSS-400)，下 行网络端口连接的设备的接入网地址未分配，它的各个网络端口的上下行流量计数为0 ；</p>
    <p>[1129]	以后每秒钟向这个端口发送设备状态查询指令，检查BX-008-0交换机是否正常 工作，同时还要向BX-008-0交换机的下行端口发送端口下行协议包，检查是否有其他接入 网设备接在本接入交换机下面。在这种情况下，MSS-400服务器会在其0号表中做如下配 置：</p>
    <p>[1130]	#"00 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000 0x0000 0x0000 0x0009的端口下行协议包导向0号端口 ；</p>
    <p>[1131]	#"00 0000 0000 0000 1010" = &gt;"000 0000 0001”，即目的地址（DA)是 0x80000x0000 0x0000 OxOOOa的端口下行协议包导向0号端口 ；</p>
    <p>[1132]</p>
    <p>iOO 0000 0000 0000 1011" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOb的端口下行协议包导向0号端口 ；</p>
    <p>[1133]</p>
    <p>iOO 0000 0000 0000 1100" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOc的端口下行协议包导向0号端口 ；</p>
    <p>[1134]</p>
    <p>iOO 0000 0000 0000 1101" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOd的端口下行协议包导向0号端口 ；</p>
    <p>[1135]</p>
    <p>iOO 0000 0000 0000 1110" = &gt;"000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOe的端口下行协议包导向0号端口 ；</p>
    <p>[1136]</p>
    <p>iOO 0000 0000 0000 1111" = &gt;‘‘000 0000 0001”，即目的地址（DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOf的端口下行协议包导向0号端口 ；</p>
    <p>[1137]</p>
    <p>iOO 0000 0000 0001 0000" = &gt;"000 0000 0001”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0010的端口下行协议包导向0号端口 ；</p>
    <p>[1138] MSS-400服务器会通过包括端口分配信息的端口分配包，通知BX-008-0交换机在 其0号表中做如下配置：</p>
    <p>[1139]</p>
    <p>iOO 0000 0000 0000 1001 " = &gt;"00 0000 0001”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 0x0009的端口下行协议包导向0号端口 ；</p>
    <p>[1140]</p>
    <p>iOO 0000 0000 0000 1010 " = &gt;"00 0000 0010”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOa的端口下行协议包导向1号端口 ；</p>
    <p>[1141]</p>
    <p>iOO 0000 0000 0000 1011 " = &gt;"00 0000 0100”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOb的端口下行协议包导向2号端口 ；</p>
    <p>[1142]</p>
    <p>iOO 0000 0000 0000 1100 " = &gt;"00 0000 1000”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOc的端口下行协议包导向3号端口 ；</p>
    <p>[1143]</p>
    <p>iOO 0000 0000 0000 1101 " = &gt;"00 0001 0000”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOd的端口下行协议包导向4号端口 ；</p>
    <p>[1144]</p>
    <p>iOO 0000 0000 0000 1110 ‘‘ = &gt;‘‘00 0010 0000”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOe的端口下行协议包导向5号端口 ；</p>
    <p>[1145]</p>
    <p>iOO 0000 0000 0000 1111 " = &gt;"00 0100 0000”，即目的地址(DA)是 0x8000</p>
    <p>0x0000 0x0000 OxOOOf的端口下行协议包导向6号端口 ；</p>
    <p>1000 0000”，即目的地址（DA)是 0x8000</p>
    <p>号端口 ；</p>
    <p>[1146]	#"00 0000 0000 0001 0000 " = &gt;"00 0x0000 0x0000 0x0010的端口下行协议包导向7</p>
    <p>[1147]	10、MSS-400 服务器发目的地址（DA)是 0x8000 0x0000 0x00000x0009,0x8000 0x0000 0x0000 0x000a&gt;0x8000 0x0000 0x0000 0x000b&gt;0x8000 0x0000 0x0000 0x000c、 0x8000 0x0000 0x0000 OxOOOd,0x8000 0x0000 0x0000 OxOOOe,0x8000 0x0000 0x0000 OxOOOf、0x8000 0x00000x0000 0x0010 的端口下行协议包（SA 都为 0x0000 0x0000 0x00000x0000)，根据MSS-400服务器中0号表的配置，所述端口下行协议包会依次导向 MSS-400服务器0号端口，根据BX-008-0交换机中0号表配置，端口下行协议包会依次导 向BX-008-0交换机0到7号端口 ；并且，MSS-400服务器中的地址信息表的第0x0009至 0x0010项被配置成：[1148]	&#8226;地址占用描述符：“01”表示此地址待用；</p>
    <p>[1149]	&#8226;设备描述符：不做修改；</p>
    <p>[1150]	&#8226;设备资源描述信息：不做修改；</p>
    <p>[1151]	下一个可用地址为0x0011 ；</p>
    <p>[1152]	11、STB-O从BX-008-0交换机的0号端口收到端口下行协议包（即目的地址是 0x8000 0x0000 0x0000 0x0009的端口下行协议包）收到端口下行协议包后发送端口上行 协议包（包含本终端的注册信息），包的DA是0x0800 0x0000 0x0000 0x0000，SA是0x0000 0x0000 0x0000 0x0009 (交换机的 0 号端口 )；</p>
    <p>[1153]	12、MSS-400服务器收到STB-O交换机发出的端口上行协议包后，对比上行协议 包的源地址（SA)及设备类型就知道BX-008-0的0号端口下接了一台终端，然后在服务 器内部的注册信息表里找到终端信息，向终端发送入网命令（告诉终端的接入网地址为 0x0009)；</p>
    <p>[1154]	13、STB-O收到入网命令后，知道自己的接入网地址是0x0009就入网了，同时向服 务器发送入网命令应答；</p>
    <p>[1155]	14、MSS-400服务器收到STB-O发出的入网命令应答就知道STB-O交换机已经入 网了，于是将地址信息表的第0x0009项配置成：</p>
    <p>[1156]	&#8226;地址占用描述符：“10”表示此地址已用；</p>
    <p>[1157]	&#8226;设备描述符：“000011”表示其中一种终端；</p>
    <p>[1158]	&#8226;设备资源描述信息：此终端有视音频编解码引擎，1个百兆网口，此终端型号为 STB，它的网络端口连接的设备的接入网地址是0x0001 (即BX-008-0)，它的网络端口的上 下行流量计数为0 ；</p>
    <p>[1159]	地址信息表的第0x0001项被配置成：</p>
    <p>[1160]	&#8226;地址占用描述符：不做修改；</p>
    <p>[1161]	&#8226;设备描述符：不做修改；</p>
    <p>[1162]	&#8226;设备资源描述信息：此接入交换机有8个下行百兆网口依次定义为0号端口到 7号端口，1个CPU模块接口定义为8号端口，1个上行百兆网口定义为9号端口，此接入交 换机型号为BX-008，它的上行网络端口连接的设备的接入网地址是0x0000 (即MSS-400)， 下行网络端口 0连接的设备的接入网地址是0x0009，其余未分配，它的各个网络端口的上 下行流量计数为0 ；</p>
    <p>[1163]	以后MSS-400服务器每秒钟向这个端口发送设备状态查询指令，检查STB-O是否 正常工作，当服务器6秒之内没有收到状态查询应答，就认为STB-O已经被移出网络，不再 发送设备状态查询指令，继续向本端口发送查询包。</p>
    <p>[1164]	参照上述第6-14步骤，BX-008-1也会入网，获得其接入网地址为0x0002 ；STB-I 也会入网，获得其接入网地址为0x0012。</p>
    <p>[1165]	在入网后，节点服务器与以太网协转网关、终端就可以进行通信服务了（包括单 播通信服务与组播通信服务），为使本领域技术人员更好地理解本发明，以下提供一种节点 服务器与以太网协转网关、终端进行单播通信服务的示例。</p>
    <p>[1166]	3. 3. 4单播通信服务的通信连接流程示例：</p>
    <p>[1167]	如图7所示，假设一台节点服务器MSS-400 (接入网地址为0x0000)，它的0号端口接了一台以太网协转网关BX-008-0(接入网地址为0x0001)，它的1号端口接了一台以 太网协转网关ΒΧ-008-1(接入网地址为0x0002)，BX-008-0的0号端口接了一台机顶盒 STB-O (接入网地址为0x0009)，BX_008-1的1号端口接了一台机顶盒STB-1 (接入网地址 为0x0012)。机顶盒STB_0向节点服务器MSS-400发出申请和机顶盒STB_1进行可视通信 的单播通信服务，步骤如下：</p>
    <p>[1168]	Si、机顶盒STB_0发出服务请求协议包，包的DA(目的地址)为0x0800 0x0000 0x0000 0x0000(即 MSS-400 的地址）、SA (源地址）为 0x0000 0x0000 0x0000 0x0009 ；在 该包中，还包括以太网协转网关BX-008-0的MAC地址（MAC DA)和机顶盒STB_0的MAC地 址(MAC SA)；此外，还可以包括reserved 0x0000 (保留字），PDU部分如下表所示:</p>
    <p>[1169]</p>
    <span class="patent-image-not-available"> </span>
    <span class="patent-image-not-available"> </span>
    <p>[1171]	服务申il[1172]	#define[1173]	#define[1174]	#define[1175]	#define[1176]	#define[1177]	#define[1178]	#define[1179]	#define[1180]	#define[1181]	#define[1182]	#define[1183]	#define停继续	[1184]	#define[1185]	#define[1186]	#define</p>
    <p>服务申请所涉及到的节目号码，广播频道号全放在服务参数中，例如： SERVICE_TYPE_GTML_REQUEST 0x8000 申请一张菜单 SERVICE_TYPE_VOD_REQUEST 0x8001 申请点播节目 SERVICE_TYPE_CHANGE_MENU 0x8002 申请改变背景菜单 SERVICE_TYPE_BROADCAST_REQUEST 0x8003 申请收看广播 SERVICE_TYPE_CHANGE_CHANNEL 0x8004 申请频道切换 SERVICE_TYPE_TELEPHONE_DIRECT 0x8005 串请拨打可视电话 SERVICE_TYPE_PERMISSION 0x8006 是否允许接入的应答 SERVICE_TYPE_RECORD_REQUEST 0x8007 申请录制 SERVICE_TYPE_END_REQUEST 0x8008 申请结束当前服务 SERVICE_TYPE_ORG_CAST_REQUEST 0x8009 申请发起直播 SERVICE_TYPE_DDB_REQUEST 0x800b 申请收看延时电视 SERVICE_TYPE_SKIP 0x800c收看点播或延时电视的过程中快进快退暂</p>
    <p>SERVICE_TYPE_RECORD_END 0x800e 申请结束录制 SERVICE_TYPE_VIEff_Monitor_DIRECT 0x8024 申请收看监控 SERVICE_TYPE_RCV_CAST_DIRECT 0x8025 申请收看直播</p>
    <p>100[1187]	#define SERVICE_TYPE_TELEPHONE_REQUEST 0 申请拨打可视电话</p>
    <p>[1188]	#define SERVICE_TYPE_RCV_CAST_REQUEST Oxa 申请收看直播</p>
    <p>[1189]	#define SERVICE_TYPE_VIEff_Monitor Oxc 申请收看监控</p>
    <p>[1190]在本例中，服务参数为	SERVICE_TYPE_TELEPHONE_REQUEST 或 SERVICE_TYPE_ TELEPHONE_DIRECT。</p>
    <p>[1191]	S2、连接在机顶盒STB_0与节点服务器MSS-400之间的以太网协转网关BX-008-0 收到所述服务请求协议包，首先去掉该包中的以太网协转网关ΒΧ-008-0的MAC地址（MAC DA)和机顶盒STB_0的MAC地址（MAC SA)。</p>
    <p>[1192]	然后，根据1号表的配置，该服务请求协议包被导向至节点服务器MSS-400，节点 服务器MSS-400根据包的内容，判断收到可视通信的申请（服务类型），根据服务号码查 CAM表（内容-地址映射表）知道被叫（目标终端）是STB_1，根据其内部的地址信息表， 就知道了本次服务涉及的链路拓扑，判断出链路允许，双方可以进行通信。于是分别发送菜 单协议包给主叫（STB_0)和被叫（STB_1)，并等待被叫应答：</p>
    <p>[1193]其中，发向	STB_0 的菜单协议包：DA 为 0x8000 0x0000 0x00000x0009、SA 为 0x0000 0x0000 0x0000 0x0000、reserved 0x0000、PDU 部分如下表所示：</p>
    <p>[1194]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1195]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1196]发向	STB_1 的菜单协议包:DA 为 0x8000 0x0000 0x0000 0x0012、SA 为 0x0000 0x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如上表所示。</p>
    <p>[1197]	S3、根据节点服务器MSS-400中0号表的配置，以及，以太网协转网关BX-008-0和 BX-008-1中0号表的配置，这2个菜单协议包会分别导向至机顶盒STB_0和STB_1，在此过程中BX-008-0和BX-008-1分别对这2个菜单协议包添加MAC DA和MAC SA。</p>
    <p>[1198]	被叫STB_1发出申请SERVICE_TYPE_PERMISSION接受STB_1通信，并向节点服务 器MSS-400发送应答协议包，该包包括以太网协转网关BX-008-1的MAC地址（MAC DA)和机 顶盒 STB_1 的 MAC 地址（MAC SA)，还包括 DA 为 0x0800 0x0000 0x0000 0x0000、SAOxOOOO 0x0000 0x0000 0x0012、reserved 0x0000，服务参数是 SERVICE_TYPE_PERMISSION，PDU 部</p>
    <p>分如下表所示：</p>
    <p>[1199]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1200]	S4、以太网协转网关BX-008-1去掉所述应答协议包中的以太网协转网关 BX-008-1的MAC地址（MAC DA)和机顶盒STB_1的MAC地址（MAC SA)，然后根据1号表的 配置，所述应答协议包导向节点服务器MSS-400，节点服务器MSS-400根据包的内容判断收 到接受可视通信的申请，根据服务号码查CAM表知道被叫是STB_1，根据其内部的地址信息 表，节点服务器MSS-400就知道了本次服务涉及的链路拓扑，判断出链路允许，双方可以进 行通信。</p>
    <p>[1201]	在这种情况下，节点服务器MSS-400配置自己的2号表如下：</p>
    <p>[1202]	#"10 0000 0000 0001 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012 (即机顶盒BX-008-1)的单播数据包导向1号端口 ；</p>
    <p>[1203]	&#21443;“10 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址（DA)是 0x1000 0x0000 0x0000 0x0009 (即机顶盒BX-008-0)的单播数据包导向0号端口 ；</p>
    <p>[1204]	并且，节点服务器MSS-400给上行链路（主叫通路)和下行链路（被叫通路)上 的所有以太网协转网关发送端口配置命令。要求同时开放对方地址的上行和自身地址的下 行。</p>
    <p>[1205]	发向以太网协转网关BX-008-0的两个包：</p>
    <p>[1206]	1)第一个包的 DA 0x8000 0x0000 0x0000 0x0001、SA 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如下表所示：</p>
    <p>[1207]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1208]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1209]	2)第二个包的 DA 为 0x8000 0x0000 0x0000 0x0001、SA 为 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 部分如下表所示：</p>
    <p>[1210]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1211]	发向以太网协转网关BX-008-1的两个包：</p>
    <p>[1212]	1)第一个包的 DA 为 0x8000 0x0000 0x0000 0x0002、SA 为 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 如下表所示：</p>
    <p>[1213]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1214]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1215]	2)第二个包的 DA 为 0x8000 0x0000 0x0000 0x0002、SA 为 0x00000x0000 0x0000 0x0000、reserved 0x0000，PDU 如下表所示：</p>
    <p>[1216]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1217]	发向机顶盒STB-O的包（服务处理命令，本例中为编解码命令）：</p>
    <p>[1218]包的	DA 0x8000 0x0000 0x0000 0x0009、 SA 0x0000 0x0000 0x00000x0000、 reserved 0x0000, PDU部分如下表所示：[1219]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1220]	发向STB-I的包（服务处理命令，本例中为编解码命令）：</p>
    <p>[1221]包的	DA 为 0x8000 0x0000 0x0000 0x0012、SA 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：</p>
    <p>[1222]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1223]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1224]	上述编解码命令的PDU中，字段号13表示编码类型：0 =停止编码，Offff =维持 原状，Oxfffe将解码的数据返回，不进行本地编码；字段号14表示解码类型：0 =停止解 码，Offff =维持原状；字段号15-18表示编码地址（DA或组播地址）=OxfTfT =维持原状； 字段号19-22表示解码地址（DA或组播地址）=OxfTfT =维持原状；字段号23表示：HB ：编 码HDA，LB ：解码的HAD ；Oxffff =维持原状；字段号24表示响铃参数：0 =关闭响铃，1 = 开始响铃，Oxffff =维持原状；字段号25表示云台操作参数=Oxffff =维持原状；字段号 26表示辅助信道操作参数=OxfTfT =维持原状。</p>
    <p>[1225]	其中，编码类型如下表所示：</p>
    <p>[1226]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1227]	S5、根据节点服务器MSS-400中0号表的配置，以及，以太网协转网关BX-008-0、 BX-008-1中0号表的配置，前面4个发给以太网协转网关的包会分别导向BX-008-0、 BX-008-1。</p>
    <p>[1228]	在这种情况下，以太网协转网关BX-008-0配置自己的2号表如下：</p>
    <p>[1229]	&#21443;“10 0000 0000 0001 0010 “ = &gt;“10 0000 0000”，即目的地址(DA)是 0x10000x0000 0x0000 0x0012的单播数据包导向9号端口 ；</p>
    <p>[1230]	&#21443;“10 0000 0000 0000 1001 " = &gt;"00 0000 0001”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向0号端口 ；</p>
    <p>[1231]	以太网协转网关BX-008-1配置自己的2号表如下：</p>
    <p>[1232]	&#21443;“10 0000 0000 0001 0010 “ = &gt;“00 0000 0010”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012的单播数据包导向1号端口 ；</p>
    <p>[1233]	#"10 0000 0000 0000 1001 " = &gt;"10 0000 0000”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向9号端口 ；</p>
    <p>[1234]	根据节点服务器MSS-400中0号表的配置，以及，以太网协转网关BX-008-0、 BX-008-1中0号表的配置，后面2个发向机顶盒的包会分别导向至机顶盒STB-0、STB-I。 在此过程中，ΒΧ-008-0、ΒΧ-008-1会分别向这2个包中添加相应的MAC DA和MAC SA。收到 包后，机顶盒STB-O、STB-I就可以根据包的内容开始编解码，并接收、发送单播数据。</p>
    <p>[1235]	具体而言，在配置好当次服务的通信链路后，所述机顶盒STB-0、STB-I基于所述 通信链路收发单播数据的过程为：</p>
    <p>[1236]	1)机顶盒STB-O向机顶盒STB-I发送单播数据包，该包包括以太网协转网关 BX-008-0的MAC地址（MAC DA)和机顶盒STB_0的MAC地址（MAC SA)，该包的DA是0x1000 0x0000 0x0000 0x0012 ;SA 是 0x0000 0x0000 0x0000 0x0009 ；</p>
    <p>[1237]	2)该单播数据包进入以太网协转网关BX-008-0，，首先去掉所述MAC DA和MAC SA，然后以太网协转网关BX-008-0的交换引擎模块根据组合地址域查2号表，表的地址 是 “10 0000 0000 0001 0010”，该表项的输出是 “10 0000 0000”（ “10 0000 0000 0001 0010 “ = &gt;“10 00000000”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012 的单播数</p>
    <p>据包导向9号端口），表示打开上行9号端口，当前单播数据包通过该9号端口进入了节点 服务器MSS-400 ；</p>
    <p>[1238]	3)节点服务器MSS-400收到所述单播数据包后，其交换引擎根据组合地址域查2 号表,表的地址是“10 0000 0000 0001 0010”，该表项的输出是“000 0000 0010，，（"10 0000 0000 0001 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0012的单播数据包导向1号端口），表示打开下行1号端口，当前单播数据包通过该1号 端口进入了以太网协转网关BX-008-1 ；</p>
    <p>[1239]	4)以太网协转网关BX-008-1收到所述单播数据包后，其交换引擎模块根据组 合地址域查2号表，表的地址是“10 0000 0000 0001 0010”，该表项的输出是“00 0000 0010”（“10 0000 0000 0001 0010 “=&gt;“00 00000010”，即目的地址（DA)是 0x1000 0x0000 0x0000 0x0012的单播数据包导向1号端口），表示打开下行1号端口，当前单播数 据包通过该1号端口进入了机顶盒STB-I ；在此过程中，BX-008-1在该包中添加以太网协转 网关BX-008-1的MAC地址（MAC SA)和机顶盒STB-1的MAC地址（MAC DA)；</p>
    <p>[1240]	5)机顶盒STB-I向机顶盒STB-O发送单播数据包，该包的DA是0x1000 0x0000 0x0000 0x0009 ； SA 是 0x0000 0x0000 0x0000 0x0012 ；该包还包括以太网协转网关 BX-008-1 的 MAC 地址（MAC DA)和机顶盒 STB_1 的 MAC 地址（MAC SA)；</p>
    <p>[1241]	6)该单播数据包进入以太网协转网关BX-008-1，先去掉所述MACDA和MAC SA，然 后以太网协转网关BX-008-1的交换引擎模块根据组合地址域查2号表，表的地址是“100000 0000 0000 1001”，该表项的输出是“10 0000 0000”（“10 0000 0000 0000 1001 "= &gt;“10 0000 0000”，即目的地址（DA)是 0x1000 0x0000 0x0000 0x0009 的单播数据包导</p>
    <p>向9号端口），表示打开上行9号端口，当前单播数据包通过该9号端口进入了节点服务器 MSS-400 ；</p>
    <p>[1242]	7)节点服务器MSS-400收到所述单播数据包后，其交换引擎根据组合地址域查2 号表,表的地址是“10 0000 0000 0000 1001”，该表项的输出是“000 0000 0001”（“10 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址(DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向0号端口），表示打开下行0号端口，当前单播数据包通过该0号 端口进入了以太网协转网关BX-008-0 ；</p>
    <p>[1243]	8)以太网协转网关BX-008-0收到所述单播数据包后，其交换引擎模块根据组 合地址域查2号表，表的地址是“10 0000 0000 0000 1001”，该表项的输出是“00 0000 0001”（“10 0000 0000 0000 1001 “=&gt;“00 00000001”，即目的地址（DA)是 0x1000 0x0000 0x0000 0x0009的单播数据包导向0号端口），表示打开下行0号端口，当前单播数 据包通过该0号端口进入了机顶盒STB-0。在此过程中，BX-008-0在包中添加了以太网协 转网关BX-008-0的MAC地址（MAC SA)和机顶盒STB-O的MAC地址（MAC DA)。</p>
    <p>[1244]	3. 3. 5组播通信服务的通信连接流程示例</p>
    <p>[1245]	同样参照图7所示，假设一台节点服务器MSS-400 (接入网地址为0x0000)，它的0 号端口接了一台以太网协转网关BX-008-0(接入网地址为0x0001)，它的1号端口接了一台 以太网协转网关ΒΧ-008-1(接入网地址为0x0002)，BX-008-0的0号端口接了一台机顶盒 STB-O (接入网地址为 0x0009)，STB_0 的号码是 0x6666 0x6666 0x6666，BX_008_1 的 1 号端 口接了一台机顶盒STB-1(接入网地址为0x0012)，STB_1的号码是0x8888 0x8888 0x8888。 机顶盒STB_0向节点服务器MSS-400申请发起直播，步骤如下：</p>
    <p>[1246]	1、机顶盒STB_0发出发起直播的服务请求协议包，包中包括以太网协转网关 BX-008-0 的 MAC 地址（MAC DA)和机顶盒 STB_0 的 MAC 地址（MAC SA)，包的 DA 是 0x0800 0x0000 0x0000 0x0000、SA 是 0x0000 0x0000 0x0000 0x0009、reserved 0x0000 (保留</p>
    <p>字），PDU部分如下表所示：</p>
    <p>[1247]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1248]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1249]	2、连接在机顶盒STB_0与节点服务器MSS-400之间的以太网协转网关BX-008-0 收到所述服务请求协议包，首先去掉该包中的以太网协转网关BX-008-0的MAC地址（MAC DA)和机顶盒STB_0的MAC地址（MAC SA)。</p>
    <p>[1250]	然后，根据1号表的配置，该服务请求协议包被导向节点服务器MSS-400，节点服 务器MSS-400根据包的内容，判断收到发起直播的申请（服务类型），根据服务号码查CAM 表（内容-地址映射表）知道用户（源终端）是STB_0，根据其内部的地址信息表，就知 道了本次服务涉及的链路拓扑，判断出链路允许，可以进行发起直播，于是分配组播地址为 0x0008。并且，节点服务器给当前通信链路上的所有以太网协转网关发送端口配置命令，要 求同时开放对方地址的上行和自身地址的下行。此时，通过链路拓扑判断，获知当前只需配 置以太网协转网关BX-008-0。</p>
    <p>[1251]	在这种情况下，节点服务器MSS-400向以太网协转网关BX-008-0发包：</p>
    <p>[1252]包的	DA 为 0x8000 0x0000 0x0000 0x0001、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000 (保留字)，PDU部分如下表所示：</p>
    <p>[1253]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1254]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1255]	节点服务器MSS-400向机顶盒STB-O发包（服务处理命令，本例为编解码命令）：</p>
    <p>[1256]包的	DA 为 0x8000 0x0000 0x0000 0x0009，SA 为 0x0000 0x00000x0000 0x0000、reserved 0x0000, PDU部分如下表所示：</p>
    <p>[1257]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1258]	3、根据节点服务器MSS-400中0号表的配置，发向以太网协转网关BX-008-0的包 会导向至BX-008-0。在这种情况下，BX-008-0配置自己的3号表如下：</p>
    <p>[1259]	#"11 0000 0000 0000 1000 " = &gt;"00 0000 0001”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向0号端口 ；</p>
    <p>[1260]	4、根据节点服务器MSS-400中0号表的配置，以及，以太网协转网关BX-008-0中 0号表的配置，发向机顶盒STB-O的包会导向至STB-0。在此过程中，BX-008-0在包中添加 BX-008-0 &amp;MAC(MAC SA)和STB-O的MAC (MAC DA)发送。STB-O根据包的内容开始编解码， 并开始接收、发送组播数据。</p>
    <p>[1261]	具体而言，所述机顶盒STB-O基于当前的直播发起通信链路收发组播数据的过程 为：</p>
    <p>[1262]	1)机顶盒STB-O发出组播数据包，该包包括BX-008-0的MAC(MAC DA)和STB-O 的 MAC(MAC SA)，该包的 DA 是 0x7800 0x0000 0x00000x0008 (组播地址）；SA 是 0x0000 0x0000 0x0000 0x0009 ；</p>
    <p>[1263]	2)所述组播数据包进入以太网协转网关BX-008-0，首先去掉所述MAC DA和MACSA，然后以太网协转网关BX-008-0的交换引擎模块根据组合地址域查3号表，表的地址 是 “11 0000 0000 0000 1000”，该表项的输出是 “00 0000 0001”（“11 0000 0000 0000 1000" = &gt;"00 00000001”，即目的地址（DA)是 0x7800 0x0000 0x0000 0x0008 的组播数据</p>
    <p>包导向0号端口），表示打开下行0号端口，当前组播数据包通过该0号端口进入了机顶盒 STB-O。此过程中，BX-008-0 再在包中添加 BX-008-0 的 MAC (MAC SA)和 STB-O 的 MAC (MAC DA)，通过该0号端口发送。</p>
    <p>[1264]	机顶盒STB_1向节点服务器MSS-400申请收看直播，号码是0x66660x6666 0x6666，步骤如下：</p>
    <p>[1265]	1、机顶盒STB_1发出收看直播的服务请求协议包，该包包括BX-008-1的MAC(MAC DA)和 STB_1 的 MAC (MAC SA)，包的 DA 是 0x0800 0x0000 0x0000 0x0000、SA 是 0x0000 0x0000 0x00000x0012、reserved 0x0000，PDU 部分如下表所示：</p>
    <p>[1266]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1267]	2、连接在机顶盒STB_1与节点服务器MSS-400之间的以太网协转网关BX_008_1， 先去掉所述MAC DA和MAC SA，然后根据1号表的配置，该服务请求协议包被导向节点服务 器MSS-400，节点服务器MSS-400根据包的内容，判断收到收看直播的申请，根据服务号码 查CAM表知道发起者（源终端）是STB_0，根据其内部的地址信息表，就知道了本次服务涉 及的链路拓扑，判断出链路允许，可以进行收看直播，于是分配组播地址（对应分配给源终 端的组播地址）是0x0008。并且，节点服务器给当前通信链路上的所有以太网协转网关发 送端口配置命令，要求同时开放对方地址的上行和自身地址的下行。在这种情况下，节点服 务器MSS-400配置自己的3号表如下：</p>
    <p>[1268]	&#21443;“11 0000 0000 0000 1000" = &gt;"000 0000 0010”，即目的地址（DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口 ；</p>
    <p>[1269]	同时，节点服务器MSS-400向以太网协转网关BX-008-0发包：</p>
    <p>[1270]包的	DA 为 0x8000 0x0000 0x0000 0x0001、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：[1271]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1272]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1273]	同时，节点服务器MSS-400向以太网协转网关BX_008_1发包：</p>
    <p>[1274]包的	DA 为 0x8000 0x0000 0x0000 0x0002、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：</p>
    <p>[1275]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1276]	同时，节点服务器MSS-400向机顶盒STB-I发包：</p>
    <p>[1277]包的	DA 为 0x8000 0x0000 0x0000 0x0012、SA 为 0x0000 0x00000x0000 0x0000、 reserved 0x0000, PDU部分如下表所示：[1278]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1279]	3、根据节点服务器MSS-400中0号表的配置，发向以太网协转网关BX-008-0、 BX-008-1会分别导向至以太网协转网关BX-008-0和BX-008-1。</p>
    <p>[1280]	在这种情况下，以太网协转网关BX-008-0配置自己的3号表如下：</p>
    <p>[1281]	#"11 0000 0000 0000 1000 " = &gt;"10 0000 0001”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向0号、9号端口 ；</p>
    <p>[1282]	以太网协转网关BX-008-1配置自己的3号表如下：</p>
    <p>[1283]	&#21443;“11 0000 0000 0000 1000 “ = &gt;“00 0000 0010”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口 ；</p>
    <p>[1284]	4、根据节点服务器MSS-400中0号表的配置，以及，以太网协转网关BX_008_1中0 号表的配置，发向机顶盒STB-I的包会导向至STB-1。STB-I根据包的内容接收组播数据、 解码。BX-008-1 会在包中添加 BX-008-1 的 MAC (MAC SA)和 STB-I 的 MAC (MAC DA)发送。</p>
    <p>[1285]	具体而言，所述机顶盒STB-I基于当前的收看直播的通信链路接收组播数据的过 程为：</p>
    <p>[1286]	1)机顶盒STB-O发出组播数据包，该包包括以太网协转网关BX-008-0的MAC地址（MAC DA)和机顶盒 STB_0 的 MAC 地址（MACSA)，该包的 DA 是 0x7800 0x0000 0x0000 0x0008 (组播地址）；SA 是 0x0000 0x0000 0x0000 0x0009 ；</p>
    <p>[1287]	2)所述组播数据包进入以太网协转网关BX-008-0，先去掉所述MAC DA和MAC SA, 然后以太网协转网关BX-008-0的交换引擎模块根据组合地址域查3号表，表的地址是“11 0000 0000 0000 1000”，该表项的输出是“10 0000 0001”（“11 0000 0000 0000 1000 "= &gt;"10 00000001”，即目的地址(DA)是0x7800 0x0000 0x0000 0x0008的组播数据包导向 0号、9号端口）；表示打开下行0号端口和上行9号端口，当前组播数据包通过该0号端口 进入了机顶盒STB-O ；通过该9号端口进入了节点服务器MSS-400 ；</p>
    <p>[1288]	其中，通过该0号端口进入了机顶盒STB-O的包，BX-008-0在包中添加了 BX-008-0 的 MAC 地址（MAC SA)和机顶盒 STB_0 的 MAC 地址（MAC DA)。</p>
    <p>[1289]	3)节点服务器MSS-400收到该组播数据包后，其交换引擎模块根据组合地址域查 3号表，表的地址是“11 0000 0000 0000 1000”，该表项的输出是“000 0000 0010”（“11 0000 0000 0000 1000 “ = &gt;“000 00000010”，即目的地址(DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口），表示打开下行1号端口，当前组播数据包通过该1号 端口进入了以太网协转网关BX-008-1 ；</p>
    <p>[1290]	4)以太网协转网关BX-008-1收到该组播数据包后，其交换引擎模块根据组合 地址域查3号表，表的地址是“11 0000 0000 0000 1000”，该表项的输出是“00 0000 0010”（“11 0000 0000 0000 1000 “=&gt;“00 00000010”，即目的地址（DA)是 0x7800 0x0000 0x0000 0x0008的组播数据包导向1号端口），表示打开下行1号端口，当前组播 数据包通过该1号端口进入了机顶盒STB-I。该包中添加了 BX-008-1的MAC (MAC SA)和 STB-I 的 MAC(MAC DA)。</p>
    <p>[1291]	3. 3. 6以太网协转网关的流量控制</p>
    <p>[1292]	以太网协转网关还可以对经过的数据包和协议包进行精确的流量控制。参照图 12，如下：</p>
    <p>[1293]	步骤1001，下行网络接口接收的数据包进入包检测模块；</p>
    <p>[1294]	步骤1002，包检测模块检查数据包的以太网协转网关MAC DA、目标终端MAC SA、以 太网length or frame type、新型网目地地址（DA)、新型网源地址（SA)、数据包类型及包 长度是否符合要求，如果符合则分配相应的流标识符（stream-id)，并由MAC删除模块减去 MAC DA,MAC SA，然后进入相应的端口接收缓存，否则丢弃；</p>
    <p>[1295]	而上行网络接口接收的数据包直接进入相应的端口接收缓存，CPU模块接口接收 的数据包也直接进入相应的端口接收缓存。这是因为本实施例是对上行转发进行控制，因 此上行网络接口和CPU模块接口接收的数据包都不进行检测。</p>
    <p>[1296]	本实施例中，流标识符（stream-id)可以是8bit，对应256种流。</p>
    <p>[1297]	步骤1003，交换引擎对各个端口接收缓存进行轮询，如果有包则对其进行地址查 找表查询，从而获得包的导向信息；</p>
    <p>[1298]	对于数据包，查找数据包地址表，如果是单播数据包，则查找2号表，如果是组播 数据包，则查找3号表。</p>
    <p>[1299]	步骤1004，如果进入端口接收缓存的数据包是下行网络接口往上行网络接口去 的，则交换引擎结合流标识符（stream-id)把该数据包存入对应的包缓存器队列；如果该包缓存器队列接近满，则丢弃；</p>
    <p>[1300]	如果进入端口接收缓存的数据包不是下行网络接口往上行网络接口去的（例如， 是上行网络接口往下行网络接口去的，或者是CPU模块接口往下行网络接口去的，等等）， 则交换引擎根据包的导向信息把该数据包存入对应的包缓存器队列；如果该包缓存器队列 接近满，则丢弃；</p>
    <p>[1301]	所述包缓存器中，假设有256个流类型，则可以有256个缓存，分别缓存不同的流 对应的数据包。</p>
    <p>[1302]	以上为包的接收部分，下边是包的发送部分：</p>
    <p>[1303]	步骤1005，交换引擎轮询所有包缓存器队列，分为两种情形；</p>
    <p>[1304]	第一种，如果该队列是下行网络接口往上行网络接口去的，则满足以下条件进行 转发：</p>
    <p>[1305]	1)端口发送缓存未满；</p>
    <p>[1306]	2)该队列包计数器大于零；</p>
    <p>[1307]	3)获得码率控制模块产生的令牌；</p>
    <p>[1308]	所谓转发是指由交换引擎从该包缓存器队列顺序读出一个包，并写入上行网络接 口的端口发送缓存。</p>
    <p>[1309]	第二种，如果该队列不是下行网络接口往上行网络接口去的，则满足以下条件进 行转发：</p>
    <p>[1310]	1)该端口发送缓存未满；</p>
    <p>[1311]	2)该队列包计数器大于零。</p>
    <p>[1312]	步骤1006，下行网络接口的发送模块检测该端口的发送缓存，如果有包则根据包 的新型网目地地址DA获知对应的终端的以太网MACDA，由MAC添加模块添加终端的以太网 MAC DA、以太网协转网关的MAC SA、以太网length or frame type，并发送。</p>
    <p>[1313]	上行网络接口的发送模块检测该端口的发送缓存，如果有包则发送。</p>
    <p>[1314]	本实施例中，以太网协转网关是基于存储&#8212;&#8212;转发机制的，所有的端口都有接收 缓存和发送缓存，这些缓存都是在交换机芯片内部的，不会太大，每个接送缓存和发送缓存 在2kbyte到4kbyte之间，大概可以缓存2到3个最大以太网包（大概1556byte)。但是，仅 有这些缓存是远远不够的，因此在交换机芯片外面需要增加包缓存器，一般用SDRAM、SRAM 等颗粒包缓存器，比如可以用16Mbyte的SDRAM作为包缓存器，它可以存储IOK个最大以太 网包（大概1556byte)。所谓的端口发送缓存未满就是指端口发送缓存最少还存一个最大 以太网包（大概1556byte)，这样保证发送缓存不会溢出。</p>
    <p>[1315]	下面通过一个例子具体说明码率控制模块如何产生令牌。</p>
    <p>[1316]	接入网交换机的码率控制模块为每个流配备了一组计数器，分别定义如下：</p>
    <p>[1317]	bit (68) = op	‘ 0' -&#8212;&gt; reset, ‘ 1' -&#8212;&gt; normal</p>
    <p>[1318]	bit (67 downto 60) = frame_cnt	0-255</p>
    <p>[1319]	bit (59 downto 50) = frame_4byte	-511-511</p>
    <p>[1320]	bit (49 downto 41) = max_frame_4byte 0-511</p>
    <p>[1321]	bit (40 downto 32) = add_4byte	0&#8212;511</p>
    <p>[1322]	bit (31 downto 16) = timer_set[1323]	bit (15 downto 0) = timer_cnt</p>
    <p>[1324]	bit (68) = op，当op =’ 0’时表示初始化计数器为零，当op =，1’时表示正常操 作；</p>
    <p>[1325]	bit (67 downto 60) = frame_cnt表示包缓存队列中的包计数，这里假设为 8bit (0-255)；</p>
    <p>[1326]	bit (59 downto 50) = frame_4byte 表示可以发送的字节数（注意 frame_4byte 为4byte的计数器，假设frame_4byte = 4，表示可以发送的字节数为16，同时这个计数器 可以是负的，这里假设为IObit所以范围是-511-511)；</p>
    <p>[1327]	bit (49 downto 41) = max_frame_4byte表示可以发送的字节数的最大值，这里 假设为 9bit (0-511)；</p>
    <p>[1328]	bit (40 downto 32) = add_4byte表示每隔固定时间增加的可以发送的字节数 (注意add_4byte为4byte的计数器，假设add_4byte = 4，表示增加的可以发送的字节数 为16，这里假设为9bit所以范围是0-511)；</p>
    <p>[1329]	bit(31 downto 16) = timer_Set表示设定的时间间隔，假设系统查询周期 为50us，如果timer_set = 100，则表示设定的时间间隔为50usxl00 = 5ms，这里假设为 16bit ；</p>
    <p>[1330]	bit(15 downto 0) = timer_Cnt表示系统查询周期的计数器，假设系统查询周期 为50us，则表示每隔50us, timer_cnt加1，这里假设为16bit。</p>
    <p>[1331]	现在假设总共有256个流，则在码率控制模块中会维持256组计数器。码率控制 模块对每组计数器处理时间为10个时钟周期，系统时钟为125MHz，也就是时钟周期为8ns。 那么处理256组计数器的时间需要256x10x8ns = 20480ns = 20. 48us，假设系统查询周期 为50us，则有非常大的冗余。</p>
    <p>[1332]	为了方便描述，这里假设第50个流的计数器分别设置如下：</p>
    <p>[1333]	timer_set = 100,</p>
    <p>[1334]	add_4byte = 16，</p>
    <p>[1335]	frame_4byte = -10,</p>
    <p>[1336]	max_frame_4byte = 400,</p>
    <p>[1337]	frame_cnt = 2。</p>
    <p>[1338]	码率控制模块检查第50个流的计数器，如果timer_Cnt = timer_Set (100)，表示 根据设定的时间间隔到了发包的时间，则frame_4byte = frame_4byte+add_4byte，并判断 frame_4byte 是否大于 max_frame_4byte,如果大于则 frame_4byte = max_frame_4byte0 在上面的例子中，frame_4byte = frame_4byte+add_4byte = -10+16 = 6,小于 max_ frame_4byte(400)。</p>
    <p>[1339]	然后，如果frame_4byte大于0，并且frame_Cnt大于0，则码率控制模块发送一 个令牌给交换引擎（例子中的令牌号为50)。交换引擎根据令牌号从相应的包缓存队列中 (例子中为包缓存队列50)取出一个数据包并发送，同时把该数据包的长度返还给码率控 制模块。码率控制模块把frame_4byte减去相应的包长度，假设该包长度framejength = 20 (4byte 的整数倍），贝Ij frame_4byte = frame_4byte-frame_length = 6-20 = -14。</p>
    <p>[1340]上述计数器	op、max_frame_4byte、add_4byte、timer_set 即为流量控制信息，都是由CPU模块来配置（通过与节点服务器之间的协议交互获得)。timer_Cnt初始化为0， 每隔系统查询周期加1 ；frame_cnt初始化为0，如果该包缓存队列中增加一个数据包，则 frame_cnt 力口 1。码率控制模块通过控制 max_frame_4byte、add_4byte、timer_set 几个参 数，可以把输入不均&#21243;的数据流变成均&#21243;的数据流输出。例如，需要输出包长为1024byte、 间隔为5ms的数据流，则设置：</p>
    <p>[1341]	max_frame_4byte = 256(1024byte)，</p>
    <p>[1342]	add_4byte = 256 (1024byte)，</p>
    <p>[1343]	timer_set = 100 (假设系统查询周期为50us)。</p>
    <p>[1344]	由上可知，服务不同，对应的流也不同，则CPU模块从节点服务器获得的流量控制 信息也不同。而且，上述码率控制不仅可以对固定包长的数据包进行控制，还可以对变长 包进行控制，所述变长包是指每次输入交换机的数据包长度是变化的。这是因为每次可以 发送的数据大小由可发送字节的最大值max_frame_4byte和用于调整变长包发送的参数 add_4byte 决定。</p>
    <p>[1345]	更具体的，将上述以太网协转网关进行流量控制的过程结合上述3. 3. 4的单播通 信过程进行举例说明：</p>
    <p>[1346]	3. 3. 4中详细举例说明了节点服务器MSS-400发送协议包完成配表，通知本次服 务的通信链路上的各个以太网协转网关开启相应端口。优选的，在针对本次服务的通信路 径设定过程中，节点服务器MSS-400也可以通过发送协议包实现流控信息的传递，即将针 对本次服务的流控信息发送给机顶盒STB-O向机顶盒STB-I的上行链路中的第一个以太网 协转网关BX-008-0，由其对本次服务的数据包进行流量控制。</p>
    <p>[1347]	因为节点服务器MSS-400在针对本次服务设定路径时，也同时依据本次服务的类 型等属性信息，确定了本次服务的所占流量（即向本次服务分配了多少流量），并在节点服 务器MSS-400的地址信息表中的设备资源描述信息中加以记录（即在该端口的流量信息中 增加本次服务所占用的流量）。这样在下一个服务请求时，查阅就可以知悉该端口的实际流量。</p>
    <p>[1348]	节点服务器MSS-400向交换机BX-008-0发送流量控制信息，是为了确保节点服务 器MSS-400针对本次服务所分配的流量额度能够确保实现，而不是随意增加或者随意减少 (包括在带宽统计意义上的变化和带宽在离散时间点的变化）。</p>
    <p>[1349]	由于流控信息可以保证交换机BX-008-0在收到本次服务的数据包时，依据一定 的时间间隔对数据包进行发送，并且每次发送的数据大小也有要求。当终端发送的数据包 长度较大时，则可以积累两个或者多个时间间隔后再发送，这样，既可以不拆解或分解用户 数据包，同时也可以基本保证数据发送的稳定均&#21243;。当然，优选的，本发明在进行服务建立 时，就可以通知交换机和终端限定数据包长度，例如，终端发起的数据包长度就符合流控信 息的要求，同时交换机还可以对数据包长度不符合的数据包进行丢弃，以进一步保证数据 发送的稳定均&#21243;。</p>
    <p>[1350]	总之，通过流控信息可以保证交换机BX-008-0在每个时刻所发送的数据流量是 稳定的、均&#21243;的，并且是符合所分配的流量额度的，不会出现随意变化的情况。这样，也就能 够保证本发明可以实现从网络中各个服务、各个端口的流量的精确分配和控制。</p>
    <p>[1351]	当然，为了保证流量的精确控制，本发明还可以对服务建立请求的协议包也进行</p>
    <p>119流量控制。具体的，节点服务器MSS-400可以对接入终端的最底层交换机都赋予流量控制 信息，即当各个交换机接收到上行协议包时，就按照节点服务器MSS-400在当前交换机上 电入网时所通知的流量控制信息进行数据传输即可。这样，本发明可以保证即使同时发起 大量的服务请求协议包，也不会影响整个网络的流量分布，即本发明能够对服务请求过程 进行流量控制，也可以对已经建立服务链路的数据传输过程进行流量控制。</p>
    <p>[1352]	在3. 3. 5组播链路路径的建立过程中，也存在前面单播服务中的端口流量控制信 息设定、记录、通知的过程，由于实现过程和技术原理基本一致，在此不再赘述。</p>
    <p>[1353]	4、城域网实现</p>
    <p>[1354]	为了简化设计，在城域网中的数据包的类型总共有4种，分别是：</p>
    <p>[1355]	&#8226;城域查询标签包（由城域服务器发往节点交换机、节点服务器的带标签的协议 包）；</p>
    <p>[1356]	&#8226;城域应答标签包（由节点交换机、节点服务器回应给城域服务器的带标签的协 议包）；</p>
    <p>[1357]	&#8226;单播标签数据包（由节点服务器在单组播数据包上添加标签构成）；</p>
    <p>[1358]	&#8226;组播标签数据包（由节点服务器在单组播数据包上添加标签构成）；</p>
    <p>[1359]	城域网的地址总共是4013^，本文把它分成3层，分别是81^&#20175;161^&#20175;1613^，并依 次定义为国家网、广域网、城域网。同一城域网、同一接入网的终端之间的数据传送由这接 入网的节点服器控制。</p>
    <p>[1360]	假设STB_0位于接入网A，STB_1位于接入网B，接入网A、接入网B属于同一城域 网C。实现过程如下：</p>
    <p>[1361]	1、STB_0发出请求和STB_1进行可视电话；</p>
    <p>[1362]	2、接入网A的节点服务器根据STB_1的号码查到不属于接入网A，然后它向城域网 C的城域服务器发出查询；</p>
    <p>[1363]	3、城域网C的城域服务器根据STB_1的号码查到它属于接入网B，于是它向接入网 B的节点服务器发出查询；</p>
    <p>[1364]	4、接入网B的节点服务器根据STB_1的号码查到STB_1在接入网B，接入网B的节 点服务器发送呼叫菜单给STB_1 ；</p>
    <p>[1365]	5、STB_1可以选择接受或者拒接，应答发送给接入网B的节点服务器，这里假设选 择接受；</p>
    <p>[1366]	6、接入网B的节点服务器向城域网C的城域服务器发出应答；</p>
    <p>[1367]	7、城域网C的城域服务器向接入网A的节点服务器发出应答；</p>
    <p>[1368]	8、接入网A的节点服务器向STB_0发出应答。</p>
    <p>[1369]	从上描述可知，终端只和本接入网节点服务器交互，节点服务器和本城域网的城 域服务器交互，以此类推，城域服务器和本广域网的广域服务器交互。</p>
    <p>[1370]	假设城域查询包的数据报类型为“1001 0000”（ 二进制），也就是0x90 (十六进 制），城域应答包的数据报类型为“0000 1001” ( 二进制），也就是0x09 (十六进制），单播 标签数据包的数据报类型为“0001 0000”（ 二进制），也就是0x10 (十六进制），组播标签数 据包的数据报类型为“01111000”（ 二进制），也就是0x78 (十六进制），需要4张查找表，例 如[1371]	&#8226;城域查询标签包的标签查找表，定义为4号表，大小为64K ；</p>
    <p>[1372]	&#8226;城域应答标签包的标签查找表，定义为5号表，大小为64K ；</p>
    <p>[1373]	&#8226;单播标签数据包的标签查找表，定义为6号表，大小为64K ；</p>
    <p>[1374]	&#8226;组播标签数据包的标签查找表，定义为7号表，大小为64K ；</p>
    <p>[1375]	城域查询标签包、城域应答标签包、单播标签数据包、组播标签数据包的标签查 找表的输出除了表示数据包导向的端口外，另外还有16bit的出标签。例如其中的一种 节点交换机MX-4，它有4个千兆光口，1个CPU模块接口。如果4个千兆光口依次定义为 0号端口到3号端口，CPU模块接口定义为4号端口，则总共需要64kx21bit (5bit+16bit) 城域查询标签包地址查找表，64kx21bit(5bit+16bit)城域应答标签包地址查找表， 64Kx21bit(5bit+16bit) 单播标签数据包，64Kx21bit (5bit+16bit)组播标签数据包。例 如入标签为0x0001的城域查询标签包查找表的输出为“1 0000 0000 0000 0000 0000”， 表示包导向4号端口（CPU端口），出标签为0x0000 ；入标签为0x0001的组播标签数据包查 找表的输出为“0 0011 0000 0011 0000 0000”，表示数据包导向0号、1号端口，出标签为 0x0300，以此类推。</p>
    <p>[1376]	单组播标签数据包实例如下：</p>
    <p>[1377]	假设0号端口进来一个数据包它的头部数据是0x1056 0x15000x0000 0x55aa 0x0056 0x1500 0001 0xaa55 0x0000 0x0000 0x00001，其中 DA 是 0x1056 0x1500 0x0000 0x55aa, SA 是 0x0056 0x1500 0001 0xaa55 保留字节是 0x0000，标签是 0x0001，那么它的 数据包类型为0x10，根据查表规则这时查6号表，即地址为“0000 0000 0000 0001”，此地 址对应的查找表的输出为“0 1100 1000 0000 0000 0001”，表示数据包导向的2号、3号 端口，更换标签为0x8001，所以当数据包从2号、3号端口输出时，它的头部数据是0x1056 0x1500 0x0000 0x55aa 0x0056 0x15000001 0xaa55 0x0000 0x0000 0x8001。</p>
    <p>[1378]	下面通过实施例详细说明城域网中的通信，具体包括城域服务器与节点交换机、 城域服务器与节点服务器的入网流程和服务流程。</p>
    <p>[1379]	4.1 城域网的入网流程</p>
    <p>[1380]	4. 1. 1城域服务器与节点交换机、节点服务器的入网流程</p>
    <p>[1381]	首先每台允许入网的交换机都必须在服务器里注册，交换机的注册信息有交换机 的设备类型、设备标识，没有注册的交换机无法入网。</p>
    <p>[1382]	首先每台允许入网的交换机都必须在服务器里注册，交换机的注册信息有交换机 的设备类型、设备标识，没有注册的交换机无法入网。如图7所示，所述节点交换机入网的 过程涉及以下步骤：</p>
    <p>[1383]	Si、城域服务器向每个端口发送查询包，节点交换机收到查询包后发送应答包 (应答中包含交换机的设备类型、设备标识，这是每台交换机的固有信息）；</p>
    <p>[1384]	S2、城域服务器收到节点交换机发出的应答后就知道本端口下接了一台节点交换 机，然后在城域服务器内部的注册信息表里找到该节点交换机信息，并向该节点交换机发 送入网命令（告诉交换机的城域网地址和标签），该节点交换机收到入网命令后就入网了， 同时向所述城域服务器发送入网命令应答；</p>
    <p>[1385]	S3、城域服务器收到交换机发出的入网命令应答后，就知道该节点交换机已经入 网了，以后每秒钟向这个端口发送状态查询包，检查该节点交换机是否正常工作，同时还要向该节点交换机的其它端口发送端口查询包，检查是否有其他设备接在该节点交换机下 面。如果该节点交换机正常工作，收到状态查询包后会发送状态查询应答给所述城域服务 器。当城域服务器一定时间内（如6秒之内）没有收到状态查询应答，就认为该节点交换 机已经被移出网络，不再发送状态查询包，继续向本端口发送查询包。</p>
    <p>[1386]	对于连接在节点交换机下的节点服务器入网流程，与前述过程相似，在此不再详 述。</p>
    <p>[1387]	4. 1. 2城域服务器与节点交换机、节点服务器的入网交互示例</p>
    <p>[1388]	所有城域网网中的设备都由设备信息表来描述，2个byte的设备类型加6个byte 的设备标识就可以唯一的标示一个设备，一般根据不同的设备类型有不同的设备信息表来 描述，例如有节点交换机信息表、节点服务器信息表。设备信息表的表项由如下构成：</p>
    <p>[1389]	1)设备标识：6个byte，设备注册的时候，写入城域服务器的硬盘或flash，城域服 务器上电后导入CPU的内存；</p>
    <p>[1390]	2)设备状态：2个byte，0x0000表示此设备未入网，0x0001表示此设备待入网（城 域服务器发出了入网命令包，但未收到入网命令应答)，0x0002表示此设备已入网（城域服 务器收到入网应答包后设置）；</p>
    <p>[1391]	3)设备地址：2个byte，该设备分配的城域网地址。</p>
    <p>[1392]	城域网的地址是16bit，所有城域网的设备都有唯一的接入网地址（包括城域服 务器、节点交换机、节点服务器）在城域服务器的CPU模块维护着一张2的16次方的表，也 即64K的表，称为城域地址信息表，每个表的表项由如下构成：</p>
    <p>[1393]	1)地址占用描述符：2个byte，0x0000表示此地址未用，0x0001表示此地址待用 (城域服务器用此地址发出了入网命令包，但未收到入网命令应答），0x0002表示此地址已 用（城域服务器收到入网应答包后设置）；</p>
    <p>[1394]	2)设备类型：2个byte，例如0x0000表示城域服务器MS-1000，0x0001表示其中 一种节点交换机MX-4，0x0002表示其中一种节点服务器MSS-400 ；</p>
    <p>[1395]	3)设备资源描述信息：若干byte，例如该设备是节点交换机，则包括它的网络端 口连接的设备的城域网地址，它的各个网络端口的上下行流量计数；如果该设备是节点服 务器，则包括它的网络端口连接的设备的接入网地址，它的网络端口的上下行流量计数，等 等；所有这些信息是为了服务流程提供决策依据，而且每次的服务流程中都会修改这些信 肩、ο</p>
    <p>[1396]	同样，城域查询标签描述的是城域服务器到节点交换机或节点服务器的连接，而 城域应答标签描述的是节点交换机或节点服务器到城域服务器到的连接。为了简化设计， 假设两者是一一对应的，例如城域服务器到一节点交换机的城域查询标签是0x0008，则该 节点交换机到城域服务器的城域应答标签也是0x0008，并且出标签等于入标签。这样在城 域服务器的CPU模块维护另一张2的16次方的表，也即64K的表，称为城域协议标签信息 表，每个表的表项由如下构成：</p>
    <p>[1397]	1)标签占用描述符：2个byte，0x0000表示此标签未用，0x0001表示此标签待用 (城域服务器用此标签发出了端口查询包，但未收到入网应答包），0x0002表示此标签已用 (城域服务器收到入网应答包后设置）；</p>
    <p>[1398]	2)标签描述符：2个byte，该标签对应的设备的城域网地址；[1399]	3)标签路由描述信息：4个byte，用来描述该城域查询标签包的上一跳交换机的 城域网地址及端口号，前2个byte表示上一跳交换机的城域网地址，后2个byte表示上一 跳交换机的端口号。</p>
    <p>[1400]	如图14所示，举例说明，假设此城域服务器有4个千兆光口，1个CPU模块接口。 如果4个千兆光口依次定义为0号端口到3号端口，CPU模块接口定义为4号端口，此城域 服务器型号为MS-1000，MS-1000的0号端口、1号端口分别接了 1台MX-4-0 2号端口、3号 端口，MX-4-0 的 0 号端口接了 1 台 MSS-400-0，1 号端口接了 1 台 MSS-400-1。</p>
    <p>[1401]	入网交互过程如下：</p>
    <p>[1402]	1、MS-1000服务器上电后初始化硬件，从硬盘导入配置文件到CPU内存（例如节 点交换机的注册信息、节点服务器的注册信息等等），MS-1000服务器初始化城域地址信息 表、城域协议标签信息表，全部清零（表示所有地址、标签未用），MS-1000服务器配置自己 的城域网地址为0x0000，也即城域地址信息表的第0x0000项被配置成如下：</p>
    <p>[1403]	&#8226;地址占用描述符：0x0002表示此地址已用；</p>
    <p>[1404]	&#8226;设备描述符：0x0000表示城域服务器；</p>
    <p>[1405]	&#8226;设备资源描述信息：此城域服务器有4个千兆光口依次定义为0号端口到3号 端口，CPU模块接口定义为4号端口，此节点服务器型号为MS-1000，它的网络端口连接的设 备的城域网地址未分配，它的各个网络端口的上下行流量计数为0 ；</p>
    <p>[1406]	下一个可用地址为0x0001，下一个城域协议标签为0x0000 ；</p>
    <p>[1407]	2、MS-1000服务器初始化4、5、6、7号表</p>
    <p>[1408]	&#8226;配置 4 号表为 “0 0000 0000 0000 0000 0000” 到 “0 0000 1111 11111111 1111”，即所有城域查询标签包传送关闭；</p>
    <p>[1409]	&#8226;配置 5 号表为 “1 0000 0000 0000 0000 0000” 到 “1 0000 1111 11111111 1111”，即所有的城域应答标签包导向CPU ；</p>
    <p>[1410]	&#8226;配置6号、7号表为“0 0000 0000 0000 0000 0000”，即所有单组播数据包传送</p>
    <p>关闭；</p>
    <p>[1411]	3、MS-1000服务器配置知道自己有4个千兆光口，下一个城域协议标签为0x0000， 所以它配置4个4号表的表项分别为</p>
    <p>[1412]	#"100 0000 0000 0000 0000 议标签0x0000的查询包导向0号端口；</p>
    <p>[1413]	#"100 0000 0000 0000 0001 议标签0x0001的查询包导向1号端口；</p>
    <p>[1414]	#"100 0000 0000 0000 0010 议标签0x0002的查询包导向2号端口；</p>
    <p>[1415]	#"100 0000 0000 0000 0011 议标签0x0003的查询包导向3号端口；</p>
    <p>[1416]	下一个城域协议标签为0x0004</p>
    <p>[1417]	4、MS-1000 服务器发头部信息为 0x9000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000,0x9000 0x00000x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0001,0x9000 0x0000 0x0000 0x0000 0x0000 0x0000</p>
    <p>” =&gt;‘‘0 0001 0000	0000 0000 0000”，即城域协</p>
    <p>” =&gt;‘‘0 0010 0000	0000 0000 0001”，即城域协</p>
    <p>” =&gt;‘‘0 0100 0000	0000 0000 0010”，即城域协</p>
    <p>” =&gt;‘‘0 1000 0000	0000 0000 0011”，即城域协</p>
    <p>1230x0000 0x0000 0x00000x0000 0x0002,0x9000 0x0000 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0003的端口查询包，由于包根据标签交换，所以即使DA</p>
    <p>相同也无所谓。根据4号表配置端口查询包会依次导向0到3号端口；</p>
    <p>[1418]	标签信息表的第0x0000项被配置成如下：</p>
    <p>[1419]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1420]	&#8226;标签描述符：不做修改；</p>
    <p>[1421]	&#8226;标签路由描述信息：0x0000 (上一跳交换机的城域网地址即MS-1000的城域网 地址)，0x0000 (MS-1000 的 0 号端口）。</p>
    <p>[1422]	标签信息表的第0x0001项被配置成如下：</p>
    <p>[1423]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1424]	&#8226;标签描述符：不做修改；</p>
    <p>[1425]	&#8226;标签路由描述信息：0x0000 (上一跳交换机的城域网地址即MS-1000的城域网 地址)，0x0001 (MS-1000 的 1 号端口）。</p>
    <p>[1426]	标签信息表的第0x0002项被配置成如下：</p>
    <p>[1427]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1428]	&#8226;标签描述符：不做修改；</p>
    <p>[1429]	&#8226;标签路由描述信息：0x0000 (上一跳交换机的城域网地址即MS-1000的城域网 地址)，0x0002 (MS-1000 的 2 号端 口 )。</p>
    <p>[1430]	标签信息表的第0x0003项被配置成如下：</p>
    <p>[1431]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1432]	&#8226;标签描述符：不做修改；</p>
    <p>[1433]	&#8226;标签路由描述信息：0x0000 (上一跳交换机的城域网地址即MS-1000的城域网 地址)，0x0003 (MS-1000 的 3 号端 口 )。</p>
    <p>[1434]	下一个可用标签为0x0004 ；</p>
    <p>[1435]	5、MX-4-0交换机上电后初始化硬件，</p>
    <p>[1436]	&#8226;配置 4 号表为 “1 0000 0000 0000 0000 0000” 到 “1 0000 1111 11111111 1111”，即所有城域查询标签包导向CPU ；</p>
    <p>[1437]	&#8226;配置 5 号表为 “0 0000 0000 0000 0000 0000” 到 “0 0000 1111 11111111 1111”，即所有的城域应答标签包传送关闭；</p>
    <p>[1438]	&#8226;配置6号、7号表为“0 0000 0000 0000 0000 0000”，即所有单组播数据包传送</p>
    <p>关闭；</p>
    <p>[1439]	6、根据拓扑图MX-4-0交换机2号端口收到城域协议标签0x0000的查询包，则</p>
    <p>[1440]	&#8226;配置 5 号表“101 0000 0000 0000 0000”=&gt;“0 0100 0000 0000 00000000”， 即城域协议标签0x0000的应答包导向2号端口 ；</p>
    <p>[1441]	根据拓扑图MX-4-0交换机3号端口收到城域协议标签0x0001的查询包，则</p>
    <p>[1442]	&#8226;配置 5 号表“101 0000 0000 0000 0001"= &gt;"0 1000 0000 0000 00000000”， 即城域协议标签0x0001的应答包导向3号端口 ；</p>
    <p>[1443]	发送2个应答包（应答中包含本交换机的设备类型、设备标识以及收到该查询 包的端口号），一个包的头部为 0x0900 0x0000 0x0000 0x00000x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000，同时在包中标明收到该查询包的端口号为2号；</p>
    <p>[1444]另一个包的头部	0x0900 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000 0x0001，同时在包中标明收到该查询包的端口号为3号；</p>
    <p>[1445]	7、MS-1000服务器0号端口收到城域协议标签0x0000的查询应答包后，</p>
    <p>[1446]	1)根据应答包中的设备类型知道是节点交换机，把应答包中的设备标识与节点交 换机的设备信息表中的设备标识项逐一比对，直到完全相同表明此设备已注册，检查设备 状态项为0x0000，知道此设备未入网；</p>
    <p>[1447]	2)根据应答包中的城域协议标签0x0000查城域协议标签信息表的第0x0000项， 知道上一跳交换机是MS-1000服务器（地址为0x0000)、端口号是0号；</p>
    <p>[1448]	3)根据应答包PDU中第5字段号（标明收到查询包的交换机端口号）MS_1000服 务器知道0号端口下接了一台交换机的2号端口。</p>
    <p>[1449]	发送入网命令（告诉交换机的城域网地址为0x0001)，包的头部为0x9000 0x0000 0x0001 0x0000 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0000 ；</p>
    <p>[1450]	地址信息表的第0x0001被配置成如下：</p>
    <p>[1451]	&#8226;地址占用描述符：0x0001表示此地址待用（城域服务器用此地址发出了入网命 令包，但未收到入网命令应答）；</p>
    <p>[1452]	&#8226;设备描述符：不做修改；</p>
    <p>[1453]	&#8226;设备资源描述信息：不做修改；</p>
    <p>[1454]	对应的设备信息表的表项被配置成如下：</p>
    <p>[1455]	&#8226;设备标识：不做修改；</p>
    <p>[1456]	&#8226;设备状态：0x0001表示此设备待入网（城域服务器发出了入网命令包，但未收 到入网命令应答）；</p>
    <p>[1457]	&#8226;设备地址：0x0001 ；</p>
    <p>[1458]	8、MS-1000服务器1号端口收到城域协议标签0x0001的查询应答包后，</p>
    <p>[1459]	1)根据应答包中的设备类型知道是节点交换机，把应答包中的设备标识与节点交 换机的设备信息表中的设备标识项逐一比对，直到完全相同表明此设备已注册，检查设备 状态项为0x0001，知道此设备待入网；</p>
    <p>[1460]	2)根据应答包中的城域协议标签0x0001查城域协议标签信息表的第0x0001项， 知道上一跳交换机是MS-1000服务器（地址为0x0000)、端口号是1号；</p>
    <p>[1461]	3)根据应答包PDU中第5字段号（标明收到查询包的交换机端口号）MS_1000服 务器知道1号端口下接了一台交换机的3号端口。</p>
    <p>[1462]	发送入网命令（告诉交换机的城域网地址为0x0001)，包的头部为0x9000 0x0000 0x0001 0x0000 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0001 ；</p>
    <p> 1463]	地址信息表的第0x0001被配置成如下：</p>
    <p>[1464]	&#8226;地址占用描述符：0x0001表示此地址待用（城域服务器用此地址发出了入网命 令包，但未收到入网命令应答）；</p>
    <p>[1465]	&#8226;设备描述符：不做修改；</p>
    <p>[1466]	&#8226;设备资源描述信息：不做修改；</p>
    <p>[1467]	对应的设备信息表的表项被配置成如下：[1468]	&#8226;设备标识：不做修改；</p>
    <p>[1469]	&#8226;设备状态：0x0001表示此设备待入网（城域服务器发出了入网命令包，但未收 到入网命令应答）；</p>
    <p>[1470]	&#8226;设备地址：0x0001 ；</p>
    <p>[1471]	9、MX-4-0交换机2号端口收到城域协议标签0x0000的入网命令包（包的头部为 0x9000 0x0000 0x0001 0x0000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000) 后，比对其中的设备类型、设备标识，知道自己的城域网地址是0x0001就入网了，同时 向服务器发送入网命令应答，包的头部分别为0x0900 0x0000 0x0000 0x0000 0x0000 0x00000x0001 0x0000 0x0000 0x0000 0x0000 ；</p>
    <p>[1472]	10、MX-4-0交换机3号端口收到城域协议标签0x0001的入网命令包（包的 头部为 0x9000 0x0000 0x0001 0x0000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0001)后，比对其中的设备类型、设备标识，知道自己的城域网地址是0x0001就入网了， 同时向服务器发送入网命令应答，包的头部分别为0x0900 0x0000 0x0000 0x0000 0x0000 0x00000x0001 0x0000 0x0000 0x0000 0x0001 ；</p>
    <p>[1473]	11,MS-1000服务器0号端口收到城域协议标签0x0000的入网命令应答包后，</p>
    <p>[1474]	1)根据入网命令应答包中的城域协议标签0x0000，检查标签信息表的第0x0000 项的标签路由描述信息知道该交换机的知道上一跳交换机是MS-1000服务器（地址为 0x0000)、端口号是0号。</p>
    <p>[1475]	2)根据入网命令应答包PDU中第9字段号（标明收到查询包的交换机端口号） MS-1000服务器知道0号端口下接了一台交换机的2号端口；</p>
    <p>[1476]	3)根据入网命令应答包中的城域地址0x0001，知道该交换机的城域地址是 0x0001。</p>
    <p>[1477]	综合1)、2)、3)，可知MX-4-0交换机已经入网了。</p>
    <p>[1478]	地址信息表的第0x0001被配置成如下：</p>
    <p>[1479]	&#8226;地址占用描述符：0x0002表示此地址已用；</p>
    <p>[1480]	&#8226;设备描述符：0x0001表示其中一种节点交换机MX-4-0 ；</p>
    <p>[1481]	&#8226;设备资源描述信息：4个千兆光口依次定义为0号端口到3号端口，CPU模块接 口定义为4号端口 ；它的2号端口接了一台城域地址0x0000的MS-1000的0号端口，其它 的网络端口连接的设备的城域网地址未知，它的各个网络端口的上下行流量计数为0</p>
    <p>[1482]	标签信息表的第0x0000项被配置成如下：</p>
    <p>[1483]	&#8226;标签占用描述符：0x0002表示此标签已用；</p>
    <p>[1484]	&#8226;标签描述符：0x0000 ；</p>
    <p>[1485]	&#8226;标签路由描述信息：0x0000 (上一跳交换机的城域网地址即MS-1000的城域网 地址)，0x0000 (MS-1000 的 0 号端口）。</p>
    <p>[1486]	对应的设备信息表的表项被配置成如下：</p>
    <p>[1487]	&#8226;设备标识：不做修改；</p>
    <p>[1488]	&#8226;设备状态：0x0002表示此设备已入网（城域服务器发出了入网命令包，并收到 入网命令应答）；</p>
    <p>[1489]	&#8226;设备地址：0x0001。</p>
    <p>126[1490]	城域地址信息表的第0x0000项被配置成如下：</p>
    <p>[1491]	&#8226;地址占用描述符：不做修改；</p>
    <p>[1492]	&#8226;设备描述符：不做修改；</p>
    <p>[1493]	&#8226;设备资源描述信息：此城域服务器有4个千兆光口依次定义为0号端口到3号 端口，CPU模块接口定义为4号端口，此节点服务器型号为MS-1000，它的0号端口接了一台 城域地址0x0001的MX-4-0的2号端口，其它的网络端口连接的设备的城域网地址未分配， 它的各个网络端口的上下行流量计数为0 ；</p>
    <p>[1494]	以后会定时（如每秒）向端口 0发设备状态查询指令，如果MS-1000服务器在一 定时间内（如6秒）没有收到状态查询应答，就不再发送设备状态查询指令，继续向端口 0 发送查询包。</p>
    <p>[1495]	12、MS-1000服务器1号端口收到城域协议标签0x0001的入网命令应答包后，</p>
    <p>[1496]	1)根据入网命令应答包中的城域协议标签0x0001，检查标签信息表的第0x0001 项的标签路由描述信息知道该交换机的知道上一跳交换机是MS-1000服务器（地址为 0x0000)、端口号是1号；</p>
    <p>[1497]	2)根据入网命令应答包PDU中第9字段号（标明收到查询包的交换机端口号） MS-1000服务器知道1号端口下接了一台交换机的3号端口。</p>
    <p>[1498]	3)根据入网命令应答包中的城域地址0x0001，知道该交换机的城域地址是 0x0001。</p>
    <p>[1499]	综合1)、2)、3)，可知MX-4-0交换机已经入网了。</p>
    <p>[1500]	地址信息表的第0x0001被配置成如下：</p>
    <p>[1501]	&#8226;地址占用描述符：0x0002表示此地址已用；</p>
    <p>[1502]	&#8226;设备描述符：0x0001表示其中一种节点交换机MX-4-0 ；</p>
    <p>[1503]	&#8226;设备资源描述信息：4个千兆光口依次定义为0号端口到3号端口，CPU模块接 口定义为4号端口 ；它的2号端口接了一台城域地址0x0000的MS-1000的0号端口，它的 3号端口接了一台城域地址0x0000的MS-1000的1号端口，其它的网络端口连接的设备的 城域网地址未知，它的各个网络端口的上下行流量计数为0。</p>
    <p>[1504]	标签信息表的第0x0001项被配置成如下：</p>
    <p>[1505]	&#8226;标签占用描述符：0x0002表示此标签已用；</p>
    <p>[1506]	&#8226;标签描述符：0x0001 ；</p>
    <p>[1507]	&#8226;标签路由描述信息：0x0000 (上一跳交换机的城域网地址即MS-1000的城域网 地址)，0x0001 (MS-1000 的 0 号端口）。</p>
    <p>[1508]	对应的设备信息表的表项被配置成如下：</p>
    <p>[1509]	&#8226;设备标识：不做修改；</p>
    <p>[1510]	&#8226;设备状态：0x0002表示此设备已入网（城域服务器发出了入网命令包，并收到 入网命令应答）；</p>
    <p>[1511]	&#8226;设备地址：0x0001。</p>
    <p>[1512]	城域地址信息表的第0x0000项被配置成如下：</p>
    <p>[1513]	&#8226;地址占用描述符：不做修改；</p>
    <p>[1514]	&#8226;设备描述符：不做修改；[1515]  。设备资源描述信息：此城域服务器有4个干兆光口依次定义为0号端口到3号端口，CPU模块接口定义为4号端口，此节点服务器型号为MS一1000，它的0号端口接了一台城域地址Ox000l的MX一4&#8212;0的2号端口，l号端口接了一台城域地址Ox000l的MX一4&#8212;0的3号端口，其它的网络端口连接的设备的城域网地址未分配，它的各个网络端口的上下行流量计数为0；[1516]  以后会定时(如每秒)向端口l发设备状态查询指令，如果MS一1000服务器在一定时间内(如6秒)没有收到状态查询应答，就不再发送设备状态查询指令，继续向端口l发送查询包。[1517]  131MS一1000服务器知道它的0号端口接了城域地址Ox000l的MX一4&#8212;0的2号端口，l号端口接了MX一4&#8212;0的3号端口，MX一4&#8212;0的0号1l号端口未知，下一个城域协议标签为Ox0004。所以它配置4个4号表的表项分别为[1518]  。“100 0000 0000 0000 0100”一&gt;“0 000l 0000 0000 0000 0100”，即城域协议标签Ox0004的查询包导向0号端口；[1519]  。“100 0000 0000 0000 010l”一&gt;“0 000l 0000 0000 0000 010l”，即城域协议标签Ox0005的查询包导向0号端口；[1520]  。“100 0000 0000 0000 0110”一&gt;“0 0010 0000 0000 0000 0110”，即城域协议标签Ox0006的查询包导向l号端口；[1521]  。“100 0000 0000 0000 011l”一&gt;“0 0010 0000 0000 0000 011l”，即城域协议标签Ox0007的查询包导向l号端口；[1522]  下一个城域协议标签为Ox0008。[1523]  MS一1000通过使用标签Ox0000或Ox000l发包通知MX一4&#8212;0，配置MX一4&#8212;0 4号表的表项：[1524]  。“100 0000 0000 0000 0100”一&gt;“0 000l 0000 0000 0000 0100”，，即城域协议标签Ox0004查询包导向0号端口；[1525]  。“100 0000 0000 0000 010l”一&gt;“0 0010 0000 0000 0000 010l”，，即城域协议标签Ox0005查询包导向l号端口；[1526]  。“100 0000 0000 0000 0110”一&gt;“0 000l 0000 0000 0000 0110”，，即城域协议标签Ox0006查询包导向0号端口；[1527]  。“100 0000 0000 0000 011l”一&gt;“0 0010 0000 0000 0000 011l”，，即城域协议标签Ox0007查询包导向l号端口；[1528]  配置MX一4&#8212;0 5号表的表项：[1529]  。“10l 0000 0000 0000 0100”一&gt;“0 0100 0000 0000 0000 0100”，，即城域协议标签Ox0004应答包导向2号端口；[1530]  。“10l 0000 0000 0000 010l”一&gt;“0 0100 0000 0000 0000 010l”，，即城域协议标签Ox0005应答包导向2号端口；[1531]  。“lol 0000 0000 0000 0110”一&gt;“0 1000 0000 0000 0000 0110”，，即城域协议标签Ox0006应答包导向3号端口；[1532]  。“10l 0000 0000 0000 011l”一&gt;“0 1000 0000 0000 0000 011l”，，即城域协议标签Ox0007应答包导向3号端口；[1533]	14、MS-1000 服务器发头部信息为 0x9000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0004,0x9000 0x00000x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0005,0x9000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0006,0x9000 0x0000 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0007的端口查询包，由于包根据标签交换，所以即使DA 相同也无所谓。根据O号表配置，标签0X0004、0X0005查询包会依次导向0号端口，标签 0x0006、0x0007查询包会依次导向1号端口 ；</p>
    <p>[1534]	标签信息表的第0x0004项被配置成如下：</p>
    <p>[1535]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1536]	&#8226;标签描述符：不做修改；</p>
    <p>[1537]	&#8226;标签路由描述信息：0x0001 (上一跳交换机的城域网地址即MX-4-0的城域网地 址)，0x0000 (MX-4-0 的 0 号端 口 )。</p>
    <p>[1538]	标签信息表的第0x0005项被配置成如下：</p>
    <p>[1539]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1540]	&#8226;标签描述符：不做修改；</p>
    <p>[1541]	&#8226;标签路由描述信息：0x0001 (上一跳交换机的城域网地址即MX-4-0的城域网地 址)，0x0001 (MX-4-0 的 1 号端 口 )。</p>
    <p>[1542]	标签信息表的第0x0006项被配置成如下：</p>
    <p>[1543]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1544]	&#8226;标签描述符：不做修改；</p>
    <p>[1545]	&#8226;标签路由描述信息：0x0001 (上一跳交换机的城域网地址即MX-4-0的城域网地 址)，0x0000 (MX-4-0 的 0 号端 口 )。</p>
    <p>[1546]	标签信息表的第0x0007项被配置成如下：</p>
    <p>[1547]	&#8226;标签占用描述符：0x0001表示此标签待用；</p>
    <p>[1548]	&#8226;标签描述符：不做修改；</p>
    <p>[1549]	&#8226;标签路由描述信息：0x0001 (上一跳交换机的城域网地址即MX-4-0的城域网地 址)，0x0001 (MS-1000 的 1 号端 口 )。</p>
    <p>[1550]	下一个可用标签为0x0008 ；</p>
    <p>[1551]	15、MSS-400-0、MSS-400-l交换机上电后初始化硬件，由于节点服务器是标签的发 起端或终结端，因此无需替换标签；</p>
    <p>[1552]	&#8226;配置4号表为“001 0000 0000 “，即所有城域查询标签包导向CPU ；</p>
    <p>[1553]	&#8226;配置5号表为“100 0000 0000”，即所有的城域应答标签包导向10号端口（即 上行千兆光口）；</p>
    <p>[1554]	&#8226;配置6号、7号表为“000 0000 0000 “，即所有单组播数据包传送关闭；</p>
    <p>[1555]	16、根据拓扑图MSS-400-0交换机10号端口收到城域协议标签0x0004、0x0006的 查询包，则：</p>
    <p>[1556]	发送2个应答包（应答中包含本交换机的设备类型、设备标识以及收到该查询 包的端口号），一个包的头部为 0x0900 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0004，同时在包中标明收到该查询包的端口号为10号；[1557]另一个包的头部	0x0900 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000 0x0006，同时在包中标明收到该查询包的端口号为10号；</p>
    <p>[1558]	17、根据拓扑图MSS-400-1交换机10号端口收到城域协议标签0x0005、0x0007的 查询包，则：</p>
    <p>[1559]	发送2个应答包（应答中包含本交换机的设备类型、设备标识以及收到该查询 包的端口号），一个包的头部为 0x0900 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0005，同时在包中标明收到该查询包的端口号为10号；</p>
    <p>[1560]另一个包的头部	0x0900 0x0000 0x0000 0x0000 0x0000 0x00000x0000 0x0000 0x0000 0x0000 0x0007，同时在包中标明收到该查询包的端口号为10号；</p>
    <p>[1561]	18、同样重复 7、8、9、10、11、12，这 2 台 MSS-400 也入网了。</p>
    <p>[1562]	4. 2城域网的服务流程</p>
    <p>[1563]	如图15所示，假设此城域服务器有4个千兆光口，1个CPU模块接口。如果4个 千兆光口依次定义为0号端口到3号端口，CPU模块接口定义为4号端口，此城域服务器 型号为MS-1000，MS-1000的0号端口、1号端口分别接了 1台MX-4-0 2号端口、3号端口， MX-4-0的0号端口接了 1台MSS-400-0，1号端口接了 1台MSS-400-1 (如上图)。</p>
    <p>[1564]	STB_0接在MSS-400-0的0号端口，STB_1接在MSS_400_1的1号端口，它们入网后 的地址是 STB_0 (0x0000 0x0000 0x0002 x0009)、STB_1 (0x0000 0x0000 0x0003 0x0012)， MX-4-0的城域网地址是0x0001 ；MX-4-0和MSS-1000的城域协议标签0x0000、0x0001 ； MSS-400-0 和 MSS-1000 的城域协议标签 0x0005,0x0007,MSS-400-1 和 MSS-1000 的城域协 议标签 0x0006、0x0008。</p>
    <p>[1565]	4.2.1 服务建立流程</p>
    <p>[1566]	STB_0向MSS-400-0发出申请和STB_1进行可视通信，步骤如下：</p>
    <p>[1567]	1、STB_0 发出服务申请指令包，包的 DA 0x0800 0x0000 0x00020x0000、SA 0x0000 0x0000 0x0002 0x0009, reserved 0x0000，PDU 部分见附录，服务参数是 SERVICE&#8212; TYPE_TELEPHONE_REQUEST 或 SERVICE_TYPE_TELEPHONE_DIRECT。</p>
    <p>[1568]	2、服务申请指令包根据1号表的配置导向MSS-400-0，MSS-400-0根据包的内容判 断收到可视通信的申请；根据SA知道是STB_0，(假设可视电话的带宽是上下行6Mbit/s， STB_0和MSS-400-0的上下行带宽还剩80Mbit/s)，检查STB_0和MSS-400-0的上下行带宽 发现满足服务要求，则继续跳转至4，否则跳转至3。</p>
    <p>[1569]	3、MSS-400-0发送菜单给主叫STB_0，表示服务拒绝；</p>
    <p>[1570]发向	STB_0:包的 DA 0x8000 0x0000 0x0002 0x0009、SA 0x00000x0000 0x0002 0x0000、reserved 0x0000, PDU部分见附录菜单数据格式。</p>
    <p>[1571]	4、MSS-400-0根据被叫号码查CAM表（内容-地址映射表）知道被叫不在自己 的接入网，所以MSS-400-0向城域服务器MSS-1000发出服务申请指令包，包的DA 0x0900 0x0000 0x0000 0x0000, SA 0x00000x0000 0x0002 0x0009, reserved 0x0000，协议标签是 0x0005 (PDU部分见“五、城域网入网流程的数据格式定义”），服务参数是SERVICE_TYPE_ TELEPHONE_REQUEST 或 SERVICE_TYPE_TELEPHONE_DIRECT。</p>
    <p>[1572]	5、 MSS-1000收到MSS-400-0的服务申请包根据根据包的内容判断收到可视通 信的申请；根据SA知道是MSS-400-0下的终端，（假设MX-4-0和MSS-400-0的上下行带根据被叫号码查CAM表（内容-地址映射表）知道被叫在MSS-400-1 的接入网下（假设MX-4-0和MSS-400-1的上下行带宽还剩800Mbit/s)，检查MX-4-0和 MSS-400-0、MSS-400-l的上下行带宽发现满足服务要求，则继续跳转至7，否则跳转至6。</p>
    <p>[1573]	6、MSS-1000 发送服务拒绝包给 MSS-400-0。包的 DA 0x90000x0000 0x0002 0x0009、SA 0x0000 0x0000 0x0000 0x0000、reservedOxOOOO，协议标签是 0x0005，PDU 部 分忽略，MSS-400-0收到此服务拒绝包则跳转至3。</p>
    <p>[1574]	7、MSS_1000向MSS-400-1发出服务申请包，发出服务申请指令包，包的DA 0x9000 0x0000 0x0003 0x0012、SA 0x0000 0x0000 0x00000x0000, reserved 0x0000，协议标签是 0x0006, (PDU部分见“五、城域网入网流程的数据格式定义”），服务参数是SERVICE_TYPE_ TELEPH0NE_REQUEST 或 SERVICE_TYPE_TELEPHONE_DIRECT。</p>
    <p>[1575]	8、MSS-400_1收到MSS-1000的服务申请包，根据根据包的内容判断收到可视通信 的申请；根据被叫号码查CAM表（内容-地址映射表）知道被叫是STB_1 (假设STB_1和 MSS-400-1的上下行带宽还剩80Mbit/s)，检查STB_1和MSS-400-1的上下行带宽发现满足 服务要求，则继续跳转至10，否则跳转至9。</p>
    <p>[1576]	9、MSS-1000收到此服务拒绝包则跳转至6。</p>
    <p>[1577]	10、MSS-400-1分别发送菜单被叫，等待被叫应答；</p>
    <p>[1578]发向	STB_1:包的 DA 0x8000 0x0000 0x0003 0x0012、SA 0x00000x0000 0x0003 0x0000、reserved 0x0000, PDU部分见附录菜单数据格式。</p>
    <p>[1579]	11、STB_1收到菜单，发出申请SERVICE_TYPE_PERMISSION接受通信，包的DA 0x0800 0x0000 0x0003 0x0000、SA 0x0000 0x00000x0003 0x0012、reserved 0x0000, (PDU部分见“五、城域网入网流程的数据格式定义”），服务参数是SERVI CE_TYPE_ PERMISSION。</p>
    <p>[1580]	12、MSS-400-l收到STB_1的应答包，发送服务允许包给MSS-1000，包的DA 0x9000 0x0000 0x0000 0x0000、SA 0x0000 0x0000 0x00030x0000, reserved 0x0000，协议标签是 0x0006, PDU部分忽略。</p>
    <p>[1581]	13、MSS-1000收到服务允许包，则分配单播标签（假设MSS-400-0到MSS-400-1的 入标签、出标签为0x0000，MSS-400-1到MSS-400-0的入标签、出标签为0x0001)；</p>
    <p>[1582]	&#183; MSS-1000 向 MX-4-0 发标签分配包，包的 DA 0x9000 0x00000x0001 0x0000,SA 0x0000 0x0000 0x0000 0x0000, reserved 0x0000，协议标签是 0x0000，PDU 部分包含入标</p>
    <p>签、出标签及导向端口 ；</p>
    <p>[1583]	^mSS-IOOO 向 MSS-400-0 发标签分配包，包的 DA 0x9000 0x00000x0002 0x0000、 SA 0x0000 0x0000 0x0000 0x0000, reserved 0x0000，协议标签是 0x0005，PDU 部分包含</p>
    <p>入标签、出标签及导向端口，还包含DA、SA和标签的绑定；</p>
    <p>[1584]	&#183; MSS-1000 向 MSS-400-1 发标签分配包，包的 DA 0x9000 0x00000x0003 0x0000、SA 0x0000 0x0000 0x0000 0x0000, reserved 0x0000，协议标签是 0x0006，PDU 部</p>
    <p>分包含入标签、出标签及导向端口，还包含DA、SA和标签的绑定；</p>
    <p>[1585]	14、MX-4-0收到标签分配包更新其6号表，第0x0000项为：出标签为0x0000，导向 端口为1号端口 ；第0x0001项为：出标签为0x0001，导向端口为0号端口。</p>
    <p>[1586]	15、MSS-400-0收到标签分配包更新其DA、SA和标签绑定的CAM表（地址-标签绑</p>
    <p>131定表），即此CAM表的第 0x0000项为：DA 0x10000x0000 0x0003 0x0012 SA 0x0000 0x0000 0x0002 0x0009 ；</p>
    <p>[1587]	更新其6号表，第0x0000项为：出标签为0x0000，导向端口为10号端口 ；</p>
    <p>[1588]	MSS-400-0配置自己的2号表如下：</p>
    <p>[1589]	&#21443;“10 0000 0000 0000 1001" = &gt;"000 0000 0001”，即目的地址（DA)是 0x1000 0x0000 0x0002 0x0009的单播数据包导向0号端口 ；</p>
    <p>[1590]	向STB-O发编解码命令包：</p>
    <p>[1591]包的	DA 0x8000 0x0000 0x0002 0x0009、 SA 0x0000 0x0000 0x00020x0000、 reserved 0x0000，PDU部分见编解码命令。</p>
    <p>[1592]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1593]	16、MSS-400_1收到标签分配包更新其DA、SA和标签绑定的CAM表，即此CAM表的 第 0x0001 项为:DA 0x1000 0x0000 0x0002 0x0009SA 0x0000 0x0000 0x0003 0x0012 ；</p>
    <p>[1594]	更新其6号表，第0x0001项为：出标签为0x0001，导向端口为10号端口 ；</p>
    <p>[1595]	MSS-400-1配置自己的2号表如下：</p>
    <p>[1596]	#"10 0000 0000 0001 0010" = &gt;"000 0000 0010”，即目的地址(DA)是 0x1000 0x0000 0x0003 0x0012的单播数据包导向1号端口 ；[1597]	向STB-I发编解码命令包：</p>
    <p>[1598]包的	DA 0x8000 0x0000 0x0003 0x0012、 SA 0x0000 0x0000 0x00030x0000、 reserved 0x0000，PDU部分见编解码命令。</p>
    <p>[1599]</p>
    <span class="patent-image-not-available"> </span>
    <p>[1600]	根据0号表，后面编解码命令包会分别导向STB-0、STB_1。STB_0、STB_1根据包的 内容开始编解码，并接收、发送单播数据。</p>
    <p>[1601]	4.2.2服务通信流程</p>
    <p>[1602]	1) STB-O 发向 STB-I 的包的 DA 是 0x1000 0x0000 0x0003 0x0012SA 是 0x0000 0x0000 0x0002 0x0009 ；</p>
    <p>[1603]	2)包进入MSS-400-0，MSS-400-0的交换引擎检查DA的城域网地址发现不是本接 入网的，则查DA、SA和标签绑定的CAM表，获得单播标签0x0000，再查6号表的第0x0000 项获得出标签0x0000，导向端口是10号端口，在10号端口的发送端添加标签0x0000，即包 的头部为 0x1000 0x0000 0x0003 0x0012 0x0000 0x0000 0x0002 0x0009 0x00000x0000 0x0000 ；</p>
    <p>[1604]	3)包进入MX-4-0，MX_4_0的交换引擎根据组合地址域查表，查的是6号表，即表 的地址是“110 0000 0000 0000 0000”，根据MX-4-0的6号表的配置单播标签为0x0000的单播标签数据包导向1号端口，出标签为0x0000，，即包的头部为0x1000 0x0000 0x0003 0x0012 0x00000x0000 0x0002 0x0009 0x0000 0x0000 0x0000 ；</p>
    <p>[1605]	4)包进入MSS-400-1的10号端口的接收模块则去掉标签进入交换引擎， MSS-400-1的交换引擎根据组合地址域查表，查的是2号表，即表的地址是“10 0000 0000 0001 0010”，根据MSS-400-1的2号表的配置，知道该表项的输出是“00 0000 0010”表示 打开下行1号端口，所以包进入了 STB-I ；</p>
    <p>[1606]	5)同样STB-I 发向 STB-O 的包的DA是0x1000 0x0000 0x00020x0009 SA是0x0000 0x0000 0x0003 0x0012 ；</p>
    <p>[1607]	6)包进入MSS-400-1 ,MSS-400-1的交换引擎检查DA的城域网地址发现不是本接 入网的，则查DA、SA和标签绑定的CAM表，获得单播标签0x0001，再查6号表的第0x0001 项获得出标签0x0001，导向端口是10号端口，在10号端口的发送端添加标签0x0001，即包 的头部为 0x1000 0x0000 0x0002 0x0009 0x0000 0x0000 0x0003 0x0012 0x00000x0000 0x0001 ；</p>
    <p>[1608]	7)包进入MX-4-0，MX_4_0的交换引擎根据组合地址域查表，查的是6号表，即表 的地址是“110 0000 0000 0000 0001”，根据MX-4-0的6号表的配置单播标签为0x0001 的单播标签数据包导向0号端口，出标签为0x0001，，即包的头部为0x1000 0x0000 0x0002 0x0009 0x00000x0000 0x0003 0x0012 0x0000 0x0000 0x0001 ；</p>
    <p>[1609]	8)包进入MSS-400-0的10号端口的接收模块则去掉标签进入交换引擎， MSS-400-0的交换引擎根据组合地址域查表，查的是2号表，即表的地址是“10 0000 0000 0000 1001”，根据MSS-400-0的2号表的配置，知道该表项的输出是“00 0000 0001”表示 打开下行0号端口，所以包进入了 STB-O。</p>
    <p>[1610]	四、以下通过与IP互联网对比，更进一步描述本发明实施例的优点：</p>
    <p>[1611]	1、网络地址结构上根治仿冒</p>
    <p>[1612]	IP互联网的地址由用户设备告诉网络；本发明的新型网地址由网络告诉用户设 备。</p>
    <p>[1613]	为了防范他人入侵，PC和互联网设置了繁琐的口令、密码障碍。就算是实名地址， 仍无法避免密码被破译或用户稍不留神而造成的安全信息泄漏。连接到IP互联网上的PC 终端，首先必须自报家门，告诉网络自己的IP地址。然而，谁能保证这个IP地址是真是假。 这就是IP互联网第一个无法克服的安全漏洞。</p>
    <p>[1614]	本发明的新型网终端的地址是通过网管协议学来的，用户终端只能用这个学来的 地址进入本发明的新型网，因此，无需认证确保不会错。详细描述参见网管协议。本发明的 新型网创立了有序化结构“带色彩”的地址体系（D/SCAF)。本发明的新型网地址不仅具备 唯一性，同时具备可定位和可定性功能，如同个人身份证号码一样，隐含了该用户端口的地 理位置、设备性质、服务权限等其他特征。本发明的新型网交换机根据这些特征规定了分组 包的行为规则，实现不同性质的数据分流。</p>
    <p>[1615]	2、每次服务发放独立通行证，阻断黑客攻击和病毒扩散的途径；</p>
    <p>[1616]	IP互联网可以自由进出，用户自备防火墙；本发明的新型网每次服务必须申请通 行证。</p>
    <p>[1617]	由于通讯协议在用户终端执行，可能被篡改。由于路由信息在网上广播，可能被窃听。网络中的地址欺骗、匿名攻击、邮件炸弹、泪滴、隐蔽监听、端口扫描、内部入侵、涂改信 息等形形色色固有的缺陷，为黑客提供了施展空间。垃圾邮件等互联网污染难以防范。</p>
    <p>[1618]	由于IP互联网用户可以设定任意IP地址来冒充别人，可以向网上任何设备发出 探针窥探别人的信息，也可以向网络发送任意干扰数据包（泼脏水）。为此，许多聪明人发 明了各种防火墙，试图保持独善其身。但是，安装防火墙是自愿的，防火墙的效果是暂时的 和相对的，IP互联网本身永远不会干净。这是IP互联网第二项收不了场的安全败笔。</p>
    <p>[1619]	本发明的新型网用户入网后，网络交换机仅允许用户向节点服务器发出有限的服 务请求，对其他数据包一律关门。如果节点服务器批准用户申请，即向用户所在的交换机发 出网络通行证，用户终端发出的每个数据包若不符合网络交换机端的审核条件一律丢弃， 彻底杜绝黑客攻击。每次服务结束后，自动撤销通行证。通行证机制由交换机执行，不在用 户可控制的范围内：</p>
    <p>[1620]	审核用户数据包的源地址：防止用户发送任何假冒或匿名数据包（入网后自动设 定）</p>
    <p>[1621]	审核目标地址：用户只能发送数据包到服务器指定的对象（服务申请时确定）</p>
    <p>[1622]	审核数据流量：用户发送数据流量必须符合服务器规定（服务申请时确定）</p>
    <p>[1623]	审核版权标识：防止用户转发从网上下载的有版权内容（内容供应商设定）</p>
    <p>[1624]	本发明的新型网不需要防火墙、杀毒、加密、内外网隔离等消极手段，本发明的新 型网从结构上彻底阻断了黑客攻击和病毒扩散的途径，是本质上可以高枕无忧的安全网</p>
    <p>[1625]	3、网络设备与用户数据完全隔离，切断病毒和木马的生命线；</p>
    <p>[1626]	IP互联网设备可随意拆解用户数据包；本发明的新型网设备与用户数据完全隔 离。即在数据传输中，新型网设备（例如，交换机、网关等）对用户数据包并不进行拆解，而 是直接依据数据包的地址，查找映射表，将其从相应端口转发即可。即本发明的交换机并不 存在自己计算和选择路由的功能。</p>
    <p>[1627]	冯&#183;诺依曼创造的电脑将程序指令和操作数据放在同一个地方，也就是说一段程 序可以修改机器中的其他程序和数据。沿用至今的这一电脑模式，给特洛伊木马，蠕虫，病 毒，后门等留下了可乘之机。随着病毒的高速积累，防毒软件和补丁永远慢一拍，处于被动 状态。</p>
    <p>[1628]	互联网TCP/IP协议的技术核心是尽力而为、储存转发、检错重发。为了实现互联 网的使命，网络服务器和路由器必须具备解析用户数据包的能力，这就为黑客病毒留了活 路，网络安全从此成了比谁聪明的角力，永无安宁。这是IP互联网第三项遗传性缺陷。</p>
    <p>[1629]	本发明的新型网上所有的服务器和交换机设备中的CPU都不可能接触到任意一 个用户数据包。也就是说，整个本发明的新型网只是为业务提供方和接收方的终端设备之 间，建立一条完全隔离和流量行为规范的透明管道。用户终端不管收发什么数据，一概与网 络无关。从结构上切断了病毒和木马的生命线。因此，本发明的新型网杜绝网络上的无关 人员窃取用户数据的可能，同理，那些想当黑客或制毒的人根本就没有可供攻击的对象。</p>
    <p>[1630]	4、用户之间的自由连接完全隔离，确保有效管理：</p>
    <p>[1631]	IP互联网是自由市场，无中间人；本发明的新型网是百货公司，有中间人。对于网 络来说，消费者与内容供应商都属于网络用户范畴，只是大小不同而已。IP互联网是个无管理的自由市场，任意用户之间可以直接通讯（P2P)。也就是说，要不要管理是用户说了算， 要不要收费是单方大用户（供应商）说了算，要不要遵守法规也是单方大用户（吸血鬼网 站）说了算。运营商至多收个入场费，要想执行法律、道德、安全和商业规矩只能是天方夜 谭，现在和将来都不可能。这是IP互联网第四项架构上的残疾。</p>
    <p>[1632]	本发明的新型网创造了服务节点概念，形成有管理的百货公司商业模式。用户之 间，或者消费者与供货商之间，绝对不可能有任何自由接触，一切联系都必须取得节点服务 器（中间人）的批准。这是实现网络业务有效管理的必要条件。要想成为新型网的用户， 必须先与网络运营商谈判自己的角色，从普通消费者、网上商店、学校医院、政府部门、直到 电视台，都属于运营商的客户，就好像上述部门都是电话公司的客户一样。尽管看起来每个 角色无非都是收发视讯内容，但如何收发必须严格遵守各自商定的行为法则。有了不可逾 越的规范，各类用户之间的关系才能在真正意义上分成C2C、B2C、B2B等，或者统称为有管 理的用户与用户间通讯（MP2P)。</p>
    <p>[1633]	5、商业规则植入通讯协议，确保盈利模式；</p>
    <p>[1634]	IP互联网奉行先通讯，后管理模式；本发明的新型网奉行先管理，后通讯模式。</p>
    <p>[1635]	网上散布非法媒体内容，只有造成恶劣影响以后，才能在局部范围内查封，而不能 防范于未然。法律与道德不能防范有组织有计划的“职业攻击”。而且法律只能对已造成危 害的人实施处罚。IP互联网将管理定义成一种额外附加的服务，建立在应用层。因此，管理 自然成为一种可有可无的摆设。这是IP互联网第五项难移的本性。</p>
    <p>[1636]	本发明的新型网用户终端只能在节点服务器许可范围内的指定业务中，选择申请 其中之一。服务建立过程中的协议信令，由节点服务器执行（不经用户之手）。用户终端只 是被动地回答服务器的提问，接受或拒绝服务，不能参与到协议过程中。一旦用户接受服务 器提供的服务，只能按照通行证规定的方式发送数据包，任何偏离通行证规定的数据包一 律在底层交换机中丢弃。本发明的新型网协议的基本思路是实现以服务内容为核心的商业 模式，而不只是完成简单的数据交流。在这一模式下，安全是新型网的固有属性，而不是附 加在网络上的额外服务项目。当然，业务权限审核、资源确认和计费手续等，均可轻易包含 管理合同之中。</p>
    <p>[1637]	由于本发明关于一种新型网的通信系统基本相应于前述方法实施例，具体可以参 见前述方法实施例中的相关说明，在此就不赘述了。</p>
    <p>[1638]	需要说明的是，在本文中，诸如第一和第二等之类的关系术语仅仅用来将一个实 体或者操作与另一个实体或操作区分开来，而不一定要求或者暗示这些实体或操作之间存 在任何这种实际的关系或者顺序。</p>
    <p>[1639]	以上对本发明所提供的一种新型网的通信方法及一种新型网的通信系统进行了 详细介绍，本文中应用了具体个例对本发明的原理及实施方式进行了阐述，以上实施例的 说明只是用于帮助理解本发明的方法及其核心思想；同时，对于本领域的一般技术人员，依 据本发明的思想，在具体实施方式及应用范围上均会有改变之处，综上所述，本说明书内容 不应理解为对本发明的限制。</p>
  </div>
  </div></div><div class="patent-section patent-tabular-section"><a id="backward-citations"></a><div class="patent-section-header"><span class="patent-section-title">专利引用</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th">引用的专利</th><th class="patent-data-table-th"> 申请日期</th><th class="patent-data-table-th">公开日</th><th class="patent-data-table-th"> 申请人</th><th class="patent-data-table-th">专利名</th></tr></thead><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN101557303A?cl=zh">CN101557303A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2008年4月30日</td><td class="patent-data-table-td patent-date-value">2009年10月14日</td><td class="patent-data-table-td ">华为技术有限公司</td><td class="patent-data-table-td ">路径建立请求方法、路径建立方法与系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN101674221A?cl=zh">CN101674221A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2008年9月9日</td><td class="patent-data-table-td patent-date-value">2010年3月17日</td><td class="patent-data-table-td ">中国移动通信集团公司</td><td class="patent-data-table-td ">静态路由生成方法、终端路由实现方法及装置</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/US20080049621">US20080049621</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2005年12月30日</td><td class="patent-data-table-td patent-date-value">2008年2月28日</td><td class="patent-data-table-td ">Mcguire Alan</td><td class="patent-data-table-td ">Connection-Oriented Communications Scheme For Connection-Less Communications Traffic</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/WO2008058477A1?cl=zh">WO2008058477A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2007年7月27日</td><td class="patent-data-table-td patent-date-value">2008年5月22日</td><td class="patent-data-table-td ">Huawei Technologies Co., Ltd.</td><td class="patent-data-table-td ">Location information management method, apparatus and system</td></tr></table><div class="patent-section-footer">* 由审查员引用</div></div><div class="patent-section patent-tabular-section"><a id="forward-citations"></a><div class="patent-section-header"><span class="patent-section-title"> 被以下专利引用</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th">引用专利</th><th class="patent-data-table-th"> 申请日期</th><th class="patent-data-table-th">公开日</th><th class="patent-data-table-th"> 申请人</th><th class="patent-data-table-th">专利名</th></tr></thead><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102045365A?cl=zh">CN102045365A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2010年12月30日</td><td class="patent-data-table-td patent-date-value">2011年5月4日</td><td class="patent-data-table-td ">中国民航信息网络股份有限公司</td><td class="patent-data-table-td ">一种基于TCP/IP协议的eTerm连接系统及其方法</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102118316A?cl=zh">CN102118316A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年3月7日</td><td class="patent-data-table-td patent-date-value">2011年7月6日</td><td class="patent-data-table-td ">杭州华三通信技术有限公司</td><td class="patent-data-table-td ">学习mac地址的方法和设备</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102118316B?cl=zh">CN102118316B</a></td><td class="patent-data-table-td patent-date-value">2011年3月7日</td><td class="patent-data-table-td patent-date-value">2013年9月25日</td><td class="patent-data-table-td ">杭州华三通信技术有限公司</td><td class="patent-data-table-td ">学习mac地址的方法和设备</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102185864A?cl=zh">CN102185864A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年5月13日</td><td class="patent-data-table-td patent-date-value">2011年9月14日</td><td class="patent-data-table-td ">北京星网锐捷网络技术有限公司</td><td class="patent-data-table-td ">安全认证策略配置方法、装置及系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN102185864B?cl=zh">CN102185864B</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年5月13日</td><td class="patent-data-table-td patent-date-value">2014年12月24日</td><td class="patent-data-table-td ">北京星网锐捷网络技术有限公司</td><td class="patent-data-table-td ">安全认证策略配置方法、装置及系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN103493423A?cl=zh">CN103493423A</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2012年4月3日</td><td class="patent-data-table-td patent-date-value">2014年1月1日</td><td class="patent-data-table-td ">阿尔卡特朗讯</td><td class="patent-data-table-td ">用于电信系统中的dsl幻象模式信号的组合设备</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/CN103493423B?cl=zh">CN103493423B</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2012年4月3日</td><td class="patent-data-table-td patent-date-value">2016年3月9日</td><td class="patent-data-table-td ">阿尔卡特朗讯</td><td class="patent-data-table-td ">用于电信系统中的dsl幻象模式信号的组合设备</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/EP2723096A1?cl=zh">EP2723096A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2012年5月22日</td><td class="patent-data-table-td patent-date-value">2014年4月23日</td><td class="patent-data-table-td ">ZTE Corporation</td><td class="patent-data-table-td ">Method, system and media server for creating multicast channel</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/US9083656">US9083656</a></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2015年7月14日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">Service communication method and system for access network apparatus</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/US9124429">US9124429</a></td><td class="patent-data-table-td patent-date-value">2012年4月3日</td><td class="patent-data-table-td patent-date-value">2015年9月1日</td><td class="patent-data-table-td ">Alcatel Lucent</td><td class="patent-data-table-td ">Combination device for DSL phantom mode signals in a telecommunication system</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/US9219685">US9219685</a></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2015年12月22日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">Communication method and system for a novel network</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/US9253106">US9253106</a></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2016年2月2日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">Traffic-control-based data transmission method and communication system</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/WO2012016528A1?cl=zh">WO2012016528A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2012年2月9日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">一种兼容以太网的方法及系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/WO2012016529A1?cl=zh">WO2012016529A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2012年2月9日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">一种接入网设备的通信连接方法及系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/WO2012016532A1?cl=zh">WO2012016532A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2012年2月9日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">一种基于流量控制的数据传输方法及通信系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/WO2012016533A1?cl=zh">WO2012016533A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2012年2月9日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">一种新型网的通信方法及系统</td></tr><tr><td class="patent-data-table-td citation-patent"><a href="/patents/WO2012016536A1?cl=zh">WO2012016536A1</a><span class='patent-tooltip-anchor' data-tooltip-text="由审查员引用"> *</span></td><td class="patent-data-table-td patent-date-value">2011年8月4日</td><td class="patent-data-table-td patent-date-value">2012年2月9日</td><td class="patent-data-table-td ">Beijing Qiantang Network Technology Company, Ltd.</td><td class="patent-data-table-td ">一种接入网设备的服务通信方法及系统</td></tr></table><div class="patent-section-footer">* 由审查员引用</div></div><div class="patent-section patent-tabular-section"><a id="classifications"></a><div class="patent-section-header"><span class="patent-section-title">分类</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th"> </th><th class="patent-data-table-th"> </th></tr></thead><tr><td class="patent-data-table-td ">国际分类号</td><td class="patent-data-table-td "><span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://web2.wipo.int/ipcpub/&amp;usg=AFQjCNER44F5jlVoswCkvW3YEcB5lW4moA#refresh=page&amp;notion=scheme&amp;version=20130101&amp;symbol=H04L0029060000">H04L29/06</a></span>, <span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://web2.wipo.int/ipcpub/&amp;usg=AFQjCNER44F5jlVoswCkvW3YEcB5lW4moA#refresh=page&amp;notion=scheme&amp;version=20130101&amp;symbol=H04L0029120000">H04L29/12</a></span>, <span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://web2.wipo.int/ipcpub/&amp;usg=AFQjCNER44F5jlVoswCkvW3YEcB5lW4moA#refresh=page&amp;notion=scheme&amp;version=20130101&amp;symbol=H04L0012180000">H04L12/18</a></span>, <span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://web2.wipo.int/ipcpub/&amp;usg=AFQjCNER44F5jlVoswCkvW3YEcB5lW4moA#refresh=page&amp;notion=scheme&amp;version=20130101&amp;symbol=H04L0012560000">H04L12/56</a></span></td></tr><tr><td class="patent-data-table-td "> 合作分类</td><td class="patent-data-table-td "><span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://worldwide.espacenet.com/classification&amp;usg=AFQjCNGs5WqSrPE3A4ZP63zGuM6PRNfEFA#!/CPC=H04L41/0896">H04L41/0896</a></span>, <span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://worldwide.espacenet.com/classification&amp;usg=AFQjCNGs5WqSrPE3A4ZP63zGuM6PRNfEFA#!/CPC=H04L61/6022">H04L61/6022</a></span>, <span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://worldwide.espacenet.com/classification&amp;usg=AFQjCNGs5WqSrPE3A4ZP63zGuM6PRNfEFA#!/CPC=H04L12/4625">H04L12/4625</a></span>, <span class="nested-value"><a href="https://www.google.com/url?id=Ph2CBwABERAJ&amp;q=http://worldwide.espacenet.com/classification&amp;usg=AFQjCNGs5WqSrPE3A4ZP63zGuM6PRNfEFA#!/CPC=H04L45/74">H04L45/74</a></span></td></tr><tr><td class="patent-data-table-td "> 欧洲专利分类号</td><td class="patent-data-table-td "><span class="nested-value">H04L61/60D11</span></td></tr></table><div class="patent-section-footer"></div></div><div class="patent-section patent-tabular-section"><a id="legal-events"></a><div class="patent-section-header"><span class="patent-section-title">法律事件</span></div><table class="patent-data-table"><thead class="patent-data-table-thead"><tr class="patent-data-table"><th class="patent-data-table-th"> 日期</th><th class="patent-data-table-th">代码</th><th class="patent-data-table-th">事件</th><th class="patent-data-table-th">说明</th></tr></thead><tr><td class="patent-data-table-td patent-date-value">2010年12月15日</td><td class="patent-data-table-td ">C06</td><td class="patent-data-table-td ">Publication</td><td class="patent-data-table-td "></td></tr><tr><td class="patent-data-table-td patent-date-value">2011年9月14日</td><td class="patent-data-table-td ">C10</td><td class="patent-data-table-td ">Entry into substantive examination</td><td class="patent-data-table-td "></td></tr><tr><td class="patent-data-table-td patent-date-value">2013年6月5日</td><td class="patent-data-table-td ">C14</td><td class="patent-data-table-td ">Grant of patent or utility model</td><td class="patent-data-table-td "></td></tr></table><div class="patent-section-footer"></div></div><div class="modal-dialog" id="patent-images-lightbox"><div class="patent-lightbox-controls"><div class="patent-lightbox-rotate-controls"><div class="patent-lightbox-rotation-text">旋转</div><div class="rotate-icon rotate-ccw-icon"></div><div class="rotate-icon rotate-cw-icon"></div></div><div class="patent-lightbox-index-counter"></div><a class="patent-lightbox-fullsize-link" target="_blank">原始图片</a><div class="patent-drawings-control patent-drawings-next"><img class="patent-drawings-button-img"src="/googlebooks/images/kennedy/page_right.png" alt="Next page"width="21" height="21" /></div><div class="patent-drawings-control patent-drawings-prev"><img class="patent-drawings-button-img"src="/googlebooks/images/kennedy/page_left.png" alt="Previous page"width="21" height="21" /></div></div><div class="modal-dialog-content"><div class="patent-lightbox-image-holder"><div class="patent-lightbox-placeholder"></div></div></div></div><script>_OC_initPatentsAtb({image_not_available_html: " 未提供图片。\x3ca href\x3d//docs.google.com/viewer?url\x3dpatentimages.storage.googleapis.com/pdfs/d198f78df1930caeec94/CN101917492A.pdf\x3e查看 PDF\x3c/a\x3e"});</script></div></div></div></div></div><script>(function() {var href = window.location.href;if (href.indexOf('?') !== -1) {var parameters = href.split('?')[1].split('&');for (var i = 0; i < parameters.length; i++) {var param = parameters[i].split('=');if (param[0] == 'focus') {var elem = document.getElementById(param[1]);if (elem) {elem.focus();}}}}})();</script><script>_OC_addFlags({LockSrc:"/books/javascript/lock_5115ea495017d9115e613207d3810e5a.js", Host:"https://www.google.com/", IsBooksRentalEnabled:1, IsBrowsingHistoryEnabled:1, IsWebReaderSvgEnabled:0, IsImageModeNotesEnabled:1, IsOfflineBubbleEnabled:1, IsFutureOnSaleVolumesEnabled:1, IsBooksUnifiedLeftNavEnabled:1, IsMobileRequest:0, IsZipitFolderCollectionEnabled:1, IsAdsDisabled:0, IsEmbeddedMediaEnabled:1, IsImageModeAnnotationsEnabled:1, IsMyLibraryGooglePlusEnabled:1, IsImagePageProviderEnabled:1, IsBookcardListPriceSmall:0, IsInternalUser:0, IsBooksShareButtonEnabled:0, IsDisabledRandomBookshelves:0});_OC_Run({"enable_p13n":false,"is_cobrand":false,"sign_in_url":"https://www.google.com/accounts/Login?service=\u0026continue=https://www.google.com/patents%3Fcl%3Dzh%26hl%3Dzh-CN\u0026hl=zh-CN"}, {"volume_id":"","is_ebook":true,"volumeresult":{"has_flowing_text":false,"has_scanned_text":true,"can_download_pdf":false,"can_download_epub":false,"is_pdf_drm_enabled":false,"is_epub_drm_enabled":false,"download_pdf_url":"https://www.google.com/patents/download/%E4%B8%80%E7%A7%8D%E6%96%B0%E5%9E%8B%E7%BD%91%E7%9A%84%E9%80%9A%E4%BF%A1%E6%96%B9%E6%B3%95%E5%8F%8A%E7%B3%BB%E7%BB%9F.pdf?id=Ph2CBwABERAJ\u0026hl=zh-CN\u0026output=pdf\u0026sig=ACfU3U23doQ_7Jnuun6Fu_EWtFuiU-ZASg"},"sample_url":"https://www.google.com/patents/reader?id=Ph2CBwABERAJ\u0026hl=zh-CN\u0026printsec=frontcover\u0026output=reader\u0026source=gbs_atb_hover","is_browsable":true,"is_public_domain":true}, {});</script><div id="footer_table" style="font-size:83%;text-align:center;position:relative;top:20px;height:4.5em;margin-top:2em"><div style="margin-bottom:8px"><a href="https://www.google.com/search?hl=zh-CN"><nobr>Google&nbsp;首页</nobr></a> - <a href="//www.google.com/patents/sitemap/"><nobr>站点地图</nobr></a> - <a href="http://www.google.com/googlebooks/uspto.html"><nobr>美国专利商标局 (USPTO) 专利信息批量下载</nobr></a> - <a href="/intl/zh-CN/privacy/"><nobr>隐私权政策</nobr></a> - <a href="/intl/zh-CN/policies/terms/"><nobr>服务条款</nobr></a> - <a href="https://support.google.com/faqs/answer/2539193?hl=zh-CN"><nobr> 关于 Google 专利</nobr></a> - <a href="//www.google.com/tools/feedback/intl/zh-CN/error.html" onclick="try{_OC_startFeedback({productId: '72792',locale: 'zh-CN'});return false;}catch(e){}"><nobr>发送反馈</nobr></a></div></div> <script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">var pageTracker = _gat._getTracker("UA-27188110-1");pageTracker._setCookiePath("/patents/");pageTracker._trackPageview();</script> </body></html>